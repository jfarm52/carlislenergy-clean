<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no,address=no,email=no">
    <title>Refrigeration Data Collection</title>
    
    <!-- Flatpickr for desktop date picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        /* Simple, mobile‑friendly layout */
        * {
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f2f2f2;
            color: #333;
            max-width: 100%;
            overflow-x: hidden;
        }
        header {
            background: linear-gradient(135deg, #1e5a99 0%, #2d7bb8 50%, #5ca3d6 100%);
            color: #fff;
            padding: 0.5rem 1rem;
            text-align: center;
            position: relative;
        }
        @media (max-width: 768px) {
            header {
                padding: 0.5rem 0.5rem 0.5rem 75px;
            }
            header img[alt="Carlisle Logo"] {
                height: 60px !important;
            }
        }
        .container {
            padding: 1rem;
        }
        h2 {
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }
        .field {
            margin-bottom: 0.75rem;
        }
        .field label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: bold;
        }
        .field input, .field select, .field textarea {
            width: 100%;
            max-width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            /* Capitalise first letter of each word */
            text-transform: capitalize;
            box-sizing: border-box;
        }
        
        /* Disable auto-capitalization for blade spec - allow plain number entry */
        #room-bladeSpec {
            text-transform: none;
        }
        
        /* Disable auto-capitalization for notes - allow normal sentence capitalization */
        #room-notes {
            text-transform: none;
        }
        
        .field textarea {
            resize: vertical;
        }
        .button {
            display: inline-block;
            padding: 0.5rem 1rem;
            margin-top: 1rem;
            background: linear-gradient(135deg, #1e5a99 0%, #2d7bb8 50%, #5ca3d6 100%);
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            text-align: center;
        }
        .button.secondary {
            background-color: #888;
        }
        
        /* Status message styles - reuse button color for uploading state */
        #dropbox-status {
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        
        #dropbox-status.status-uploading {
            color: #2d7bb8;
        }
        
        #dropbox-status.status-success {
            color: #0a0;
        }
        
        #dropbox-status.status-error {
            color: #c00;
        }
        
        .retry-btn {
            margin-left: 0.5rem;
            padding: 0.3rem 0.8rem;
            font-size: 0.9rem;
            cursor: pointer;
            border: 1px solid #c00;
            color: #c00;
            background: transparent;
            border-radius: 4px;
        }
        
        .retry-btn:active {
            opacity: 0.7;
        }
        
        .bottom-save-container {
            margin: 2rem 0;
            text-align: center;
        }
        
        .bottom-save-container #saveProjectBtn {
            min-width: 220px;
        }
        
        /* Icon buttons for edit/delete – no background or border */
        .icon-button {
            background: none;
            border: none;
            padding: 0;
            font-size: 0.9rem;
            cursor: pointer;
            line-height: 1;
        }
        .cards {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }
        .card {
            background-color: #fff;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
            border: 2px solid #555;
            padding: 0.75rem 1rem;
            width: calc(50% - 1rem);
            position: relative;
            user-select: none;
            -webkit-user-select: none;
        }
        /* Six-dot drag handle for reordering cards */
        .drag-handle {
            cursor: grab;
            font-size: 1.2rem;
            user-select: none;
            padding: 0;
            background: none;
            border: none;
            line-height: 1;
            letter-spacing: -0.05rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .drag-handle:hover {
            opacity: 1;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        @media (max-width: 600px) {
            .card {
                width: 100%;
            }
        }
        .card-title {
            font-weight: bold;
            margin: 0;
            font-size: 1.4rem;
            flex-grow: 1;
            text-align: center;
            width: 95%;
            padding-left: 0.5rem;
        }

        /* Subheading style for quantities and specs headings */
        .subheading {
            font-size: 0.85rem;
            font-weight: bold;
            font-style: italic;
            text-decoration: underline;
            margin: 0.25rem 0 0.1rem 0;
        }
        .card-body p {
            margin: 0.25rem 0;
        }
        .card-actions {
            margin-top: 0.5rem;
            display: flex;
            justify-content: flex-start;
            gap: 1.5rem;
        }
        .card-header {
            display: grid;
            grid-template-columns: auto 1fr;
            grid-template-rows: auto auto;
            column-gap: 0.5rem;
            row-gap: 0.15rem;
            position: relative; /* For absolute positioning of trash icon */
            margin-bottom: 0.5rem;
        }
        .hidden {
            display: none;
        }
        
        /* Mobile responsive layout */
        @media (max-width: 768px) {
            header {
                overflow: hidden;
                padding: 1rem 0.5rem !important;
            }
            #headerLogo {
                display: none !important;
            }
            #headerContent {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
                max-width: 100% !important;
                text-align: center !important;
            }
            #headerContent h1 {
                font-size: 1.3rem !important;
            }
            #headerContent #forLine {
                margin-top: 1rem !important;
            }
            #headerContent #customerName {
                font-size: 2.2rem !important;
                font-weight: 600 !important;
                font-style: italic !important;
                font-family: Georgia, 'Times New Roman', serif !important;
                margin-top: 0.2rem !important;
            }
            #headerContent #byLine {
                margin-top: 0.45rem !important;
                font-size: 0.8rem !important;
            }
            #headerContent #logoStack {
                margin-top: 0.15rem !important;
                margin-left: -1.5rem !important;
            }
            #headerContent #headerCompanyLogo {
                height: 78px !important;
            }
            #headerContent #dbaLicenseLine {
                font-size: 0.75rem !important;
                font-style: italic !important;
                margin-top: 0.2rem !important;
                margin-left: 0.9rem !important;
            }
            
            .container {
                padding: 0.75rem !important;
                max-width: 100%;
            }
            
            /* Stack top info bar vertically on mobile */
            #topInfoBar {
                flex-direction: column !important;
                gap: 0.75rem !important;
                padding: 0.75rem 0.5rem !important;
            }
            #siteAddressDisplay {
                width: 100% !important;
                text-align: center !important;
            }
            #dateField {
                width: 100% !important;
                text-align: center !important;
                padding-right: 0 !important;
            }
        }
        
        /* Prevent auto-linking and underlining in license line */
        #dbaLicenseLine, #dbaLicenseLine *, #dbaLicenseLine a, #dbaLicenseLine span {
            text-decoration: none !important;
            color: inherit !important;
            -webkit-text-decoration: none !important;
        }
        #dbaLicenseLine a {
            pointer-events: none !important;
        }
        /* Disable iOS data detectors */
        a[x-apple-data-detectors] {
            color: inherit !important;
            text-decoration: none !important;
            font-size: inherit !important;
            font-family: inherit !important;
            font-weight: inherit !important;
            line-height: inherit !important;
        }
        /* Hover effect for edit site pencil icon */
        #editSiteBtn:hover {
            opacity: 1 !important;
        }
        
        /* Tab styling for equipment cards */
        .card-tab {
            padding: 0.5rem 1rem;
            background-color: #e0e0e0;
            border: 1px solid #ccc;
            border-bottom: 2px solid #ccc;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: normal;
            transition: all 0.2s ease;
            position: relative;
            bottom: -2px;
        }
        .card-tab:hover {
            background-color: #d0d0d0;
        }
        .card-tab.active {
            background-color: #fff;
            font-weight: bold;
            border-bottom: 2px solid #fff;
            bottom: -2px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .notes-content {
            padding: 1rem;
            background-color: #fafafa;
            border-radius: 4px;
            min-height: 100px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .notes-empty {
            color: #999;
            font-style: italic;
        }
        
        /* Edit mode isolation - hide elements when editing a room */
        body.editing-room header,
        body.editing-room #topInfoBar {
            display: none !important;
        }
        
        body.editing-room .card:not(.editing) {
            display: none !important;
        }
        
        body.editing-room #addEvapButtonContainer,
        body.editing-room #addCondButtonContainer,
        body.editing-room #dataSection > h2 {
            display: none !important;
        }
        
        body.editing-room #exportImportSection {
            display: none !important;
        }
        
        /* Card header with icons on left */
        .card-icon-header {
            grid-row: 1;
            grid-column: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }
        
        .card-title-section {
            grid-row: 2;
            grid-column: 1 / span 2;
            text-align: center;
            margin: 0;
        }
        
        /* Form title with Cancel button on same line */
        .form-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .form-title-row h2 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .form-title-cancel-btn {
            background-color: #888;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 0.4rem 0.8rem;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        /* Form top buttons - positioned at top-right */
        .form-top-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .form-top-buttons .button {
            margin: 0;
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }
        
        /* Form footer buttons - centered with spacing */
        .form-footer-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .form-footer-buttons .button {
            margin: 0;
        }
        
        .delete-room-btn {
            background-color: #d9534f !important;
        }
        
        /* Edit pencil positioning for Details and Notes tabs */
        .edit-pencil-bottom {
            display: none;
            position: absolute;
            bottom: 0.5rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.1rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            z-index: 10;
        }
        
        .edit-pencil-bottom:hover {
            opacity: 1;
        }
        
        .edit-pencil-notes-tab {
            display: none;
            font-size: 1rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            margin-left: 0.5rem;
        }
        
        .edit-pencil-notes-tab:hover {
            opacity: 1;
        }
        
        /* Show bottom pencil when Details tab is active */
        .tab-content.active[data-tab-content="details"] ~ .edit-pencil-bottom {
            display: block;
        }
        
        /* Done button for inline notes editing */
        .notes-done-btn {
            background: linear-gradient(135deg, #1e5a99 0%, #2d7bb8 50%, #5ca3d6 100%);
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 0.4rem 0.8rem;
            margin-left: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            vertical-align: middle;
            order: 2;
        }
        
        /* Temperature section - prevent wrapping */
        .temp-section {
            flex: 0 0 auto;
            min-width: max-content;
            white-space: nowrap;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        @media (max-width: 600px) {
            .notes-done-btn {
                width: 100%;
                margin-left: 0;
                margin-top: 0.5rem;
            }
        }
        
        /* Editable notes content */
        .notes-content[contenteditable="true"] {
            border: 2px solid #2d7bb8;
            outline: none;
            background-color: #fff;
            cursor: text;
            text-transform: none;
        }
        
        /* Nearby businesses modal/popup */
        #nearbyBusinessesModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        #nearbyBusinessesModal.show {
            display: flex;
        }
        .nearby-modal-content {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .nearby-modal-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nearby-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        .nearby-business-item {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .nearby-business-item:hover {
            background-color: #f0f0f0;
        }
        .nearby-business-name {
            font-weight: bold;
            color: #333;
        }
        .nearby-business-address {
            font-size: 0.9rem;
            color: #666;
        }
        
        /* Autocomplete dropdown styling */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .autocomplete-dropdown.show {
            display: block;
        }
        .autocomplete-item {
            padding: 0.75rem !important;
            border-bottom: 1px solid #f0f0f0 !important;
            cursor: pointer !important;
            font-size: 0.95rem !important;
            background-color: #ffffff !important;
            color: #000000 !important;
        }
        .autocomplete-item:last-child {
            border-bottom: none !important;
        }
        .autocomplete-item:hover {
            background-color: #f0f0f0 !important;
        }
        .autocomplete-main {
            font-weight: 500 !important;
            color: #000000 !important;
            display: block !important;
            padding: 0 !important;
        }
        .autocomplete-secondary {
            font-size: 0.85rem !important;
            color: #555555 !important;
            margin-top: 0.25rem !important;
            display: block !important;
        }
        .autocomplete-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        /* ===== GOOGLE PLACES AUTOCOMPLETE VISIBILITY FIXES ===== */
        /* Extra protection to ensure autocomplete text is ALWAYS visible */
        /* This prevents white-on-white or invisible text issues */
        
        .autocomplete-dropdown * {
            color: inherit !important;
        }
        
        .autocomplete-item,
        .autocomplete-item *,
        .autocomplete-item span,
        .autocomplete-item div {
            color: #000000 !important;
            background-color: transparent !important;
        }
        
        .autocomplete-item {
            background-color: #ffffff !important;
        }
        
        .autocomplete-item:hover,
        .autocomplete-item:hover * {
            background-color: #f0f0f0 !important;
        }
        
        /* Ensure no text shadows or transforms hide the text */
        .autocomplete-item,
        .autocomplete-item * {
            text-shadow: none !important;
            opacity: 1 !important;
        }
        
        .autocomplete-main,
        .autocomplete-secondary {
            line-height: 1.4 !important;
        }
        
        /* === Enhanced Google Places dropdown visibility (mobile-optimized) === */
        .autocomplete-dropdown {
            z-index: 9999 !important;
            background-color: #ffffff !important;
            border: 1px solid #ccc !important;
            color: #000000 !important;
            font-size: 14px !important;
        }
        
        .autocomplete-item.selected,
        .autocomplete-item:active {
            background-color: #e6f0ff !important;
        }
        
        .autocomplete-main {
            font-weight: 600 !important;
        }
        
        /* === Clear "X" button - only visible when field has value === */
        .input-wrapper {
            position: relative;
            display: block;
            width: 100%;
        }
        
        .input-wrapper input[type="text"],
        .input-wrapper input[type="tel"],
        .input-wrapper input[type="email"],
        .input-wrapper input[type="number"],
        .input-wrapper input[type="search"] {
            padding-right: 32px !important;
        }
        
        .input-wrapper .clear-input-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #eee;
            border-radius: 50%;
            padding: 4px 7px;
            font-size: 14px;
            cursor: pointer;
            display: none;
            z-index: 10;
            user-select: none;
        }
        
        .input-wrapper .clear-input-btn:hover {
            background: #ddd;
        }
        
        .input-wrapper .clear-input-btn:active {
            background: #ccc;
        }
        
        /* ========================================================================
           BULLETPROOF AUTOCOMPLETE DROPDOWN VISIBILITY OVERRIDES
           These rules ensure autocomplete suggestions are ALWAYS visible
           ======================================================================== */
        
        /* Autocomplete dropdown container */
        .autocomplete-dropdown {
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 999999 !important;
            background-color: #ffffff !important;
            background: #ffffff !important;
            border: 1px solid #cccccc !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            overflow-y: auto !important;
            max-height: 50vh !important;
            position: absolute !important;
            top: 100% !important;
            margin-top: 4px !important;
            left: 0 !important;
            right: 0 !important;
            border-radius: 0 0 8px 8px !important;
            box-sizing: border-box !important;
        }
        
        /* Mobile-specific: shorter dropdown to account for keyboard */
        @media (max-width: 768px) {
            .autocomplete-dropdown {
                max-height: 45vh !important;
            }
        }
        
        .autocomplete-dropdown.show {
            display: block !important;
        }
        
        .autocomplete-dropdown:not(.show) {
            display: none !important;
        }
        
        /* Individual autocomplete items */
        .autocomplete-item {
            visibility: visible !important;
            opacity: 1 !important;
            display: block !important;
            background-color: #ffffff !important;
            padding: 10px 14px !important;
            cursor: pointer !important;
            border-bottom: 1px solid #e6e6e6 !important;
        }
        
        .autocomplete-item:last-child {
            border-bottom: none !important;
        }
        
        .autocomplete-item:hover {
            background-color: #eef3ff !important;
        }
        
        /* Text elements inside items */
        .autocomplete-main {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            color: #000000 !important;
            font-weight: 600 !important;
            font-size: 15px !important;
            line-height: 1.4 !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .autocomplete-secondary {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            color: #666666 !important;
            font-weight: 400 !important;
            font-size: 13px !important;
            line-height: 1.3 !important;
            margin: 4px 0 0 0 !important;
            padding: 0 !important;
        }
        
        /* Remove any inherited effects that could hide text */
        .autocomplete-dropdown *,
        .autocomplete-item *,
        .autocomplete-main,
        .autocomplete-secondary {
            text-shadow: none !important;
            filter: none !important;
            transform: none !important;
            clip: auto !important;
            clip-path: none !important;
        }
        
        /* Google Places widget (future-proofing) */
        .pac-container {
            z-index: 999999 !important;
            background: #ffffff !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25) !important;
        }
        
        .pac-item {
            background-color: #ffffff !important;
            color: #000000 !important;
            padding: 10px 14px !important;
            font-size: 15px !important;
            border-bottom: 1px solid #e6e6e6 !important;
        }
        
        .pac-item:hover,
        .pac-item.pac-item-selected {
            background: #eef3ff !important;
        }
        
        .pac-item-query {
            color: #000000 !important;
            font-weight: 600 !important;
        }
        
        .pac-matched {
            color: #007bff !important;
        }
        
        .pac-icon {
            display: none !important;
        }
        
        /* ===== PHOTO SYSTEM STYLES ===== */
        
        /* Photo pool section container */
        .photo-pool-section {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        /* Photo pool header with title and buttons */
        .photo-pool-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .photo-pool-header h2 {
            margin: 0;
            font-size: 1.3rem;
        }
        
        .photo-pool-header > div {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .photo-pool-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .photo-pool-buttons .button {
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
        }
        
        @media (max-width: 600px) {
            .photo-pool-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .photo-pool-buttons {
                width: 100%;
            }
            
            .photo-pool-buttons .button {
                flex: 1;
                min-width: 0;
            }
        }
        
        /* Photo grid - responsive columns */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        @media (max-width: 992px) {
            .photo-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .photo-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Individual photo tile */
        .photo-tile {
            position: relative;
            background-color: #fff;
            border: 2px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
            aspect-ratio: 1;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .photo-tile:hover {
            border-color: #2d7bb8;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .photo-tile.separator {
            border-color: #ff9800;
            border-width: 3px;
        }
        
        /* Thumbnail image styling */
        .photo-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        /* Separator badge indicator */
        .photo-separator-badge {
            position: absolute;
            top: 4px;
            left: 4px;
            background-color: #ff9800;
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            z-index: 5;
        }
        
        /* Photo action buttons overlay */
        .photo-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            padding: 0.5rem 0.25rem 0.25rem;
            display: flex;
            justify-content: center;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .photo-tile:hover .photo-actions {
            opacity: 1;
        }
        
        /* Touch devices - always show actions */
        @media (hover: none) {
            .photo-actions {
                opacity: 1;
            }
        }
        
        .photo-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            background-color: #fff;
            color: #333;
        }
        
        .photo-actions button:hover {
            background-color: #e0e0e0;
        }
        
        .photo-actions button.separator-btn.active {
            background-color: #ff9800;
            color: white;
        }
        
        .photo-actions button.remove-btn {
            background-color: #d9534f;
            color: white;
        }
        
        .photo-actions button.remove-btn:hover {
            background-color: #c9302c;
        }
        
        /* Photo count badge on tabs */
        .photo-count-badge {
            display: inline-block;
            background-color: #2d7bb8;
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 1.2rem;
            height: 1.2rem;
            line-height: 1.2rem;
            text-align: center;
            border-radius: 50%;
            margin-left: 0.25rem;
            vertical-align: middle;
        }
        
        /* Photo attach modal */
        .photo-attach-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.6);
            z-index: 99999;
            justify-content: center;
            align-items: center;
        }
        
        .photo-attach-modal.show {
            display: flex;
        }
        
        .photo-attach-modal-content {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .photo-attach-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .photo-attach-modal-header h3 {
            margin: 0;
        }
        
        .photo-attach-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .photo-attach-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            max-height: 50vh;
            overflow-y: auto;
        }
        
        @media (max-width: 600px) {
            .photo-attach-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .photo-attach-item {
            aspect-ratio: 1;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 4px;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        
        .photo-attach-item:hover {
            border-color: #2d7bb8;
        }
        
        .photo-attach-item.selected {
            border-color: #28a745;
            border-width: 3px;
        }
        
        .photo-attach-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Photos tab content styling */
        .photos-tab-content {
            padding: 0.75rem;
            background-color: #fafafa;
            border-radius: 4px;
            min-height: 80px;
        }
        
        .room-photos-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        @media (max-width: 600px) {
            .room-photos-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .room-photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .room-photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .room-photo-item .remove-photo-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(217, 83, 79, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .photos-empty {
            color: #999;
            font-style: italic;
            text-align: center;
            padding: 1rem;
        }
        
        .attach-photos-btn {
            margin-top: 0.5rem;
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        
        /* Auto-assign summary modal */
        .auto-assign-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.6);
            z-index: 99999;
            justify-content: center;
            align-items: center;
        }
        
        .auto-assign-modal.show {
            display: flex;
        }
        
        .auto-assign-modal-content {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .auto-assign-summary {
            margin: 1rem 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .auto-assign-summary-item {
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .auto-assign-summary-item:last-child {
            border-bottom: none;
        }
        
        /* Photos navigation button */
        #photosNavBtn {
            background: linear-gradient(135deg, #5ca3d6 0%, #2d7bb8 100%);
        }
        
        /* Autosave Restore Modal */
        .autosave-restore-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            z-index: 100001;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        
        .autosave-restore-modal.hidden {
            display: none;
        }
        
        .autosave-restore-modal-content {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .autosave-restore-modal-content h3 {
            margin-top: 0;
            color: #1e5a99;
        }
        
        .autosave-restore-info {
            background-color: #f5f5f5;
            padding: 0.75rem;
            border-radius: 4px;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        
        .autosave-restore-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }
        
        /* Delete Confirmation Modal - Custom modal to replace native confirm() */
        /* This modal dismisses keyboard first and is always visible on iOS */
        .delete-confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.6);
            z-index: 200000; /* Higher than all other modals */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .delete-confirm-modal.hidden {
            display: none;
        }
        
        .delete-confirm-modal-content {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .delete-confirm-modal-content h3 {
            margin-top: 0;
            color: #d32f2f;
        }
        
        .delete-confirm-modal-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-top: 1.5rem;
        }
        
        .delete-confirm-modal-buttons button {
            min-width: 100px;
            padding: 0.75rem 1.25rem;
            font-size: 1rem;
        }
        
        /* Trash icon in reorder mode - positioned at bottom center of card */
        .reorder-trash-icon {
            position: absolute;
            bottom: 0.5rem;
            left: 50%;
            transform: translateX(-50%);
            color: #d32f2f;
            font-size: 1.4rem;
            cursor: pointer;
            padding: 0.25rem 0.4rem;
            z-index: 10;
            display: none; /* Hidden by default, shown in reorder mode via JS */
        }
        
        .reorder-trash-icon:hover {
            color: #b71c1c;
        }
        
        /* Show trash icon when in reorder mode */
        .card.reorder-active .reorder-trash-icon {
            display: block;
        }
        
        /* Project Name Modal */
        .project-name-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.6);
            z-index: 100000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .project-name-modal.hidden {
            display: none;
        }
        
        .project-name-modal-content {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        /* Load Project Modal (full-screen) */
        .load-project-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            z-index: 100000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        
        .load-project-modal.hidden {
            display: none;
        }
        
        .load-project-modal-content {
            background: white;
            border-radius: 8px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .load-project-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #ddd;
        }
        
        .load-project-modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #666;
            line-height: 1;
        }
        
        .load-project-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .project-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .project-list-item:hover {
            background-color: #f0f7ff;
            border-color: #2d7bb8;
        }
        
        .project-list-info {
            flex: 1;
            min-width: 0;
        }
        
        .project-list-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .project-list-customer {
            color: #666;
            font-size: 0.9rem;
        }
        
        .project-list-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.25rem;
            flex-wrap: wrap;
        }
        
        .project-list-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        .project-list-actions button {
            padding: 0.4rem 0.6rem;
            font-size: 0.8rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            background: #f5f5f5;
        }
        
        .project-list-actions button:hover {
            background: #e0e0e0;
        }
        
        .project-list-actions .delete-btn {
            background-color: #fee;
            border-color: #c00;
            color: #c00;
        }
        
        .project-list-actions .delete-btn:hover {
            background-color: #fcc;
        }
        
        @media (max-width: 600px) {
            .project-list-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .project-list-actions {
                margin-top: 0.5rem;
                width: 100%;
                justify-content: flex-end;
            }
        }
        
        /* Hamburger Menu */
        .hamburger-btn {
            position: fixed;
            top: 0.75rem;
            left: 0.75rem;
            z-index: 10001;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 6px;
            padding: 0.5rem 0.7rem;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            line-height: 1;
        }
        .hamburger-btn:hover {
            background: #fff;
        }
        
        /* Navigation Drawer */
        .nav-drawer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 10002;
        }
        .nav-drawer-overlay.show {
            display: block;
        }
        .nav-drawer {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: #fff;
            z-index: 10003;
            transition: left 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            overflow-y: auto;
        }
        .nav-drawer.open {
            left: 0;
        }
        .nav-drawer-header {
            background: linear-gradient(135deg, #1e5a99 0%, #2d7bb8 50%, #5ca3d6 100%);
            color: #fff;
            padding: 1.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-drawer-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        .nav-drawer-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
        }
        .nav-drawer-items {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-drawer-items li {
            border-bottom: 1px solid #eee;
        }
        .nav-drawer-items a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            color: #333;
            text-decoration: none;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        .nav-drawer-items a:hover {
            background-color: #f0f7ff;
        }
        .nav-drawer-items a.active {
            background-color: #e6f0ff;
            color: #1e5a99;
            font-weight: bold;
        }
        .nav-drawer-items .nav-icon {
            font-size: 1.2rem;
        }
        
        /* View pages for hash routing */
        .view-page {
            display: none;
        }
        .view-page.active {
            display: block;
        }
        
        /* Projects page (full-page list) */
        .projects-page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .projects-page-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .select-all-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f5f5f5;
            border-radius: 4px;
        }
        .select-all-container label {
            cursor: pointer;
            font-size: 0.9rem;
        }
        .delete-selected-btn {
            background-color: #d9534f;
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .delete-selected-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* Project checkbox in list */
        .project-checkbox {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        /* Customer Info page */
        .customer-info-page {
            max-width: 600px;
            margin: 0 auto;
        }
        .customer-info-page h2 {
            margin-bottom: 1rem;
        }
        .customer-info-save-btn {
            margin-top: 1rem;
        }
        
        /* ==================== NAVIGATION VIEW SYSTEM ==================== */
        /* Main app container - shows one view at a time */
        #app-main {
            min-height: 100dvh;
        }
        
        .app-view {
            display: none;
            padding-top: 60px; /* Space for hamburger button */
        }
        .app-view.active {
            display: block;
        }
        
        /* Hide header and other elements when on non-project views */
        body.view-home header,
        body.view-home #topInfoBar,
        body.view-projects header,
        body.view-projects #topInfoBar,
        body.view-customerInfo header,
        body.view-customerInfo #topInfoBar {
            display: none !important;
        }
        
        /* ==================== HOME PAGE STYLES ==================== */
        /* TODO: set hero background image from client assets */
        .home-view {
            min-height: 100dvh;
            /* Brand canvas: blue gradient, but “sexier” via layered glows (keeps readability) */
            background: linear-gradient(135deg, #0b1f3a 0%, #1e5a99 35%, #2d7bb8 70%, #6fd0ff 100%);
            position: relative;
            isolation: isolate;
            padding: 2.25rem 12px;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        }

        .home-view::before {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            /* “Mesh” feel using a few radial gradients */
            background:
                radial-gradient(900px circle at 12% 10%, rgba(255,255,255,0.18), transparent 62%),
                radial-gradient(750px circle at 88% 22%, rgba(111,208,255,0.28), transparent 60%),
                radial-gradient(900px circle at 55% 105%, rgba(45,123,184,0.40), transparent 62%);
            mix-blend-mode: screen;
            opacity: 0.9;
        }

        .home-view::after {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            /* Gentle darkening so white text + controls stay readable on bright cyan */
            background: linear-gradient(to bottom, rgba(0,0,0,0.08), rgba(0,0,0,0.35));
            opacity: 1;
        }
        
        .home-hero {
            text-align: center;
            color: #fff;
            padding: 2.25rem 1.25rem 1.5rem 1.25rem;
            max-width: 720px;
            margin: 0 auto;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
            border-radius: 20px;
            background: rgba(10, 26, 52, 0.32);
            border: 1px solid rgba(255,255,255,0.18);
            box-shadow: 0 26px 70px rgba(0,0,0,0.35);
            backdrop-filter: blur(10px);
        }

        .home-hero::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: inherit;
            pointer-events: none;
            /* subtle inner highlight so the panel feels less “flat” */
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.12);
        }
        
        .home-logo {
            max-width: 100%;
            max-height: 160px;
            height: auto;
            display: block;
            margin: 0 auto 1.25rem auto;
            /* Subtle frosted plate so the dark wordmark stays readable, without feeling “white-boxy” */
            background: linear-gradient(135deg, rgba(255,255,255,0.30), rgba(255,255,255,0.12));
            border: 1px solid rgba(255,255,255,0.22);
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 22px 55px rgba(0,0,0,0.26);
            filter: drop-shadow(0 10px 18px rgba(0,0,0,0.18));
        }
        
        .home-title {
            font-size: 2.05rem;
            margin: 0 0 0.65rem 0;
            font-weight: 750;
            letter-spacing: -0.02em;
            text-shadow: 0 10px 26px rgba(0,0,0,0.35);
        }
        
        .home-subtitle {
            /* Eyebrow label (not button-like) */
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            margin: 0 0 1.6rem 0;
            padding: 0;
            border-radius: 0;
            background: transparent;
            border: none;
            box-shadow: none;
            color: rgba(255,255,255,0.82);
            letter-spacing: 0.18em;
            text-transform: uppercase;
        }

        .home-subtitle::before,
        .home-subtitle::after {
            content: "";
            height: 1px;
            width: 28px;
            background: linear-gradient(90deg, rgba(111,208,255,0.0), rgba(111,208,255,0.75), rgba(111,208,255,0.0));
            opacity: 0.9;
        }
        
        .home-cta-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2.5rem;
        }
        
        .home-cta-btn {
            padding: 1.15rem 1.75rem;
            font-size: 1.15rem;
            border: 1px solid transparent;
            border-radius: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease, background 0.18s ease;
            box-shadow: 0 10px 26px rgba(0,0,0,0.22);
            font-weight: 650;
        }
        
        .home-cta-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 40px rgba(0,0,0,0.28);
            filter: saturate(1.05);
        }

        .home-cta-btn:active {
            transform: translateY(0px) scale(0.99);
            box-shadow: 0 10px 26px rgba(0,0,0,0.22);
        }
        
        .home-cta-btn.primary {
            background: linear-gradient(135deg, #6fd0ff 0%, #2d7bb8 45%, #1e5a99 100%);
            color: #fff;
            font-weight: 750;
            border-color: rgba(255,255,255,0.18);
            text-shadow: 0 10px 22px rgba(0,0,0,0.25);
            background-size: 180% 180%;
            animation: homeGradientShift 8s ease-in-out infinite;
        }

        @keyframes homeGradientShift {
            0%   { background-position: 0% 50%; }
            50%  { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .home-cta-btn.secondary {
            /* Secondary: same shape + depth, softer gradient (still clearly clickable) */
            background: linear-gradient(135deg, rgba(255,255,255,0.20) 0%, rgba(255,255,255,0.10) 100%);
            color: rgba(255,255,255,0.95);
            border: 1px solid rgba(255,255,255,0.30);
            box-shadow: 0 10px 26px rgba(0,0,0,0.18);
        }
        
        .home-cta-btn.tertiary {
            /* Tertiary: still a “real button” (not a naked link), but clearly lowest priority */
            background: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.90);
            border: 1px solid rgba(255,255,255,0.26);
            font-size: 1.0rem;
            padding: 0.95rem 1.5rem;
            border-radius: 14px;
            box-shadow: 0 8px 22px rgba(0,0,0,0.12);
        }
        
        .home-cta-btn.tertiary:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.6);
        }

        @media (max-width: 480px) {
            .home-hero {
                padding: 1.75rem 1rem 1.25rem 1rem;
                border-radius: 16px;
            }
            .home-logo {
                max-height: 120px;
            }
            .home-title {
                font-size: 1.75rem;
            }
            .home-cta-btn {
                padding: 1.05rem 1.25rem;
                border-radius: 12px;
            }
        }
        
        /* Bills page styles */
        .bills-view {
            padding: 1rem;
            background: #f5f7fa;
            min-height: 100dvh;
        }
        .bills-container {
            max-width: 900px;
            margin: 0 auto;
        }
        .bills-header {
            background: #fff;
            padding: 1.25rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .bills-header h2 {
            margin: 0 0 0.75rem 0;
            color: #1e5a99;
        }
        .bills-project-summary {
            color: #555;
        }
        .bills-project-name {
            font-weight: bold;
            font-size: 1.1rem;
        }
        .bills-project-address {
            font-size: 0.9rem;
            color: #777;
        }
        .bills-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .bills-panel {
            background: #fff;
            padding: 1.25rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .bills-panel h3 {
            margin: 0 0 0.75rem 0;
            color: #333;
            font-size: 1rem;
        }
        .bills-helper-text {
            color: #666;
            font-size: 0.9rem;
            margin: 0 0 1rem 0;
        }
        .bills-upload-area {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .bills-upload-btn {
            align-self: flex-start;
        }
        .bills-upload-status {
            font-size: 0.9rem;
            color: #555;
        }
        .bills-files-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .bills-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        .bills-file-info {
            display: flex;
            flex-direction: column;
        }
        .bills-file-name {
            font-weight: 500;
        }
        .bills-file-meta {
            font-size: 0.8rem;
            color: #888;
        }
        .bills-file-delete {
            background: none;
            border: none;
            color: #d9534f;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
        }
        .bills-empty-state {
            color: #999;
            font-style: italic;
            padding: 1rem;
            text-align: center;
        }
        .bills-reads-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .bills-reads-table th,
        .bills-reads-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        .bills-reads-table th {
            background: #f0f0f0;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .bills-reads-table td {
            font-size: 0.9rem;
        }
        .bills-empty-row td {
            color: #999;
            font-style: italic;
            text-align: center;
        }
        .bills-footer {
            margin-top: 1.5rem;
            text-align: center;
        }
        .bills-grouped-data {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .bills-account-group {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .bills-account-header {
            background: #1e5a99;
            color: #fff;
            padding: 0.75rem 1rem;
            font-weight: bold;
        }
        .bills-account-header .account-utility {
            font-size: 1rem;
        }
        .bills-account-header .account-number {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }
        .bills-meter-group {
            border-top: 1px solid #e0e0e0;
        }
        .bills-meter-header {
            background: #f0f4f8;
            padding: 0.6rem 1rem;
            font-weight: 600;
            color: #333;
            border-bottom: 1px solid #ddd;
        }
        .bills-meter-reads-table {
            width: 100%;
            border-collapse: collapse;
        }
        .bills-meter-reads-table th,
        .bills-meter-reads-table td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
        }
        .bills-meter-reads-table th {
            background: #fafafa;
            font-weight: 600;
            color: #555;
        }
        .bills-meter-reads-table tr:last-child td {
            border-bottom: none;
        }
        
        /* Detailed bill breakdown styles */
        .bills-page-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        @media (max-width: 768px) {
            .bills-page-container {
                padding: 0 0.75rem;
            }
        }
        .bill-detail-section {
            margin: 0.75rem 0;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }
        .bill-detail-header {
            background: #f0f4f8;
            padding: 0.6rem 1rem;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        .bill-detail-header:hover {
            background: #e8eef4;
        }
        .bill-detail-header .toggle-icon {
            font-size: 0.8rem;
            transition: transform 0.2s;
        }
        .bill-detail-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        .bill-detail-content {
            padding: 0.75rem 1rem;
            background: #fff;
        }
        .bill-detail-content.collapsed {
            display: none;
        }
        .bill-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        .bill-summary-item {
            display: flex;
            flex-direction: column;
        }
        .bill-summary-item label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 0.15rem;
        }
        .bill-summary-item span {
            font-size: 0.95rem;
            color: #333;
            font-weight: 500;
        }
        .bill-summary-item.highlight span {
            color: #1e5a99;
            font-size: 1.1rem;
            font-weight: 700;
        }
        .bill-charges-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.35rem 1rem;
            max-width: 350px;
        }
        .bill-charges-grid .charge-label {
            font-size: 0.9rem;
            color: #555;
        }
        .bill-charges-grid .charge-amount {
            font-size: 0.9rem;
            text-align: right;
            font-weight: 500;
        }
        .bill-charges-grid .charge-total {
            font-weight: 700;
            color: #1e5a99;
            border-top: 2px solid #1e5a99;
            padding-top: 0.35rem;
            margin-top: 0.25rem;
        }
        .bill-tou-table, .bill-line-items-table, .bill-history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .bill-tou-table th, .bill-tou-table td,
        .bill-line-items-table th, .bill-line-items-table td,
        .bill-history-table th, .bill-history-table td {
            padding: 0.4rem 0.6rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .bill-tou-table th, .bill-line-items-table th, .bill-history-table th {
            background: #fafafa;
            font-weight: 600;
            color: #555;
        }
        .bill-tou-table .num, .bill-line-items-table .num,
        .bill-history-table .num {
            text-align: right;
        }
        .bill-line-items-table .credit {
            color: #28a745;
        }
        .bill-usage-summary {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.6rem;
            margin-bottom: 0.5rem;
        }
        .usage-stat {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 0.6rem 0.5rem;
            text-align: center;
        }
        .usage-stat .value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e5a99;
            white-space: nowrap;
        }
        .usage-stat .label {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.15rem;
            line-height: 1.2;
        }
        @media (max-width: 400px) {
            .usage-stat .value {
                font-size: 0.9rem;
            }
            .usage-stat .label {
                font-size: 0.65rem;
            }
        }
        .tou-breakdown {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }
        .tou-item {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            min-width: 100px;
            text-align: center;
        }
        .tou-item.on-peak { border-left: 3px solid #dc3545; }
        .tou-item.mid-peak { border-left: 3px solid #ffc107; }
        .tou-item.off-peak { border-left: 3px solid #28a745; }
        .tou-item .period {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
        }
        .tou-item .kwh {
            font-size: 1rem;
            font-weight: 700;
            color: #333;
        }
        @media (max-width: 600px) {
            .bill-summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .bill-usage-summary {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .bills-status-complete {
            color: #1e5a99;
            font-weight: 600;
        }
        .bills-status-ok {
            color: #28a745;
            font-weight: 500;
        }
        .bills-status-needs_review {
            color: #ffc107;
            font-weight: 500;
        }
        .bills-status-error {
            color: #dc3545;
            font-weight: 500;
        }
        .bills-status-review {
            color: #dc3545;
            font-weight: 500;
        }
        .bills-status-skipped {
            color: #6c757d;
            font-weight: 400;
            font-style: italic;
        }
        .bills-status-pending {
            color: #6c757d;
            font-weight: 500;
        }
        
        /* Bill upload progress bar and status styles */
        .bills-progress-container {
            margin-top: 0.75rem;
            display: none;
        }
        .bills-progress-container.show {
            display: block;
        }
        .bills-progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        .bills-progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #1e5a99 0%, #2d7bb8 100%);
            transition: width 0.2s ease;
            width: 0%;
        }
        .bills-progress-text {
            font-size: 0.85rem;
            color: #555;
        }
        
        /* Per-file upload progress items */
        .bill-upload-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .bill-upload-items:empty {
            display: none;
        }
        .bill-upload-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 0.5rem 0.75rem;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        .bill-upload-item .filename {
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .bill-upload-item .progress-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .bill-upload-item .progress-bar-container {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        .bill-upload-item .progress-bar-fill {
            height: 100%;
            width: 0%;
            transition: width 0.2s ease, background-color 0.3s ease;
            border-radius: 4px;
        }
        .bill-upload-item .progress-bar-fill.uploading {
            background: linear-gradient(135deg, #1e5a99 0%, #2d7bb8 100%);
        }
        .bill-upload-item .progress-bar-fill.extracting {
            background: linear-gradient(135deg, #1e5a99 0%, #2d7bb8 100%);
        }
        .bill-upload-item .progress-bar-fill.complete {
            background: #1e5a99;
        }
        .bill-upload-item .progress-bar-fill.ok {
            background: #28a745;
        }
        .bill-upload-item .progress-bar-fill.needs-review {
            background: #ffc107;
        }
        .bill-upload-item .progress-bar-fill.skipped {
            background: #adb5bd;
        }
        .bill-upload-item .progress-bar-fill.pending {
            background: #adb5bd;
            animation: pulse-pending 1.5s ease-in-out infinite;
        }
        @keyframes pulse-pending {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .bill-upload-item .progress-text {
            font-size: 0.75rem;
            color: #666;
            min-width: 90px;
            text-align: right;
        }
        .bill-upload-item .progress-text.complete {
            color: #1e5a99;
            font-weight: 600;
        }
        .bill-upload-item .progress-text.ok {
            color: #28a745;
        }
        .bill-upload-item .progress-text.needs-review {
            color: #ffc107;
        }
        .bill-upload-item .progress-text.skipped {
            color: #6c757d;
            font-style: italic;
        }
        
        /* Status label styles */
        .bills-status-processing {
            color: #2d7bb8;
            font-weight: 500;
        }
        .bills-status-processing::before {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #2d7bb8;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 4px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .bills-status-needs_review {
            color: #856404;
            font-weight: 600;
            background-color: #fff3cd;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #ffc107;
            font-size: 0.85em;
        }
        .bills-status-approved {
            color: #28a745;
            font-weight: 500;
        }
        .bills-status-error {
            color: #dc3545;
            font-weight: 500;
        }
        
        /* Multi-meter summary card styles */
        .bills-summary-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #1e5a99;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }
        .bills-summary-card h4 {
            margin: 0 0 1rem 0;
            color: #1e5a99;
            font-size: 1.1rem;
        }
        .bills-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }
        @media (max-width: 500px) {
            .bills-summary-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            .bills-summary-stat {
                padding: 0.5rem;
            }
            .bills-summary-stat .stat-value {
                font-size: 1.1rem;
            }
            .bills-summary-stat .stat-label {
                font-size: 0.65rem;
            }
        }
        @media (max-width: 280px) {
            .bills-summary-grid {
                grid-template-columns: 1fr;
            }
        }
        .bills-summary-stat {
            background: #fff;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            min-width: 0;
            box-sizing: border-box;
        }
        .bills-summary-stat .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1e5a99;
            display: block;
            min-width: 0;
            overflow: visible;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .bills-summary-stat .stat-label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            margin-top: 0.25rem;
            white-space: normal;
        }
        
        /* ========== FACILITY STATS GRID - MOBILE RESPONSIVE ========== */
        .facility-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 0.5rem;
            text-align: center;
        }
        .facility-stats-grid > div {
            min-width: 0;
            box-sizing: border-box;
            overflow: visible;
        }
        .facility-stats-grid .stat-value {
            font-size: 1rem;
            font-weight: 700;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: visible;
        }
        .facility-stats-grid .stat-label {
            font-size: 0.6rem;
            opacity: 0.9;
            text-transform: uppercase;
            white-space: normal;
        }
        @media (max-width: 500px) {
            .facility-stats-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 0.4rem;
            }
            .facility-stats-grid .stat-value {
                font-size: 0.95rem;
            }
        }
        @media (max-width: 280px) {
            .facility-stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* ========== EMBEDDED METER STATS ROW - MOBILE RESPONSIVE ========== */
        .embedded-meter-stats-row {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr)) 24px;
            align-items: center;
            gap: 0.25rem;
            text-align: center;
        }
        .embedded-meter-stats-row > div {
            min-width: 0;
            box-sizing: border-box;
            overflow: visible;
        }
        .embedded-meter-stats-row .stat-value {
            font-size: 0.95rem;
            font-weight: 700;
            color: #333;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: visible;
        }
        .embedded-meter-stats-row .stat-label {
            font-size: 0.6rem;
            color: #666;
            text-transform: uppercase;
            white-space: normal;
        }
        .embedded-meter-stats-row .meter-expand-icon {
            grid-column: -1;
            grid-row: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @media (max-width: 500px) {
            .embedded-meter-stats-row {
                grid-template-columns: repeat(2, minmax(0, 1fr)) 24px;
                grid-template-rows: auto auto;
                gap: 0.3rem;
            }
            .embedded-meter-stats-row .stat-value {
                font-size: 0.85rem;
            }
            .embedded-meter-stats-row .meter-expand-icon {
                grid-row: 1 / 3;
            }
        }
        @media (max-width: 280px) {
            .embedded-meter-stats-row {
                grid-template-columns: 1fr 24px;
                grid-template-rows: repeat(4, auto);
            }
            .embedded-meter-stats-row .meter-expand-icon {
                grid-row: 1 / 5;
            }
        }
        
        /* ========== EMBEDDED BILL ROW - 4-CELL GRID (no ellipsis on numbers) ========== */
        .embedded-bill-row {
            display: grid;
            grid-template-columns: minmax(70px, 1.2fr) repeat(3, minmax(0, 1fr)) 20px;
            align-items: center;
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid #eee;
            background: white;
            cursor: pointer;
            font-size: 0.85rem;
            gap: 0.25rem;
        }
        .embedded-bill-row:hover {
            background: #f8f9fa;
        }
        .embedded-bill-row > span {
            min-width: 0;
            box-sizing: border-box;
        }
        .embedded-bill-row .period-col {
            font-weight: 500;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .embedded-bill-row .kwh-col {
            text-align: center;
            color: #555;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: visible;
        }
        .embedded-bill-row .cost-col {
            text-align: center;
            color: #333;
            font-weight: 500;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: visible;
        }
        .embedded-bill-row .rate-col {
            text-align: center;
            color: #666;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: visible;
        }
        @media (max-width: 500px) {
            .embedded-bill-row {
                grid-template-columns: minmax(60px, 1fr) repeat(3, minmax(0, 1fr)) 18px;
                font-size: 0.7rem;
                padding: 0.5rem 0.4rem;
                gap: 0.15rem;
            }
        }
        
        /* Expand/Collapse all bills toggle button */
        .expand-all-bills-toggle:hover {
            background: rgba(21, 101, 192, 0.15) !important;
            border-color: rgba(21, 101, 192, 0.5) !important;
        }
        .expand-all-bills-toggle:active {
            background: rgba(21, 101, 192, 0.25) !important;
        }
        
        /* ========== EMBEDDED BILL FILE ROW - 3-COLUMN GRID LAYOUT ========== */
        .embedded-bill-file-row {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            margin-bottom: 0.5rem;
            align-items: center;
        }
        .embedded-bill-file-row .file-info-column {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            min-width: 0;
        }
        .embedded-bill-file-row .file-row-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .embedded-bill-file-row .embedded-bill-checkbox {
            flex-shrink: 0;
        }
        .embedded-bill-file-row .file-name {
            font-weight: 500;
            color: #333;
            font-size: 0.85rem;
            word-break: break-word;
            line-height: 1.3;
            flex: 1;
        }
        .embedded-bill-file-row .file-progress-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .embedded-bill-file-row .progress-track {
            flex: 1;
            min-width: 60px;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }
        .embedded-bill-file-row .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .embedded-bill-file-row .progress-fill.waiting,
        .embedded-bill-file-row .progress-fill.processing {
            width: 50%;
            background: linear-gradient(90deg, #1e5a99, #2d7bb8);
            animation: progress-pulse 1.5s ease-in-out infinite;
        }
        .embedded-bill-file-row .progress-fill.complete {
            width: 100%;
            background: #1e5a99;
        }
        .embedded-bill-file-row .progress-fill.ok {
            width: 100%;
            background: #28a745;
        }
        .embedded-bill-file-row .progress-fill.needs-review {
            width: 100%;
            background: #ffc107;
        }
        .embedded-bill-file-row .progress-fill.skipped {
            width: 100%;
            background: #adb5bd;
        }
        .embedded-bill-file-row .progress-fill.error {
            width: 100%;
            background: #dc3545;
        }
        @keyframes progress-pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .embedded-bill-file-row .progress-text {
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }
        .embedded-bill-file-row .progress-text.waiting { color: #6c757d; }
        .embedded-bill-file-row .progress-text.processing { color: #1e5a99; }
        .embedded-bill-file-row .progress-text.complete { color: #1e5a99; font-weight: 600; }
        .embedded-bill-file-row .progress-text.ok { color: #28a745; }
        .embedded-bill-file-row .progress-text.skipped { color: #6c757d; font-style: italic; }
        .embedded-bill-file-row .progress-text.needs-review { color: #ffc107; }
        .embedded-bill-file-row .progress-text.error { color: #dc3545; }
        .embedded-bill-file-row .embedded-file-view-btn,
        .embedded-bill-file-row .embedded-file-delete-btn {
            padding: 0.35rem 0.6rem;
            font-size: 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            white-space: nowrap;
        }
        .embedded-bill-file-row .embedded-file-view-btn {
            background: #1976d2;
            color: white;
        }
        .embedded-bill-file-row .embedded-file-delete-btn {
            background: #dc3545;
            color: white;
        }
        
        /* Per-meter card styles */
        .bills-meter-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 10px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        .bills-meter-card-header {
            background: #f0f4f8;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
        }
        .bills-meter-card-header:hover {
            background: #e8eef4;
        }
        .bills-meter-card-header .meter-title {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }
        .bills-meter-card-header .meter-toggle {
            font-size: 0.8rem;
            color: #666;
            transition: transform 0.2s;
        }
        .bills-meter-card-header.collapsed .meter-toggle {
            transform: rotate(-90deg);
        }
        .bills-meter-summary {
            background: #fafbfc;
            padding: 0.75rem 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem;
            border-bottom: 1px solid #eee;
        }
        .bills-meter-summary .meter-stat {
            text-align: center;
        }
        .bills-meter-summary .meter-stat .value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }
        .bills-meter-summary .meter-stat .label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
        }
        .bills-meter-months {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .bills-meter-months.expanded {
            max-height: 2000px;
        }
        .bills-month-row {
            padding: 0.6rem 1rem;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 0.5rem;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .bills-month-row:hover {
            background: #f8f9fa;
        }
        .bills-month-row:last-child {
            border-bottom: none;
        }
        .bills-month-row .month-label {
            font-weight: 500;
            color: #333;
        }
        .bills-month-row .month-value {
            color: #555;
            font-size: 0.9rem;
        }
        .bills-month-row .expand-icon {
            color: #888;
            font-size: 0.8rem;
            transition: transform 0.2s ease;
            display: inline-block;
        }
        .bills-month-row.expanded .expand-icon {
            transform: rotate(90deg);
        }
        
        /* Bill detail expansion */
        .bills-month-detail {
            background: #f8f9fa;
            padding: 0;
            border-top: 1px solid #eee;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.25s ease-out, padding 0.25s ease-out;
        }
        .bills-month-detail.show {
            max-height: 500px;
            padding: 1rem;
        }
        .bills-tou-breakdown {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-top: 0.75rem;
        }
        .bills-tou-item {
            background: #fff;
            border-radius: 6px;
            padding: 0.6rem;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        /* Legacy fixed period classes */
        .bills-tou-item.on-peak { border-left: 3px solid #dc3545; }
        .bills-tou-item.mid-peak { border-left: 3px solid #ffc107; }
        .bills-tou-item.off-peak { border-left: 3px solid #28a745; }
        .bills-tou-item.super-off-peak { border-left: 3px solid #9b59b6; }
        /* Generic TOU color coding based on relative rates */
        .bills-tou-item.tou-highest { border-left: 3px solid #dc3545; background: #fff5f5; }  /* Red - highest rate */
        .bills-tou-item.tou-high { border-left: 3px solid #ff8c42; background: #fffaf5; }     /* Orange - high rate */
        .bills-tou-item.tou-mid { border-left: 3px solid #ffc107; background: #fffef5; }      /* Yellow - mid rate */
        .bills-tou-item.tou-low { border-left: 3px solid #28a745; background: #f5fff9; }      /* Green - low rate */
        .bills-tou-item.tou-neutral { border-left: 3px solid #6c757d; background: #f8f9fa; }  /* Gray - neutral/unknown */
        .bills-tou-item .period-name {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
        }
        .bills-tou-item .period-kwh {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
        }
        .bills-tou-item .period-rate {
            font-size: 0.75rem;
            color: #888;
        }
        
        /* Clickable needs_review badge */
        .bills-status-needs_review.clickable {
            cursor: pointer;
            text-decoration: underline;
        }
        .bills-status-needs_review.clickable:hover {
            color: #e5a800;
        }
        
        /* Embedded bills section styles */
        .embedded-bills-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .embedded-bills-upload {
            background: white;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        .embedded-bills-upload:hover {
            border-color: #2196f3;
            background: #f0f7ff;
        }
        .embedded-bills-files {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .embedded-bills-data {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* Embedded bills file progress bar styles */
        .file-progress-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            min-width: 0;
        }
        .file-progress-bar .progress-track {
            flex: 1;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            min-width: 60px;
            max-width: 120px;
        }
        .file-progress-bar .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .file-progress-bar .progress-fill.complete {
            background: #1e5a99;
            width: 100%;
        }
        .file-progress-bar .progress-fill.ok {
            background: #28a745;
            width: 100%;
        }
        .file-progress-bar .progress-fill.waiting {
            background: #6c757d;
            width: 30%;
            animation: progress-pulse 1.5s ease-in-out infinite;
        }
        .file-progress-bar .progress-fill.processing {
            background: #2196f3;
            width: 60%;
            animation: progress-animate 1.5s ease-in-out infinite;
        }
        .file-progress-bar .progress-fill.error {
            background: #dc3545;
            width: 100%;
        }
        .file-progress-bar .progress-fill.needs-review {
            background: #ffc107;
            width: 100%;
        }
        .file-progress-bar .progress-fill.skipped {
            background: #adb5bd;
            width: 100%;
        }
        .file-progress-bar .progress-text {
            font-size: 0.8rem;
            white-space: nowrap;
            min-width: 80px;
        }
        .file-progress-bar .progress-text.complete { color: #1e5a99; font-weight: 600; }
        .file-progress-bar .progress-text.ok { color: #28a745; }
        .file-progress-bar .progress-text.skipped { color: #6c757d; font-style: italic; }
        .file-progress-bar .progress-text.waiting { color: #6c757d; }
        .file-progress-bar .progress-text.processing { color: #2196f3; }
        .file-progress-bar .progress-text.error { color: #dc3545; }
        .file-progress-bar .progress-text.needs-review { color: #ffc107; }
        
        @keyframes progress-pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        @keyframes progress-animate {
            0% { width: 40%; }
            50% { width: 70%; }
            100% { width: 40%; }
        }
        
        /* Field review modal */
        .field-review-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.6);
            z-index: 100001;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .field-review-modal.show {
            display: flex;
        }
        .field-review-content {
            background: #fff;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .field-review-header {
            background: linear-gradient(135deg, #ffc107 0%, #e5a800 100%);
            color: #333;
            padding: 1rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .field-review-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }
        .field-review-close {
            background: none;
            border: none;
            color: #333;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
        }
        .field-review-close:hover {
            opacity: 1;
        }
        .field-review-body {
            padding: 1.25rem;
        }
        .field-review-field {
            margin-bottom: 1rem;
        }
        .field-review-field label {
            display: block;
            font-weight: 500;
            color: #333;
            margin-bottom: 0.35rem;
            font-size: 0.9rem;
        }
        .field-review-field input {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        .field-review-field input:focus {
            border-color: #1e5a99;
            outline: none;
            box-shadow: 0 0 0 2px rgba(30,90,153,0.15);
        }
        .field-review-footer {
            padding: 1rem 1.25rem;
            background: #f8f9fa;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        .field-review-footer .button {
            margin: 0;
            padding: 0.6rem 1.25rem;
        }
        
        @media (max-width: 600px) {
            .bills-month-row {
                grid-template-columns: 1fr 1fr;
                gap: 0.25rem;
            }
            .bills-month-row .expand-icon {
                display: none;
            }
            .bills-tou-breakdown {
                grid-template-columns: 1fr;
            }
        }
        
        /* Clickable file rows */
        .bills-file-item {
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .bills-file-item:hover {
            background-color: #f0f4f8;
            border-color: #2d7bb8;
        }
        
        /* Bill Review Modal */
        .bill-review-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.6);
            z-index: 99999;
            justify-content: center;
            align-items: flex-start;
            overflow-y: auto;
            padding: 2rem 1rem;
        }
        .bill-review-modal.show {
            display: flex;
        }
        .bill-review-content {
            background: #fff;
            border-radius: 12px;
            width: 100%;
            max-width: 700px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .bill-review-header {
            background: linear-gradient(135deg, #1e5a99 0%, #2d7bb8 100%);
            color: #fff;
            padding: 1rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .bill-review-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }
        .bill-review-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.8;
        }
        .bill-review-close:hover {
            opacity: 1;
        }
        .bill-review-body {
            padding: 1.25rem;
            max-height: 70vh;
            overflow-y: auto;
        }
        .bill-review-file-info {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        .bill-review-file-info strong {
            color: #333;
        }
        .bill-review-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        .bill-review-actions {
            flex-shrink: 0;
        }
        .bill-view-pdf-btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            white-space: nowrap;
            text-decoration: none;
        }
        
        /* Bill PDF Modal */
        .bill-pdf-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.8);
            z-index: 100000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .bill-pdf-modal.show {
            display: flex;
        }
        .bill-pdf-modal-content {
            background: #fff;
            border-radius: 12px;
            width: 100%;
            max-width: 900px;
            height: 90vh;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            overflow: hidden;
        }
        .bill-pdf-modal-header {
            background: linear-gradient(135deg, #1e5a99 0%, #2d7bb8 100%);
            color: #fff;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .bill-pdf-modal-header h3 {
            margin: 0;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc(100% - 40px);
        }
        .bill-pdf-modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.8;
            padding: 0;
            line-height: 1;
        }
        .bill-pdf-modal-close:hover {
            opacity: 1;
        }
        .bill-pdf-modal-body {
            flex: 1;
            min-height: 0;
            background: #333;
            overflow: auto;
        }
        .pdf-canvas-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: auto;
            padding: 1rem;
        }
        .pdf-loading {
            color: #fff;
            font-size: 1.2rem;
            padding: 2rem;
            text-align: center;
        }
        .pdf-pages {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        .pdf-pages canvas {
            max-width: 100%;
            height: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            background: #fff;
        }
        .bill-pdf-modal-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            background: #444;
            color: #fff;
        }
        .bill-pdf-modal-nav span {
            font-size: 0.9rem;
        }
        .bill-pdf-modal-footer {
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
            flex-wrap: wrap;
        }
        .bill-pdf-modal-footer .button {
            margin: 0;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        @media (max-width: 600px) {
            .bill-pdf-modal-content {
                height: 95vh;
                max-height: 95vh;
                border-radius: 8px;
            }
            .bill-pdf-modal-footer {
                justify-content: center;
            }
        }
        .bill-review-section {
            margin-bottom: 1.25rem;
        }
        .bill-review-section h4 {
            margin: 0 0 0.5rem 0;
            color: #1e5a99;
            font-size: 1rem;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 0.5rem;
        }
        .bill-meter-card {
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        .bill-meter-card h5 {
            margin: 0 0 0.75rem 0;
            color: #333;
            font-size: 0.95rem;
        }
        .bill-meter-reads {
            max-height: 200px;
            overflow-y: auto;
        }
        .bill-meter-reads table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .bill-meter-reads th,
        .bill-meter-reads td {
            padding: 0.4rem 0.5rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .bill-meter-reads th {
            background: #f0f0f0;
            font-weight: 600;
        }
        .bill-review-editable input {
            width: 100%;
            padding: 0.3rem 0.5rem;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 0.85rem;
        }
        .bill-review-footer {
            background: #f0f0f0;
            padding: 1rem 1.25rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .bill-review-footer .button {
            margin: 0;
        }
        .bill-review-footer .button.approve-btn {
            background: #28a745;
        }
        .bill-review-footer .button.save-btn {
            background: #ffc107;
            color: #333;
        }
        .bill-review-footer .button.edit-btn {
            background: #6c757d;
        }
        .bill-review-footer .button.back-btn {
            background: #6c757d;
        }
        
        /* Missing Fields Alert Panel */
        .bill-missing-fields {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-left: 4px solid #e0a800;
            border-radius: 6px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
        }
        .bill-missing-fields.error {
            background: #f8d7da;
            border-color: #dc3545;
            border-left-color: #c82333;
        }
        .bill-missing-fields h5 {
            margin: 0 0 0.5rem 0;
            color: #856404;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .bill-missing-fields.error h5 {
            color: #721c24;
        }
        .bill-missing-fields ul {
            margin: 0;
            padding-left: 1.5rem;
            font-size: 0.85rem;
            color: #664d03;
        }
        .bill-missing-fields.error ul {
            color: #721c24;
        }
        
        /* Missing Fields List (new structured format) */
        .missing-fields-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .missing-field-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .missing-field-info {
            flex: 1;
            min-width: 150px;
        }
        .missing-field-label {
            font-weight: 600;
            color: #856404;
            font-size: 0.9rem;
        }
        .bill-missing-fields.error .missing-field-label {
            color: #721c24;
        }
        .missing-field-reason {
            display: block;
            font-size: 0.75rem;
            color: #856404;
            opacity: 0.85;
            margin-top: 0.1rem;
        }
        .bill-missing-fields.error .missing-field-reason {
            color: #721c24;
        }
        .missing-field-input {
            flex: 2;
            min-width: 200px;
        }
        .missing-field-input input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 2px solid #ffc107;
            border-radius: 4px;
            font-size: 0.9rem;
            background: #fff;
            transition: border-color 0.2s;
        }
        .bill-missing-fields.error .missing-field-input input {
            border-color: #dc3545;
        }
        .missing-field-input input:focus {
            outline: none;
            border-color: #1e5a99;
            box-shadow: 0 0 0 3px rgba(30, 90, 153, 0.1);
        }
        .missing-field-input input:not(:placeholder-shown) {
            border-color: #28a745;
        }
        
        /* Bill-Level Fields Section */
        .bill-level-fields {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .bill-level-fields h5 {
            margin: 0 0 0.75rem 0;
            color: #333;
            font-size: 0.95rem;
        }
        .bill-field-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        .bill-field {
            flex: 1;
            min-width: 200px;
        }
        .bill-field label {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
        .bill-field input {
            width: 100%;
            padding: 0.4rem 0.6rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .bill-field input:disabled {
            background: #e9ecef;
            color: #495057;
        }
        .bill-field input.field-missing {
            border: 2px solid #dc3545 !important;
            background-color: #fff5f5;
        }
        
        /* Enhanced Meter Card */
        .bill-meter-card {
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        .bill-meter-card h5 {
            margin: 0 0 0.75rem 0;
            color: #333;
            font-size: 0.95rem;
        }
        .bill-meter-header-fields {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }
        .bill-meter-header-fields .bill-field {
            flex: 1;
            min-width: 150px;
        }
        
        /* Read Status Indicators */
        .read-status-ok {
            color: #28a745;
            font-weight: bold;
        }
        .read-status-warning {
            color: #ffc107;
            font-weight: bold;
        }
        .bill-meter-reads td.field-missing {
            background-color: #fff5f5;
            border: 1px solid #dc3545 !important;
        }
        .bill-meter-reads td.field-missing input {
            border-color: #dc3545;
            background-color: #fff5f5;
        }
        
        /* Screenshot Upload Area */
        .bill-screenshot-section {
            background: #f0f4f8;
            border: 1px dashed #b0c4de;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .bill-screenshot-section h5 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            color: #555;
        }
        .bill-screenshot-tip {
            font-size: 0.8rem;
            color: #666;
            font-style: italic;
            margin: 0 0 0.75rem 0;
        }
        .bill-screenshot-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 0.75rem;
        }
        .bill-screenshot-item {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
            background: #fff;
        }
        .bill-screenshot-thumb {
            width: 100px;
            height: 80px;
            object-fit: cover;
            cursor: pointer;
            display: block;
        }
        .bill-pdf-thumb {
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #666;
            border-bottom: 1px solid #eee;
        }
        .bill-screenshot-info {
            font-size: 0.7rem;
            padding: 4px 6px;
            background: #f8f9fa;
            color: #666;
            text-align: center;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .bill-screenshot-delete {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .bill-screenshot-delete:hover {
            background: #dc3545;
        }
        .bill-screenshot-error {
            color: #dc3545;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            padding: 8px 12px;
            background: #fff5f5;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
        }
        .bill-screenshot-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 0.75rem;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .bill-screenshot-btn {
            background: #6c757d;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .bill-screenshot-btn:hover {
            background: #5a6268;
        }
        
        /* Processing spinner for status */
        .bills-status-processing {
            color: #2d7bb8;
            font-weight: 500;
        }
        .bills-status-processing::before {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #2d7bb8;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 4px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Status pills - gray pending */
        .bills-status-pending {
            color: #6c757d;
            font-weight: 500;
        }
        
        .home-recent-section {
            position: relative;
            overflow: hidden;
            background: rgba(255,255,255,0.92);
            border-radius: 16px;
            padding: 1.25rem;
            max-width: 600px;
            margin: 0 auto;
            /* Intentional “brand frame” via gradient border (not a random stripe) */
            border: 1px solid transparent;
            background:
                linear-gradient(rgba(255,255,255,0.92), rgba(255,255,255,0.92)) padding-box,
                linear-gradient(90deg, rgba(111,208,255,0.95), rgba(45,123,184,0.95), rgba(30,90,153,0.95)) border-box;
            box-shadow: 0 18px 55px rgba(0,0,0,0.22);
        }
        
        .home-recent-header {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .home-recent-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .home-recent-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: rgba(255,255,255,0.75);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
            border: 1px solid rgba(30,90,153,0.10);
        }
        
        .home-recent-item:hover {
            background: rgba(235, 247, 255, 0.92);
        }
        
        .home-recent-info {
            flex: 1;
            min-width: 0;
        }
        
        .home-recent-name {
            font-weight: 600;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .home-recent-meta {
            font-size: 0.8rem;
            color: #666;
        }
        
        .home-recent-open {
            background: linear-gradient(135deg, #2d7bb8 0%, #1e5a99 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 0.4rem 0.75rem;
            font-size: 0.85rem;
            cursor: pointer;
            flex-shrink: 0;
            margin-left: 0.5rem;
            box-shadow: 0 10px 20px rgba(30,90,153,0.22);
        }
        
        .home-recent-empty {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 1rem;
        }
        
        /* ==================== PROJECTS PAGE STYLES ==================== */
        .projects-view {
            padding: 1rem;
            max-width: 900px;
            margin: 0 auto;
        }
        
        .projects-view-header {
            margin-bottom: 1rem;
        }
        
        .projects-view-header h2 {
            margin: 0 0 1rem 0;
            font-size: 1.4rem;
        }
        
        .projects-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .projects-search {
            flex: 1;
            min-width: 200px;
            padding: 0.6rem 0.75rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .projects-sort-select {
            padding: 0.6rem 0.75rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9rem;
            background: #fff;
        }
        
        .projects-sort-dir-btn {
            padding: 0.6rem 0.75rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #f5f5f5;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .projects-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: calc(100dvh - 200px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 2rem;
        }
        
        /* Mobile: Allow more scroll space */
        @media (max-width: 600px) {
            .projects-list {
                max-height: calc(100dvh - 180px);
            }
            .projects-view {
                height: 100dvh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
        
        .project-row {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }
        
        .project-row:hover {
            border-color: #2d7bb8;
            background: #f0f7ff;
        }
        
        .project-row-info {
            flex: 1;
            min-width: 0;
        }
        
        .project-row-name {
            font-weight: 600;
            font-size: 1rem;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .project-row-subline {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.15rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .project-row-open-btn {
            background: linear-gradient(135deg, #1e5a99 0%, #2d7bb8 100%);
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
            flex-shrink: 0;
            margin-left: 0.75rem;
        }
        
        .projects-empty {
            text-align: center;
            color: #666;
            padding: 2rem;
            font-style: italic;
        }
        
        .projects-select-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: #333;
            color: white;
            padding: 0.5rem calc(env(safe-area-inset-right, 0px) + 8px) calc(0.5rem + env(safe-area-inset-bottom, 0px)) calc(env(safe-area-inset-left, 0px) + 8px);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.3rem;
            z-index: 1000;
            flex-wrap: nowrap;
            max-height: 50px;
            box-sizing: border-box;
        }
        .projects-select-bar.hidden { display: none; }
        .projects-select-bar .button {
            min-width: 0;
            padding: 0.3rem 0.5rem;
            font-size: 0.75rem;
            white-space: nowrap;
            flex-shrink: 1;
        }
        .projects-select-bar .select-count,
        .projects-select-bar #projectsSelectedCount,
        .projects-select-bar #deletedProjectsSelectedCount {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.75rem;
            white-space: nowrap;
            flex-shrink: 0;
            padding: 0 0.25rem;
        }
        
        /* When select bar is visible, add bottom padding so last items aren't hidden */
        /* 50px toolbar + 16px buffer + iOS safe area */
        .projects-list.has-select-bar {
            padding-bottom: calc(66px + env(safe-area-inset-bottom, 0px));
        }
        
        .project-row-checkbox { 
            width: 20px; 
            height: 20px; 
            margin-right: 0.75rem;
            flex-shrink: 0;
        }
        .project-row.selectable { cursor: pointer; }
        .project-row.selected { background-color: #e3f2fd; border-color: #2196f3; }
        
        /* Deleted Projects View */
        .deleted-project-row {
            border-left: 3px solid #dc3545;
        }
        .deleted-project-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
            margin-left: 0.75rem;
        }
        .days-remaining {
            font-weight: 500;
        }
        .days-remaining.urgent {
            color: #dc3545;
            font-weight: 600;
        }
        @media (max-width: 600px) {
            .deleted-project-row {
                flex-wrap: wrap;
            }
            .deleted-project-actions {
                width: 100%;
                margin-left: 0;
                margin-top: 0.5rem;
                justify-content: flex-end;
            }
        }
        
        /* ==================== CURRENT PROJECT VIEW ==================== */
        /* Responsive centered card grid for Current Project view */
        .cards-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
        
        @media (max-width: 600px) {
            .cards-container {
                grid-template-columns: 1fr;
                padding: 0.5rem;
            }
        }
        
        .bottom-buttons-row {
            max-width: 1400px;
            margin: 1rem auto;
            padding: 0 1rem;
            text-align: center;
        }
        
        .print-view-btn {
            background: #5cb85c;
            color: #fff;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        @media (max-width: 600px) {
            .home-title {
                font-size: 1.5rem;
            }
            .home-cta-btn {
                padding: 1rem 1.5rem;
                font-size: 1.1rem;
            }
            .projects-controls {
                flex-direction: column;
            }
            .projects-search {
                min-width: 100%;
            }
        }
        
        /* ==================== GLOBAL TOAST NOTIFICATIONS ==================== */
        .global-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 200001;
            font-size: 0.95rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 90%;
            text-align: center;
        }
        .global-toast.show { opacity: 1; }
        .global-toast.info { background: #333; color: #fff; }
        .global-toast.success { background: #28a745; color: #fff; }
        .global-toast.error { background: #dc3545; color: #fff; }
        .global-toast.warning { background: #ffc107; color: #333; }
        
        /* ==================== GLOBAL CONFIRM MODAL ==================== */
        .global-confirm-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.6);
            z-index: 200000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .global-confirm-modal.hidden { display: none; }
        .global-confirm-modal-content {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .global-confirm-modal-content h3 {
            margin-top: 0;
            margin-bottom: 0.75rem;
        }
        .global-confirm-modal-content p {
            margin: 0 0 1.25rem 0;
            color: #555;
            line-height: 1.5;
        }
        .global-confirm-modal-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        .global-confirm-modal-buttons button {
            min-width: 80px;
            padding: 0.65rem 1.25rem;
            font-size: 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        .global-confirm-btn-cancel {
            background: #e0e0e0;
            color: #333;
            border: none;
        }
        .global-confirm-btn-cancel:hover { background: #d0d0d0; }
        .global-confirm-btn-confirm {
            background: #1e5a99;
            color: #fff;
            border: none;
        }
        .global-confirm-btn-confirm:hover { background: #174a80; }
        .global-confirm-btn-confirm.danger {
            background: #d32f2f;
        }
        .global-confirm-btn-confirm.danger:hover { background: #b71c1c; }
    </style>
</head>
<body>
    <!-- Leader status indicator for debugging multi-tab behavior -->
    <div id="tabLeaderIndicator" style="display:none; position:fixed; bottom:5px; left:5px; font-size:10px; color:#666; z-index:9999;"></div>
    
    <!-- Global Confirm Modal - replaces native confirm() -->
    <div id="globalConfirmModal" class="global-confirm-modal hidden">
        <div class="global-confirm-modal-content">
            <h3 id="globalConfirmTitle">Confirm</h3>
            <p id="globalConfirmMessage">Are you sure?</p>
            <div class="global-confirm-modal-buttons">
                <button id="globalConfirmCancelBtn" class="global-confirm-btn-cancel">Cancel</button>
                <button id="globalConfirmOkBtn" class="global-confirm-btn-confirm">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Hamburger Menu Button -->
    <button id="hamburgerBtn" class="hamburger-btn" title="Menu">☰</button>
    
    <!-- Navigation Drawer Overlay -->
    <div id="navDrawerOverlay" class="nav-drawer-overlay"></div>
    
    <!-- Navigation Drawer -->
    <nav id="navDrawer" class="nav-drawer">
        <div class="nav-drawer-header">
            <h3>Menu</h3>
            <button id="navDrawerCloseBtn" class="nav-drawer-close">&times;</button>
        </div>
        <ul class="nav-drawer-items">
            <li><a href="/home" data-nav="home"><span class="nav-icon">🏠</span> Home</a></li>
            <li><a href="/projects" data-nav="projects"><span class="nav-icon">📁</span> Projects</a></li>
            <li><a href="/deleted-projects" data-nav="deletedProjects"><span class="nav-icon">🗑️</span> Recently Deleted</a></li>
            <li><a href="/customer-info" data-nav="customerInfo"><span class="nav-icon">👤</span> Customer Info</a></li>
            <li><a href="/current-project" data-nav="currentProject"><span class="nav-icon">📋</span> Current Project</a></li>
            <!-- Utility Bills menu item removed - now embedded in Current Project view -->
            <!-- <li id="billsNavItem" style="display:none;"><a href="#utility-bills" data-nav="utilityBills"><span class="nav-icon">📄</span> Utility Bills</a></li> -->
        </ul>
    </nav>
    
    <!-- ==================== HOME VIEW ==================== -->
    <div id="homeView" class="app-view home-view">
        <div class="home-hero">
            <img src="static/carlisle_logo_full.png" alt="Carlisle Energy Solutions" class="home-logo">
            <h1 class="home-title">Refrigeration Data Collection</h1>
            <p class="home-subtitle">SiteWalk</p>
            
            <div class="home-cta-buttons">
                <button id="startNewProjectBtn" class="home-cta-btn primary">
                    <span>➕</span> Start New Project
                </button>
                <button id="pastSitewalksBtn" class="home-cta-btn secondary">
                    <span>📁</span> Past Sitewalks
                </button>
                <button id="homeImportCsvBtn" class="home-cta-btn tertiary">
                    <span>📥</span> Import Project from CSV
                </button>
                <input type="file" id="homeImportCsvFile" accept=".csv" style="display: none;">
            </div>
            
            <div class="home-recent-section">
                <div class="home-recent-header">
                    <span>🕐</span> Recently Opened
                </div>
                <div id="homeRecentList" class="home-recent-list">
                    <div class="home-recent-empty">Loading recent projects...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ==================== PROJECTS VIEW ==================== -->
    <div id="projectsView" class="app-view projects-view">
        <div class="projects-view-header">
            <h2>📁 Projects</h2>
            <div class="projects-controls">
                <input type="text" id="projectsSearchInput" class="projects-search" placeholder="Search projects...">
                <select id="projectsSortSelect" class="projects-sort-select">
                    <option value="dateLastModified">Last Modified</option>
                    <option value="dateOfSiteVisit">Site Visit Date</option>
                    <option value="name">Project Name</option>
                    <option value="utilityCompany">Utility Company</option>
                </select>
                <button id="projectsSortDirBtn" class="projects-sort-dir-btn" title="Toggle sort direction">↓</button>
                <button id="importCsvBtn" class="button" style="margin-left: 0.5rem; padding: 0.4rem 0.8rem; font-size: 0.9rem;">📥 Import CSV</button>
                <input type="file" id="importCsvFile" accept=".csv" style="display: none;">
                <button id="projectsSelectModeBtn" class="button" style="margin-left: 0.5rem; padding: 0.4rem 0.8rem; font-size: 0.9rem;">☑️ Select</button>
            </div>
        </div>
        <div id="projectsListContainer" class="projects-list">
            <div class="projects-empty">Loading projects...</div>
        </div>
        <div id="projectsSelectBar" class="projects-select-bar hidden">
            <button id="projectsSelectAllBtn" class="button secondary">Select All</button>
            <button id="projectsDeselectAllBtn" class="button secondary">Deselect All</button>
            <span id="projectsSelectedCount">0 selected</span>
            <button id="projectsDeleteSelectedBtn" class="button" style="background-color: #dc3545;">🗑️ Delete Selected</button>
            <button id="projectsCancelSelectBtn" class="button secondary">Cancel</button>
        </div>
    </div>
    
    <!-- ==================== DELETED PROJECTS VIEW ==================== -->
    <div id="deletedProjectsView" class="app-view projects-view">
        <div class="projects-view-header">
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <h2 style="margin: 0;">🗑️ Recently Deleted</h2>
                <button id="deletedProjectsSelectModeBtn" class="button" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">☑️ Select</button>
            </div>
            <p style="color: #666; font-size: 0.9rem; margin: 0.5rem 0 1rem 0;">
                Projects are kept for 30 days before being permanently deleted.
            </p>
        </div>
        <div id="deletedProjectsListContainer" class="projects-list">
            <div class="projects-empty">Loading deleted projects...</div>
        </div>
        <div id="deletedProjectsSelectBar" class="projects-select-bar hidden">
            <button id="deletedProjectsSelectAllBtn" class="button secondary">Select All</button>
            <button id="deletedProjectsDeselectAllBtn" class="button secondary">Deselect All</button>
            <button id="deletedProjectsInvertSelectionBtn" class="button secondary">Invert</button>
            <span id="deletedProjectsSelectedCount">0 selected</span>
            <button id="deletedProjectsBulkRestoreBtn" class="button" style="background-color: #28a745;">↩️ Restore</button>
            <button id="deletedProjectsBulkDeleteBtn" class="button" style="background-color: #dc3545;">🗑️ Delete Forever</button>
            <button id="deletedProjectsCancelSelectBtn" class="button secondary">Cancel</button>
        </div>
    </div>
    
    <!-- ==================== CUSTOMER INFO VIEW ==================== -->
    <div id="customerInfoView" class="app-view">
        <div class="customer-info-page" style="padding: 1rem;">
            <h2>👤 Customer Information</h2>
            <p style="color: #666; margin-bottom: 1rem;">Edit customer and site details for the current project.</p>
            <div id="customerInfoFormWrapper">
                <!-- Customer info form will be rendered here dynamically -->
            </div>
        </div>
    </div>
    
    <!-- ==================== CURRENT PROJECT VIEW ==================== -->
    <div id="currentProjectView" class="app-view current-project-view active">
        <!-- The header, topInfoBar, siteSection, dataSection are all inside this view -->

        <header>
        <div id="headerContent" style="width:100%; text-align:center; padding-left:0.5rem; padding-right:0.5rem;">
            <h1 style="margin:0; font-size:1.6rem;">Refrigeration Data Collection</h1>
            <div id="byLine" style="font-size:0.85rem; font-style:italic; margin-top:0.25rem;">Prepared by:</div>
            <div id="logoStack" style="display:inline-block; margin-top:0.05rem;">
                <img src="static/carlisle_logo_full.png" alt="Carlisle Energy Solutions" id="headerCompanyLogo" style="height:95px; display:block;">
                <div id="dbaLicenseLine" style="font-size:0.8rem; font-style:italic; margin-top:0.1rem; text-align:center; margin-left:1.2rem;"><span style="text-decoration:none;">DBA: Carlisle Refrigeration &nbsp;&nbsp;|&nbsp;&nbsp; Lic: </span><span style="text-decoration:none;">1099492</span></div>
            </div>
            <div id="forLine" style="font-size:0.85rem; font-style:italic; margin-top:1.2rem;">for:</div>
            <div id="customerName" style="font-size:3.5rem; font-weight:600; font-style:italic; font-family:Georgia, 'Times New Roman', serif; margin-top:0.15rem;"></div>
        </div>
        </header>
    <div class="container">
        <!-- Resume Banner - shown when localStorage has in-progress work -->
        <div id="resumeBanner" class="hidden" style="margin:0.5rem 0; padding:0.75rem 1rem; background-color:#e8f4f8; border:2px solid #2d7bb8; border-radius:4px;">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.5rem;">
                <div style="flex:1; min-width:200px;">
                    <div style="font-weight:bold; color:#1e5a99; margin-bottom:0.25rem;">📋 In-Progress Work Found</div>
                    <div id="resumeText" style="font-size:0.9rem; color:#555;"></div>
                </div>
                <div style="display:flex; gap:0.5rem; flex-wrap:nowrap;">
                    <button id="resumeBtn" class="button" style="margin:0; padding:0.5rem 1rem; white-space:nowrap;">Resume</button>
                    <button id="discardBtn" class="button secondary" style="margin:0; padding:0.5rem 1rem; white-space:nowrap;">Discard</button>
                </div>
            </div>
        </div>
        
        <!-- Site Address (centered), Date of Site Visit (right) - responsive layout -->
        <div id="topInfoBar" style="display:flex; align-items:center; gap:1rem; margin:0.25rem 0 0.25rem 0; padding:0.5rem 0.75rem; background-color:#f9f9f9; border-radius:4px; justify-content:space-between; flex-wrap:wrap;">
            <div id="siteAddressDisplay" style="flex:1; text-align:center;">
                <div style="font-weight:normal; font-size:0.85rem; color:#666;">Site Address: <span id="editSiteBtn" class="hidden" style="cursor:pointer; font-size:1.1rem; opacity:0.6; transition:opacity 0.2s; margin-left:0.3rem;" title="Edit Site Info">✏️</span></div>
                <div id="siteAddressText" style="font-size:1rem; font-weight:bold; color:#333; text-align:center;"></div>
            </div>
            <div id="dateField" style="flex:0 0 auto; text-align:right;">
                <div style="font-size:0.85rem; color:#666; margin-bottom:0.2rem;">Date of Site Visit</div>
                <div id="visitDateText" style="font-size:1rem; font-weight:bold; color:#333;"></div>
            </div>
        </div>

        <!-- Site section -->
        <div id="siteSection">
            <h2>Site Details</h2>
            <form id="siteForm">
                <div class="field"><label for="site-date">Date of Site Visit</label><input type="date" id="site-date" /></div>
                
                <div class="field">
                    <label for="site-customer">Customer</label>
                    <div class="autocomplete-wrapper">
                        <div class="input-wrapper">
                            <input type="text" id="site-customer" class="capitalize suggest" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Customer" required>
                            <span class="clear-input-btn">✕</span>
                        </div>
                        <div id="site-customer-autocomplete" class="autocomplete-dropdown"></div>
                    </div>
                    <button type="button" id="useLocationBtn" style="margin-top:0.5rem; padding:0.5rem 1rem; background-color:#2d7bb8; color:white; border:none; border-radius:4px; font-size:0.9rem; cursor:pointer;" title="Show nearby businesses at your location">📍 Show Businesses Nearby</button>
                </div>
                <div class="field">
                    <label for="site-street">Street Address</label>
                    <div class="autocomplete-wrapper">
                        <div class="input-wrapper">
                            <input type="text" id="site-street" class="capitalize suggest" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Street Address">
                            <span class="clear-input-btn">✕</span>
                        </div>
                        <div id="site-street-autocomplete" class="autocomplete-dropdown"></div>
                    </div>
                </div>
                <div class="field">
                    <label for="site-city">City</label>
                    <div class="autocomplete-wrapper">
                        <div class="input-wrapper">
                            <input type="text" id="site-city" class="capitalize suggest" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="City">
                            <span class="clear-input-btn">✕</span>
                        </div>
                        <div id="site-city-autocomplete" class="autocomplete-dropdown"></div>
                    </div>
                </div>
                <div class="field"><label for="site-state">State</label>
                    <!-- Pre-populate states to avoid issues where JavaScript may not execute (e.g., in some mobile previews). -->
                    <select id="site-state">
                        <!-- Make California the default by specifying selected on CA -->
                        <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option><option value="AR">AR</option><option value="CA" selected>CA</option><option value="CO">CO</option><option value="CT">CT</option><option value="DE">DE</option><option value="FL">FL</option><option value="GA">GA</option><option value="HI">HI</option><option value="ID">ID</option><option value="IL">IL</option><option value="IN">IN</option><option value="IA">IA</option><option value="KS">KS</option><option value="KY">KY</option><option value="LA">LA</option><option value="ME">ME</option><option value="MD">MD</option><option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option><option value="MS">MS</option><option value="MO">MO</option><option value="MT">MT</option><option value="NE">NE</option><option value="NV">NV</option><option value="NH">NH</option><option value="NJ">NJ</option><option value="NM">NM</option><option value="NY">NY</option><option value="NC">NC</option><option value="ND">ND</option><option value="OH">OH</option><option value="OK">OK</option><option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option><option value="SC">SC</option><option value="SD">SD</option><option value="TN">TN</option><option value="TX">TX</option><option value="UT">UT</option><option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option><option value="WV">WV</option><option value="WI">WI</option><option value="WY">WY</option>
                    </select>
                </div>
                <div class="field">
                    <label for="site-zip">ZIP</label>
                    <div class="input-wrapper">
                        <input type="text" id="site-zip" inputmode="numeric" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="ZIP" maxlength="10">
                        <span class="clear-input-btn">✕</span>
                    </div>
                </div>
                <div class="field">
                    <label for="site-contact">Contact</label>
                    <div class="input-wrapper">
                        <input type="text" id="site-contact" class="capitalize suggest" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Contact Name">
                        <span class="clear-input-btn">✕</span>
                    </div>
                </div>
                <div class="field">
                    <label for="site-phone">Phone</label>
                    <div class="input-wrapper">
                        <input type="tel" id="site-phone" class="suggest" inputmode="tel" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Phone Number">
                        <span class="clear-input-btn">✕</span>
                    </div>
                </div>
                
                <div class="field">
                    <label for="site-utility">Utility Company</label>
                    <select id="site-utility">
                        <option value="">—</option>
                        <option value="LADWP">LADWP</option>
                        <option value="Vernon">Vernon</option>
                        <option value="SCE">SCE</option>
                        <option value="PG&E">PG&E</option>
                        <option value="SDG&E">SDG&E</option>
                        <option value="RPU">RPU</option>
                        <option value="Anaheim">Anaheim</option>
                        <option value="TID">TID</option>
                        <option value="Hawaii Energy">Hawaii Energy</option>
                        <option value="NV Energy">NV Energy</option>
                        <option value="Pilgrim">Pilgrim</option>
                        <option value="Azusa Light & Water">Azusa Light & Water</option>
                        <option value="Chicago">Chicago</option>
                        <option value="Eversource - Boston">Eversource - Boston</option>
                        <option value="FPL - FL">FPL - FL</option>
                        <option value="IID">IID</option>
                        <option value="MPD Electric - Carolinas">MPD Electric - Carolinas</option>
                        <option value="PSEG">PSEG</option>
                        <option value="RMP - Utah">RMP - Utah</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div id="site-utility-other-container" class="field hidden">
                    <label for="site-utility-other">Custom Utility</label>
                    <input type="text" id="site-utility-other" class="capitalize" placeholder="Enter utility company name" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false">
                </div>

                <!-- Edit Saved Projects UI (hidden by default) -->
                <div id="editSavedProjectsContainer" class="hidden" style="margin-bottom:1rem; padding:1rem; background-color:#f9f9f9; border:1px solid #ddd; border-radius:4px;">
                    <h3 style="margin-top:0; font-size:1.1rem;">Edit Saved Projects</h3>
                    <div style="margin-bottom:0.75rem; padding:0.5rem; background-color:#e8f4f8; border:1px solid #b8d4e0; border-radius:4px;">
                        <label style="cursor:pointer; font-weight:bold; font-size:0.95rem;">
                            <input type="checkbox" id="selectAllProjectsCheckbox" style="margin-right:0.5rem; cursor:pointer;">
                            Select All
                        </label>
                    </div>
                    <div id="savedProjectsChecklistContainer" style="max-height:300px; overflow-y:auto; margin-bottom:1rem;">
                        <!-- Checkboxes will be populated here -->
                    </div>
                    <div style="display:flex; gap:0.5rem; justify-content:flex-end;">
                        <button type="button" id="deleteSelectedProjectsBtn" class="button" style="background-color:#d9534f; padding:0.5rem 1rem;">🗑️ Delete Selected</button>
                        <button type="button" id="cancelEditProjectsBtn" class="button secondary" style="padding:0.5rem 1rem;">Cancel</button>
                    </div>
                </div>

                <!-- No address suggestions populated; relies on browser autocomplete -->
                <button type="button" id="proceedBtn" class="button">Proceed to Data Collection</button>
            </form>
        </div>

        <!-- Bottom-centered Save Customer Info button -->
        <div id="bottomSaveContainer" class="bottom-save-container">
            <button type="button" id="saveProjectBtn" class="button secondary">💾 Save Customer Info</button>
        </div>

        <!-- Data section (hidden until proceed) -->
        <div id="dataSection" class="hidden">
            <!-- Room/unit form (hidden until add clicked) -->
            <form id="roomForm" class="hidden">
                <div class="form-title-row">
                    <h2 id="form-title"></h2>
                    <button type="button" id="formHeaderCancelBtn" class="form-title-cancel-btn">Cancel</button>
                </div>
                <div class="form-top-buttons">
                    <button type="button" id="formTopSaveBtn" class="button">Save Unit</button>
                    <button type="button" id="formTopCancelBtn" class="button secondary">Cancel</button>
                </div>
                <div class="field"><label for="room-zone">Zone</label>
                    <select id="room-zone" name="room-zone">
                        <option value="">—</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="G">G</option>
                        <option value="H">H</option>
                        <option value="I">I</option>
                        <option value="J">J</option>
                        <option value="K">K</option>
                        <option value="L">L</option>
                        <option value="M">M</option>
                        <option value="N">N</option>
                        <option value="O">O</option>
                        <option value="P">P</option>
                        <option value="Q">Q</option>
                        <option value="R">R</option>
                        <option value="S">S</option>
                        <option value="T">T</option>
                        <option value="U">U</option>
                        <option value="V">V</option>
                        <option value="W">W</option>
                        <option value="X">X</option>
                        <option value="Y">Y</option>
                        <option value="Z">Z</option>
                        <option value="custom">Other...</option>
                    </select>
                </div>
                <div class="field hidden" id="custom-zone-field"><label for="room-zoneCustom">Custom Zone</label><input type="text" id="room-zoneCustom" name="room-zoneCustom" class="capitalize" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                <div class="field"><label for="room-name">Room Name</label><input type="text" id="room-name" name="room-name" class="capitalize suggest" list="room-name-options" required autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                <div class="field"><label for="room-mfg">Manufacturer</label>
                    <select id="room-mfg" name="room-mfg">
                        <option value="">—</option>
                    </select>
                </div>
                <div class="field hidden" id="custom-mfg-field"><label for="room-mfgCustom">Custom Manufacturer</label><input type="text" id="room-mfgCustom" name="room-mfgCustom" class="capitalize" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                <div class="field"><label for="room-count" id="count-label">Count</label><input type="number" id="room-count" name="room-count" min="0" inputmode="numeric" list="count-options" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                <div class="field"><label for="room-fanMotorsPerUnit">Fan Motors Per Unit</label><input type="number" id="room-fanMotorsPerUnit" name="room-fanMotorsPerUnit" min="0" inputmode="numeric" list="count-options" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                <div class="field"><label for="room-voltage">Voltage</label>
                    <select id="room-voltage" name="room-voltage">
                        <option value="">—</option>
                        <option value="460">460</option>
                        <option value="230">230</option>
                        <option value="115">115</option>
                    </select>
                </div>
                <div class="field"><label for="room-phase">Phase</label>
                    <select id="room-phase" name="room-phase">
                        <option value="">—</option>
                        <option value="3">3</option>
                        <option value="1">1</option>
                    </select>
                </div>
                <div class="field"><label for="room-amps">Amps/FLA EA</label><input type="number" id="room-amps" name="room-amps" min="0.01" max="20.0" step="0.01" inputmode="decimal" placeholder="1.0" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                <div class="field"><label for="room-hp">Motor HP</label>
                    <select id="room-hp" name="room-hp">
                        <option value="">—</option>
                        <option value="1.0 HP">1.0 HP</option>
                        <option value="1.5 HP">1.5 HP</option>
                        <option value="2.2 HP">2.2 HP</option>
                        <option value="3.0 HP">3.0 HP</option>
                        <option value="5.0 HP">5.0 HP</option>
                        <option value="1/4 HP">1/4 HP</option>
                        <option value="1/3 HP">1/3 HP</option>
                        <option value="1/2 HP">1/2 HP</option>
                        <option value="3/4 HP">3/4 HP</option>
                        <option value="1/5 HP">1/5 HP</option>
                        <option value="1/6 HP">1/6 HP</option>
                        <option value="1/8 HP">1/8 HP</option>
                        <option value="1/15 HP">1/15 HP</option>
                        <option value="1/20 HP">1/20 HP</option>
                        <option value="9W">9W</option>
                        <option value="12W">12W</option>
                        <option value="16W">16W</option>
                        <option value="18W">18W</option>
                        <option value="45W">45W</option>
                        <option value="60W">60W</option>
                        <option value="75W">75W</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="field hidden" id="custom-hp-field"><label for="room-hpCustom">Custom Motor HP</label><input type="text" id="room-hpCustom" name="room-hpCustom" placeholder="e.g., 0.9 HP, 6.5 HP" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                <div class="field"><label for="room-motorMounting">Motor Mount</label>
                    <select id="room-motorMounting" name="room-motorMounting">
                        <option value="">—</option>
                        <option value="base">Base</option>
                        <option value="squirrel">Squirrel</option>
                        <option value="custom">Custom (specify)</option>
                    </select>
                </div>
                <div class="field hidden" id="custom-mount-field"><label for="room-motorMountingCustom">Custom Mount</label><input type="text" id="room-motorMountingCustom" name="room-motorMountingCustom" class="suggest" list="room-motorMountingCustom-options" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                <div class="field"><label for="room-frame">Frame</label>
                    <select id="room-frame" name="room-frame">
                        <option value="">—</option>
                        <option value="48">48</option>
                        <option value="48Y">48Y</option>
                        <option value="56">56</option>
                        <option value="56Y">56Y</option>
                        <option value="42">42</option>
                        <option value="42Y">42Y</option>
                        <option value="143T">143T</option>
                        <option value="145T">145T</option>
                        <option value="182T">182T</option>
                        <option value="184T">184T</option>
                        <option value="213T">213T</option>
                        <option value="215T">215T</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="field hidden" id="custom-frame-field"><label for="room-frameCustom">Custom Frame</label><input type="text" id="room-frameCustom" name="room-frameCustom" placeholder="e.g., 256T" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                <div class="field"><label for="room-rpm">RPM</label>
                    <select id="room-rpm" name="room-rpm">
                        <option value="">—</option>
                        <option value="850">850</option>
                        <option value="1075">1075</option>
                        <option value="1140">1140</option>
                        <option value="825">825</option>
                        <option value="900">900</option>
                        <option value="950">950</option>
                        <option value="1000">1000</option>
                        <option value="1550">1550</option>
                        <option value="1625">1625</option>
                        <option value="1725">1725</option>
                        <option value="1750">1750</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="field hidden" id="custom-rpm-field"><label for="room-rpmCustom">Custom RPM</label><input type="text" id="room-rpmCustom" name="room-rpmCustom" placeholder="e.g., 1800" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                <!-- Condenser specific: split condenser -->
                <div class="field hidden" id="split-field"><label for="room-split">Split Condenser?</label>
                    <select id="room-split" name="room-split">
                        <option value="No">No</option>
                        <option value="Yes">Yes</option>
                    </select>
                </div>
                <!-- Detailed fields (always shown) -->
                <div id="detailedFields">
                    <!-- Reordered fields: rotation, shaft size, shaft adapters, blade spec, blades needed, run time -->
                    <div class="field"><label for="room-rotation">Rotation (OSE)</label>
                        <select id="room-rotation" name="room-rotation">
                            <option value="CCW">CCW</option>
                            <option value="CW">CW</option>
                        </select>
                    </div>
                    <div class="field"><label for="room-shaftSize">Shaft Size</label>
                        <select id="room-shaftSize" name="room-shaftSize">
                            <option value="">—</option>
                            <option value="1/2&quot;">1/2&quot;</option>
                            <option value="5/8&quot;">5/8&quot;</option>
                            <option value="3/4&quot;">3/4&quot;</option>
                            <option value="7/8&quot;">7/8&quot;</option>
                            <option value="1&quot;">1&quot;</option>
                            <option value="1-1/8&quot;">1-1/8&quot;</option>
                        </select>
                    </div>
                    <div class="field"><label for="room-shaftAdapters">Shaft Adapters?</label>
                        <select id="room-shaftAdapters" name="room-shaftAdapters">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <!-- Adapter type appears when shaft adapters set to Yes -->
                    <div class="field hidden" id="adapter-type-field"><label for="room-shaftAdapterType">Adapter Type</label>
                        <select id="room-shaftAdapterType" name="room-shaftAdapterType">
                            <option value="">—</option>
                            <option value="5/8 to 1/2">5/8 to 1/2</option>
                            <option value="3/4 to 1/2">3/4 to 1/2</option>
                            <option value="7/8 to 1/2">7/8 to 1/2</option>
                            <option value="1 to 1/2">1 to 1/2</option>
                            <option value="7/8 to 5/8">7/8 to 5/8</option>
                            <option value="1 to 5/8">1 to 5/8</option>
                            <option value="1-1/8 to 5/8">1-1/8 to 5/8</option>
                            <option value="custom">Other...</option>
                        </select>
                    </div>
                    <div class="field hidden" id="custom-adapter-field"><label for="room-shaftAdapterTypeCustom">Custom Adapter Type</label><input type="text" id="room-shaftAdapterTypeCustom" name="room-shaftAdapterTypeCustom" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                    <!-- Adapter quantity (auto-calculated) appears when shaft adapters set to Yes -->
                    <div class="field hidden" id="adapter-qty-field"><label for="room-shaftAdapterQty">Shaft Adptr QTY</label><input type="number" id="room-shaftAdapterQty" name="room-shaftAdapterQty" readonly style="background-color: #f5f5f5;"></div>
                    <div class="field"><label for="room-bladeSpec">Blade Size/Pitch/Wing#</label><input type="text" id="room-bladeSpec" name="room-bladeSpec" inputmode="numeric" placeholder="__/__/__" maxlength="8" class="suggest" list="room-bladeSpec-options" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                    <div class="field"><label for="room-bladesNeeded"># Blades Needed</label><input type="number" id="room-bladesNeeded" name="room-bladesNeeded" min="0" list="blades-options" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                    <div class="field"><label for="room-runTime">Run Time</label><input type="text" id="room-runTime" name="room-runTime" class="suggest" list="room-runTime-options" value="100%" placeholder="100%" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                </div>
                <div class="field"><label for="room-notes">Notes</label><textarea id="room-notes" name="room-notes" rows="3" autocapitalize="sentences" spellcheck="true" autocorrect="on"></textarea></div>
                <div id="temp-fields" class="hidden">
                    <div class="field"><label for="room-currentTemp">Current Temp °F</label><input type="number" id="room-currentTemp" name="room-currentTemp" step="0.1" inputmode="decimal" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                    <div class="field"><label for="room-setPoint">Set Point °F</label><input type="number" id="room-setPoint" name="room-setPoint" step="0.1" inputmode="decimal" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                </div>
                <input type="hidden" id="room-section" />
                <input type="hidden" id="room-mode" />
                <div class="form-footer-buttons">
                    <button type="submit" id="formSubmitBtn" class="button">Save Unit</button>
                    <button type="button" id="cancelBtn" class="button secondary">Cancel</button>
                    <button type="button" id="deleteRoomBtn" class="button delete-room-btn">Delete Room</button>
                </div>
            </form>

            <!-- Datalist options for counts -->
            <datalist id="count-options"></datalist>
            <!-- Datalist for blades numbers (updated dynamically) -->
            <datalist id="blades-options"></datalist>

            <!-- Datalists for suggestions -->
            <datalist id="site-customer-options"></datalist>
            <datalist id="site-street-options"></datalist>
            <datalist id="site-city-options"></datalist>
            <datalist id="site-contact-options"></datalist>
            <datalist id="site-phone-options"></datalist>
            <datalist id="zone-options">
                <option value="A"></option>
                <option value="B"></option>
                <option value="C"></option>
                <option value="D"></option>
                <option value="E"></option>
                <option value="F"></option>
                <option value="G"></option>
                <option value="H"></option>
                <option value="I"></option>
                <option value="J"></option>
                <option value="K"></option>
                <option value="L"></option>
                <option value="M"></option>
                <option value="N"></option>
                <option value="O"></option>
                <option value="P"></option>
                <option value="Q"></option>
                <option value="R"></option>
                <option value="S"></option>
                <option value="T"></option>
                <option value="U"></option>
                <option value="V"></option>
                <option value="W"></option>
                <option value="X"></option>
                <option value="Y"></option>
                <option value="Z"></option>
            </datalist>
            <datalist id="room-name-options"></datalist>
            <datalist id="room-mfg-options"></datalist>
            <datalist id="room-motorMountingCustom-options"></datalist>
            <datalist id="room-frame-options">
                <!-- Default frame sizes for fractional horsepower motors (first four are most common) -->
                <option value="48" data-default="true"></option>
                <option value="48Y" data-default="true"></option>
                <option value="56" data-default="true"></option>
                <option value="56Y" data-default="true"></option>
                <option value="42" data-default="true"></option>
                <option value="42Y" data-default="true"></option>
                <!-- Larger frames for higher horsepower motors -->
                <option value="143T" data-default="true"></option>
                <option value="145T" data-default="true"></option>
                <option value="182T" data-default="true"></option>
                <option value="184T" data-default="true"></option>
            </datalist>
            <datalist id="room-bladeSpec-options"></datalist>
            <datalist id="room-shaftAdapterType-options">
                <!-- Common shaft adapter/bushing sizes - allows using blade with larger bore on motor with smaller shaft -->
                <option value="5/8 to 1/2" data-default="true"></option>
                <option value="3/4 to 1/2" data-default="true"></option>
                <option value="7/8 to 1/2" data-default="true"></option>
                <option value="1 to 1/2" data-default="true"></option>
                <option value="7/8 to 5/8" data-default="true"></option>
                <option value="1 to 5/8" data-default="true"></option>
                <option value="1-1/8 to 5/8" data-default="true"></option>
            </datalist>
            <datalist id="room-runTime-options"></datalist>
            <!-- Datalist for RPM common speeds -->
            <datalist id="rpm-options">
                <!-- List the most common cooler/freezer fan motor speeds first -->
                <option value="850" data-default="true"></option>
                <option value="1075" data-default="true"></option>
                <option value="1140" data-default="true"></option>
                <!-- Additional relevant speeds in ascending order -->
                <option value="825" data-default="true"></option>
                <option value="900" data-default="true"></option>
                <option value="950" data-default="true"></option>
                <option value="1000" data-default="true"></option>
                <option value="1550" data-default="true"></option>
                <option value="1725" data-default="true"></option>
                <option value="3450" data-default="true"></option>
            </datalist>
            <datalist id="room-shaftSize-options"></datalist>

            <!-- Cards containers for evaporators and condensers -->
            <h2 style="margin-top:1rem;">Evaporators</h2>
            <div id="cards-evap" class="cards"></div>
            
            <!-- Add Evaporator button (dynamically positioned after last evaporator card) -->
            <div id="addEvapButtonContainer" style="margin-top:1rem; text-align:center;"></div>
            
            <h2 style="margin-top:1.5rem;">Condensers</h2>
            <div id="cards-cond" class="cards"></div>
            
            <!-- Add Condenser button (dynamically positioned after last condenser card) -->
            <div id="addCondButtonContainer" style="margin-top:1rem; text-align:center;"></div>

            <!-- Photos Pool Section -->
            <section id="photosPoolSection" class="photo-pool-section hidden">
                <div class="photo-pool-header">
                    <h2>📷 Photos Pool</h2>
                    <div class="photo-pool-buttons">
                        <button id="autoAssignPhotosBtn" class="button secondary">Auto-Assign</button>
                        <button id="takePhotoBtn" class="button secondary">📸 Take Photo</button>
                        <button id="addPhotosBtn" class="button">📁 Choose Photos</button>
                        <!-- Camera input (with capture) - opens camera directly -->
                        <input type="file" id="cameraPhotoInput" accept="image/*" capture="environment" style="display:none;">
                        <!-- Library input (no capture) - opens iOS picker with Camera, Library, Files options -->
                        <input type="file" id="photoFileInput" accept="image/*" multiple style="display:none;">
                    </div>
                </div>
                <p id="photoPoolHint" style="color:#666;font-size:0.9rem;">Unassigned photos appear here. Mark photos as "Room Start" to use auto-assign.</p>
                <div id="photoGrid" class="photo-grid"></div>
            </section>

            <!-- Photo Attach Modal -->
            <div id="photoAttachModal" class="photo-attach-modal">
                <div class="photo-attach-modal-content">
                    <div class="photo-attach-modal-header">
                        <h3>Select Photos to Attach</h3>
                        <button class="photo-attach-modal-close">&times;</button>
                    </div>
                    <p style="color:#666;font-size:0.9rem;margin-bottom:1rem;">Click photos to select, then click Attach.</p>
                    <div id="photoAttachGrid" class="photo-attach-grid"></div>
                    <div style="margin-top:1rem; text-align:right;">
                        <button id="photoAttachCancelBtn" class="button secondary" style="margin-right:0.5rem;">Cancel</button>
                        <button id="photoAttachConfirmBtn" class="button">Attach Selected</button>
                    </div>
                </div>
            </div>

            <!-- Auto-Assign Summary Modal -->
            <div id="autoAssignModal" class="auto-assign-modal">
                <div class="auto-assign-modal-content">
                    <h3 style="margin-top:0;">Auto-Assign Complete</h3>
                    <div id="autoAssignSummary" class="auto-assign-summary"></div>
                    <div style="margin-top:1rem; text-align:right;">
                        <button id="autoAssignUndoBtn" class="button secondary" style="margin-right:0.5rem;">Undo</button>
                        <button id="autoAssignCloseBtn" class="button">Close</button>
                    </div>
                </div>
            </div>

            <!-- Project Name Modal (for Save new projects) -->
            <div id="projectNameModal" class="project-name-modal hidden">
                <div class="project-name-modal-content">
                    <h3 style="margin-top:0;">Save Project</h3>
                    <p style="color:#666;font-size:0.9rem;margin-bottom:1rem;">Enter a name for this project:</p>
                    <div class="field">
                        <input type="text" id="projectNameInput" placeholder="Project name" style="width:100%;font-size:1rem;">
                    </div>
                    <div style="margin-top:1rem; text-align:right;">
                        <button id="projectNameCancelBtn" class="button secondary" style="margin-right:0.5rem;">Cancel</button>
                        <button id="projectNameSaveBtn" class="button">Save</button>
                    </div>
                </div>
            </div>

            <!-- Delete Confirmation Modal - Custom modal to replace native confirm() -->
            <div id="deleteConfirmModal" class="delete-confirm-modal hidden">
                <div class="delete-confirm-modal-content">
                    <h3>🗑️ Delete</h3>
                    <p id="deleteConfirmMessage">Are you sure you want to delete this room?</p>
                    <div class="delete-confirm-modal-buttons">
                        <button id="deleteConfirmCancelBtn" class="button secondary">Cancel</button>
                        <button id="deleteConfirmDeleteBtn" class="button delete-room-btn">Delete</button>
                    </div>
                </div>
            </div>

            <!-- Load Project Modal (full-screen) -->
            <div id="loadProjectModal" class="load-project-modal hidden">
                <div class="load-project-modal-content">
                    <div class="load-project-modal-header">
                        <h3 style="margin:0;">Load Project</h3>
                        <button id="loadProjectCloseBtn" class="load-project-modal-close">&times;</button>
                    </div>
                    <div style="padding: 0.5rem 1rem; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                        <div class="select-all-container">
                            <input type="checkbox" id="modalSelectAllCheckbox" class="project-checkbox">
                            <label for="modalSelectAllCheckbox">Select All</label>
                        </div>
                        <button id="modalDeleteSelectedBtn" class="delete-selected-btn" disabled>🗑️ Delete Selected</button>
                    </div>
                    <div id="loadProjectListContainer" class="load-project-list-container">
                        <p style="text-align:center;color:#666;">Loading projects...</p>
                    </div>
                </div>
            </div>
            
            <!-- Autosave Restore Modal (localStorage) -->
            <div id="autosaveRestoreModal" class="autosave-restore-modal hidden">
                <div class="autosave-restore-modal-content">
                    <h3>📋 Unsaved Changes Found</h3>
                    <p>We found unsaved changes from your last session.</p>
                    <div id="autosaveRestoreInfo" class="autosave-restore-info">
                        <div id="autosaveTimestamp"></div>
                        <div id="autosaveDetails"></div>
                    </div>
                    <p style="color:#666;font-size:0.9rem;">Would you like to restore these changes?</p>
                    <div class="autosave-restore-buttons">
                        <button id="autosaveDiscardBtn" class="button secondary">Discard</button>
                        <button id="autosaveRestoreBtn" class="button">Restore</button>
                    </div>
                </div>
            </div>

            <!-- Server Autosave Restore Modal (when loading a project) -->
            <div id="serverAutosaveModal" class="autosave-restore-modal hidden">
                <div class="autosave-restore-modal-content">
                    <h3>📋 Newer Autosave Found</h3>
                    <p>A more recent autosave was found for this project.</p>
                    <div class="autosave-restore-info">
                        <div id="serverAutosaveTimestamp"></div>
                        <div id="serverSavedTimestamp"></div>
                        <div id="serverAutosaveDetails" style="margin-top:0.5rem;"></div>
                    </div>
                    <p style="color:#666;font-size:0.9rem;">Would you like to restore the autosave or use the last saved version?</p>
                    <div class="autosave-restore-buttons">
                        <button id="serverAutosaveDiscardBtn" class="button secondary">Use Last Save</button>
                        <button id="serverAutosaveRestoreBtn" class="button">Restore Autosave</button>
                    </div>
                </div>
            </div>

            <!-- ==================== EMBEDDED ELECTRIC BILLS SECTION ==================== -->
            <div id="embeddedBillsSection" class="embedded-bills-section" style="margin-top: 2rem; padding: 0 0.5rem;">
                <div class="bills-section-header" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid #2196f3; padding-bottom: 0.5rem;">
                    <span style="font-size: 1.5rem;">⚡</span>
                    <h2 style="margin: 0; color: #333; font-size: 1.3rem;">Electric Bills</h2>
                </div>
                
                <div id="embeddedBillsContent">
                    <!-- Content will be dynamically populated -->
                    <div class="bills-loading" style="text-align: center; padding: 2rem; color: #666;">
                        Loading bills data...
                    </div>
                </div>
            </div>

            <!-- Export and Save buttons (moved to bottom, below Electric Bills) -->
            <div id="exportImportSectionBottom" style="margin-top:2rem; text-align:center; display:flex; flex-direction:column; align-items:center; gap:0.5rem;">
                <div style="display:flex; justify-content:center; gap:1rem; flex-wrap:wrap;">
                    <button id="saveProjectBtn2Bottom" class="button secondary">💾 Save Project</button>
                    <button id="saveAsBtnBottom" class="button secondary">💾 Save As...</button>
                    <button id="exportBtnBottom" class="button secondary">📤 Send to Dropbox</button>
                    <button id="printViewBtnBottom" class="button secondary">🖨️ Print View</button>
                    <button id="photosNavBtnBottom" class="button">📷 Photos</button>
                </div>
                <div style="display:flex; justify-content:center; gap:1rem; flex-wrap:wrap; margin-top:0.5rem;">
                    <button id="newProjectBtnBottom" class="button secondary" style="font-size:0.85rem; padding:0.4rem 0.8rem;">🆕 New Project</button>
                    <button id="loadProjectBtnBottom" class="button secondary" style="font-size:0.85rem; padding:0.4rem 0.8rem;">📂 Load Project</button>
                </div>
                <div id="currentProjectDisplayBottom" style="font-size:0.8rem; color:#2d7bb8; margin-top:0.25rem; font-style:italic;"></div>
                <div id="dropbox-status-bottom" style="font-size:0.85rem; margin-top:0.5rem; max-width:90%; word-break:break-word;"></div>
            </div>

            <!-- Footer section -->
            <div style="text-align:center; margin-top:2rem;">
                <img src="static/carlisle_logo_full.png" alt="Carlisle Energy Solutions" style="height:80px; margin-bottom:0.5rem;">
                <div style="font-size:0.75rem; color:#555;">23832 Rockfield Blvd #170, Lake Forest, CA 92630</div>
                <div style="font-size:0.75rem; color:#555;">(714) 684-1766</div>
            </div>
        </div>
    </div>
    </div> <!-- End of currentProjectView -->

    <!-- ==================== UTILITY BILLS VIEW ==================== -->
    <div id="utilityBillsView" class="app-view bills-view">
        <div class="bills-container">
            <div class="bills-header">
                <h2>📄 Utility Bills</h2>
                <div id="billsProjectSummary" class="bills-project-summary">
                    <div class="bills-project-name">No project selected</div>
                    <div class="bills-project-address"></div>
                </div>
            </div>
            
            <div class="bills-content">
                <div class="bills-panel">
                    <h3>📁 Upload Bill Files</h3>
                    <p class="bills-helper-text">Upload PDF utility bills. You can upload multiple bills, including bills with multiple meters and 13+ months of history. AI will extract account, meter, and usage data automatically.</p>
                    <div class="bills-upload-area">
                        <input type="file" id="billFileInput" accept=".pdf,image/*" multiple style="display:none;">
                        <button id="billUploadBtn" class="button primary bills-upload-btn">
                            📤 Upload Bills
                        </button>
                        <div id="billUploadStatus" class="bills-upload-status"></div>
                        <div id="billProgressContainer" class="bills-progress-container">
                            <div class="bills-progress-bar">
                                <div id="billProgressFill" class="bills-progress-fill"></div>
                            </div>
                            <div id="billProgressText" class="bills-progress-text"></div>
                        </div>
                        <div id="billUploadItems" class="bill-upload-items"></div>
                    </div>
                </div>
                
                <div class="bills-panel">
                    <h3>📋 Uploaded Files</h3>
                    <div id="billFilesList" class="bills-files-list">
                        <div class="bills-empty-state">No files uploaded yet</div>
                    </div>
                </div>
                
                <div class="bills-panel bills-data-panel">
                    <h3>📊 Extracted Data</h3>
                    <p class="bills-helper-text">Data is grouped by Account, then by Meter. Each meter shows all extracted billing periods.</p>
                    <div id="billsGroupedData" class="bills-grouped-data">
                        <div class="bills-empty-state">No data extracted yet. Upload utility bills above.</div>
                    </div>
                </div>
            </div>
            
            <div class="bills-footer">
                <button id="billsBackBtn" class="button secondary">← Back to Project</button>
            </div>
        </div>
    </div>

    <!-- ==================== PRINT VIEW ==================== -->
    <div id="printViewContainer" class="app-view">
        <div style="max-width: 1100px; margin: 0 auto; padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #ddd;">
                <button id="printViewBackBtn" class="button secondary" onclick="NavigationController.setView('currentProject')">← Back to Project</button>
                <div style="display: flex; gap: 0.5rem;">
                    <button id="printViewDownloadBtn" class="button primary" onclick="NavigationController.downloadPrintPdf()">📥 Download PDF</button>
                    <button class="button secondary" onclick="window.print()">🖨️ Print</button>
                </div>
            </div>
            <div id="printViewContent">
                <!-- Content populated by renderPrintView() -->
            </div>
        </div>
    </div>

    <!-- Bill Review Modal -->
    <div id="billReviewModal" class="bill-review-modal">
        <div class="bill-review-content">
            <div class="bill-review-header">
                <h3>📄 Bill Review</h3>
                <button id="billReviewClose" class="bill-review-close">&times;</button>
            </div>
            <div class="bill-review-body">
                <div id="billReviewMissingFields"></div>
                <div id="billReviewFileInfo" class="bill-review-file-info"></div>
                <div id="billReviewScreenshot" class="bill-screenshot-section">
                    <h5>📎 Annotated Files</h5>
                    <p class="bill-screenshot-tip">Tip: Click "View PDF" above, mark it up in Preview or your PDF viewer, then upload the annotated file here.</p>
                    <input type="file" id="billScreenshotInput" accept=".pdf,image/*,image/png,image/jpeg,image/webp,image/heic,image/gif" multiple style="display:none;">
                    <button id="billScreenshotBtn" class="bill-screenshot-btn">📤 Add File</button>
                    <div id="billScreenshotGallery" class="bill-screenshot-gallery"></div>
                    <div id="billScreenshotError" class="bill-screenshot-error" style="display:none;"></div>
                </div>
                <div id="billReviewData" class="bill-review-section"></div>
            </div>
            <div class="bill-review-footer">
                <button id="billReviewBackBtn" class="button back-btn">← Back</button>
                <button id="billReviewEditBtn" class="button edit-btn">✏️ Edit</button>
                <button id="billReviewSaveBtn" class="button save-btn" style="display:none;">💾 Save Corrections</button>
                <button id="billReviewManualFixBtn" class="button save-btn" style="display:none;">💾 Save & Mark as OK</button>
            </div>
        </div>
    </div>

    <!-- Bill PDF Modal -->
    <div id="billPdfModal" class="bill-pdf-modal">
        <div class="bill-pdf-modal-content">
            <div class="bill-pdf-modal-header">
                <h3 id="billPdfModalTitle">PDF Viewer</h3>
                <button id="billPdfModalClose" class="bill-pdf-modal-close">&times;</button>
            </div>
            <div class="bill-pdf-modal-body">
                <div id="billPdfCanvasContainer" class="pdf-canvas-container">
                    <div id="billPdfLoading" class="pdf-loading">Loading PDF...</div>
                    <div id="billPdfPages" class="pdf-pages"></div>
                </div>
            </div>
            <div class="bill-pdf-modal-nav">
                <button id="billPdfPrevPage" class="button secondary" disabled>◀ Prev</button>
                <span id="billPdfPageInfo">Page 1 of 1</span>
                <button id="billPdfNextPage" class="button secondary" disabled>Next ▶</button>
            </div>
            <div class="bill-pdf-modal-footer">
                <button id="billPdfModalBack" class="button secondary">← Back</button>
                <button id="billPdfModalDownload" class="button secondary">⬇️ Download PDF</button>
                <button id="billPdfModalNewTab" class="button">🔗 Open in New Tab</button>
            </div>
        </div>
    </div>

    <!-- Field Review Modal (for editing missing fields) -->
    <div id="fieldReviewModal" class="field-review-modal">
        <div class="field-review-content">
            <div class="field-review-header">
                <h3>⚠️ Review Missing Fields</h3>
                <button id="fieldReviewClose" class="field-review-close">&times;</button>
            </div>
            <div id="fieldReviewBody" class="field-review-body">
                <p>Loading...</p>
            </div>
            <div class="field-review-footer">
                <button id="fieldReviewCancel" class="button secondary">Cancel</button>
                <button id="fieldReviewSave" class="button">💾 Save</button>
            </div>
        </div>
    </div>

    <!-- CRITICAL: Console wrapper MUST run before ANY other JavaScript -->
    <script>
    (function() {
        'use strict';
        const MAX_LOG_BYTES = 50 * 1024; // 50KB limit
        const isReplit = typeof window !== 'undefined' && 
            (window.location.hostname.includes('replit') || 
             window.location.hostname.includes('repl.co') ||
             navigator.userAgent.includes('Replit'));
        
        function getSize(obj) {
            try {
                if (typeof obj === 'string') return obj.length;
                if (obj === null || obj === undefined) return 0;
                if (typeof obj === 'object') {
                    const str = JSON.stringify(obj);
                    return str ? str.length : 0;
                }
                return String(obj).length;
            } catch (e) {
                return 0;
            }
        }
        
        function getSummary(obj) {
            if (obj === null) return 'null';
            if (obj === undefined) return 'undefined';
            if (typeof obj === 'string') return `string(${obj.length})`;
            if (Array.isArray(obj)) return `array(${obj.length})`;
            if (typeof obj === 'object') {
                const keys = Object.keys(obj);
                return `object{${keys.slice(0,5).join(',')}${keys.length > 5 ? '...' : ''}}`;
            }
            return typeof obj;
        }
        
        function wrapMethod(original, methodName) {
            return function(...args) {
                if (!isReplit) {
                    return original.apply(console, args);
                }
                const safeArgs = args.map((arg, i) => {
                    const size = getSize(arg);
                    if (size > MAX_LOG_BYTES) {
                        return `[OMITTED] arg${i} size=${size} type=${getSummary(arg)}`;
                    }
                    return arg;
                });
                return original.apply(console, safeArgs);
            };
        }
        
        // Store originals and wrap
        const _log = console.log;
        const _warn = console.warn;
        const _error = console.error;
        const _debug = console.debug;
        
        console.log = wrapMethod(_log, 'log');
        console.warn = wrapMethod(_warn, 'warn');
        console.error = wrapMethod(_error, 'error');
        console.debug = wrapMethod(_debug, 'debug');
        
        // Log that wrapper is active
        _log('[CONSOLE] Safe logging wrapper active - max per-arg: 50KB');
    })();
    </script>

    <script>
    // Bill PDF Modal Functions (global scope) - Using PDF.js for inline rendering
    let currentBillPdfFileId = null;
    let currentBillPdfUrl = null;
    let pdfDocument = null;
    let currentPage = 1;
    let totalPages = 0;
    
    // Configure PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
    
    async function openBillPdfModal(fileId, fileName) {
        currentBillPdfFileId = fileId;
        currentBillPdfUrl = `/api/bills/file/${fileId}/pdf`;
        
        const modal = document.getElementById('billPdfModal');
        const title = document.getElementById('billPdfModalTitle');
        const loading = document.getElementById('billPdfLoading');
        const pagesContainer = document.getElementById('billPdfPages');
        const pageInfo = document.getElementById('billPdfPageInfo');
        
        if (title) title.textContent = fileName || 'PDF Viewer';
        if (loading) loading.style.display = 'block';
        if (pagesContainer) pagesContainer.innerHTML = '';
        if (pageInfo) pageInfo.textContent = 'Loading...';
        if (modal) modal.classList.add('show');
        
        // Reset state
        pdfDocument = null;
        currentPage = 1;
        totalPages = 0;
        updateNavButtons();
        
        try {
            // Load PDF with PDF.js
            const loadingTask = pdfjsLib.getDocument(currentBillPdfUrl);
            pdfDocument = await loadingTask.promise;
            totalPages = pdfDocument.numPages;
            
            if (loading) loading.style.display = 'none';
            if (pageInfo) pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            
            // Render first page
            await renderPage(currentPage);
            updateNavButtons();
            
        } catch (error) {
            console.error('[PDF] Error loading PDF:', error);
            if (loading) loading.textContent = 'Error loading PDF. Try "Open in New Tab" instead.';
        }
    }
    
    async function renderPage(pageNum) {
        if (!pdfDocument) return;
        
        const pagesContainer = document.getElementById('billPdfPages');
        if (!pagesContainer) return;
        
        pagesContainer.innerHTML = '';
        
        try {
            const page = await pdfDocument.getPage(pageNum);
            const scale = 1.5;
            const viewport = page.getViewport({ scale });
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            await page.render({
                canvasContext: context,
                viewport: viewport
            }).promise;
            
            pagesContainer.appendChild(canvas);
            
        } catch (error) {
            console.error('[PDF] Error rendering page:', error);
            pagesContainer.innerHTML = '<div style="color: #fff; padding: 2rem;">Error rendering page</div>';
        }
    }
    
    function updateNavButtons() {
        const prevBtn = document.getElementById('billPdfPrevPage');
        const nextBtn = document.getElementById('billPdfNextPage');
        const pageInfo = document.getElementById('billPdfPageInfo');
        
        if (prevBtn) prevBtn.disabled = currentPage <= 1;
        if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
        if (pageInfo && totalPages > 0) pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    }
    
    async function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            await renderPage(currentPage);
            updateNavButtons();
        }
    }
    
    async function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            await renderPage(currentPage);
            updateNavButtons();
        }
    }
    
    function closeBillPdfModal() {
        const modal = document.getElementById('billPdfModal');
        const pagesContainer = document.getElementById('billPdfPages');
        
        if (pagesContainer) pagesContainer.innerHTML = '';
        if (modal) modal.classList.remove('show');
        
        pdfDocument = null;
        currentBillPdfFileId = null;
        currentBillPdfUrl = null;
        currentPage = 1;
        totalPages = 0;
    }
    
    function downloadBillPdf() {
        if (currentBillPdfUrl) {
            const link = document.createElement('a');
            link.href = currentBillPdfUrl;
            link.download = '';
            link.click();
        }
    }
    
    function openPdfInNewTab() {
        if (currentBillPdfUrl) {
            window.open(currentBillPdfUrl, '_blank');
        }
    }
    
    // Setup PDF modal event listeners when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        const closeBtn = document.getElementById('billPdfModalClose');
        const backBtn = document.getElementById('billPdfModalBack');
        const downloadBtn = document.getElementById('billPdfModalDownload');
        const newTabBtn = document.getElementById('billPdfModalNewTab');
        const prevBtn = document.getElementById('billPdfPrevPage');
        const nextBtn = document.getElementById('billPdfNextPage');
        const modal = document.getElementById('billPdfModal');
        
        if (closeBtn) closeBtn.addEventListener('click', closeBillPdfModal);
        if (backBtn) backBtn.addEventListener('click', closeBillPdfModal);
        if (downloadBtn) downloadBtn.addEventListener('click', downloadBillPdf);
        if (newTabBtn) newTabBtn.addEventListener('click', openPdfInNewTab);
        if (prevBtn) prevBtn.addEventListener('click', prevPage);
        if (nextBtn) nextBtn.addEventListener('click', nextPage);
        
        // Close on background click
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeBillPdfModal();
            });
        }
    });
    </script>

    <script>
    // Build ID for version tracking - prevents old tabs from creating duplicates
    const BUILD_ID = '2025-12-17-v1';
    
    // Show build mismatch banner prompting user to refresh
    function showBuildMismatchBanner() {
        // Only show once per session
        if (document.getElementById('buildMismatchBanner')) return;
        
        const banner = document.createElement('div');
        banner.id = 'buildMismatchBanner';
        banner.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#dc3545;color:white;padding:12px 20px;text-align:center;z-index:99999;font-size:14px;display:flex;justify-content:center;align-items:center;gap:15px;';
        banner.innerHTML = `
            <span>⚠️ This tab is out of date. Please refresh to continue saving.</span>
            <button onclick="location.reload()" style="background:white;color:#dc3545;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:bold;">Refresh Now</button>
        `;
        document.body.insertBefore(banner, document.body.firstChild);
        console.log('[BUILD] Showing build mismatch banner - user needs to refresh');
    }
    
    // ==================== GLOBAL TOAST NOTIFICATION SYSTEM ====================
    // Replaces native alert() calls with non-blocking toast notifications
    function showToast(message, type = 'info', duration = 3000) {
        const toast = document.createElement('div');
        toast.className = `global-toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // Fade in
        setTimeout(() => toast.classList.add('show'), 10);
        
        // Fade out and remove
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }
    
    // ==================== GLOBAL CONFIRM MODAL SYSTEM ====================
    // Replaces native confirm() calls with custom modal that works on iOS
    function showConfirmModal(options = {}) {
        return new Promise((resolve) => {
            const {
                title = 'Confirm',
                message = 'Are you sure?',
                confirmText = 'OK',
                cancelText = 'Cancel',
                danger = false
            } = options;
            
            // Blur any focused input to dismiss iOS keyboard first
            if (document.activeElement && document.activeElement.blur) {
                document.activeElement.blur();
            }
            
            // Wait for keyboard to dismiss
            setTimeout(() => {
                const modal = document.getElementById('globalConfirmModal');
                const titleEl = document.getElementById('globalConfirmTitle');
                const messageEl = document.getElementById('globalConfirmMessage');
                const cancelBtn = document.getElementById('globalConfirmCancelBtn');
                const okBtn = document.getElementById('globalConfirmOkBtn');
                
                if (!modal) {
                    console.error('[showConfirmModal] Modal element not found');
                    resolve(false);
                    return;
                }
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                cancelBtn.textContent = cancelText;
                okBtn.textContent = confirmText;
                
                // Apply danger styling if needed
                if (danger) {
                    okBtn.classList.add('danger');
                } else {
                    okBtn.classList.remove('danger');
                }
                
                modal.classList.remove('hidden');
                
                function cleanup() {
                    modal.classList.add('hidden');
                    cancelBtn.removeEventListener('click', onCancel);
                    okBtn.removeEventListener('click', onConfirm);
                }
                
                function onCancel() {
                    cleanup();
                    resolve(false);
                }
                
                function onConfirm() {
                    cleanup();
                    resolve(true);
                }
                
                cancelBtn.addEventListener('click', onCancel);
                okBtn.addEventListener('click', onConfirm);
            }, 100);
        });
    }
    
    // ===== SAFE LOGGING UTILITY =====
    // Prevents logging large objects that could crash Replit's event stream (>4MB limit)
    const MAX_LOG_SIZE = 50000; // 50KB max for any logged object
    const _originalConsoleLog = console.log;
    const _originalConsoleWarn = console.warn;
    const _originalConsoleError = console.error;
    
    function safeStringify(obj, maxLen = MAX_LOG_SIZE) {
        try {
            const str = JSON.stringify(obj);
            if (str && str.length > maxLen) {
                return `[Object too large: ${(str.length / 1024).toFixed(1)}KB - truncated]`;
            }
            return str;
        } catch (e) {
            return '[Unstringifiable object]';
        }
    }
    
    // Guard console methods in Replit environment
    if (window.location.hostname.includes('replit') || window.location.hostname.includes('repl.co')) {
        console.log = function(...args) {
            const safeArgs = args.map(arg => {
                if (typeof arg === 'object' && arg !== null) {
                    const str = safeStringify(arg);
                    if (str.startsWith('[Object too large')) return str;
                }
                return arg;
            });
            _originalConsoleLog.apply(console, safeArgs);
        };
        console.warn = function(...args) {
            const safeArgs = args.map(arg => {
                if (typeof arg === 'object' && arg !== null) {
                    const str = safeStringify(arg);
                    if (str.startsWith('[Object too large')) return str;
                }
                return arg;
            });
            _originalConsoleWarn.apply(console, safeArgs);
        };
    }
    
    // ===== BILL DEBUG MODE TOGGLE =====
    // Enable with ?billDebug=true in URL to see field resolution in console
    window.BILL_DEBUG = new URLSearchParams(window.location.search).has('billDebug');
    
    // ===== LADWP UTILITY NAME MATCHING HELPER =====
    // Centralized helper for case-insensitive LADWP matching across all bill display locations
    function isUtilityLADWP(utilityName) {
        if (!utilityName) return false;
        const name = utilityName.toLowerCase();
        return name.includes('ladwp') ||
               name.includes('la dwp') ||
               name.includes('los angeles department of water') ||
               name.includes('los angeles dept of water') ||
               name.includes('la dept of water') ||
               name.includes('l.a. dwp') ||
               name.includes('l.a. department of water');
    }
    
    // ===== BILL VALUE FORMATTER UTILITY =====
    // Standardized number formatting for bill display values
    // Types: 'rate' (¢/kWh), 'avgDay' ($/day), 'cost' ($), 'kwh' (kWh)
    function formatBillValue(value, type) {
        if (value == null || value === '' || isNaN(value)) {
            return '-';
        }
        
        const num = Number(value);
        
        switch (type) {
            case 'rate':
                // Rate/kWh in cents: 1 decimal place, rounded
                return num.toFixed(1) + '¢';
            
            case 'avgDay':
                // Avg cost per day: 2 decimal places with $ prefix
                return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            case 'cost':
                // Total cost: 2 decimal places with commas and $ prefix
                return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            case 'kwh':
                // kWh: Integer with commas (unless fractional, then 1 decimal) + " kWh" suffix
                if (num % 1 === 0) {
                    return Math.round(num).toLocaleString('en-US') + ' kWh';
                } else {
                    return num.toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + ' kWh';
                }
            
            default:
                return String(num);
        }
    }
    
    // ===== BILL FIELD RESOLUTION HELPER =====
    // Tries multiple sources in order and logs which source was used when debug mode is enabled
    function resolveBillField(fieldName, ...sources) {
        let source = 'none';
        let value = null;
        for (let i = 0; i < sources.length; i++) {
            const [val, srcName] = sources[i];
            if (val && val !== 'N/A' && val.trim && val.trim() !== '') {
                value = val;
                source = srcName;
                break;
            } else if (val && typeof val !== 'string') {
                value = val;
                source = srcName;
                break;
            }
        }
        if (window.BILL_DEBUG) {
            console.log(`[BILL_DEBUG] ${fieldName}: "${value}" from ${source}`);
        }
        return value;
    }
    
    // Compute days using provided value, falling back to start/end dates if missing
    function computeDaysInPeriod(providedDays, startDate, endDate) {
        const parsed = providedDays != null ? Number(providedDays) : null;
        if (parsed && !Number.isNaN(parsed) && parsed > 0) {
            return parsed;
        }
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            if (!isNaN(start) && !isNaN(end)) {
                const diffMs = end.getTime() - start.getTime();
                const days = Math.round(diffMs / (1000 * 60 * 60 * 24));
                if (days > 0) {
                    return days;
                }
            }
        }
        return null;
    }
    
    (function() {
        const roomForm = document.getElementById('roomForm');
        const exportBtn = document.getElementById('exportBtnBottom');
        const evapCardsContainer = document.getElementById('cards-evap');
        const condCardsContainer = document.getElementById('cards-cond');
        const addEvapButtonContainer = document.getElementById('addEvapButtonContainer');
        const addCondButtonContainer = document.getElementById('addCondButtonContainer');
        const formTitle = document.getElementById('form-title');
        const cancelBtn = document.getElementById('cancelBtn');
        const formHeaderCancelBtn = document.getElementById('formHeaderCancelBtn');
        const deleteRoomBtn = document.getElementById('deleteRoomBtn');
        const siteSection = document.getElementById('siteSection');
        const dataSection = document.getElementById('dataSection');
        const proceedBtn = document.getElementById('proceedBtn');
        const siteForm = document.getElementById('siteForm');
        
        // Track when in edit mode
        let editingRoomId = null;
        
        // ===== GPS LOCATION FOR AUTOCOMPLETE BIAS =====
        // Stores user's GPS location (lat, lng) for biasing autocomplete results to nearby places
        let userLocationLatLng = null;
        
        // Create Add Evaporator and Add Condenser buttons dynamically
        let evapBtn, condBtn;
        function createAddButtons() {
            // Create Add Evaporator button
            addEvapButtonContainer.innerHTML = '';
            evapBtn = document.createElement('button');
            evapBtn.id = 'add-evap';
            evapBtn.className = 'button';
            evapBtn.textContent = 'Add Evaporator';
            evapBtn.addEventListener('click', () => {
                currentSection = 'evap';
                openForm();
            });
            addEvapButtonContainer.appendChild(evapBtn);
            
            // Create Add Condenser button
            addCondButtonContainer.innerHTML = '';
            condBtn = document.createElement('button');
            condBtn.id = 'add-cond';
            condBtn.className = 'button';
            condBtn.textContent = 'Add Condenser';
            condBtn.addEventListener('click', () => {
                currentSection = 'cond';
                openForm();
            });
            addCondButtonContainer.appendChild(condBtn);
        }

        // auto‑fill date field with today if not set
        (function() {
            const today = new Date();
            const yy = String(today.getFullYear()).slice(-2);
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const dateStr = `20${yy}-${mm}-${dd}`;
            const dateInput = document.getElementById('site-date');
            if (dateInput && !dateInput.value) {
                dateInput.value = dateStr;
            }
            // Initialize visit date display
            const m = today.getMonth() + 1;
            const d = today.getDate();
            const visitDateDisplay = `${m}/${d}/${yy}`;
            const visitDateText = document.getElementById('visitDateText');
            if (visitDateText) {
                visitDateText.textContent = visitDateDisplay;
            }
            // Initialize siteData with today's date (will be overwritten if loading from storage)
            window.initialDate = dateStr;
            window.initialVisitDate = visitDateDisplay;
        })();
        
        // Enhance Date of Site Visit picker on desktop with Flatpickr
        (function() {
            const dateInput = document.getElementById('site-date');
            if (!dateInput) return;

            // Only use Flatpickr on larger screens; keep native date on mobile
            if (window.innerWidth <= 768 || typeof flatpickr === 'undefined') {
                return;
            }

            // Preserve any existing value before we change the type
            const existingValue = dateInput.value;

            // Switch to text to avoid the native date picker
            dateInput.type = 'text';
            if (!dateInput.placeholder) {
                dateInput.placeholder = 'YYYY-MM-DD';
            }

            flatpickr(dateInput, {
                dateFormat: 'Y-m-d',           // matches existing storage format
                defaultDate: existingValue || 'today',
                position: 'below',             // open below the field
                clickOpens: true,
                allowInput: true
            });
        })();

        // ==================================================================================
        // PROJECT STATE MANAGEMENT
        // ==================================================================================
        // ProjectState: Centralized state manager for current project
        // Owns: project_id, siteData, entries, and dirty tracking
        // This ensures we never lose track of which project we're working on
        const ProjectState = {
            project_id: null,           // Stable UUID for this project (survives save/load)
            currentProjectId: null,     // UUID of currently loaded/saved project (null for new unsaved)
            currentProjectName: null,   // User-defined project name
            siteData: {},               // Customer info, address, etc.
            entries: [],                // Array of equipment entries (evaporators + condensers)
            photos: [],                 // Array of photo objects for this project
            isDirty: false,             // Has unsaved changes?
            uploadedPhotoIds: new Set(), // Track photos already uploaded in this session (per room key)
            
            // Initialize a new project
            init: function() {
                this.project_id = generateUUID();
                this.currentProjectId = null;
                this.currentProjectName = null;
                this.siteData = {};
                this.entries = [];
                this.photos = [];
                this.isDirty = false;
                this.uploadedPhotoIds = new Set();
            },
            
            // Load project from object (from localStorage or server)
            // IMPORTANT: Updates objects in-place to maintain references
            load: function(data) {
                // CRITICAL FIX: Determine the authoritative project ID from ALL sources
                // Priority: _metadata.project_id > data.currentProjectId > data.project_id > siteData.project_id
                // BOTH project_id AND currentProjectId MUST be set together to prevent duplicates
                const authoritativeId = data._metadata?.project_id || data.currentProjectId || data.project_id || data.siteData?.project_id || null;
                
                // Set BOTH IDs together - this is critical for preventing duplicates
                this.currentProjectId = authoritativeId;
                this.project_id = authoritativeId || generateUUID();
                this.currentProjectName = data._metadata?.name || data.currentProjectName || data.name || null;
                
                console.log('[ProjectState.load] Set IDs:', { currentProjectId: this.currentProjectId, project_id: this.project_id });
                
                // TASK 2: Update URL with project ID whenever a project is loaded
                if (authoritativeId && typeof updateUrlWithProjectId === 'function') {
                    updateUrlWithProjectId(authoritativeId);
                }
                
                // Clear and repopulate siteData (maintains reference for legacy code)
                Object.keys(this.siteData).forEach(key => delete this.siteData[key]);
                Object.assign(this.siteData, data.siteData || {});
                
                // Clear and repopulate entries array (maintains reference)
                this.entries.length = 0;
                this.entries.push(...migrateEntries(data.entries || []));
                
                // Clear and repopulate photos array (migrate projects without photos)
                this.photos.length = 0;
                if (Array.isArray(data.photos)) {
                    this.photos.push(...data.photos);
                }
                
                this.isDirty = false;
                // Reset upload tracker when loading a new project (new session context)
                this.uploadedPhotoIds = new Set();
                // CRITICAL: Use currentProjectId (server's key) for siteData.project_id
                // This ensures future saves update the correct project instead of creating duplicates
                this.siteData.project_id = this.currentProjectId || this.project_id;
            },
            
            // Mark as dirty (has unsaved changes)
            markDirty: function() {
                this.isDirty = true;
            },
            
            // Get current state as plain object for saving
            toObject: function() {
                return {
                    project_id: this.project_id,
                    siteData: this.siteData,
                    entries: this.entries,
                    photos: this.photos
                };
            }
        };
        
        // Initialize with empty state
        ProjectState.init();
        
        // ==================================================================================
        // DATE FORMATTING HELPERS
        // ==================================================================================
        // Format ISO date (YYYY-MM-DD) to display format (M/D/YY)
        function formatDateForDisplay(isoDate) {
            if (!isoDate) return '';
            const parts = isoDate.split('-');
            if (parts.length !== 3) return isoDate;
            const year = parts[0];
            const month = parseInt(parts[1], 10);
            const day = parseInt(parts[2], 10);
            const yy = year.slice(-2);
            return `${month}/${day}/${yy}`;
        }
        
        // Parse display date (M/D/YY) to ISO format (YYYY-MM-DD)
        function parseDateFromDisplay(displayDate) {
            if (!displayDate) return '';
            const parts = displayDate.split('/');
            if (parts.length !== 3) return displayDate;
            const month = parts[0].padStart(2, '0');
            const day = parts[1].padStart(2, '0');
            let year = parts[2];
            if (year.length === 2) {
                year = (parseInt(year, 10) > 50 ? '19' : '20') + year;
            }
            return `${year}-${month}-${day}`;
        }
        
        // Get today's date in ISO format (YYYY-MM-DD)
        function getTodayISO() {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Get today's date in display format (M/D/YY)
        function getTodayDisplay() {
            return formatDateForDisplay(getTodayISO());
        }
        
        // ==================================================================================
        // PROJECT STORE - Centralized cache for projects list
        // ==================================================================================
        const ProjectStore = {
            projects: [],           // Cached array of project metadata from server
            lastFetched: null,      // Timestamp of last fetch
            isLoading: false,       // Loading state
            
            // Update the cache with new projects
            setProjects(projects) {
                this.projects = projects;
                this.lastFetched = Date.now();
                this.notifyListeners();
            },
            
            // Get cached projects
            getProjects() {
                return this.projects;
            },
            
            // Clear the cache
            clear() {
                this.projects = [];
                this.lastFetched = null;
                this.notifyListeners();
            },
            
            // Listeners for cache updates
            listeners: [],
            addListener(fn) {
                this.listeners.push(fn);
            },
            removeListener(fn) {
                this.listeners = this.listeners.filter(l => l !== fn);
            },
            notifyListeners() {
                this.listeners.forEach(fn => fn(this.projects));
            }
        };
        
        // ==================================================================================
        // PROJECT SERVICE - Centralized API for all project operations
        // ==================================================================================
        const ProjectService = {
            // List all projects from backend (fetches all pages automatically)
            async listProjects() {
                try {
                    ProjectStore.isLoading = true;
                    let allProjects = [];
                    let offset = 0;
                    const limit = 100;
                    let hasMore = true;
                    
                    // Fetch all pages until no more data
                    while (hasMore) {
                        const response = await fetch(`/api/projects?limit=${limit}&offset=${offset}`, {
                            headers: {
                                'X-User-Id': 'default',
                                'X-User-Role': 'admin'
                            }
                        });
                        if (!response.ok) {
                            ProjectStore.isLoading = false;
                            return allProjects;
                        }
                        const data = await response.json();
                        // Handle new paginated response format: {items, total, limit, offset, hasMore}
                        const pageProjects = Array.isArray(data) ? data : (data.items || []);
                        allProjects = allProjects.concat(pageProjects);
                        hasMore = data.hasMore === true;
                        offset += limit;
                        
                        // Safety break - max 10 pages (1000 projects)
                        if (offset >= 1000) break;
                    }
                    
                    // Fix "Unknown" project names
                    let projects = await this.fixUnknownProjectNames(allProjects);
                    
                    ProjectStore.setProjects(projects);
                    ProjectStore.isLoading = false;
                    return projects;
                } catch (err) {
                    console.error('[ProjectService] Error listing projects:', err);
                    ProjectStore.isLoading = false;
                    return [];
                }
            },
            
            // Get single project by ID
            async getProject(id) {
                console.log('[ProjectService] Getting project:', id);
                if (!id || typeof id !== 'string') {
                    throw new Error('Invalid project ID');
                }
                try {
                    const response = await fetch(`/api/projects/${id}`);
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.message || errData.error || 'Failed to fetch project');
                    }
                    return await response.json();
                } catch (err) {
                    console.error('[ProjectService] Error getting project:', err);
                    throw err;
                }
            },
            
            // Create new project
            async createProject(name) {
                try {
                    const response = await fetch('/api/projects/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error || 'Failed to create project');
                    }
                    const result = await response.json();
                    // Refresh cache
                    await this.listProjects();
                    return result;
                } catch (err) {
                    console.error('[ProjectService] Error creating project:', err);
                    throw err;
                }
            },
            
            // Update existing project
            async updateProject(id, data) {
                console.log('[ProjectService] Updating project:', id);
                if (!id || typeof id !== 'string') {
                    throw new Error('Invalid project ID');
                }
                try {
                    const response = await fetch(`/api/projects/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error || 'Failed to update project');
                    }
                    const result = await response.json();
                    // Refresh cache
                    await this.listProjects();
                    return result;
                } catch (err) {
                    console.error('[ProjectService] Error updating project:', err);
                    throw err;
                }
            },
            
            // Delete one or many projects (batch delete)
            async deleteProjects(ids) {
                const idsArray = Array.isArray(ids) ? ids : [ids];
                console.log('[ProjectService] Deleting projects:', idsArray);
                
                const results = await Promise.allSettled(
                    idsArray.map(async (id) => {
                        const response = await fetch(`/api/projects/${id}`, {
                            method: 'DELETE'
                        });
                        if (!response.ok) {
                            throw new Error(`Failed to delete ${id}`);
                        }
                        return id;
                    })
                );
                
                const succeeded = results.filter(r => r.status === 'fulfilled').map(r => r.value);
                const failed = results.filter(r => r.status === 'rejected').map((r, i) => idsArray[i]);
                
                console.log('[ProjectService] Deleted:', succeeded.length, 'Failed:', failed.length);
                
                // Refresh cache
                await this.listProjects();
                
                return { succeeded, failed };
            },
            
            // Duplicate a project
            async duplicateProject(id) {
                console.log('[ProjectService] Duplicating project:', id);
                if (!id || typeof id !== 'string') {
                    throw new Error('Invalid project ID');
                }
                try {
                    const response = await fetch(`/api/projects/${id}/duplicate`, {
                        method: 'POST'
                    });
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.message || errData.error || 'Failed to duplicate project');
                    }
                    const result = await response.json();
                    // Refresh cache
                    await this.listProjects();
                    return result;
                } catch (err) {
                    console.error('[ProjectService] Error duplicating project:', err);
                    throw err;
                }
            },
            
            // Fix "Unknown" project names by computing fallback and persisting
            async fixUnknownProjectNames(projects) {
                const fixPromises = [];
                
                for (const proj of projects) {
                    if (!proj.name || proj.name.trim() === '' || proj.name === 'Unknown') {
                        // Compute fallback name - ignore customer if it's also "Unknown"
                        let customerName = proj.customer && proj.customer.trim() && proj.customer !== 'Unknown' 
                            ? proj.customer 
                            : null;
                        
                        // Add date suffix for uniqueness
                        let dateSuffix = '';
                        if (proj.created_at) {
                            try {
                                const d = new Date(proj.created_at);
                                const mm = String(d.getMonth() + 1).padStart(2, '0');
                                const dd = String(d.getDate()).padStart(2, '0');
                                const yy = String(d.getFullYear()).slice(-2);
                                dateSuffix = ` (created ${mm}/${dd}/${yy})`;
                            } catch (e) {}
                        }
                        
                        // Build the fixed name
                        let fixedName;
                        if (customerName) {
                            // Has real customer name - use it with optional date
                            fixedName = customerName + (dateSuffix || '');
                        } else {
                            // No real customer - use "Unnamed Project" with date to make it unique
                            fixedName = 'Unnamed Project' + (dateSuffix || ` (${proj.id.slice(0,8)})`);
                        }
                        
                        proj.name = fixedName; // Update in memory immediately
                        
                        // Persist the fix to server (fire and forget)
                        fixPromises.push(
                            fetch(`/api/projects/${proj.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ name: fixedName })
                            }).then(() => {
                                console.log('[ProjectService] Fixed project name:', proj.id, '→', fixedName);
                            }).catch(err => {
                                console.warn('[ProjectService] Failed to persist name fix:', proj.id, err);
                            })
                        );
                    }
                }
                
                // Wait for all fixes to complete (but don't block if they fail)
                if (fixPromises.length > 0) {
                    await Promise.allSettled(fixPromises);
                }
                
                return projects;
            }
        };
        
        // ==================================================================================
        // BUILD PROJECT LABEL - Consistent project label generation
        // ==================================================================================
        function buildProjectLabel(proj, options = {}) {
            const { includeDate = true, includeUnits = true } = options;
            
            // Use project name first, fallback to customer
            let label = proj.name || proj.customer || 'Unnamed Project';
            
            // Add unit counts
            if (includeUnits) {
                const evap = proj.evap_count || proj.evapCount || 0;
                const cond = proj.cond_count || proj.condCount || 0;
                if (evap > 0 || cond > 0) {
                    label += ` (${evap} evap, ${cond} cond)`;
                }
            }
            
            // Add date
            if (includeDate && (proj.saved_at || proj.last_modified)) {
                try {
                    const d = new Date(proj.saved_at || proj.last_modified);
                    const mm = String(d.getMonth() + 1).padStart(2, '0');
                    const dd = String(d.getDate()).padStart(2, '0');
                    const yy = String(d.getFullYear()).slice(-2);
                    const hh = String(d.getHours()).padStart(2, '0');
                    const min = String(d.getMinutes()).padStart(2, '0');
                    label += ` - ${mm}/${dd}/${yy} ${hh}:${min}`;
                } catch (e) {}
            }
            
            return label;
        }
        
        // ==================================================================================
        // GOOGLE PLACES UI HELPERS
        // ==================================================================================
        function updateGooglePlacesUI() {
            // Function is called before/after NavigationController init; guard accordingly.
            const enabled = (typeof NavigationController !== 'undefined') && NavigationController.googlePlacesEnabled === true;
            const helpMsg = enabled
                ? 'Show nearby businesses at your location'
                : 'Google Places not configured. Set GOOGLE_PLACES_API_KEY in .env and restart the server.';
            
            const buttonIds = ['useLocationBtn', 'ci-show-businesses'];
            buttonIds.forEach((id) => {
                const btn = document.getElementById(id);
                if (!btn) return;
                
                btn.title = helpMsg;
                
                if (enabled) {
                    btn.disabled = false;
                    btn.style.opacity = '';
                    btn.style.cursor = 'pointer';
                } else {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                }
            });
        }
        
        // ==================================================================================
        // NAVIGATION CONTROLLER - Manages currentView and view rendering
        // ==================================================================================
        const NavigationController = {
            currentView: 'home', // 'home', 'projects', 'customerInfo', 'currentProject'
            
            // Projects view state
            projectsSearchQuery: '',
            projectsSortField: 'dateLastModified',
            projectsSortDir: 'desc',
            cachedProjects: [],
            selectMode: false,
            selectedProjectIds: new Set(),
            
            // Deleted projects view state
            deletedSelectMode: false,
            deletedSelectedIds: new Set(),
            
            // Recently opened tracking (session-based, deduplicated, limit 5)
            recentlyOpenedIds: [],
            
            // Initialize navigation
            init() {
                this.setupDrawer();
                this.setupHashListener();
                this.setupHomeButtons();
                this.setupProjectsControls();
                this.setupDeletedProjectsControls();
                
                // Check bills feature flag
                this.checkBillsFeature();
                
                // Check for saved new project date from localStorage (set before reload in startNewProject)
                const savedNewDate = localStorage.getItem('newProjectDate');
                if (savedNewDate) {
                    localStorage.removeItem('newProjectDate');
                    siteData.date = savedNewDate;
                    siteData.visitDate = formatDateForDisplay(savedNewDate);
                    ProjectState.siteData.date = savedNewDate;
                    ProjectState.siteData.visitDate = siteData.visitDate;
                }
                
                // Initial navigation based on URL path (support both path and legacy hash)
                setTimeout(() => {
                    // If there's a projectId in the URL, skip navigation here - loadProjectById will handle it
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('projectId')) {
                        console.log('[nav] Deep link detected - deferring navigation to loadProjectById');
                        return;
                    }
                    
                    let path = window.location.pathname.replace(/^\//, '');
                    const hash = window.location.hash.replace('#', '');
                    
                    // Handle encoded hash URLs (e.g., /%23home -> /home)
                    if (path.startsWith('%23') || path.startsWith('#')) {
                        const cleanPath = path.replace(/^(%23|#)/, '');
                        window.history.replaceState(null, '', '/' + cleanPath);
                        path = cleanPath;
                    }
                    
                    // Project-specific views that require a loaded project
                    const projectRequiredPaths = ['current-project', 'utility-bills', 'customer-info', 'print'];
                    const isProjectPath = projectRequiredPaths.includes(path);
                    
                    console.log('[nav] DEBUG: path=' + path + ', isProjectPath=' + isProjectPath);
                    console.log('[nav] DEBUG: ProjectState.currentProjectId=' + ProjectState.currentProjectId);
                    console.log('[nav] DEBUG: ProjectState.project_id=' + ProjectState.project_id);
                    
                    // If navigating to a project-specific view, ensure project is loaded first
                    if (isProjectPath && !ProjectState.currentProjectId && !ProjectState.project_id) {
                        console.log('[nav] Project view requested but no project loaded - attempting restore');
                        
                        // Try to restore from localStorage
                        const dataStr = localStorage.getItem('currentProject');
                        console.log('[nav] DEBUG: localStorage currentProject exists:', !!dataStr);
                        if (dataStr) {
                            console.log('[nav] DEBUG: localStorage length:', dataStr.length);
                            try {
                                const data = JSON.parse(dataStr);
                                console.log('[nav] DEBUG: parsed data keys:', Object.keys(data));
                                console.log('[nav] DEBUG: data.currentProjectId:', data.currentProjectId);
                                console.log('[nav] DEBUG: data.entries?.length:', data.entries?.length);
                                console.log('[nav] DEBUG: data.siteData?.customer:', data.siteData?.customer);
                                
                                if (data.currentProjectId || data.project_id || data.siteData?.project_id) {
                                    console.log('[nav] Restoring project from localStorage for refresh');
                                    ProjectState.load(data);
                                    
                                    console.log('[nav] DEBUG after load: entries.length:', entries.length);
                                    console.log('[nav] DEBUG after load: siteData.customer:', siteData.customer);
                                    
                                    console.log('[nav] Project restored, proceeding to:', path);
                                } else {
                                    console.log('[nav] No project ID in localStorage, redirecting to home');
                                    window.history.replaceState(null, '', '/home');
                                    path = 'home';
                                }
                            } catch (e) {
                                console.error('[nav] Failed to restore project:', e);
                                window.history.replaceState(null, '', '/home');
                                path = 'home';
                            }
                        } else {
                            console.log('[nav] No saved project, redirecting to home');
                            window.history.replaceState(null, '', '/home');
                            path = 'home';
                        }
                    }
                    
                    // Handle legacy hash URLs by redirecting to path
                    if (hash && !path) {
                        window.history.replaceState(null, '', '/' + hash);
                        this.handlePathChange();
                    } else if (path) {
                        this.handlePathChange();
                    } else {
                        this.setView('home');
                    }
                }, 100);
            },
            
            // Setup hamburger drawer
            setupDrawer() {
                const hamburgerBtn = document.getElementById('hamburgerBtn');
                const navDrawer = document.getElementById('navDrawer');
                const navDrawerOverlay = document.getElementById('navDrawerOverlay');
                const navDrawerCloseBtn = document.getElementById('navDrawerCloseBtn');
                const navLinks = document.querySelectorAll('.nav-drawer-items a');
                
                if (hamburgerBtn) hamburgerBtn.addEventListener('click', () => this.openDrawer());
                if (navDrawerCloseBtn) navDrawerCloseBtn.addEventListener('click', () => this.closeDrawer());
                if (navDrawerOverlay) navDrawerOverlay.addEventListener('click', () => this.closeDrawer());
                
                // Nav link click handlers
                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.closeDrawer();  // Close drawer first to prevent double-click issue
                        const nav = link.getAttribute('data-nav');
                        this.setView(nav);
                    });
                });
            },
            
            openDrawer() {
                document.getElementById('navDrawer').classList.add('open');
                document.getElementById('navDrawerOverlay').classList.add('show');
            },
            
            closeDrawer() {
                document.getElementById('navDrawer').classList.remove('open');
                document.getElementById('navDrawerOverlay').classList.remove('show');
            },
            
            // Setup popstate listener for path-based routing
            setupHashListener() {
                window.addEventListener('popstate', () => this.handlePathChange());
            },
            
            handlePathChange() {
                const path = window.location.pathname.replace(/^\//, '') || 'home';
                
                // Map path to view
                const pathToView = {
                    'home': 'home',
                    'projects': 'projects',
                    'deleted-projects': 'deletedProjects',
                    'customer-info': 'customerInfo',
                    'current-project': 'currentProject',
                    'utility-bills': 'utilityBills',
                    'print': 'printView'
                };
                
                const view = pathToView[path] || 'home';
                if (view !== this.currentView) {
                    this.setView(view, false); // false = don't update URL again
                }
            },
            
            // Set current view
            setView(viewName, updateHash = true) {
                // Capture previous view before overwriting
                const previousView = this.currentView;
                
                // Reset selection state when leaving Projects or Deleted Projects views
                // This prevents stale bulk selection state from persisting across navigation
                if (previousView === 'projects' && viewName !== 'projects') {
                    this.selectMode = false;
                    this.selectedProjectIds.clear();
                    document.getElementById('projectsSelectBar')?.classList.add('hidden');
                    document.getElementById('projectsListContainer')?.classList.remove('has-select-bar');
                    const projectsSelectBtn = document.getElementById('projectsSelectModeBtn');
                    if (projectsSelectBtn) projectsSelectBtn.textContent = '☑️ Select';
                }
                if (previousView === 'deletedProjects' && viewName !== 'deletedProjects') {
                    this.deletedSelectMode = false;
                    this.deletedSelectedIds.clear();
                    document.getElementById('deletedProjectsSelectBar')?.classList.add('hidden');
                    document.getElementById('deletedProjectsListContainer')?.classList.remove('has-select-bar');
                    const deletedSelectBtn = document.getElementById('deletedProjectsSelectModeBtn');
                    if (deletedSelectBtn) deletedSelectBtn.textContent = '☑️ Select';
                }
                
                this.currentView = viewName;
                
                // Update URL path (using pushState for clean URLs)
                // IMPORTANT: Only preserve ?projectId for project-specific views
                if (updateHash) {
                    const viewToPath = {
                        'home': '/home',
                        'projects': '/projects',
                        'deletedProjects': '/deleted-projects',
                        'customerInfo': '/customer-info',
                        'currentProject': '/current-project',
                        'utilityBills': '/utility-bills',
                        'printView': '/print'
                    };
                    const newPath = viewToPath[viewName] || '/home';
                    
                    // Only preserve ?projectId for project-specific views
                    const projectViews = ['currentProject', 'utilityBills', 'customerInfo', 'printView'];
                    const shouldPreserveProjectId = projectViews.includes(viewName);
                    
                    let newUrl = newPath;
                    if (shouldPreserveProjectId) {
                        // Keep the projectId query parameter
                        const queryString = window.location.search;
                        newUrl = newPath + queryString;
                    }
                    // For non-project views (home, projects, etc.), use clean URL without query params
                    
                    if (window.location.pathname + window.location.search !== newUrl) {
                        window.history.pushState(null, '', newUrl);
                    }
                }
                
                // Hide all views
                document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
                
                // Update body class for CSS targeting
                document.body.classList.remove('view-home', 'view-projects', 'view-deletedProjects', 'view-customerInfo', 'view-currentProject', 'view-utilityBills', 'view-printView');
                document.body.classList.add(`view-${viewName}`);
                
                // Update active nav link
                document.querySelectorAll('.nav-drawer-items a').forEach(link => {
                    const nav = link.getAttribute('data-nav');
                    if (nav === viewName) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });
                
                // Render the appropriate view
                switch (viewName) {
                    case 'home':
                        document.getElementById('homeView').classList.add('active');
                        this.renderHomeView();
                        break;
                    case 'projects':
                        document.getElementById('projectsView').classList.add('active');
                        this.renderProjectsView();
                        break;
                    case 'deletedProjects':
                        document.getElementById('deletedProjectsView').classList.add('active');
                        this.renderDeletedProjectsView();
                        break;
                    case 'customerInfo':
                        document.getElementById('customerInfoView').classList.add('active');
                        this.renderCustomerInfoView();
                        break;
                    case 'currentProject':
                        document.getElementById('currentProjectView').classList.add('active');
                        this.renderCurrentProjectView();
                        break;
                    case 'utilityBills':
                        document.getElementById('utilityBillsView').classList.add('active');
                        this.renderBillsView();
                        break;
                    case 'printView':
                        document.getElementById('printViewContainer').classList.add('active');
                        this.renderPrintView();
                        break;
                }
                
                // Close drawer after navigation
                this.closeDrawer();
            },
            
            // Route-scoped refresh: Only refresh the current view's data
            // Does NOT reset route, activeProjectId, or selection state
            async refreshCurrentView() {
                console.log('[refresh] Refreshing current view:', this.currentView);
                
                switch (this.currentView) {
                    case 'home':
                        // Refresh only home data (recent projects list)
                        await this.renderHomeView();
                        break;
                    case 'projects':
                        // Refresh only projects list, preserve search/sort/selection state
                        try {
                            this.cachedProjects = await ProjectService.listProjects();
                            this.renderProjectsList();
                        } catch (err) {
                            console.error('[refresh] Failed to refresh projects:', err);
                        }
                        break;
                    case 'deletedProjects':
                        // Refresh only deleted projects list
                        await this.renderDeletedProjectsView();
                        break;
                    case 'currentProject':
                        // Refresh current project from server (if we have an ID)
                        // IMPORTANT: Uses minimal update path that does NOT reset:
                        //   - URL, selection state, dirty flags, route
                        // Only refreshes: entries, siteData, photos data
                        const projectId = ProjectState.currentProjectId || ProjectState.project_id;
                        if (projectId) {
                            try {
                                const projectData = await ProjectService.getProject(projectId);
                                if (projectData) {
                                    // Minimal data update - preserve selection/dirty/URL state
                                    // Clear and repopulate arrays in place (maintains references)
                                    Object.keys(siteData).forEach(key => delete siteData[key]);
                                    Object.assign(siteData, projectData.siteData || {});
                                    
                                    entries.length = 0;
                                    if (typeof migrateEntries === 'function') {
                                        entries.push(...migrateEntries(projectData.entries || []));
                                    } else {
                                        entries.push(...(projectData.entries || []));
                                    }
                                    
                                    photos.length = 0;
                                    if (Array.isArray(projectData.photos)) {
                                        photos.push(...projectData.photos);
                                    }
                                    
                                    // Re-render the view without navigation/URL changes
                                    this.renderCurrentProjectView();
                                    console.log('[refresh] Refreshed project data without state reset');
                                }
                            } catch (err) {
                                console.error('[refresh] Failed to refresh project:', err);
                            }
                        }
                        break;
                    case 'utilityBills':
                        // Refresh bills view
                        const billsProjectId = ProjectState.currentProjectId;
                        if (billsProjectId) {
                            await this.loadBillsData(billsProjectId);
                        }
                        break;
                    default:
                        // For other views, just re-render
                        console.log('[refresh] No specific refresh for view:', this.currentView);
                        break;
                }
                
                console.log('[refresh] Completed for:', this.currentView);
            },
            
            // Setup Home page buttons
            setupHomeButtons() {
                const startNewBtn = document.getElementById('startNewProjectBtn');
                const pastSitewalksBtn = document.getElementById('pastSitewalksBtn');
                const homeImportBtn = document.getElementById('homeImportCsvBtn');
                const homeImportFile = document.getElementById('homeImportCsvFile');
                
                if (startNewBtn) {
                    startNewBtn.addEventListener('click', () => {
                        // Clear state and go to customer info
                        newProject();
                        this.setView('customerInfo');
                    });
                }
                
                if (pastSitewalksBtn) {
                    pastSitewalksBtn.addEventListener('click', () => {
                        this.setView('projects');
                    });
                }
                
                // Home screen Import CSV button
                if (homeImportBtn && homeImportFile) {
                    homeImportBtn.addEventListener('click', () => {
                        homeImportFile.click();
                    });
                    
                    homeImportFile.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        // Reset file input
                        homeImportFile.value = '';
                        
                        try {
                            homeImportBtn.disabled = true;
                            homeImportBtn.innerHTML = '<span>⏳</span> Importing...';
                            
                            const formData = new FormData();
                            formData.append('file', file);
                            
                            const response = await fetch('/api/import-csv', {
                                method: 'POST',
                                body: formData
                            });
                            
                            const result = await response.json();
                            
                            if (result.success) {
                                console.log('[import-csv] Success:', result);
                                
                                // Load the imported project
                                const loaded = await loadProjectFromService(result.projectId);
                                if (loaded) {
                                    this.addToRecentlyOpened(result.projectId);
                                    this.setView('currentProject');
                                    showToast(`Imported "${result.projectName}" successfully! ${result.evapCount} evaporators, ${result.condCount} condensers`, 'success');
                                }
                            } else {
                                showToast('Import failed: ' + (result.error || 'Unknown error'), 'error');
                            }
                        } catch (err) {
                            console.error('[import-csv] Error:', err);
                            showToast('Import failed: ' + err.message, 'error');
                        } finally {
                            homeImportBtn.disabled = false;
                            homeImportBtn.innerHTML = '<span>📥</span> Import Project from CSV';
                        }
                    });
                }
            },
            
            // Setup Projects page controls
            setupProjectsControls() {
                const searchInput = document.getElementById('projectsSearchInput');
                const sortSelect = document.getElementById('projectsSortSelect');
                const sortDirBtn = document.getElementById('projectsSortDirBtn');
                
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.projectsSearchQuery = e.target.value.trim().toLowerCase();
                        this.renderProjectsList();
                    });
                }
                
                if (sortSelect) {
                    sortSelect.addEventListener('change', (e) => {
                        this.projectsSortField = e.target.value;
                        this.renderProjectsList();
                    });
                }
                
                if (sortDirBtn) {
                    sortDirBtn.addEventListener('click', () => {
                        this.projectsSortDir = this.projectsSortDir === 'desc' ? 'asc' : 'desc';
                        sortDirBtn.textContent = this.projectsSortDir === 'desc' ? '↓' : '↑';
                        this.renderProjectsList();
                    });
                }
                
                // Import CSV button handler
                const importCsvBtn = document.getElementById('importCsvBtn');
                const importCsvFile = document.getElementById('importCsvFile');
                
                if (importCsvBtn && importCsvFile) {
                    importCsvBtn.addEventListener('click', () => {
                        importCsvFile.click();
                    });
                    
                    importCsvFile.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        // Reset file input for next use
                        importCsvFile.value = '';
                        
                        try {
                            importCsvBtn.disabled = true;
                            importCsvBtn.textContent = '⏳ Importing...';
                            
                            const formData = new FormData();
                            formData.append('file', file);
                            
                            const response = await fetch('/api/import-csv', {
                                method: 'POST',
                                body: formData
                            });
                            
                            const result = await response.json();
                            
                            if (result.success) {
                                console.log('[import-csv] Success:', result);
                                
                                // Load the imported project
                                const loaded = await loadProjectFromService(result.projectId);
                                if (loaded) {
                                    // Add to recently opened
                                    NavigationController.addToRecentlyOpened(result.projectId);
                                    
                                    // Navigate to current project view
                                    NavigationController.setView('currentProject');
                                    
                                    showToast(`Imported "${result.projectName}" successfully! ${result.evapCount} evaporators, ${result.condCount} condensers`, 'success');
                                }
                            } else {
                                showToast('Import failed: ' + (result.error || 'Unknown error'), 'error');
                            }
                        } catch (err) {
                            console.error('[import-csv] Error:', err);
                            showToast('Import failed: ' + err.message, 'error');
                        } finally {
                            importCsvBtn.disabled = false;
                            importCsvBtn.textContent = '📥 Import CSV';
                        }
                    });
                }
                
                // Select mode button handlers
                const selectModeBtn = document.getElementById('projectsSelectModeBtn');
                const selectAllBtn = document.getElementById('projectsSelectAllBtn');
                const deselectAllBtn = document.getElementById('projectsDeselectAllBtn');
                const deleteSelectedBtn = document.getElementById('projectsDeleteSelectedBtn');
                const cancelSelectBtn = document.getElementById('projectsCancelSelectBtn');
                
                if (selectModeBtn) selectModeBtn.addEventListener('click', () => this.toggleSelectMode());
                if (selectAllBtn) selectAllBtn.addEventListener('click', () => this.selectAllProjects());
                if (deselectAllBtn) deselectAllBtn.addEventListener('click', () => this.deselectAllProjects());
                if (deleteSelectedBtn) deleteSelectedBtn.addEventListener('click', () => this.deleteSelectedProjects());
                if (cancelSelectBtn) cancelSelectBtn.addEventListener('click', () => this.toggleSelectMode());
            },
            
            // Setup Deleted Projects page controls (bulk selection)
            setupDeletedProjectsControls() {
                const selectModeBtn = document.getElementById('deletedProjectsSelectModeBtn');
                const selectAllBtn = document.getElementById('deletedProjectsSelectAllBtn');
                const deselectAllBtn = document.getElementById('deletedProjectsDeselectAllBtn');
                const invertSelectionBtn = document.getElementById('deletedProjectsInvertSelectionBtn');
                const bulkRestoreBtn = document.getElementById('deletedProjectsBulkRestoreBtn');
                const bulkDeleteBtn = document.getElementById('deletedProjectsBulkDeleteBtn');
                const cancelSelectBtn = document.getElementById('deletedProjectsCancelSelectBtn');
                
                if (selectModeBtn) selectModeBtn.addEventListener('click', () => this.toggleDeletedSelectMode());
                if (selectAllBtn) selectAllBtn.addEventListener('click', () => this.selectAllDeletedProjects());
                if (deselectAllBtn) deselectAllBtn.addEventListener('click', () => this.deselectAllDeletedProjects());
                if (invertSelectionBtn) invertSelectionBtn.addEventListener('click', () => this.invertDeletedSelection());
                if (bulkRestoreBtn) bulkRestoreBtn.addEventListener('click', () => this.bulkRestoreDeletedProjects());
                if (bulkDeleteBtn) bulkDeleteBtn.addEventListener('click', () => this.bulkDeleteDeletedProjects());
                if (cancelSelectBtn) cancelSelectBtn.addEventListener('click', () => this.toggleDeletedSelectMode());
            },
            
            // Add project to recently opened list (deduplicated, limit 5)
            addToRecentlyOpened(projectId) {
                if (!projectId) return;
                // Remove existing entry if present
                this.recentlyOpenedIds = this.recentlyOpenedIds.filter(id => id !== projectId);
                // Add to front
                this.recentlyOpenedIds.unshift(projectId);
                // Limit to 5
                if (this.recentlyOpenedIds.length > 5) {
                    this.recentlyOpenedIds = this.recentlyOpenedIds.slice(0, 5);
                }
            },
            
            // ==================================================================================
            // RENDER HOME VIEW
            // ==================================================================================
            async renderHomeView() {
                const recentList = document.getElementById('homeRecentList');
                if (!recentList) return;
                
                recentList.innerHTML = '<div class="home-recent-empty">Loading recent projects...</div>';
                
                try {
                    const projects = await ProjectService.listProjects();
                    
                    // Build deduplicated list: prioritize session-opened, then by last_modified
                    let sorted = [];
                    const projectMap = new Map(projects.map(p => [p.id, p]));
                    const seenIds = new Set();
                    
                    // First add session-opened projects (in order)
                    for (const id of this.recentlyOpenedIds) {
                        if (projectMap.has(id) && !seenIds.has(id)) {
                            sorted.push(projectMap.get(id));
                            seenIds.add(id);
                        }
                    }
                    
                    // Fill remaining slots from most recently modified
                    const byLastModified = [...projects].sort((a, b) => {
                        const aDate = new Date(a.last_modified || a.updated_at || a.saved_at || 0);
                        const bDate = new Date(b.last_modified || b.updated_at || b.saved_at || 0);
                        return bDate - aDate;
                    });
                    
                    for (const proj of byLastModified) {
                        if (!seenIds.has(proj.id)) {
                            sorted.push(proj);
                            seenIds.add(proj.id);
                        }
                        if (sorted.length >= 5) break;
                    }
                    
                    sorted = sorted.slice(0, 5);
                    
                    if (sorted.length === 0) {
                        recentList.innerHTML = '<div class="home-recent-empty">No recent projects yet. Start a new project!</div>';
                        return;
                    }
                    
                    recentList.innerHTML = '';
                    sorted.forEach(proj => {
                        const item = document.createElement('div');
                        item.className = 'home-recent-item';
                        
                        const evap = proj.evap_count || 0;
                        const cond = proj.cond_count || 0;
                        let metaParts = [];
                        if (proj.customer && proj.customer !== proj.name) metaParts.push(proj.customer);
                        if (evap > 0 || cond > 0) metaParts.push(`${evap}E/${cond}C`);
                        
                        item.innerHTML = `
                            <div class="home-recent-info">
                                <div class="home-recent-name">${proj.name || proj.customer || 'Unnamed'}</div>
                                <div class="home-recent-meta">${metaParts.join(' • ')}</div>
                            </div>
                            <button class="home-recent-open" data-id="${proj.id}">Open →</button>
                        `;
                        
                        item.querySelector('.home-recent-open').addEventListener('click', async (e) => {
                            e.stopPropagation();
                            await loadProjectFromService(proj.id);
                            this.setView('currentProject');
                        });
                        
                        item.addEventListener('click', async () => {
                            await loadProjectFromService(proj.id);
                            this.setView('currentProject');
                        });
                        
                        recentList.appendChild(item);
                    });
                } catch (err) {
                    console.error('[NavigationController] Error loading recent projects:', err);
                    recentList.innerHTML = '<div class="home-recent-empty">Failed to load projects</div>';
                }
            },
            
            // ==================================================================================
            // RENDER PROJECTS VIEW
            // ==================================================================================
            async renderProjectsView() {
                const container = document.getElementById('projectsListContainer');
                if (!container) return;
                
                container.innerHTML = '<div class="projects-empty">Loading projects...</div>';
                
                try {
                    this.cachedProjects = await ProjectService.listProjects();
                    this.renderProjectsList();
                } catch (err) {
                    console.error('[NavigationController] Error loading projects:', err);
                    container.innerHTML = '<div class="projects-empty">Failed to load projects</div>';
                }
            },
            
            renderProjectsList() {
                const container = document.getElementById('projectsListContainer');
                if (!container) return;
                
                let filtered = [...this.cachedProjects];
                
                // Apply search filter
                if (this.projectsSearchQuery) {
                    const q = this.projectsSearchQuery;
                    filtered = filtered.filter(p => {
                        const searchStr = [
                            p.name || '',
                            p.customer || '',
                            p.address || '',
                            p.street || '',
                            p.city || ''
                        ].join(' ').toLowerCase();
                        return searchStr.includes(q);
                    });
                }
                
                // Apply sort
                filtered.sort((a, b) => {
                    let aVal, bVal;
                    let isDate = false;
                    let isString = false;
                    
                    // Helper to parse dates in various formats (ISO, M/D/YY, M/D/YYYY)
                    const parseDate = (dateStr) => {
                        if (!dateStr) return 0;
                        // Try ISO format first (YYYY-MM-DD or full ISO)
                        let d = new Date(dateStr);
                        if (!isNaN(d.getTime())) return d.getTime();
                        // Try M/D/YY or M/D/YYYY format
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            const month = parseInt(parts[0], 10) - 1;
                            const day = parseInt(parts[1], 10);
                            let year = parseInt(parts[2], 10);
                            if (year < 100) year += 2000; // Convert 25 to 2025
                            return new Date(year, month, day).getTime();
                        }
                        return 0;
                    };
                    
                    switch (this.projectsSortField) {
                        case 'dateOfSiteVisit':
                            aVal = a.site_visit_date || a.date || '';
                            bVal = b.site_visit_date || b.date || '';
                            isDate = true;
                            break;
                        case 'dateLastModified':
                            aVal = a.last_modified || a.updated_at || a.saved_at || '';
                            bVal = b.last_modified || b.updated_at || b.saved_at || '';
                            isDate = true;
                            break;
                        case 'name':
                            aVal = (a.name || a.customer || '').toLowerCase();
                            bVal = (b.name || b.customer || '').toLowerCase();
                            isString = true;
                            break;
                        case 'utilityCompany':
                            aVal = (a.utility || '').toLowerCase();
                            bVal = (b.utility || '').toLowerCase();
                            isString = true;
                            break;
                        default:
                            aVal = a.last_modified || '';
                            bVal = b.last_modified || '';
                            isDate = true;
                    }
                    
                    // For dates, convert to timestamps for proper comparison
                    if (isDate) {
                        const aTime = parseDate(aVal);
                        const bTime = parseDate(bVal);
                        return this.projectsSortDir === 'asc' ? aTime - bTime : bTime - aTime;
                    }
                    
                    // For strings, use localeCompare
                    if (isString) {
                        const cmp = aVal.localeCompare(bVal);
                        return this.projectsSortDir === 'asc' ? cmp : -cmp;
                    }
                    
                    // Fallback comparison
                    if (aVal < bVal) return this.projectsSortDir === 'asc' ? -1 : 1;
                    if (aVal > bVal) return this.projectsSortDir === 'asc' ? 1 : -1;
                    return 0;
                });
                
                if (filtered.length === 0) {
                    container.innerHTML = '<div class="projects-empty">No projects found</div>';
                    return;
                }
                
                container.innerHTML = '';
                filtered.forEach(proj => {
                    const row = document.createElement('div');
                    row.className = 'project-row';
                    
                    const evap = proj.evap_count || 0;
                    const cond = proj.cond_count || 0;
                    
                    let subParts = [];
                    if (proj.customer && proj.customer !== proj.name) subParts.push(proj.customer);
                    if (evap > 0 || cond > 0) subParts.push(`${evap} evap, ${cond} cond`);
                    if (proj.site_visit_date || proj.date) {
                        subParts.push(`Visit: ${formatProjectDate(proj.site_visit_date || proj.date)}`);
                    }
                    if (proj.last_modified) {
                        subParts.push(`Modified: ${formatProjectDate(proj.last_modified)}`);
                    }
                    
                    const isSelected = this.selectedProjectIds.has(proj.id);
                    const checkboxHtml = this.selectMode ? 
                        `<input type="checkbox" class="project-row-checkbox" ${isSelected ? 'checked' : ''}>` : '';
                    
                    row.innerHTML = `
                        ${checkboxHtml}
                        <div class="project-row-info">
                            <div class="project-row-name">${proj.name || proj.customer || 'Unnamed'}</div>
                            <div class="project-row-subline">${subParts.join(' • ')}</div>
                        </div>
                        ${!this.selectMode ? '<button class="project-row-open-btn">Open →</button>' : ''}
                    `;
                    
                    if (this.selectMode) {
                        row.classList.add('selectable');
                        if (isSelected) row.classList.add('selected');
                    }
                    
                    const openBtn = row.querySelector('.project-row-open-btn');
                    if (openBtn) {
                        openBtn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            if (!this.selectMode) {
                                await loadProjectFromService(proj.id);
                                this.setView('currentProject');
                            }
                        });
                    }
                    
                    row.addEventListener('click', async () => {
                        if (this.selectMode) {
                            if (this.selectedProjectIds.has(proj.id)) {
                                this.selectedProjectIds.delete(proj.id);
                                row.classList.remove('selected');
                                row.querySelector('.project-row-checkbox').checked = false;
                            } else {
                                this.selectedProjectIds.add(proj.id);
                                row.classList.add('selected');
                                row.querySelector('.project-row-checkbox').checked = true;
                            }
                            this.updateSelectedCount();
                        } else {
                            await loadProjectFromService(proj.id);
                            this.setView('currentProject');
                        }
                    });
                    
                    // Add stopPropagation to checkbox to prevent row click from also triggering
                    const checkbox = row.querySelector('.project-row-checkbox');
                    if (checkbox) {
                        checkbox.addEventListener('click', (e) => {
                            e.stopPropagation();
                            // Toggle selection
                            if (this.selectedProjectIds.has(proj.id)) {
                                this.selectedProjectIds.delete(proj.id);
                                row.classList.remove('selected');
                                checkbox.checked = false;
                            } else {
                                this.selectedProjectIds.add(proj.id);
                                row.classList.add('selected');
                                checkbox.checked = true;
                            }
                            this.updateSelectedCount();
                        });
                    }
                    
                    container.appendChild(row);
                });
            },
            
            // ==================================================================================
            // SELECT MODE METHODS
            // ==================================================================================
            toggleSelectMode() {
                this.selectMode = !this.selectMode;
                this.selectedProjectIds.clear();
                
                const selectBar = document.getElementById('projectsSelectBar');
                const selectBtn = document.getElementById('projectsSelectModeBtn');
                const listContainer = document.getElementById('projectsListContainer');
                
                if (this.selectMode) {
                    selectBar?.classList.remove('hidden');
                    listContainer?.classList.add('has-select-bar');
                    selectBtn.textContent = '❌ Cancel Select';
                } else {
                    selectBar?.classList.add('hidden');
                    listContainer?.classList.remove('has-select-bar');
                    selectBtn.textContent = '☑️ Select';
                }
                
                this.renderProjectsList();
                this.updateSelectedCount();
            },
            
            selectAllProjects() {
                this.cachedProjects.forEach(p => this.selectedProjectIds.add(p.id));
                this.renderProjectsList();
                this.updateSelectedCount();
            },
            
            deselectAllProjects() {
                this.selectedProjectIds.clear();
                this.renderProjectsList();
                this.updateSelectedCount();
            },
            
            updateSelectedCount() {
                const countEl = document.getElementById('projectsSelectedCount');
                if (countEl) countEl.textContent = `${this.selectedProjectIds.size} selected`;
            },
            
            async deleteSelectedProjects() {
                const count = this.selectedProjectIds.size;
                if (count === 0) {
                    showToast('No projects selected', 'warning');
                    return;
                }
                
                const confirmed = await showConfirmModal({
                    title: 'Delete Projects',
                    message: `Delete ${count} project(s)? They will be moved to Recently Deleted and can be restored within 30 days.`,
                    confirmText: 'Delete',
                    cancelText: 'Cancel',
                    danger: true
                });
                if (!confirmed) return;
                
                try {
                    await ProjectService.deleteProjects([...this.selectedProjectIds]);
                    this.selectMode = false;
                    this.selectedProjectIds.clear();
                    document.getElementById('projectsSelectBar')?.classList.add('hidden');
                    document.getElementById('projectsListContainer')?.classList.remove('has-select-bar');
                    document.getElementById('projectsSelectModeBtn').textContent = '☑️ Select';
                    await this.renderProjectsView();
                } catch (err) {
                    showToast('Failed to delete some projects: ' + err.message, 'error');
                }
            },
            
            // ==================================================================================
            // RENDER DELETED PROJECTS VIEW
            // ==================================================================================
            cachedDeletedProjects: [],
            
            async renderDeletedProjectsView() {
                const container = document.getElementById('deletedProjectsListContainer');
                if (!container) return;
                
                container.innerHTML = '<div class="projects-empty">Loading deleted projects...</div>';
                
                try {
                    const response = await fetch('/api/deleted-projects');
                    if (!response.ok) throw new Error('Failed to fetch deleted projects');
                    const deletedProjects = await response.json();
                    this.cachedDeletedProjects = deletedProjects;
                    
                    if (deletedProjects.length === 0) {
                        container.innerHTML = '<div class="projects-empty">No recently deleted projects</div>';
                        // Hide select bar if no projects
                        document.getElementById('deletedProjectsSelectBar')?.classList.add('hidden');
                        return;
                    }
                    
                    container.innerHTML = '';
                    deletedProjects.forEach(proj => {
                        const row = document.createElement('div');
                        row.className = 'project-row deleted-project-row';
                        row.dataset.projectId = proj.id;
                        
                        const deletedDate = proj.deleted_at ? new Date(proj.deleted_at.replace('Z', '')) : new Date();
                        const deletedDateStr = deletedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                        
                        const daysRemaining = proj.days_remaining || 0;
                        const daysText = daysRemaining === 1 ? '1 day left' : `${daysRemaining} days left`;
                        const urgentClass = daysRemaining <= 7 ? 'urgent' : '';
                        
                        const isSelected = this.deletedSelectedIds.has(proj.id);
                        const checkboxHtml = this.deletedSelectMode 
                            ? `<input type="checkbox" class="deleted-project-checkbox" data-id="${proj.id}" ${isSelected ? 'checked' : ''} style="width: 20px; height: 20px; margin-right: 0.75rem; cursor: pointer;">`
                            : '';
                        
                        row.innerHTML = `
                            <div style="display: flex; align-items: center;">
                                ${checkboxHtml}
                                <div class="project-row-info">
                                    <div class="project-row-name">${proj.name || proj.customer || 'Unnamed'}</div>
                                    <div class="project-row-subline">Deleted: ${deletedDateStr} • <span class="days-remaining ${urgentClass}">${daysText}</span></div>
                                </div>
                            </div>
                            <div class="deleted-project-actions" ${this.deletedSelectMode ? 'style="display: none;"' : ''}>
                                <button class="button restore-btn" data-id="${proj.id}" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">↩️ Restore</button>
                                <button class="button delete-perm-btn" data-id="${proj.id}" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background-color: #dc3545;">🗑️ Delete</button>
                            </div>
                        `;
                        
                        // Checkbox change handler
                        const checkbox = row.querySelector('.deleted-project-checkbox');
                        if (checkbox) {
                            checkbox.addEventListener('change', (e) => {
                                e.stopPropagation();
                                if (e.target.checked) {
                                    this.deletedSelectedIds.add(proj.id);
                                } else {
                                    this.deletedSelectedIds.delete(proj.id);
                                }
                                this.updateDeletedSelectedCount();
                            });
                        }
                        
                        row.querySelector('.restore-btn')?.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            await this.restoreProject(proj.id, proj.name || proj.customer || 'project');
                        });
                        
                        row.querySelector('.delete-perm-btn')?.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            await this.permanentlyDeleteProject(proj.id, proj.name || proj.customer || 'project');
                        });
                        
                        container.appendChild(row);
                    });
                    
                    this.updateDeletedSelectedCount();
                } catch (err) {
                    console.error('[NavigationController] Error loading deleted projects:', err);
                    container.innerHTML = '<div class="projects-empty">Failed to load deleted projects</div>';
                }
            },
            
            // Toggle select mode for deleted projects
            toggleDeletedSelectMode() {
                this.deletedSelectMode = !this.deletedSelectMode;
                this.deletedSelectedIds.clear();
                
                const selectModeBtn = document.getElementById('deletedProjectsSelectModeBtn');
                const selectBar = document.getElementById('deletedProjectsSelectBar');
                const listContainer = document.getElementById('deletedProjectsListContainer');
                
                if (this.deletedSelectMode) {
                    selectModeBtn.textContent = '✖️ Cancel';
                    selectBar?.classList.remove('hidden');
                    listContainer?.classList.add('has-select-bar');
                } else {
                    selectModeBtn.textContent = '☑️ Select';
                    selectBar?.classList.add('hidden');
                    listContainer?.classList.remove('has-select-bar');
                }
                
                this.renderDeletedProjectsView();
            },
            
            // Select all deleted projects
            selectAllDeletedProjects() {
                this.cachedDeletedProjects.forEach(proj => {
                    this.deletedSelectedIds.add(proj.id);
                });
                document.querySelectorAll('.deleted-project-checkbox').forEach(cb => cb.checked = true);
                this.updateDeletedSelectedCount();
            },
            
            // Deselect all deleted projects
            deselectAllDeletedProjects() {
                this.deletedSelectedIds.clear();
                document.querySelectorAll('.deleted-project-checkbox').forEach(cb => cb.checked = false);
                this.updateDeletedSelectedCount();
            },
            
            // Invert selection for deleted projects
            invertDeletedSelection() {
                this.cachedDeletedProjects.forEach(proj => {
                    if (this.deletedSelectedIds.has(proj.id)) {
                        this.deletedSelectedIds.delete(proj.id);
                    } else {
                        this.deletedSelectedIds.add(proj.id);
                    }
                });
                document.querySelectorAll('.deleted-project-checkbox').forEach(cb => {
                    cb.checked = !cb.checked;
                });
                this.updateDeletedSelectedCount();
            },
            
            // Update selected count display
            updateDeletedSelectedCount() {
                const countEl = document.getElementById('deletedProjectsSelectedCount');
                if (countEl) {
                    countEl.textContent = `${this.deletedSelectedIds.size} selected`;
                }
            },
            
            // Bulk restore selected deleted projects
            async bulkRestoreDeletedProjects() {
                const count = this.deletedSelectedIds.size;
                if (count === 0) {
                    showToast('No projects selected', 'warning');
                    return;
                }
                
                const confirmed = await showConfirmModal({
                    title: 'Restore Projects',
                    message: `Restore ${count} project(s) to your active projects?`,
                    confirmText: 'Restore',
                    cancelText: 'Cancel',
                    danger: false
                });
                if (!confirmed) return;
                
                try {
                    const response = await fetch('/api/deleted-projects/bulk-restore', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ project_ids: [...this.deletedSelectedIds] })
                    });
                    
                    if (!response.ok) throw new Error('Failed to restore projects');
                    
                    const result = await response.json();
                    showToast(`${result.restored_count || count} project(s) have been restored.`, 'success');
                    
                    // Reset select mode and re-fetch both views
                    this.deletedSelectMode = false;
                    this.deletedSelectedIds.clear();
                    document.getElementById('deletedProjectsSelectModeBtn').textContent = '☑️ Select';
                    document.getElementById('deletedProjectsSelectBar')?.classList.add('hidden');
                    document.getElementById('deletedProjectsListContainer')?.classList.remove('has-select-bar');
                    await this.renderDeletedProjectsView();
                    await this.renderProjectsView();
                } catch (err) {
                    console.error('[NavigationController] Error bulk restoring projects:', err);
                    showToast('Failed to restore projects: ' + err.message, 'error');
                }
            },
            
            // Bulk permanently delete selected projects
            async bulkDeleteDeletedProjects() {
                const count = this.deletedSelectedIds.size;
                if (count === 0) {
                    showToast('No projects selected', 'warning');
                    return;
                }
                
                const confirmed = await showConfirmModal({
                    title: 'Permanently Delete',
                    message: `Permanently delete ${count} project(s)? This cannot be undone.`,
                    confirmText: 'Delete Forever',
                    cancelText: 'Cancel',
                    danger: true
                });
                if (!confirmed) return;
                
                try {
                    const response = await fetch('/api/deleted-projects/bulk-delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ project_ids: [...this.deletedSelectedIds] })
                    });
                    
                    if (!response.ok) throw new Error('Failed to delete projects');
                    
                    const result = await response.json();
                    showToast(`${result.deleted_count || count} project(s) have been permanently deleted.`, 'success');
                    
                    // Reset select mode and re-fetch
                    this.deletedSelectMode = false;
                    this.deletedSelectedIds.clear();
                    document.getElementById('deletedProjectsSelectModeBtn').textContent = '☑️ Select';
                    document.getElementById('deletedProjectsSelectBar')?.classList.add('hidden');
                    document.getElementById('deletedProjectsListContainer')?.classList.remove('has-select-bar');
                    await this.renderDeletedProjectsView();
                } catch (err) {
                    console.error('[NavigationController] Error bulk deleting projects:', err);
                    showToast('Failed to delete projects: ' + err.message, 'error');
                }
            },
            
            async restoreProject(projectId, projectName) {
                try {
                    const response = await fetch(`/api/deleted-projects/${projectId}/restore`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) throw new Error('Failed to restore project');
                    
                    showToast(`"${projectName}" has been restored to your projects.`, 'success');
                    // Refresh both views to ensure consistency
                    await this.renderDeletedProjectsView();
                    await this.renderProjectsView();
                } catch (err) {
                    console.error('[NavigationController] Error restoring project:', err);
                    showToast('Failed to restore project: ' + err.message, 'error');
                }
            },
            
            async permanentlyDeleteProject(projectId, projectName) {
                const confirmed = await showConfirmModal({
                    title: 'Permanently Delete',
                    message: `Permanently delete "${projectName}"? This cannot be undone.`,
                    confirmText: 'Delete Forever',
                    cancelText: 'Cancel',
                    danger: true
                });
                if (!confirmed) return;
                
                try {
                    const response = await fetch(`/api/deleted-projects/${projectId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) throw new Error('Failed to delete project');
                    
                    showToast(`"${projectName}" has been permanently deleted.`, 'success');
                    await this.renderDeletedProjectsView();
                } catch (err) {
                    console.error('[NavigationController] Error permanently deleting project:', err);
                    showToast('Failed to delete project: ' + err.message, 'error');
                }
            },
            
            // ==================================================================================
            // RENDER CUSTOMER INFO VIEW
            // ==================================================================================
            renderCustomerInfoView() {
                const wrapper = document.getElementById('customerInfoFormWrapper');
                if (!wrapper) return;
                
                // Use ProjectState.siteData to prefill
                const sd = ProjectState.siteData || siteData || {};
                
                // Auto-fill date with today if blank
                const dateValue = sd.date || getTodayISO();
                const dateDisplay = formatDateForDisplay(dateValue);
                
                wrapper.innerHTML = `
                    <div class="field"><label for="ci-date">Date of Site Visit</label><input type="text" id="ci-date" placeholder="M/D/YY" value="${dateDisplay}" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                    <div class="field">
                        <label for="ci-customer">Customer Name</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" id="ci-customer" placeholder="Customer Name" value="${sd.customer || ''}" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false">
                            <div id="ci-customer-autocomplete" class="autocomplete-dropdown"></div>
                        </div>
                    </div>
                    <div class="field" style="margin-top: -0.5rem;"><button type="button" id="ci-show-businesses" class="button" style="font-size: 0.9rem; padding: 0.5rem 1rem;">📍 Show Businesses Nearby</button></div>
                    <div class="field">
                        <label for="ci-street">Street Address</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" id="ci-street" placeholder="Street Address" value="${sd.street || ''}" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false">
                            <div id="ci-street-autocomplete" class="autocomplete-dropdown"></div>
                        </div>
                    </div>
                    <div class="field">
                        <label for="ci-city">City</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" id="ci-city" placeholder="City" value="${sd.city || ''}" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false">
                            <div id="ci-city-autocomplete" class="autocomplete-dropdown"></div>
                        </div>
                    </div>
                    <div class="field"><label for="ci-state">State</label><input type="text" id="ci-state" placeholder="State" maxlength="2" value="${sd.state || 'CA'}" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                    <div class="field"><label for="ci-zip">ZIP</label><input type="text" id="ci-zip" placeholder="ZIP" maxlength="10" value="${sd.zip || ''}" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                    <div class="field"><label for="ci-contact">Contact Name</label><input type="text" id="ci-contact" placeholder="Contact Name" value="${sd.contact || ''}" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                    <div class="field"><label for="ci-phone">Phone</label><input type="tel" id="ci-phone" placeholder="Phone" value="${sd.phone || ''}" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                    <div class="field"><label for="ci-utility">Utility Company</label><input type="text" id="ci-utility" placeholder="Utility Company" value="${sd.utility || ''}" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
                    <div style="display: flex; justify-content: center; gap: 0.75rem; margin-top: 1.5rem;">
                        <button id="saveCustomerInfoBtn" class="button">💾 Save & Continue</button>
                        <button id="cancelCustomerInfoBtn" class="button secondary">Cancel</button>
                    </div>
                `;
                
                // Wire up Show Businesses Nearby button
                document.getElementById('ci-show-businesses').addEventListener('click', () => {
                    // Check if Google Places API is configured
                    if (!NavigationController.googlePlacesEnabled) {
                        showToast('Google Places not configured. Set GOOGLE_PLACES_API_KEY in .env and restart the server.', 'warning');
                        return;
                    }
                    
                    // Trigger the use location button if it exists
                    const useLocationBtn = document.getElementById('useLocationBtn');
                    if (useLocationBtn) {
                        useLocationBtn.click();
                    } else if (typeof showNearbyBusinesses === 'function') {
                        showNearbyBusinesses();
                    } else {
                        // Request geolocation and call API directly
                        if (!navigator.geolocation) {
                            showToast('Geolocation is not supported by your browser.', 'warning');
                            return;
                        }
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;
                                window.location.href = `#nearby?lat=${lat}&lng=${lng}`;
                            },
                            (error) => {
                                if (error.code === error.PERMISSION_DENIED) {
                                    showToast('Location permission denied. Please allow location access.', 'warning');
                                } else if (error.code === error.TIMEOUT) {
                                    showToast('Location request timed out. Please try again.', 'warning');
                                } else {
                                    showToast('Could not get your location. Please try again.', 'warning');
                                }
                            },
                            { timeout: 10000, enableHighAccuracy: true }
                        );
                    }
                });
                
                // Ensure button reflects current config state
                updateGooglePlacesUI();
                
                // Initialize autocomplete for Customer Information modal fields
                if (typeof setupAutocomplete === 'function') {
                    setupAutocomplete('ci-customer', 'ci-customer-autocomplete');
                    setupAutocomplete('ci-street', 'ci-street-autocomplete');
                    setupAutocomplete('ci-city', 'ci-city-autocomplete');
                }
                
                // Save button handler - async to support auto-create project
                document.getElementById('saveCustomerInfoBtn').addEventListener('click', async () => {
                    // Parse date from display format to ISO
                    const dateDisplayValue = document.getElementById('ci-date').value.trim();
                    const dateISO = parseDateFromDisplay(dateDisplayValue) || getTodayISO();
                    
                    // Update siteData from form
                    siteData.date = dateISO;
                    siteData.visitDate = dateDisplayValue || formatDateForDisplay(dateISO);
                    siteData.customer = document.getElementById('ci-customer').value.trim();
                    siteData.street = document.getElementById('ci-street').value.trim();
                    siteData.city = document.getElementById('ci-city').value.trim();
                    siteData.state = document.getElementById('ci-state').value.trim();
                    siteData.zip = document.getElementById('ci-zip').value.trim();
                    siteData.contact = document.getElementById('ci-contact').value.trim();
                    siteData.phone = document.getElementById('ci-phone').value.trim();
                    siteData.utility = document.getElementById('ci-utility').value.trim();
                    
                    // Sync to ProjectState
                    Object.assign(ProjectState.siteData, siteData);
                    
                    // Sync to main form if it exists
                    const siteCustomer = document.getElementById('site-customer');
                    if (siteCustomer) {
                        document.getElementById('site-customer').value = siteData.customer;
                        document.getElementById('site-street').value = siteData.street;
                        document.getElementById('site-city').value = siteData.city;
                        document.getElementById('site-state').value = siteData.state;
                        document.getElementById('site-zip').value = siteData.zip;
                        document.getElementById('site-contact').value = siteData.contact;
                        document.getElementById('site-phone').value = siteData.phone;
                    }
                    const siteDateInput = document.getElementById('site-date');
                    if (siteDateInput) siteDateInput.value = dateISO;
                    
                    // Update displays
                    const customerNameEl = document.getElementById('customerName');
                    if (customerNameEl) customerNameEl.textContent = siteData.customer;
                    
                    const visitDateText = document.getElementById('visitDateText');
                    if (visitDateText) visitDateText.textContent = siteData.visitDate;
                    
                    const addressParts = [];
                    if (siteData.street) addressParts.push(siteData.street);
                    const cityStateZip = [siteData.city, siteData.state, siteData.zip].filter(v => v).join(', ');
                    if (cityStateZip) addressParts.push(cityStateZip);
                    const siteAddressText = document.getElementById('siteAddressText');
                    if (siteAddressText) siteAddressText.textContent = addressParts.join(', ') || 'No address provided';
                    
                    ProjectState.markDirty();
                    
                    // AUTO-CREATE PROJECT if no currentProjectId exists
                    if (!ProjectState.currentProjectId) {
                        try {
                            const projectName = siteData.customer || 'Untitled Site Walk';
                            
                            // Build project object with current state
                            const projectData = {
                                name: projectName,
                                siteData: { ...siteData },
                                entries: [...entries],
                                photos: [...(ProjectState.photos || [])]
                            };
                            
                            // Create project on server
                            const response = await fetch('/api/projects/create', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ name: projectName })
                            });
                            
                            if (response.ok) {
                                const result = await response.json();
                                const newId = result.project_id;
                                
                                // Update ProjectState with new project ID
                                ProjectState.project_id = newId;
                                ProjectState.currentProjectId = newId;
                                ProjectState.currentProjectName = projectName;
                                ProjectState.isDirty = false;
                                
                                // Save full project data
                                await ProjectService.updateProject(newId, projectData);
                                
                                updateCurrentProjectDisplay();
                                console.log('[CustomerInfo] Auto-created project:', newId);
                            }
                        } catch (err) {
                            console.error('[CustomerInfo] Failed to auto-create project:', err);
                        }
                    } else {
                        SaveController.queueSave('customer-info-save');
                    }
                    
                    // Navigate to current project view
                    this.setView('currentProject');
                });
                
                // Cancel button handler
                document.getElementById('cancelCustomerInfoBtn').addEventListener('click', () => {
                    this.setView('home');
                });
            },
            
            // ==================================================================================
            // RENDER CURRENT PROJECT VIEW
            // ==================================================================================
            renderCurrentProjectView() {
                // The current project view shows the existing equipment cards
                // Just ensure the data section is visible
                const siteSection = document.getElementById('siteSection');
                const dataSection = document.getElementById('dataSection');
                
                // If we have entries, show data section, otherwise show site form
                if (entries && entries.length > 0) {
                    if (siteSection) siteSection.classList.add('hidden');
                    if (dataSection) dataSection.classList.remove('hidden');
                    setSaveCustomerInfoVisible(false);
                    renderEntries();
                } else {
                    // Show site section for initial data entry
                    if (siteSection) siteSection.classList.remove('hidden');
                    if (dataSection) dataSection.classList.add('hidden');
                    setSaveCustomerInfoVisible(true);
                }
                
                // Update header displays
                const customerNameEl = document.getElementById('customerName');
                if (customerNameEl) customerNameEl.textContent = siteData.customer || '';
                
                const addressParts = [];
                if (siteData.street) addressParts.push(siteData.street);
                const cityStateZip = [siteData.city, siteData.state, siteData.zip].filter(v => v).join(', ');
                if (cityStateZip) addressParts.push(cityStateZip);
                const siteAddressText = document.getElementById('siteAddressText');
                if (siteAddressText) siteAddressText.textContent = addressParts.join(', ') || 'No address provided';
                
                // Render embedded bills section
                if (typeof renderEmbeddedBillsSection === 'function') {
                    renderEmbeddedBillsSection();
                }
            },
            
            // ==================================================================================
            // PRINT VIEW (In-app print preview)
            // ==================================================================================
            async renderPrintView() {
                const container = document.getElementById('printViewContent');
                if (!container) return;
                
                // Check if we need to fetch project data (e.g., after page reload)
                const projectId = ProjectState.currentProjectId || ProjectState.project_id;
                let sd = ProjectState.siteData || siteData || {};
                let entriesData = ProjectState.entries || entries || [];
                
                // If state is empty but we have a project ID, fetch from server
                if ((!sd.customer && entriesData.length === 0) && projectId) {
                    try {
                        container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">Loading project data...</div>';
                        const projectData = await ProjectService.getProject(projectId);
                        if (projectData) {
                            // Populate ProjectState with fetched data
                            ProjectState.siteData = projectData.siteData || {};
                            ProjectState.entries = projectData.entries || [];
                            ProjectState.photos = projectData.photos || [];
                            ProjectState.currentProjectName = projectData._metadata?.name || projectData.siteData?.customer || '';
                            sd = ProjectState.siteData;
                            entriesData = ProjectState.entries;
                        }
                    } catch (err) {
                        console.error('[printView] Failed to load project:', err);
                        container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #c00;">Failed to load project data. Please try again.</div>';
                        return;
                    }
                }
                
                // Handle case where no project is available at all
                if (!sd.customer && entriesData.length === 0) {
                    const noDataMsg = projectId 
                        ? '<div style="padding: 2rem; text-align: center; color: #666;">Failed to load project data. Please go back and select a project.</div>'
                        : '<div style="padding: 2rem; text-align: center; color: #666;">No project data to display. Please load a project first.</div>';
                    container.innerHTML = noDataMsg;
                    return;
                }
                
                // Filter entries by section type
                const evaps = entriesData.filter(e => e.section === 'evap');
                const conds = entriesData.filter(e => e.section === 'cond');
                
                // Format date for display
                const visitDateDisplay = sd.visitDate || formatDateForDisplay(sd.date) || '';
                
                // Build card title: Just RoomName
                const buildCardTitle = (entry, fallback) => entry['room-name'] || entry['room-roomname'] || fallback;
                
                // Build Mfr line
                const buildMfrHtml = (entry) => {
                    if (!entry['room-mfg']) return '';
                    return `<div class="print-room-mfr"><span class="mfr-label">Mfr:</span> <span class="mfr-value">${entry['room-mfg']}</span></div>`;
                };
                
                // Build info line
                const buildInfoLine = (entry, isEvap) => {
                    let parts = [];
                    if (isEvap) {
                        if (entry['room-setPoint']) parts.push(`<span class="mfr-label">Set Point:</span> <span class="mfr-value">${entry['room-setPoint']}°F</span>`);
                        if (entry['room-currentTemp']) parts.push(`<span class="mfr-label">Current Temp:</span> <span class="mfr-value">${entry['room-currentTemp']}°F</span>`);
                    }
                    if (entry['room-runTime']) parts.push(`<span class="mfr-label">Run Time:</span> <span class="mfr-value">${entry['room-runTime']}%</span>`);
                    if (!isEvap && entry['room-split'] === true) parts.push('Split');
                    return parts.length > 0 ? `<div class="print-room-info">${parts.join(' | ')}</div>` : '';
                };
                
                // Helper to wrap label:value pairs
                const specPair = (label, value) => `<span class="spec-label">${label}:</span> <span class="spec-value">${value}</span>`;
                
                // Build spec columns
                const buildSpecColumns = (entry, isEvap) => {
                    let leftLines = [];
                    let rightLines = [];
                    
                    // Left column specs
                    let line1 = [];
                    if (entry['room-count']) line1.push(specPair('Units', entry['room-count']));
                    if (entry['room-fanMotorsPerUnit']) line1.push(specPair('Motors Per Unit', entry['room-fanMotorsPerUnit']));
                    if (line1.length > 0) leftLines.push(line1.join(' | '));
                    
                    let line2 = [];
                    if (entry['room-voltage']) line2.push(specPair('Voltage', entry['room-voltage']));
                    if (entry['room-phase']) line2.push(specPair('Phase', entry['room-phase']));
                    if (entry['room-amps']) line2.push(specPair('FLA', entry['room-amps']));
                    if (entry['room-hp']) line2.push(specPair('HP', entry['room-hp']));
                    if (entry['room-rpm']) line2.push(specPair('RPM', entry['room-rpm']));
                    if (line2.length > 0) leftLines.push(line2.join(' | '));
                    
                    // Right column specs
                    let rLine1 = [];
                    if (entry['room-frame']) rLine1.push(specPair('Frame', entry['room-frame']));
                    if (entry['room-motorMounting']) {
                        const mountVal = entry['room-motorMounting'].charAt(0).toUpperCase() + entry['room-motorMounting'].slice(1);
                        rLine1.push(specPair('Mount', mountVal));
                    }
                    if (entry['room-shaftSize']) rLine1.push(specPair('Shaft', entry['room-shaftSize']));
                    if (entry['room-rotation']) rLine1.push(specPair('Rotation', entry['room-rotation']));
                    if (rLine1.length > 0) rightLines.push(rLine1.join(' | '));
                    
                    let rLine2 = [];
                    if (entry['room-shaftAdapterQty'] && Number(entry['room-shaftAdapterQty']) > 0 && entry['room-shaftAdapterType']) {
                        rLine2.push(`<span class="spec-label">Adapters:</span> <span class="spec-value">(${entry['room-shaftAdapterQty']}) ${entry['room-shaftAdapterType']}</span>`);
                    }
                    if (entry['room-bladesNeeded'] && Number(entry['room-bladesNeeded']) > 0 && entry['room-bladeSpec']) {
                        rLine2.push(`<span class="spec-label">FanBlade(s):</span> <span class="spec-value">(${entry['room-bladesNeeded']}) ${entry['room-bladeSpec']}</span>`);
                    } else if (entry['room-bladeSpec']) {
                        rLine2.push(`<span class="spec-label">FanBlade(s):</span> <span class="spec-value">${entry['room-bladeSpec']}</span>`);
                    }
                    if (rLine2.length > 0) rightLines.push(rLine2.join(' | '));
                    
                    if (leftLines.length === 0 && rightLines.length === 0) return '';
                    
                    const leftHtml = leftLines.map(l => `<div class="spec-line">${l}</div>`).join('');
                    const rightHtml = rightLines.map(l => `<div class="spec-line">${l}</div>`).join('');
                    
                    if (rightLines.length === 0) {
                        return `<div class="print-room-specs"><div class="spec-column spec-left">${leftHtml}</div></div>`;
                    }
                    return `<div class="print-room-specs"><div class="spec-column spec-left">${leftHtml}</div><div class="spec-column spec-right">${rightHtml}</div></div>`;
                };
                
                // Build HTML content
                let html = `
                    <h1 style="color:#1e5a99; margin-bottom:0.5rem;">${sd.customer || 'Project'}</h1>
                    <div class="site-info" style="background:#f5f5f5; padding:0.75rem 1rem; border-radius:4px; margin-bottom:1.5rem;">
                        <p style="margin:0.2rem 0; font-size:0.95rem;"><strong>Address:</strong> ${sd.street || ''}, ${sd.city || ''}, ${sd.state || ''} ${sd.zip || ''}</p>
                        <p style="margin:0.2rem 0; font-size:0.95rem;"><strong>Contact:</strong> ${sd.contact || ''} ${sd.phone ? '(' + sd.phone + ')' : ''}</p>
                        <p style="margin:0.2rem 0; font-size:0.95rem;"><strong>Utility:</strong> ${sd.utility || ''}</p>
                        <p style="margin:0.2rem 0; font-size:0.95rem;"><strong>Date of Site Visit:</strong> ${visitDateDisplay}</p>
                    </div>`;
                
                // Evaporators section
                if (evaps.length > 0) {
                    html += '<h2 style="color:#2d7bb8; border-bottom:2px solid #2d7bb8; padding-bottom:0.25rem; margin-top:1.5rem;">Evaporators</h2>';
                    evaps.forEach((e, i) => {
                        const notes = e['room-notes'] || '';
                        html += `
                            <div class="print-room" style="border:1px solid #bbb; border-radius:4px; padding:10px 14px; margin-bottom:12px;">
                                <div class="room-title" style="font-weight:700; font-size:1.15rem; color:#1e5a99; margin-bottom:4px;">${buildCardTitle(e, 'Evaporator ' + (i + 1))}</div>
                                ${buildMfrHtml(e)}
                                ${buildInfoLine(e, true)}
                                ${buildSpecColumns(e, true)}
                                <hr style="border:0; border-top:1px solid #ddd; margin:6px 0 4px 0;">
                                <div style="font-size:0.9rem;"><span style="font-weight:600;">Notes:</span> <span style="font-weight:normal; white-space:pre-wrap; color:#555;">${notes || '—'}</span></div>
                            </div>`;
                    });
                }
                
                // Condensers section
                if (conds.length > 0) {
                    html += '<h2 style="color:#2d7bb8; border-bottom:2px solid #2d7bb8; padding-bottom:0.25rem; margin-top:1.5rem;">Condensers</h2>';
                    conds.forEach((c, i) => {
                        const notes = c['room-notes'] || '';
                        html += `
                            <div class="print-room" style="border:1px solid #bbb; border-radius:4px; padding:10px 14px; margin-bottom:12px;">
                                <div class="room-title" style="font-weight:700; font-size:1.15rem; color:#1e5a99; margin-bottom:4px;">${buildCardTitle(c, 'Condenser ' + (i + 1))}</div>
                                ${buildMfrHtml(c)}
                                ${buildInfoLine(c, false)}
                                ${buildSpecColumns(c, false)}
                                <hr style="border:0; border-top:1px solid #ddd; margin:6px 0 4px 0;">
                                <div style="font-size:0.9rem;"><span style="font-weight:600;">Notes:</span> <span style="font-weight:normal; white-space:pre-wrap; color:#555;">${notes || '—'}</span></div>
                            </div>`;
                    });
                }
                
                container.innerHTML = html;
            },
            
            // Download PDF from backend
            async downloadPrintPdf() {
                const projectId = ProjectState.currentProjectId;
                if (!projectId) {
                    showToast('No project loaded. Please open a project first.', 'warning');
                    return;
                }
                
                try {
                    const response = await fetch(`/api/projects/${encodeURIComponent(projectId)}/print.pdf`);
                    if (!response.ok) {
                        throw new Error('Failed to generate PDF');
                    }
                    
                    const blob = await response.blob();
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'Print View.pdf';
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename="?([^"]+)"?/);
                        if (match) filename = match[1];
                    }
                    
                    // Create download link
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (err) {
                    console.error('[print-pdf] Error downloading PDF:', err);
                    showToast('Failed to download PDF: ' + err.message, 'error');
                }
            },
            
            // ==================================================================================
            // BILLS VIEW (Isolated feature - uses PostgreSQL, not JSON storage)
            // ==================================================================================
            billsFeatureEnabled: false,
            googlePlacesEnabled: false,
            _configLoaded: false,
            
            async checkBillsFeature() {
                // Use /api/config endpoint - no device/UA detection, purely server-driven
                try {
                    const response = await fetch('/api/config');
                    const data = await response.json();
                    this.billsFeatureEnabled = data.billsEnabled === true;
                    this.googlePlacesEnabled = data.googlePlacesEnabled === true;
                    this._configLoaded = true;
                    
                    // Show/hide bills nav item
                    const billsNavItem = document.getElementById('billsNavItem');
                    if (billsNavItem) {
                        billsNavItem.style.display = this.billsFeatureEnabled ? 'block' : 'none';
                    }
                    
                    console.log('[config] Bills feature enabled:', this.billsFeatureEnabled);
                    console.log('[config] Google Places enabled:', this.googlePlacesEnabled);
                    
                    // Update UI elements that depend on Google Places availability
                    updateGooglePlacesUI();
                } catch (e) {
                    console.error('[config] Could not fetch config:', e);
                    this.billsFeatureEnabled = false;
                    this.googlePlacesEnabled = false;
                    this._configLoaded = true;
                    updateGooglePlacesUI();
                }
            },
            
            async renderBillsView() {
                if (!this.billsFeatureEnabled) {
                    showToast('Utility Bills feature is not enabled.', 'warning');
                    this.setView('currentProject');
                    return;
                }
                
                // Check if we have a current project
                const projectId = ProjectState.currentProjectId;
                if (!projectId) {
                    showToast('Please open a project first to view its utility bills.', 'warning');
                    this.setView('projects');
                    return;
                }
                
                // Update project summary
                const summaryEl = document.getElementById('billsProjectSummary');
                if (summaryEl) {
                    const nameEl = summaryEl.querySelector('.bills-project-name');
                    const addrEl = summaryEl.querySelector('.bills-project-address');
                    
                    if (nameEl) nameEl.textContent = siteData.customer || ProjectState.currentProjectName || 'Unnamed Project';
                    
                    if (addrEl) {
                        const parts = [];
                        if (siteData.street) parts.push(siteData.street);
                        const cityStateZip = [siteData.city, siteData.state, siteData.zip].filter(v => v).join(', ');
                        if (cityStateZip) parts.push(cityStateZip);
                        addrEl.textContent = parts.join(', ') || 'No address';
                    }
                }
                
                // Load bills data
                await this.loadBillsData(projectId);
                
                // Setup event handlers
                this.setupBillsEventHandlers(projectId);
            },
            
            async loadBillsData(projectId) {
                const BILLS_FETCH_TIMEOUT_MS = 15000; // 15 second timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), BILLS_FETCH_TIMEOUT_MS);
                
                // Show loading state
                const container = document.getElementById('billFilesList');
                if (container) {
                    container.innerHTML = '<div class="bills-loading-state">Loading bills data...</div>';
                }
                
                try {
                    const response = await fetch(`/api/projects/${projectId}/bills/grouped?service=electric&_t=${Date.now()}`, {
                        signal: controller.signal,
                        cache: 'no-store'
                    });
                    clearTimeout(timeoutId);
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.renderBillFiles(data.files);
                        this.renderGroupedBillsData(data.accounts);
                    } else {
                        console.error('[bills] Failed to load data:', data.error);
                        this._showBillsError(projectId, data.error || 'Failed to load bills');
                    }
                } catch (e) {
                    clearTimeout(timeoutId);
                    const errorMsg = e.name === 'AbortError' 
                        ? 'Request timed out. Please check your connection.'
                        : `Error loading bills: ${e.message}`;
                    console.error('[bills] Error loading data:', e);
                    this._showBillsError(projectId, errorMsg);
                }
            },
            
            _showBillsError(projectId, message) {
                const container = document.getElementById('billFilesList');
                if (container) {
                    container.innerHTML = `
                        <div class="bills-error-state" style="text-align: center; padding: 2rem; color: #c00;">
                            <div style="margin-bottom: 1rem;">⚠️ ${message}</div>
                            <button class="button" id="retryBillsBtn" style="background-color: #1e5a99;">Retry</button>
                        </div>
                    `;
                    const retryBtn = container.querySelector('#retryBillsBtn');
                    if (retryBtn) {
                        retryBtn.addEventListener('click', () => {
                            this.loadBillsData(projectId);
                        });
                    }
                }
            },
            
            // Helper to clean filenames - strips "(cooler)", "(freezer)", or any "(text)" suffix
            cleanFilename(filename) {
                if (!filename) return filename;
                return filename.replace(/\s*\([^)]+\)\s*(?=\.[^.]+$|$)/g, '').trim();
            },
            
            // Get status class and icon for file status
            getStatusDisplay(status, serviceType = null) {
                const statusMap = {
                    'pending': { class: 'bills-status-pending', icon: '⏳', label: 'pending' },
                    'processing': { class: 'bills-status-processing', icon: '', label: 'processing' },
                    'complete': { class: 'bills-status-complete', icon: '✓', label: 'complete' },
                    'ok': { class: 'bills-status-ok', icon: '✓', label: 'ok' },
                    'approved': { class: 'bills-status-ok', icon: '✓', label: 'ok' },
                    'needs_review': { class: 'bills-status-needs_review', icon: '⚠️', label: 'needs review' },
                    'skipped': { class: 'bills-status-skipped', icon: '○', label: serviceType ? serviceType.charAt(0).toUpperCase() + serviceType.slice(1) : 'Non-Electric' },
                    'error': { class: 'bills-status-error', icon: '✗', label: 'error' },
                    'failed': { class: 'bills-status-error', icon: '✗', label: 'failed' }
                };
                return statusMap[status] || statusMap['pending'];
            },
            
            getInputTypeForField(field) {
                if (field.includes('period_start') || field.includes('period_end') || field.includes('date')) {
                    return 'date';
                }
                if (field.includes('kwh') || field.includes('charge') || field.includes('amount') || 
                    field.includes('cost') || field.includes('rate') || field.includes('demand')) {
                    return 'number';
                }
                return 'text';
            },
            
            renderBillFiles(files) {
                const container = document.getElementById('billFilesList');
                if (!container) return;
                
                if (!files || files.length === 0) {
                    container.innerHTML = '<div class="bills-empty-state">No files uploaded yet</div>';
                    return;
                }
                
                container.innerHTML = files.map(f => {
                    const cleanName = this.cleanFilename(f.original_filename);
                    const size = f.file_size ? `${(f.file_size / 1024).toFixed(1)} KB` : '';
                    const d = f.upload_date ? new Date(f.upload_date) : null;
                    const date = d ? `${d.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' })} • ${d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}` : '';
                    const reviewStatus = f.review_status || f.processing_status || 'pending';
                    const serviceType = f.service_type || (f.extraction_payload ? f.extraction_payload.service_type : null);
                    const statusDisplay = this.getStatusDisplay(reviewStatus, serviceType);
                    const isNeedsReview = reviewStatus === 'needs_review';
                    const clickableClass = isNeedsReview ? ' clickable' : '';
                    const statusHtml = isNeedsReview 
                        ? `<span class="${statusDisplay.class}${clickableClass}" data-file-id="${f.id}" data-action="review" title="Click to review missing fields">${statusDisplay.icon} ${statusDisplay.label}</span>`
                        : `<span class="${statusDisplay.class}">${statusDisplay.icon} ${statusDisplay.label}</span>`;
                    return `
                        <div class="bills-file-item" data-file-id="${f.id}" data-original-filename="${f.original_filename || ''}">
                            <div class="bills-file-info">
                                <span class="bills-file-name">📄 ${cleanName}</span>
                                <span class="bills-file-meta">${size} • ${date} • ${statusHtml} <span class="bills-file-edit" data-file-id="${f.id}" title="Edit bill fields">✏️</span></span>
                            </div>
                            <button class="bills-file-delete" data-file-id="${f.id}" title="Delete file">🗑️</button>
                        </div>
                    `;
                }).join('');
                
                // Add click handlers for row (opens review modal)
                container.querySelectorAll('.bills-file-item').forEach(row => {
                    row.addEventListener('click', async (e) => {
                        // Don't trigger if clicking delete button
                        if (e.target.closest('.bills-file-delete')) return;
                        // Don't trigger if clicking needs_review badge or edit icon (they have their own handlers)
                        if (e.target.closest('[data-action="review"]') || e.target.closest('.bills-file-edit')) return;
                        const fileId = row.dataset.fileId;
                        await this.openBillReview(ProjectState.currentProjectId, fileId);
                    });
                });
                
                // Add click handlers for needs_review badge (opens field review modal)
                container.querySelectorAll('[data-action="review"]').forEach(badge => {
                    badge.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const fileId = badge.dataset.fileId;
                        await this.openFieldReviewModal(fileId);
                    });
                });
                
                // Add click handlers for edit icon (opens field review modal)
                container.querySelectorAll('.bills-file-edit').forEach(icon => {
                    icon.style.cursor = 'pointer';
                    icon.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const fileId = icon.dataset.fileId;
                        await this.openFieldReviewModal(fileId);
                    });
                });
                
                // Add delete handlers
                container.querySelectorAll('.bills-file-delete').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const fileId = e.target.dataset.fileId || e.target.closest('.bills-file-delete').dataset.fileId;
                        const confirmed = await showConfirmModal({
                            title: 'Delete File',
                            message: 'Delete this file?',
                            confirmText: 'Delete',
                            cancelText: 'Cancel',
                            danger: true
                        });
                        if (confirmed) {
                            await this.deleteBillFile(ProjectState.currentProjectId, fileId);
                        }
                    });
                });
            },
            
            renderGroupedBillsData(accounts) {
                const container = document.getElementById('billsGroupedData');
                if (!container) return;
                
                if (!accounts || accounts.length === 0) {
                    container.innerHTML = '<div class="bills-empty-state">No data extracted yet. Upload utility bills above.</div>';
                    return;
                }
                
                // Load enhanced summary data from the summary endpoint
                this.loadProjectBillsSummary();
            },
            
            async loadProjectBillsSummary() {
                const projectId = ProjectState.currentProjectId;
                if (!projectId) return;
                
                const container = document.getElementById('billsGroupedData');
                if (!container) return;
                
                try {
                    const response = await fetch(`/api/projects/${projectId}/bills/summary?months=12&service=electric&_t=${Date.now()}`, { cache: 'no-store' });
                    const data = await response.json();
                    
                    if (!data.success || !data.accounts || data.accounts.length === 0) {
                        container.innerHTML = '<div class="bills-empty-state">No data extracted yet. Upload utility bills above.</div>';
                        return;
                    }
                    
                    this.renderMultiMeterUI(data.accounts, data.fileCounts);
                } catch (e) {
                    console.error('[bills] Error loading project summary:', e);
                    container.innerHTML = '<div class="bills-empty-state">Error loading data. Please try again.</div>';
                }
            },
            
            renderMultiMeterUI(accounts, fileCounts) {
                const container = document.getElementById('billsGroupedData');
                if (!container) return;
                fileCounts = fileCounts || {uploaded: 0, ok: 0, needsReview: 0, processing: 0, error: 0};
                
                // Clamp uploaded count to actual rendered files (safety check)
                const renderedFileCount = document.querySelectorAll('#billFilesList .bills-file-item').length;
                if (renderedFileCount > 0 && fileCounts.uploaded > renderedFileCount) {
                    console.log(`[bills] Clamping uploaded count from ${fileCounts.uploaded} to ${renderedFileCount}`);
                    fileCounts.uploaded = renderedFileCount;
                }
                
                let html = '';
                
                for (const account of accounts) {
                    // Handle nested structure from backend (combined + meters)
                    const combined = account.combined || account;
                    
                    // Calculate aggregate totals for this account (all meters combined)
                    const totalKwh = combined.totalKwh || combined.sumKwh || 0;
                    const totalCost = combined.totalCost || combined.sumCost || 0;
                    const blendedRateDollars = combined.blendedRateDollars || 0;
                    const blendedRateCents = blendedRateDollars * 100;
                    const avgCostPerDay = combined.avgCostPerDay || combined.avgCostPerDayDollars || 0;
                    const meters = account.meters || [];
                    
                    // Account header - use LADWP helper for full account number display
                    const utilityName = account.utilityName || 'Unknown Utility';
                    const accountNum = account.accountNumber || 'N/A';
                    const displayAccountNum = isUtilityLADWP(utilityName) ? accountNum : (accountNum.length > 4 ? '(...)' + accountNum.slice(-4) : accountNum);
                    
                    html += `
                        <div class="bills-account-group">
                            <div class="bills-account-header">
                                <div class="account-utility">⚡ ${utilityName}</div>
                                <div class="account-number">Account: ${displayAccountNum}</div>
                            </div>
                    `;
                    
                    // Aggregate summary card - Analyzed Bills
                    const billCount = combined.billCount || 0;
                    const billLabel = billCount === 1 ? 'Bill' : 'Bills';
                    const showFileStatus = fileCounts.uploaded > 0 && (fileCounts.uploaded !== fileCounts.ok || fileCounts.needsReview > 0 || fileCounts.processing > 0 || fileCounts.error > 0);
                    let fileStatusLine = '';
                    if (showFileStatus) {
                        const parts = [];
                        parts.push(`${fileCounts.uploaded} uploaded`);
                        parts.push(`${fileCounts.ok} analyzed`);
                        if (fileCounts.needsReview > 0) parts.push(`${fileCounts.needsReview} needs review`);
                        if (fileCounts.processing > 0) parts.push(`${fileCounts.processing} processing`);
                        if (fileCounts.error > 0) parts.push(`${fileCounts.error} error`);
                        fileStatusLine = `<div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem; font-weight: normal;">${parts.join(' · ')}</div>`;
                    }
                    html += `
                        <div class="bills-summary-card">
                            <h4>📊 Analyzed ${billLabel}<br><span style="font-size: 0.85em; font-weight: normal;">(${billCount} total)</span></h4>
                            ${fileStatusLine}
                            <div class="bills-summary-grid">
                                <div class="bills-summary-stat">
                                    <span class="stat-value">${formatBillValue(totalKwh, 'kwh')}</span>
                                    <div class="stat-label">Total kWh</div>
                                </div>
                                <div class="bills-summary-stat">
                                    <span class="stat-value">${formatBillValue(blendedRateCents, 'rate')}</span>
                                    <div class="stat-label">Blended Rate/kWh</div>
                                </div>
                                <div class="bills-summary-stat">
                                    <span class="stat-value">${formatBillValue(totalCost, 'cost')}</span>
                                    <div class="stat-label">Total Cost</div>
                                </div>
                                <div class="bills-summary-stat">
                                    <span class="stat-value">${formatBillValue(avgCostPerDay, 'avgDay')}</span>
                                    <div class="stat-label">Avg Cost/Day</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Per-meter cards
                    for (let i = 0; i < meters.length; i++) {
                        const meter = meters[i];
                        const meterId = meter.meterId || meter.id;
                        const meterNumber = meter.meterNumber || meter.meter_number || 'Unknown';
                        const meterKwh = meter.totalKwh || meter.sumKwh || 0;
                        const meterCost = meter.totalCost || meter.sumCost || 0;
                        const meterBlendedRate = (meter.blendedRateDollars || 0) * 100;
                        const meterAvgCost = meter.avgCostPerDay || meter.avgCostPerDayDollars || 0;
                        const bills = meter.bills || [];
                        
                        html += `
                            <div class="bills-meter-card" data-meter-id="${meterId}">
                                <div class="bills-meter-card-header" onclick="NavigationController.toggleMeterAccordion(this)">
                                    <span class="meter-title">📟 Meter: ${meterNumber}</span>
                                    <span class="meter-toggle">▼</span>
                                </div>
                                <div class="bills-meter-summary">
                                    <div class="meter-stat">
                                        <div class="value">${formatBillValue(meterKwh, 'kwh')}</div>
                                        <div class="label">kWh</div>
                                    </div>
                                    <div class="meter-stat">
                                        <div class="value">${formatBillValue(meterCost, 'cost')}</div>
                                        <div class="label">Cost</div>
                                    </div>
                                    <div class="meter-stat">
                                        <div class="value">${formatBillValue(meterBlendedRate, 'rate')}</div>
                                        <div class="label">Rate/kWh</div>
                                    </div>
                                    <div class="meter-stat">
                                        <div class="value">${formatBillValue(meterAvgCost, 'avgDay')}</div>
                                        <div class="label">Avg/Day</div>
                                    </div>
                                </div>
                                <div class="bills-meter-months" data-meter-id="${meterId}">
                        `;
                        
                        // Month-by-month bills
                        if (bills.length > 0) {
                            for (const bill of bills) {
                                const billId = bill.billId || bill.id;
                                const periodLabel = bill.periodLabel || bill.period_label || 'Unknown';
                                const billKwh = bill.total_kwh || 0;
                                const billCost = bill.total_amount_due || 0;
                                const billRateVal = ((bill.blendedRateDollars || 0) * 100);
                                
                                html += `
                                    <div class="bills-month-row" data-bill-id="${billId}" onclick="NavigationController.toggleBillDetail(this, ${billId})">
                                        <span class="month-label">${periodLabel}</span>
                                        <span class="month-value">${formatBillValue(billKwh, 'kwh')} kWh</span>
                                        <span class="month-value">${formatBillValue(billCost, 'cost')}</span>
                                        <span class="month-value">${formatBillValue(billRateVal, 'rate')}/kWh</span>
                                        <span class="expand-icon">▶</span>
                                    </div>
                                    <div class="bills-month-detail" id="bill-detail-${billId}"></div>
                                `;
                            }
                        } else {
                            html += `<div style="padding: 1rem; color: #999; text-align: center;">No bills available</div>`;
                        }
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                    
                    html += '</div>'; // Close account group
                }
                
                container.innerHTML = html;
                
                // Auto-expand first meter accordion
                const firstAccordion = container.querySelector('.bills-meter-months');
                if (firstAccordion) {
                    firstAccordion.classList.add('expanded');
                }
            },
            
            toggleMeterAccordion(header) {
                const card = header.closest('.bills-meter-card');
                const monthsContainer = card.querySelector('.bills-meter-months');
                
                if (monthsContainer) {
                    monthsContainer.classList.toggle('expanded');
                    header.classList.toggle('collapsed');
                }
            },
            
            async toggleBillDetail(row, billId) {
                const detailEl = document.getElementById(`bill-detail-${billId}`);
                if (!detailEl) return;
                
                // Toggle visibility
                if (detailEl.classList.contains('show')) {
                    detailEl.classList.remove('show');
                    row.classList.remove('expanded');
                    return;
                }
                
                // Show loading state
                detailEl.innerHTML = '<div style="padding: 0.5rem; color: #666;">Loading...</div>';
                detailEl.classList.add('show');
                row.classList.add('expanded');
                
                try {
                    const response = await fetch(`/api/bills/${billId}/detail`);
                    const data = await response.json();
                    
                    if (data.success) {
                        detailEl.innerHTML = this.renderBillDetailCard(data);
                    } else {
                        detailEl.innerHTML = '<div style="padding: 0.5rem; color: #d9534f;">Error loading bill detail</div>';
                    }
                } catch (e) {
                    console.error('[bills] Error loading bill detail:', e);
                    detailEl.innerHTML = '<div style="padding: 0.5rem; color: #d9534f;">Error loading bill detail</div>';
                }
            },
            
            renderBillDetailCard(bill) {
                const days = computeDaysInPeriod(bill.daysInPeriod, bill.periodStart, bill.periodEnd) ?? 0;
                const tou = bill.tou || {};
                const charges = bill.charges || {};
                const energyCharges = charges.energyCharges || 0;
                const demandCharges = charges.demandCharges || 0;
                const taxes = charges.taxes || 0;
                let html = `
                    <div class="facility-stats-grid">
                        <div class="meter-stat">
                            <div class="value">${days}</div>
                            <div class="label">Days</div>
                        </div>
                        <div class="meter-stat">
                            <div class="value">${formatBillValue(energyCharges, 'cost')}</div>
                            <div class="label">Energy</div>
                        </div>
                        <div class="meter-stat">
                            <div class="value">${formatBillValue(demandCharges, 'cost')}</div>
                            <div class="label">Demand</div>
                        </div>
                        <div class="meter-stat">
                            <div class="value">${formatBillValue(taxes, 'cost')}</div>
                            <div class="label">Taxes</div>
                        </div>
                    </div>
                `;

                // GENERIC TOU breakdown - uses bill.touPeriods array if available
                // This works for all utilities (LADWP, SCE, PG&E, SDG&E, etc)
                const touPeriods = bill.touPeriods || [];

                if (touPeriods && touPeriods.length > 0) {
                    // Smart color coding based on relative rates
                    const periodsWithRates = touPeriods.filter(p => p.rateDollarsPerKwh != null && p.rateDollarsPerKwh > 0);
                    const rates = periodsWithRates.map(p => p.rateDollarsPerKwh);
                    const minRate = rates.length > 0 ? Math.min(...rates) : 0;
                    const maxRate = rates.length > 0 ? Math.max(...rates) : 0;
                    const rateRange = maxRate - minRate;

                    // Helper to get color class based on rate
                    const getColorClass = (rate) => {
                        if (rateRange === 0 || rate == null) return 'tou-neutral';
                        const normalized = (rate - minRate) / rateRange;
                        if (normalized >= 0.75) return 'tou-highest';  // Red
                        if (normalized >= 0.5) return 'tou-high';      // Orange
                        if (normalized >= 0.25) return 'tou-mid';      // Yellow
                        return 'tou-low';                               // Green
                    };

                    html += '<div class="bills-tou-breakdown">';

                    for (const period of touPeriods) {
                        const kwh = period.kwh || 0;
                        const rate = period.rateDollarsPerKwh;
                        const cost = period.estCostDollars;
                        const periodName = period.period || 'Unknown';
                        const colorClass = getColorClass(rate);
                        const rateCents = rate ? rate * 100 : null;

                        html += `
                            <div class="bills-tou-item ${colorClass}">
                                <div class="period-name">${periodName}</div>
                                <div class="period-kwh">${formatBillValue(kwh, 'kwh')} kWh</div>
                                <div class="period-rate">${formatBillValue(rateCents, 'rate')}/kWh</div>
                                ${cost != null ? `<div class="period-cost">${formatBillValue(cost, 'cost')}</div>` : ''}
                            </div>
                        `;
                    }

                    html += '</div>';
                }
                // Fallback to fixed TOU structure if touPeriods not available
                else if (tou.onPeakKwh || tou.midPeakKwh || tou.offPeakKwh || tou.superOffPeakKwh) {
                    html += '<div class="bills-tou-breakdown">';

                    if (tou.onPeakKwh != null) {
                        const onRateCents = tou.onPeakRateDollars ? tou.onPeakRateDollars * 100 : null;
                        html += `
                            <div class="bills-tou-item tou-highest">
                                <div class="period-name">On-Peak</div>
                                <div class="period-kwh">${formatBillValue(tou.onPeakKwh, 'kwh')} kWh</div>
                                <div class="period-rate">${formatBillValue(onRateCents, 'rate')}/kWh</div>
                            </div>
                        `;
                    }

                    if (tou.midPeakKwh != null) {
                        const midRateCents = tou.midPeakRateDollars ? tou.midPeakRateDollars * 100 : null;
                        html += `
                            <div class="bills-tou-item tou-mid">
                                <div class="period-name">Mid-Peak</div>
                                <div class="period-kwh">${formatBillValue(tou.midPeakKwh, 'kwh')} kWh</div>
                                <div class="period-rate">${formatBillValue(midRateCents, 'rate')}/kWh</div>
                            </div>
                        `;
                    }

                    if (tou.offPeakKwh != null) {
                        const offRateCents = tou.offPeakRateDollars ? tou.offPeakRateDollars * 100 : null;
                        html += `
                            <div class="bills-tou-item tou-low">
                                <div class="period-name">Off-Peak</div>
                                <div class="period-kwh">${formatBillValue(tou.offPeakKwh, 'kwh')} kWh</div>
                                <div class="period-rate">${formatBillValue(offRateCents, 'rate')}/kWh</div>
                            </div>
                        `;
                    }

                    if (tou.superOffPeakKwh != null) {
                        const superOffRateCents = tou.superOffPeakRateDollars ? tou.superOffPeakRateDollars * 100 : null;
                        html += `
                            <div class="bills-tou-item tou-low">
                                <div class="period-name">Super Off</div>
                                <div class="period-kwh">${formatBillValue(tou.superOffPeakKwh, 'kwh')} kWh</div>
                                <div class="period-rate">${formatBillValue(superOffRateCents, 'rate')}/kWh</div>
                                <div class="period-cost">${formatBillValue(tou.superOffPeakCost, 'cost')}</div>
                            </div>
                        `;
                    }

                    html += '</div>';
                }

                return html;
            },
            
            async loadDetailedBillData() {
                const projectId = ProjectState.currentProjectId;
                if (!projectId) return;
                
                try {
                    const response = await fetch(`/api/projects/${projectId}/bills/detailed`);
                    const data = await response.json();
                    
                    if (data.success && data.bills && data.bills.length > 0) {
                        this.renderDetailedBillsSection(data.bills);
                    }
                } catch (e) {
                    console.error('[bills] Error loading detailed data:', e);
                }
            },
            
            renderDetailedBillsSection(bills) {
                const container = document.getElementById('billsGroupedData');
                if (!container) return;
                
                // Add detailed breakdown section after the main tables
                let detailedHtml = '<div class="bills-detailed-section bills-page-container" style="margin-top: 1.5rem;">';
                detailedHtml += '<h4 style="margin-bottom: 0.75rem; color: #333;">📊 Detailed Bill Breakdown</h4>';
                
                for (const bill of bills) {
                    const d = bill.detailed_data || {};
                    if (!d || Object.keys(d).length === 0) continue;
                    
                    const filename = this.cleanFilename(bill.original_filename || 'Bill');
                    
                    detailedHtml += `<div class="bills-account-group" style="margin-bottom: 1rem;">`;
                    detailedHtml += `<div class="bills-account-header">
                        <div class="account-utility">📄 ${filename}</div>
                        <div class="account-number">${d.utility_name || bill.utility_name || ''}</div>
                        <div class="account-number" style="font-size: 0.85rem; opacity: 0.85;">Account: ${d.customer_account || bill.account_number || 'N/A'}</div>
                    </div>`;
                    
                    // Bill Summary Section
                    detailedHtml += this.renderBillSummarySection(d);
                    
                    // Usage Summary Section
                    detailedHtml += this.renderUsageSummarySection(d);
                    
                    // TOU Rate Table
                    if (d.kwh_on_peak || d.kwh_mid_peak || d.kwh_off_peak) {
                        detailedHtml += this.renderTouSection(d);
                    }
                    
                    // Line Items Table
                    if (d.line_items && d.line_items.length > 0) {
                        detailedHtml += this.renderLineItemsSection(d.line_items);
                    }
                    
                    // Usage History
                    if (d.usage_history && d.usage_history.length > 0) {
                        detailedHtml += this.renderUsageHistorySection(d.usage_history);
                    }
                    
                    detailedHtml += '</div>';
                }
                
                detailedHtml += '</div>';
                container.insertAdjacentHTML('beforeend', detailedHtml);
                
                // Add toggle handlers for collapsible sections
                container.querySelectorAll('.bill-detail-header').forEach(header => {
                    header.addEventListener('click', () => {
                        header.classList.toggle('collapsed');
                        const content = header.nextElementSibling;
                        if (content) content.classList.toggle('collapsed');
                    });
                });
            },
            
            renderBillSummarySection(d) {
                const rawPeriodStart = d.billing_period_start;
                const rawPeriodEnd = d.billing_period_end;
                const periodStart = rawPeriodStart ? new Date(rawPeriodStart).toLocaleDateString() : '-';
                const periodEnd = rawPeriodEnd ? new Date(rawPeriodEnd).toLocaleDateString() : '-';
                const dueDate = d.due_date ? new Date(d.due_date).toLocaleDateString() : '-';
                const computedDays = computeDaysInPeriod(d.days_in_period, rawPeriodStart, rawPeriodEnd);
                
                return `
                    <div class="bill-detail-section">
                        <div class="bill-detail-header">
                            <span>📋 Bill Summary</span>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="bill-detail-content">
                            <div class="bill-summary-grid">
                                <div class="bill-summary-item">
                                    <label>Service Address</label>
                                    <span>${d.service_address || '-'}</span>
                                </div>
                                <div class="bill-summary-item">
                                    <label>Rate Schedule</label>
                                    <span>${d.rate_schedule || d.rate || '-'}</span>
                                </div>
                                <div class="bill-summary-item">
                                    <label>Billing Period</label>
                                    <span>${periodStart} - ${periodEnd} (${computedDays ?? '-'} days)</span>
                                </div>
                                <div class="bill-summary-item highlight">
                                    <label>Amount Due</label>
                                    <span>${formatBillValue(d.amount_due, 'cost')}</span>
                                </div>
                                <div class="bill-summary-item">
                                    <label>Due Date</label>
                                    <span>${dueDate}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            renderUsageSummarySection(d) {
                const hasToU = d.kwh_on_peak || d.kwh_mid_peak || d.kwh_off_peak;
                const hasDemand = d.max_demand_kw || d.max_demand_on_peak_kw;
                
                // Calculate blended rate and avg cost per day
                const totalKwh = d.kwh_total != null ? Number(d.kwh_total) : null;
                const daysInPeriod = computeDaysInPeriod(d.days_in_period, d.billing_period_start, d.billing_period_end);
                const amountDue = d.amount_due != null ? Number(d.amount_due) : null;
                const blendedRateDollars = (totalKwh && amountDue && totalKwh > 0) ? amountDue / totalKwh : null;
                const avgCostPerDay = (amountDue != null && daysInPeriod && daysInPeriod > 0) ? amountDue / daysInPeriod : null;
                const avgKwhPerDay = (totalKwh != null && daysInPeriod && daysInPeriod > 0) ? totalKwh / daysInPeriod : (d.daily_avg_kwh != null ? Number(d.daily_avg_kwh) : null);
                
                let touHtml = '';
                if (hasToU) {
                    touHtml = `
                        <div class="tou-breakdown">
                            ${d.kwh_on_peak ? `<div class="tou-item on-peak"><div class="period">On-Peak</div><div class="kwh">${formatBillValue(d.kwh_on_peak, 'kwh')} kWh</div></div>` : ''}
                            ${d.kwh_mid_peak ? `<div class="tou-item mid-peak"><div class="period">Mid-Peak</div><div class="kwh">${formatBillValue(d.kwh_mid_peak, 'kwh')} kWh</div></div>` : ''}
                            ${d.kwh_off_peak ? `<div class="tou-item off-peak"><div class="period">Off-Peak</div><div class="kwh">${formatBillValue(d.kwh_off_peak, 'kwh')} kWh</div></div>` : ''}
                        </div>
                    `;
                }
                
                let demandHtml = '';
                if (hasDemand) {
                    demandHtml = `
                        <div style="margin-top: 0.75rem;">
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.35rem;">Max Demand</div>
                            <div class="tou-breakdown">
                                ${d.max_demand_kw ? `<div class="usage-stat"><div class="value">${Number(d.max_demand_kw).toLocaleString()} kW</div><div class="label">Total</div></div>` : ''}
                                ${d.max_demand_on_peak_kw ? `<div class="usage-stat"><div class="value">${Number(d.max_demand_on_peak_kw).toLocaleString()} kW</div><div class="label">On-Peak</div></div>` : ''}
                                ${d.max_demand_mid_peak_kw ? `<div class="usage-stat"><div class="value">${Number(d.max_demand_mid_peak_kw).toLocaleString()} kW</div><div class="label">Mid-Peak</div></div>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="bill-detail-section">
                        <div class="bill-detail-header">
                            <span>⚡ Usage Summary</span>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="bill-detail-content">
                            <div class="bill-usage-summary">
                                <div class="usage-stat">
                                    <div class="value">${formatBillValue(totalKwh, 'kwh')}</div>
                                    <div class="label">Total kWh</div>
                                </div>
                                <div class="usage-stat">
                                    <div class="value">${blendedRateDollars != null ? formatBillValue(blendedRateDollars * 100, 'rate') + '/kWh' : '-'}</div>
                                    <div class="label">Avg Rate</div>
                                </div>
                                <div class="usage-stat">
                                    <div class="value">${formatBillValue(avgCostPerDay, 'avgDay')}</div>
                                    <div class="label">Avg $/Day</div>
                                </div>
                            </div>
                            ${touHtml}
                            ${demandHtml}
                        </div>
                    </div>
                `;
            },
            
            renderChargesSection(d) {
                const fmt = (v) => formatBillValue(v, 'cost');
                
                return `
                    <div class="bill-detail-section">
                        <div class="bill-detail-header">
                            <span>💰 Charges Breakdown</span>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="bill-detail-content">
                            <div class="bill-charges-grid">
                                <span class="charge-label">Energy Charges</span>
                                <span class="charge-amount">${fmt(d.energy_charges_total)}</span>
                                <span class="charge-label">Demand Charges</span>
                                <span class="charge-amount">${fmt(d.demand_charges_total)}</span>
                                <span class="charge-label">Other Charges</span>
                                <span class="charge-amount">${fmt(d.other_charges_total)}</span>
                                <span class="charge-label">Taxes</span>
                                <span class="charge-amount">${fmt(d.taxes_total)}</span>
                                <span class="charge-label charge-total">Total Amount Due</span>
                                <span class="charge-amount charge-total">${fmt(d.amount_due)}</span>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            formatRateCents(rateDollars) {
                if (rateDollars == null) return '—';
                const cents = Number(rateDollars) * 100;
                return formatBillValue(cents, 'rate') + '/kWh';
            },
            
            renderTouSection(d) {
                const fmtDollar = (v) => formatBillValue(v, 'cost');
                
                const calcCost = (kwh, rate) => {
                    if (kwh != null && rate != null) {
                        return fmtDollar(Number(kwh) * Number(rate));
                    }
                    return '-';
                };
                
                // Calculate totals
                const totalKwh = (Number(d.kwh_on_peak) || 0) + (Number(d.kwh_mid_peak) || 0) + (Number(d.kwh_off_peak) || 0);
                const totalCost = d.amount_due != null ? Number(d.amount_due) : 
                    ((d.kwh_on_peak && d.rate_on_peak_per_kwh ? Number(d.kwh_on_peak) * Number(d.rate_on_peak_per_kwh) : 0) +
                     (d.kwh_mid_peak && d.rate_mid_peak_per_kwh ? Number(d.kwh_mid_peak) * Number(d.rate_mid_peak_per_kwh) : 0) +
                     (d.kwh_off_peak && d.rate_off_peak_per_kwh ? Number(d.kwh_off_peak) * Number(d.rate_off_peak_per_kwh) : 0));
                const blendedRateDollars = totalKwh > 0 ? totalCost / totalKwh : null;
                
                return `
                    <div class="bill-detail-section">
                        <div class="bill-detail-header">
                            <span>📈 TOU Rate Details</span>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="bill-detail-content">
                            <table class="bill-tou-table">
                                <thead>
                                    <tr>
                                        <th>Period</th>
                                        <th class="num">kWh</th>
                                        <th class="num">Rate/kWh</th>
                                        <th class="num">Est. Cost</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>On-Peak</td>
                                        <td class="num">${formatBillValue(d.kwh_on_peak, 'kwh')}</td>
                                        <td class="num">${d.rate_on_peak_per_kwh != null ? formatBillValue(Number(d.rate_on_peak_per_kwh) * 100, 'rate') + '/kWh' : '-'}</td>
                                        <td class="num">${calcCost(d.kwh_on_peak, d.rate_on_peak_per_kwh)}</td>
                                    </tr>
                                    <tr>
                                        <td>Mid-Peak</td>
                                        <td class="num">${formatBillValue(d.kwh_mid_peak, 'kwh')}</td>
                                        <td class="num">${d.rate_mid_peak_per_kwh != null ? formatBillValue(Number(d.rate_mid_peak_per_kwh) * 100, 'rate') + '/kWh' : '-'}</td>
                                        <td class="num">${calcCost(d.kwh_mid_peak, d.rate_mid_peak_per_kwh)}</td>
                                    </tr>
                                    <tr>
                                        <td>Off-Peak</td>
                                        <td class="num">${formatBillValue(d.kwh_off_peak, 'kwh')}</td>
                                        <td class="num">${d.rate_off_peak_per_kwh != null ? formatBillValue(Number(d.rate_off_peak_per_kwh) * 100, 'rate') + '/kWh' : '-'}</td>
                                        <td class="num">${calcCost(d.kwh_off_peak, d.rate_off_peak_per_kwh)}</td>
                                    </tr>
                                    <tr style="font-weight: bold; border-top: 2px solid #333;">
                                        <td>Total</td>
                                        <td class="num">${formatBillValue(totalKwh, 'kwh')}</td>
                                        <td class="num">${blendedRateDollars != null ? formatBillValue(blendedRateDollars * 100, 'rate') + '/kWh' : '-'}</td>
                                        <td class="num">${fmtDollar(totalCost)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },
            
            renderLineItemsSection(lineItems) {
                let rows = '';
                for (const item of lineItems) {
                    const isCredit = item.amount != null && item.amount < 0;
                    rows += `
                        <tr>
                            <td>${item.category || '-'}</td>
                            <td>${item.label || '-'}</td>
                            <td>${item.calc || '-'}</td>
                            <td class="num ${isCredit ? 'credit' : ''}">${item.amount != null ? (isCredit ? '-' : '') + '$' + Math.abs(item.amount).toFixed(2) : '-'}</td>
                        </tr>
                    `;
                }
                
                return `
                    <div class="bill-detail-section">
                        <div class="bill-detail-header collapsed">
                            <span>📝 Line Items (${lineItems.length})</span>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="bill-detail-content collapsed">
                            <table class="bill-line-items-table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Description</th>
                                        <th>Calculation</th>
                                        <th class="num">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },
            
            renderUsageHistorySection(usageHistory) {
                let rows = '';
                for (const h of usageHistory) {
                    rows += `
                        <tr>
                            <td>${h.month || '-'}</td>
                            <td class="num">${formatBillValue(h.kwh, 'kwh')}</td>
                            <td class="num">${h.days || '-'}</td>
                            <td class="num">${h.avg_kwh_per_day != null ? Number(h.avg_kwh_per_day).toFixed(1) : '-'}</td>
                        </tr>
                    `;
                }
                
                return `
                    <div class="bill-detail-section">
                        <div class="bill-detail-header collapsed">
                            <span>📅 Usage History (${usageHistory.length} months)</span>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="bill-detail-content collapsed">
                            <table class="bill-history-table">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th class="num">kWh</th>
                                        <th class="num">Days</th>
                                        <th class="num">Avg kWh/Day</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },
            
            setupBillsEventHandlers(projectId) {
                const uploadBtn = document.getElementById('billUploadBtn');
                const fileInput = document.getElementById('billFileInput');
                const backBtn = document.getElementById('billsBackBtn');
                
                // Remove old handlers by cloning
                if (uploadBtn) {
                    const newBtn = uploadBtn.cloneNode(true);
                    uploadBtn.parentNode.replaceChild(newBtn, uploadBtn);
                    newBtn.addEventListener('click', () => {
                        const input = document.getElementById('billFileInput');
                        if (input) input.click();
                    });
                }
                
                if (fileInput) {
                    const newInput = fileInput.cloneNode(true);
                    fileInput.parentNode.replaceChild(newInput, fileInput);
                    newInput.addEventListener('change', async (e) => {
                        const files = e.target.files;
                        if (!files || files.length === 0) return;
                        
                        await this.uploadBillsWithProgress(projectId, Array.from(files));
                        
                        // Clear input
                        newInput.value = '';
                    });
                }
                
                if (backBtn) {
                    const newBack = backBtn.cloneNode(true);
                    backBtn.parentNode.replaceChild(newBack, backBtn);
                    newBack.addEventListener('click', () => this.setView('currentProject'));
                }
                
                // Setup review modal handlers
                this.setupReviewModalHandlers(projectId);
                this.setupFieldReviewModalHandlers();
            },
            
            // Track per-file polling intervals
            _filePollers: {},
            
            // Track job status polling interval
            _jobStatusPoller: null,
            
            // Start polling job-status endpoint to update overall progress bar
            startJobStatusPolling(projectId, totalFiles) {
                this.stopJobStatusPolling();
                
                const progressContainer = document.getElementById('billProgressContainer');
                const progressFill = document.getElementById('billProgressFill');
                const progressText = document.getElementById('billProgressText');
                
                // Show the progress bar
                if (progressContainer) progressContainer.classList.add('show');
                
                const poll = async () => {
                    try {
                        const response = await fetch(`/api/projects/${projectId}/bills/job-status`);
                        const data = await response.json();
                        
                        const total = data.total || totalFiles;
                        const complete = data.complete || 0;
                        const failed = data.failed || 0;
                        const needsReview = data.needsReview || 0;
                        const done = complete + failed + needsReview;
                        
                        const pct = total > 0 ? Math.round((done / total) * 100) : 0;
                        
                        if (progressFill) progressFill.style.width = pct + '%';
                        if (progressText) progressText.textContent = `Analyzing ${done} of ${total} bills...`;
                        
                        // Stop polling when all are done
                        if (done >= total) {
                            this.stopJobStatusPolling();
                            if (progressText) progressText.textContent = `Analysis complete: ${complete} ok, ${needsReview} need review, ${failed} failed`;
                            // Hide after delay
                            setTimeout(() => {
                                if (progressContainer) progressContainer.classList.remove('show');
                            }, 5000);
                        }
                    } catch (e) {
                        console.error('[bills] Job status poll error:', e);
                    }
                };
                
                // Poll immediately, then every 2 seconds
                poll();
                this._jobStatusPoller = setInterval(poll, 2000);
            },
            
            stopJobStatusPolling() {
                if (this._jobStatusPoller) {
                    clearInterval(this._jobStatusPoller);
                    this._jobStatusPoller = null;
                }
            },
            
            // Upload files with per-file progress bars
            async uploadBillsWithProgress(projectId, files) {
                const uploadBtn = document.getElementById('billUploadBtn');
                const statusEl = document.getElementById('billUploadStatus');
                const uploadItemsContainer = document.getElementById('billUploadItems');
                
                // Disable button
                if (uploadBtn) {
                    uploadBtn.disabled = true;
                    uploadBtn.textContent = '📤 Uploading...';
                }
                
                // Clear container and create per-file progress items
                uploadItemsContainer.innerHTML = '';
                const fileItems = [];
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const itemId = `upload-item-${i}`;
                    const itemHtml = `
                        <div class="bill-upload-item" id="${itemId}">
                            <span class="filename" title="${file.name}">${file.name}</span>
                            <div class="progress-row">
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill uploading" style="width: 0%"></div>
                                </div>
                                <span class="progress-text">Uploading... 0%</span>
                            </div>
                        </div>
                    `;
                    uploadItemsContainer.insertAdjacentHTML('beforeend', itemHtml);
                    fileItems.push({
                        file,
                        itemId,
                        element: document.getElementById(itemId),
                        fileId: null
                    });
                }
                
                statusEl.textContent = `Uploading ${files.length} bills...`;
                
                // Upload all files in parallel
                const uploadPromises = fileItems.map(async (item) => {
                    const result = await this.uploadSingleFileWithPerFileProgress(projectId, item.file, item.element);
                    if (result.success && result.file) {
                        item.fileId = result.file.id;
                        // Switch to processing phase - show clear Grok analysis message
                        this.updateFileItemStatus(item.element, 'extracting', 0.1, 'Analyzing with Grok AI...');
                        // Update button text to show analysis phase
                        if (uploadBtn) {
                            uploadBtn.textContent = '🔄 Analyzing with Grok...';
                        }
                        statusEl.textContent = `Analyzing ${files.length} bills...`;
                        // Trigger processing
                        try {
                            await fetch(`/api/projects/${projectId}/bills/process/${result.file.id}`, {
                                method: 'POST'
                            });
                        } catch (e) {
                            console.error('[bills] Process trigger error:', e);
                        }
                        // Start polling for extraction progress
                        this.startFileProgressPolling(item.element, result.file.id);
                    } else {
                        // Show error state with specific message
                        const progressFill = item.element.querySelector('.progress-bar-fill');
                        const progressText = item.element.querySelector('.progress-text');
                        const errorMsg = result.error || 'Upload failed';
                        console.error('[bills] Upload failed:', item.file.name, errorMsg);
                        if (progressFill) {
                            progressFill.className = 'progress-bar-fill';
                            progressFill.style.width = '100%';
                            progressFill.style.background = '#dc3545';
                        }
                        if (progressText) {
                            progressText.textContent = errorMsg.length > 40 ? 'Upload failed - see console' : errorMsg;
                            progressText.style.color = '#dc3545';
                        }
                    }
                    return result;
                });
                
                await Promise.all(uploadPromises);
                
                // Start job status polling for overall progress bar
                this.startJobStatusPolling(projectId, files.length);
                
                // Wait for all extraction polling to complete
                await this.waitForAllExtractions(fileItems);
                
                // Stop job status polling (extraction is done)
                this.stopJobStatusPolling();
                
                // Done - reload data and show summary
                await this.loadBillsData(projectId);
                
                // Get file status counts for summary
                let okCount = 0;
                let needsReviewCount = 0;
                try {
                    const statusResponse = await fetch(`/api/projects/${projectId}/bills/status`);
                    const statusData = await statusResponse.json();
                    if (statusData.success && statusData.files) {
                        statusData.files.forEach(f => {
                            const status = f.review_status || f.processing_status || 'pending';
                            if (status === 'ok' || status === 'approved') {
                                okCount++;
                            } else if (status === 'needs_review') {
                                needsReviewCount++;
                            }
                        });
                    }
                } catch (e) {
                    console.error('[bills] Status summary error:', e);
                }
                
                // Update the main progress bar with final summary
                const progressContainer = document.getElementById('billProgressContainer');
                const progressFill = document.getElementById('billProgressFill');
                const progressText = document.getElementById('billProgressText');
                if (progressFill) progressFill.style.width = '100%';
                if (progressText) progressText.textContent = `Complete: ${okCount} ok, ${needsReviewCount} need review`;
                
                // Show summary in status
                statusEl.textContent = `Finished: ${okCount} ok, ${needsReviewCount} need review`;
                
                // Show completion toast
                const totalProcessed = files.length;
                this.showToast(`${totalProcessed} bills processed · ${okCount} OK · ${needsReviewCount} needs review`, 'success');
                
                // Clear upload items and hide progress bar after delay
                setTimeout(() => {
                    statusEl.textContent = '';
                    uploadItemsContainer.innerHTML = '';
                    if (progressContainer) progressContainer.classList.remove('show');
                }, 5000);
                
                if (uploadBtn) {
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = '📤 Upload Bills';
                }
            },
            
            // Upload single file with XMLHttpRequest and update its specific progress item
            uploadSingleFileWithPerFileProgress(projectId, file, itemElement) {
                return new Promise((resolve) => {
                    const xhr = new XMLHttpRequest();
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const progressFill = itemElement.querySelector('.progress-bar-fill');
                    const progressText = itemElement.querySelector('.progress-text');
                    
                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            const pct = Math.round((e.loaded / e.total) * 100);
                            if (progressFill) progressFill.style.width = pct + '%';
                            if (progressText) progressText.textContent = `Uploading... ${pct}%`;
                        }
                    });
                    
                    xhr.addEventListener('load', () => {
                        try {
                            const result = JSON.parse(xhr.responseText);
                            resolve(result);
                        } catch (e) {
                            resolve({ success: false, error: 'Parse error' });
                        }
                    });
                    
                    xhr.addEventListener('error', () => {
                        resolve({ success: false, error: 'Network error' });
                    });
                    
                    xhr.open('POST', `/api/projects/${projectId}/bills/upload`);
                    xhr.send(formData);
                });
            },
            
            // Granular state labels for user-friendly display
            STATE_LABELS: {
                'queued': 'Queued...',
                'extracting_text': 'Extracting text...',
                'ocr': 'Running OCR...',
                'cleaning': 'Cleaning text...',
                'cached_hit': '⚡ Cache hit',
                'parsing_pass_a': 'AI parsing (quick)...',
                'parsing_pass_b': 'AI parsing (detailed)...',
                'done': '✓ Complete',
                'complete': '✓ Complete',
                'ok': '✓ OK',
                'needs_review': '⚠ Needs Review',
                'failed': '✗ Failed',
                'error': '✗ Analysis failed',
                'pending': 'Pending...',
                'extracting': 'Analyzing...',
                'processing': 'Processing...'
            },
            
            // Update file item visual status
            updateFileItemStatus(itemElement, status, progress, text) {
                const progressFill = itemElement.querySelector('.progress-bar-fill');
                const progressText = itemElement.querySelector('.progress-text');
                
                if (!progressFill || !progressText) return;
                
                // Remove all status classes
                progressFill.className = 'progress-bar-fill';
                progressText.className = 'progress-text';
                
                // Map granular states to display categories
                const processingStates = ['queued', 'extracting_text', 'ocr', 'cleaning', 'parsing_pass_a', 'parsing_pass_b', 'extracting', 'processing'];
                const completeStates = ['complete', 'done', 'cached_hit'];
                const okStates = ['ok'];
                const reviewStates = ['needs_review'];
                const skippedStates = ['skipped'];
                const errorStates = ['failed', 'error'];
                
                if (status === 'pending') {
                    progressFill.classList.add('pending');
                    progressFill.style.width = '100%';
                    progressText.textContent = text || this.STATE_LABELS[status] || 'Pending...';
                } else if (status === 'cached_hit') {
                    // Cache hit - show special fast completion (blue)
                    progressFill.classList.add('complete');
                    progressFill.style.width = '100%';
                    progressText.classList.add('complete');
                    progressText.textContent = '⚡ Cached (instant)';
                } else if (processingStates.includes(status)) {
                    progressFill.classList.add('extracting');
                    progressFill.style.width = Math.round(progress * 100) + '%';
                    const label = this.STATE_LABELS[status] || 'Processing...';
                    progressText.textContent = text || `${label} ${Math.round(progress * 100)}%`;
                } else if (completeStates.includes(status)) {
                    // Blue - perfect extraction, all fields present
                    progressFill.classList.add('complete');
                    progressFill.style.width = '100%';
                    progressText.classList.add('complete');
                    progressText.textContent = text || '✓ Complete';
                } else if (okStates.includes(status)) {
                    // Green - critical data present, some non-critical missing
                    progressFill.classList.add('ok');
                    progressFill.style.width = '100%';
                    progressText.classList.add('ok');
                    progressText.textContent = text || '✓ OK';
                } else if (reviewStates.includes(status)) {
                    // Yellow - missing critical info
                    progressFill.classList.add('needs-review');
                    progressFill.style.width = '100%';
                    progressText.classList.add('needs-review');
                    progressText.textContent = '⚠ Needs Review';
                } else if (errorStates.includes(status)) {
                    // Red - failed
                    progressFill.style.background = '#dc3545';
                    progressFill.style.width = '100%';
                    progressText.style.color = '#dc3545';
                    progressText.textContent = text || '✗ Failed';
                } else if (skippedStates.includes(status)) {
                    // Gray - non-electric bill (water, trash, etc)
                    progressFill.classList.add('skipped');
                    progressFill.style.width = '100%';
                    progressText.classList.add('skipped');
                    progressText.textContent = text || '○ Non-Electric';
                } else {
                    // Unknown status - show as processing
                    progressFill.classList.add('extracting');
                    progressFill.style.width = Math.round(progress * 100) + '%';
                    progressText.textContent = text || `Processing... ${Math.round(progress * 100)}%`;
                }
            },
            
            // Track when polling started for each file (for "still working" messages)
            _filePollerStartTimes: {},
            
            // Start polling per-file progress endpoint using new granular status API
            startFileProgressPolling(itemElement, fileId) {
                // Stop any existing poller for this file
                if (this._filePollers[fileId]) {
                    clearInterval(this._filePollers[fileId]);
                }
                
                // Track when we started polling this file
                this._filePollerStartTimes[fileId] = Date.now();
                
                const poll = async () => {
                    try {
                        // Use new granular status endpoint
                        const response = await fetch(`/api/bills/status/${fileId}`);
                        const data = await response.json();
                        
                        // New API returns 'state' instead of 'status'
                        const state = data.state || data.status || 'pending';
                        const progress = data.progress || 0;
                        const errorMsg = data.error || data.message || null;
                        
                        // Terminal states for stopping polling (includes cached_hit as it's a fast success)
                        const terminalStates = ['done', 'failed', 'ok', 'complete', 'needs_review', 'skipped', 'error', 'cached_hit'];
                        // Processing states for "still working" message
                        const processingStates = ['queued', 'extracting_text', 'ocr', 'cleaning', 'parsing_pass_a', 'parsing_pass_b', 'extracting', 'processing'];
                        
                        // Check if extraction is taking too long (> 30 seconds)
                        let customText = null;
                        if (processingStates.includes(state) && this._filePollerStartTimes[fileId]) {
                            const elapsedMs = Date.now() - this._filePollerStartTimes[fileId];
                            if (elapsedMs > 30000) {
                                customText = 'Still working... (this may take longer than usual)';
                            }
                        }
                        
                        this.updateFileItemStatus(itemElement, state, progress, customText);
                        
                        // Stop polling when in terminal state
                        if (terminalStates.includes(state)) {
                            clearInterval(this._filePollers[fileId]);
                            delete this._filePollers[fileId];
                            delete this._filePollerStartTimes[fileId];
                            
                            if ((state === 'error' || state === 'failed') && errorMsg) {
                                console.error('[bills] Extraction error for file', fileId + ':', errorMsg);
                            }
                            
                            // IMMEDIATELY refresh UI sections so completed/failed bills appear
                            const projectId = ProjectState.currentProjectId;
                            if (projectId) {
                                this.loadBillsData(projectId);  // Refresh Uploaded Files
                                this.loadProjectBillsSummary(); // Refresh Extracted Data
                            }
                        }
                    } catch (e) {
                        console.error('[bills] File progress poll error:', fileId, e);
                        // Fall back to old endpoint if new one fails
                        try {
                            const fallback = await fetch(`/api/bills/file/${fileId}/progress`);
                            const fallbackData = await fallback.json();
                            const status = fallbackData.status || 'pending';
                            const progress = fallbackData.progress || 0;
                            this.updateFileItemStatus(itemElement, status, progress, null);
                            
                            if (['ok', 'complete', 'needs_review', 'skipped', 'error'].includes(status)) {
                                clearInterval(this._filePollers[fileId]);
                                delete this._filePollers[fileId];
                                delete this._filePollerStartTimes[fileId];
                            }
                        } catch (fe) {
                            console.error('[bills] Fallback poll also failed:', fe);
                        }
                    }
                };
                
                // Poll immediately then every 500ms
                poll();
                this._filePollers[fileId] = setInterval(poll, 500);
            },
            
            // Wait for all file extractions to complete
            waitForAllExtractions(fileItems) {
                return new Promise((resolve) => {
                    const checkComplete = () => {
                        const activePollers = Object.keys(this._filePollers).length;
                        if (activePollers === 0) {
                            resolve();
                        } else {
                            setTimeout(checkComplete, 200);
                        }
                    };
                    // Start checking after a small delay to let pollers initialize
                    setTimeout(checkComplete, 500);
                });
            },
            
            // Status polling
            _statusPollInterval: null,
            
            startStatusPolling(projectId) {
                this.stopStatusPolling();
                this._statusPollInterval = setInterval(async () => {
                    try {
                        const response = await fetch(`/api/projects/${projectId}/bills/status`);
                        const data = await response.json();
                        if (data.success && data.files) {
                            this.renderBillFiles(data.files);
                        }
                    } catch (e) {
                        console.error('[bills] Status poll error:', e);
                    }
                }, 2000);
            },
            
            stopStatusPolling() {
                if (this._statusPollInterval) {
                    clearInterval(this._statusPollInterval);
                    this._statusPollInterval = null;
                }
            },
            
            // Bill Review Modal
            _currentReviewFile: null,
            _isEditMode: false,
            
            _screenshotDataUrl: null,
            
            setupReviewModalHandlers(projectId) {
                const modal = document.getElementById('billReviewModal');
                const closeBtn = document.getElementById('billReviewClose');
                const backBtn = document.getElementById('billReviewBackBtn');
                const editBtn = document.getElementById('billReviewEditBtn');
                const saveBtn = document.getElementById('billReviewSaveBtn');
                const screenshotBtn = document.getElementById('billScreenshotBtn');
                const screenshotInput = document.getElementById('billScreenshotInput');
                
                if (closeBtn) {
                    closeBtn.onclick = () => NavigationController.closeBillReview();
                }
                
                if (backBtn) {
                    backBtn.onclick = () => NavigationController.closeBillReview();
                }
                
                if (modal) {
                    modal.onclick = (e) => {
                        if (e.target === modal) NavigationController.closeBillReview();
                    };
                }
                
                if (editBtn) {
                    editBtn.onclick = () => NavigationController.toggleEditMode();
                }
                
                if (saveBtn) {
                    saveBtn.onclick = () => NavigationController.saveCorrections(projectId);
                }
                
                // Manual fix button handler
                const manualFixBtn = document.getElementById('billReviewManualFixBtn');
                if (manualFixBtn) {
                    manualFixBtn.onclick = () => NavigationController.saveManualFix(projectId);
                }
                
                // Screenshot upload handlers
                if (screenshotBtn && screenshotInput) {
                    screenshotBtn.onclick = () => screenshotInput.click();
                    screenshotInput.onchange = async (e) => {
                        const files = e.target.files;
                        if (!files || files.length === 0) return;
                        
                        if (!this._currentReviewFile) return;
                        const billId = this._currentReviewFile.id;
                        
                        const formData = new FormData();
                        for (let i = 0; i < files.length; i++) {
                            formData.append('files', files[i]);
                        }
                        
                        try {
                            screenshotBtn.disabled = true;
                            screenshotBtn.textContent = 'Uploading...';
                            
                            const response = await fetch(`/api/bills/${billId}/screenshots`, {
                                method: 'POST',
                                body: formData
                            });
                            const result = await response.json();
                            
                            if (result.success) {
                                this.hideScreenshotError();
                                await this.loadScreenshots(billId);
                            } else {
                                this.showScreenshotError(result.error || 'Upload failed');
                            }
                        } catch (err) {
                            console.error('[bills] Screenshot upload error:', err);
                            this.showScreenshotError('Failed to upload screenshot');
                        } finally {
                            screenshotBtn.disabled = false;
                            screenshotBtn.textContent = '📤 Add Screenshot';
                            screenshotInput.value = '';
                        }
                    };
                }
            },
            
            showScreenshotError(message) {
                const el = document.getElementById('billScreenshotError');
                if (el) {
                    el.textContent = message;
                    el.style.display = 'block';
                }
            },
            
            hideScreenshotError() {
                const el = document.getElementById('billScreenshotError');
                if (el) el.style.display = 'none';
            },
            
            async loadScreenshots(billId) {
                try {
                    const response = await fetch(`/api/bills/${billId}/screenshots`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.renderScreenshotGallery(data.screenshots || []);
                    }
                } catch (e) {
                    console.error('[bills] Failed to load screenshots:', e);
                }
            },
            
            renderScreenshotGallery(screenshots) {
                const gallery = document.getElementById('billScreenshotGallery');
                if (!gallery) return;
                
                if (!screenshots || screenshots.length === 0) {
                    gallery.innerHTML = '<p style="color:#999;font-size:0.85rem;">No files yet.</p>';
                    return;
                }
                
                gallery.innerHTML = screenshots.map(s => {
                    const date = s.uploaded_at ? new Date(s.uploaded_at).toLocaleString() : '';
                    const label = s.page_hint || s.original_filename || 'File';
                    const isPdf = s.mime_type === 'application/pdf' || (s.original_filename && s.original_filename.toLowerCase().endsWith('.pdf'));
                    
                    let thumbContent;
                    if (isPdf) {
                        thumbContent = `<div class="bill-screenshot-thumb bill-pdf-thumb" onclick="window.open('${s.url}', '_blank')">📄 PDF</div>`;
                    } else {
                        thumbContent = `<img src="${s.url}" class="bill-screenshot-thumb" onclick="window.open('${s.url}', '_blank')" alt="${label}">`;
                    }
                    
                    return `
                        <div class="bill-screenshot-item" data-screenshot-id="${s.id}">
                            <button class="bill-screenshot-delete" onclick="NavigationController.deleteScreenshot(${s.id})">&times;</button>
                            ${thumbContent}
                            <div class="bill-screenshot-info" title="${date}">${label}</div>
                        </div>
                    `;
                }).join('');
            },
            
            async deleteScreenshot(screenshotId) {
                if (!this._currentReviewFile) return;
                const billId = this._currentReviewFile.id;
                
                const confirmed = await showConfirmModal({
                    title: 'Delete Screenshot',
                    message: 'Delete this screenshot?',
                    confirmText: 'Delete',
                    cancelText: 'Cancel',
                    danger: true
                });
                if (!confirmed) return;
                
                try {
                    const response = await fetch(`/api/bills/${billId}/screenshots/${screenshotId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        await this.loadScreenshots(billId);
                    } else {
                        this.showToast('Failed to delete: ' + (result.error || 'Unknown error'), 'error');
                    }
                } catch (e) {
                    console.error('[bills] Delete screenshot error:', e);
                    this.showToast('Failed to delete screenshot', 'error');
                }
            },
            
            async openBillReview(projectId, fileId) {
                try {
                    const response = await fetch(`/api/projects/${projectId}/bills/files/${fileId}/review`);
                    const data = await response.json();
                    
                    if (!data.success) {
                        this.showToast('Could not load bill details: ' + (data.error || 'Unknown error'), 'error');
                        return;
                    }
                    
                    // Merge extraction_payload into file object so renderBillReviewModal has access
                    this._currentReviewFile = { ...data.file, extraction_payload: data.extraction_payload };
                    this._isEditMode = false;
                    this.hideScreenshotError();
                    this.renderBillReviewModal(this._currentReviewFile);
                    
                    // Load existing screenshots
                    await this.loadScreenshots(fileId);
                    
                    const modal = document.getElementById('billReviewModal');
                    if (modal) modal.classList.add('show');
                } catch (e) {
                    console.error('[bills] Review load error:', e);
                    this.showToast('Failed to load bill review', 'error');
                }
            },
            
            closeBillReview() {
                const modal = document.getElementById('billReviewModal');
                if (modal) modal.classList.remove('show');
                this._currentReviewFile = null;
                this._isEditMode = false;
            },
            
            showToast(message, type = 'info') {
                // Create toast element
                const toast = document.createElement('div');
                toast.className = `bills-toast bills-toast-${type}`;
                toast.textContent = message;
                toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 24px;border-radius:8px;z-index:100002;font-size:0.95rem;box-shadow:0 4px 12px rgba(0,0,0,0.3);opacity:0;transition:opacity 0.3s;';
                
                if (type === 'success') toast.style.background = '#28a745';
                else if (type === 'error') toast.style.background = '#dc3545';
                
                document.body.appendChild(toast);
                setTimeout(() => toast.style.opacity = '1', 10);
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },
            
            // Field Review Modal (for editing missing fields)
            _currentFieldReviewBillId: null,
            _fieldReviewData: null,
            
            async openFieldReviewModal(billId) {
                const modal = document.getElementById('fieldReviewModal');
                const bodyEl = document.getElementById('fieldReviewBody');
                
                if (!modal || !bodyEl) return;
                
                // Show modal with loading state
                bodyEl.innerHTML = '<p>Loading...</p>';
                modal.classList.add('show');
                this._currentFieldReviewBillId = billId;
                
                try {
                    const response = await fetch(`/api/bills/${billId}/review`);
                    const data = await response.json();
                    
                    if (!data.success) {
                        bodyEl.innerHTML = `<p style="color:#dc3545;">Error: ${data.error || 'Failed to load bill data'}</p>`;
                        return;
                    }
                    
                    this._fieldReviewData = data;
                    this.renderFieldReviewForm(data);
                } catch (e) {
                    console.error('[bills] Field review load error:', e);
                    bodyEl.innerHTML = '<p style="color:#dc3545;">Failed to load bill data</p>';
                }
            },
            
            renderFieldReviewForm(data) {
                const bodyEl = document.getElementById('fieldReviewBody');
                if (!bodyEl) return;
                
                const missingFields = data.missing || [];
                const currentValues = data.currentValues || {};
                
                if (missingFields.length === 0) {
                    bodyEl.innerHTML = '<p style="color:#28a745;">✓ All required fields have values. No corrections needed.</p>';
                    return;
                }
                
                let html = '<p style="margin-bottom:1rem;color:#666;">Please fill in the missing values below:</p>';
                
                for (const field of missingFields) {
                    const fieldName = field.field || field;
                    const fieldLabel = field.label || this.humanizeFieldName(fieldName);
                    const currentValue = currentValues[fieldName] || '';
                    const inputType = this.getInputTypeForField(fieldName);
                    
                    html += `
                        <div class="field-review-field">
                            <label for="field-${fieldName}">${fieldLabel}</label>
                            <input type="${inputType}" id="field-${fieldName}" name="${fieldName}" value="${currentValue}" placeholder="Enter ${fieldLabel.toLowerCase()}">
                        </div>
                    `;
                }
                
                bodyEl.innerHTML = html;
            },
            
            humanizeFieldName(fieldName) {
                // Convert snake_case to Title Case
                return fieldName
                    .replace(/_/g, ' ')
                    .replace(/\b\w/g, c => c.toUpperCase());
            },
            
            getInputTypeForField(fieldName) {
                if (fieldName.includes('date')) return 'date';
                if (fieldName.includes('amount') || fieldName.includes('cost') || fieldName.includes('charge') || fieldName.includes('kwh') || fieldName.includes('rate')) return 'number';
                return 'text';
            },
            
            closeFieldReviewModal() {
                const modal = document.getElementById('fieldReviewModal');
                if (modal) modal.classList.remove('show');
                this._currentFieldReviewBillId = null;
                this._fieldReviewData = null;
            },
            
            async saveFieldReviewChanges() {
                const billId = this._currentFieldReviewBillId;
                if (!billId) return;
                
                const bodyEl = document.getElementById('fieldReviewBody');
                if (!bodyEl) return;
                
                // Collect values from the form
                const inputs = bodyEl.querySelectorAll('input');
                const updates = {};
                
                inputs.forEach(input => {
                    const value = input.value.trim();
                    if (value !== '') {
                        // Parse numbers for numeric fields
                        if (input.type === 'number') {
                            updates[input.name] = parseFloat(value);
                        } else {
                            updates[input.name] = value;
                        }
                    }
                });
                
                if (Object.keys(updates).length === 0) {
                    this.showToast('No changes to save', 'info');
                    return;
                }
                
                const saveBtn = document.getElementById('fieldReviewSave');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Saving...';
                }
                
                try {
                    const response = await fetch(`/api/bills/${billId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updates)
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        this.closeFieldReviewModal();
                        this.showToast('Bill updated successfully', 'success');
                        
                        // Refresh bill data
                        const projectId = ProjectState.currentProjectId;
                        if (projectId) {
                            await this.loadBillsForProject(projectId);
                        }
                    } else {
                        this.showToast(result.error || 'Failed to save changes', 'error');
                    }
                } catch (e) {
                    console.error('[bills] Save field review error:', e);
                    this.showToast('Failed to save changes', 'error');
                } finally {
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.textContent = '💾 Save';
                    }
                }
            },
            
            setupFieldReviewModalHandlers() {
                const modal = document.getElementById('fieldReviewModal');
                const closeBtn = document.getElementById('fieldReviewClose');
                const cancelBtn = document.getElementById('fieldReviewCancel');
                const saveBtn = document.getElementById('fieldReviewSave');
                
                if (closeBtn) closeBtn.onclick = () => this.closeFieldReviewModal();
                if (cancelBtn) cancelBtn.onclick = () => this.closeFieldReviewModal();
                if (saveBtn) saveBtn.onclick = () => this.saveFieldReviewChanges();
                
                if (modal) {
                    modal.onclick = (e) => {
                        if (e.target === modal) this.closeFieldReviewModal();
                    };
                }
            },
            
            renderBillReviewModal(file) {
                const missingFieldsEl = document.getElementById('billReviewMissingFields');
                const infoEl = document.getElementById('billReviewFileInfo');
                const dataEl = document.getElementById('billReviewData');
                const screenshotSection = document.getElementById('billReviewScreenshot');
                const saveBtn = document.getElementById('billReviewSaveBtn');
                const editBtn = document.getElementById('billReviewEditBtn');
                
                if (!infoEl || !dataEl) return;
                
                // Screenshot section always visible now (supports multiple screenshots)
                if (screenshotSection) {
                    screenshotSection.style.display = 'block';
                }
                
                const cleanName = this.cleanFilename(file.original_filename);
                const size = file.file_size ? `${(file.file_size / 1024).toFixed(1)} KB` : 'Unknown size';
                const date = file.upload_date ? new Date(file.upload_date).toLocaleString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit', hour: 'numeric', minute: '2-digit', hour12: true }) : 'Unknown date';
                const reviewStatus = file.review_status || file.processing_status;
                const serviceType = file.service_type || (file.extraction_payload ? file.extraction_payload.service_type : null);
                const statusDisplay = this.getStatusDisplay(reviewStatus, serviceType);
                
                // Render Missing Fields Panel (from validation data)
                const validation = file.validation || {};
                const missingFields = validation.missing_fields || [];
                const needsReviewReasons = file.needs_review_reasons || [];
                
                if (missingFieldsEl) {
                    // If status is needs_review, show the reasons header first
                    let reasonsHtml = '';
                    if (reviewStatus === 'needs_review' && needsReviewReasons.length > 0) {
                        reasonsHtml = `<div class="bill-needs-review-reasons" style="background:#fff3cd;border:2px solid #ffc107;border-radius:8px;padding:1rem;margin-bottom:1rem;">
                            <h5 style="margin:0 0 0.5rem 0;color:#856404;">⚠️ Needs Review Because:</h5>
                            <ul style="margin:0;padding-left:1.25rem;color:#856404;">
                                ${needsReviewReasons.map(r => `<li>${r}</li>`).join('')}
                            </ul>
                        </div>`;
                    }
                    
                    if (missingFields.length > 0) {
                        const isError = missingFields.length > 2;
                        let missingHtml = reasonsHtml + `<div class="bill-missing-fields ${isError ? 'error' : ''}">
                            <h5>⚠️ Missing Required Data</h5>
                            <div class="missing-fields-list">`;
                        
                        for (const mf of missingFields) {
                            const field = typeof mf === 'string' ? mf : mf.field;
                            const label = typeof mf === 'string' ? mf.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : mf.label;
                            const reason = typeof mf === 'object' ? mf.reason : '';
                            const inputType = this.getInputTypeForField(field);
                            
                            missingHtml += `
                                <div class="missing-field-item">
                                    <div class="missing-field-info">
                                        <span class="missing-field-label">${label}</span>
                                        ${reason ? `<span class="missing-field-reason">${reason}</span>` : ''}
                                    </div>
                                    <div class="missing-field-input">
                                        <input type="${inputType}" 
                                               class="manual-fix-input" 
                                               data-field="${field}" 
                                               placeholder="Enter ${label}"
                                               ${inputType === 'number' ? 'step="0.01"' : ''}>
                                    </div>
                                </div>
                            `;
                        }
                        
                        missingHtml += `</div></div>`;
                        missingFieldsEl.innerHTML = missingHtml;
                        
                        // Show the "Save & Mark as OK" button when there are missing fields
                        const manualFixBtn = document.getElementById('billReviewManualFixBtn');
                        if (manualFixBtn) manualFixBtn.style.display = 'inline-block';
                    } else if (reviewStatus === 'needs_review' && needsReviewReasons.length > 0) {
                        // No missing fields but we have needs_review reasons - still show them
                        missingFieldsEl.innerHTML = `<div class="bill-needs-review-reasons" style="background:#fff3cd;border:2px solid #ffc107;border-radius:8px;padding:1rem;margin-bottom:1rem;">
                            <h5 style="margin:0 0 0.5rem 0;color:#856404;">⚠️ Needs Review Because:</h5>
                            <ul style="margin:0;padding-left:1.25rem;color:#856404;">
                                ${needsReviewReasons.map(r => `<li>${r}</li>`).join('')}
                            </ul>
                        </div>`;
                        const manualFixBtn = document.getElementById('billReviewManualFixBtn');
                        if (manualFixBtn) manualFixBtn.style.display = 'none';
                    } else {
                        missingFieldsEl.innerHTML = '';
                        const manualFixBtn = document.getElementById('billReviewManualFixBtn');
                        if (manualFixBtn) manualFixBtn.style.display = 'none';
                    }
                }
                
                infoEl.innerHTML = `
                    <div class="bill-review-meta">
                        <div>
                            <strong>File:</strong> ${cleanName}<br>
                            <strong>Size:</strong> ${size} &nbsp;|&nbsp; <strong>Uploaded:</strong> ${date}<br>
                            <strong>Status:</strong> <span class="${statusDisplay.class}">${statusDisplay.icon} ${statusDisplay.label}</span>
                        </div>
                        <div class="bill-review-actions">
                            <button type="button" class="button secondary bill-view-pdf-btn" onclick="openBillPdfModal(${file.id}, '${cleanName.replace(/'/g, "\\'")}')">
                                📄 View PDF
                            </button>
                        </div>
                    </div>
                `;
                
                // Check for failed/error status BEFORE checking payload
                const processingStatus = file.processing_status || '';
                const isExtractionFailed = processingStatus === 'failed' || processingStatus === 'error';
                
                // Get error message if available (prefer structured fields)
                const payload = file.extraction_payload;
                const errorCode = payload?.error_code || payload?.errorCode || null;
                const errorReason = payload?.error_reason || payload?.errorReason || payload?.error || file.error || null;
                
                const formatErrorHelp = (code, reason) => {
                    if (code === 'CONFIG_XAI_API_KEY_MISSING') {
                        return `${reason || 'Missing XAI_API_KEY.'} Add \`XAI_API_KEY=...\` to your .env/local.env and restart the server.`;
                    }
                    if (code === 'QUEUE_FAILED') {
                        return `${reason || 'Failed to start extraction.'} Try again; if it keeps happening, restart the server and check logs.`;
                    }
                    if (code === 'PROCESS_ENDPOINT_EXCEPTION') {
                        return `${reason || 'Server error starting extraction.'} Check server logs for details.`;
                    }
                    if (code === 'EXTRACTION_EXCEPTION') {
                        return `${reason || 'Extraction crashed.'} Check server logs; you can still proceed by uploading annotated screenshots or using Edit.`;
                    }
                    return reason || null;
                };
                
                const errorMessage = formatErrorHelp(errorCode, errorReason);
                
                // Show prominent error message for failed extractions
                if (isExtractionFailed || (!payload && processingStatus !== 'pending' && processingStatus !== 'processing')) {
                    let errorHtml = `
                        <div style="background: #fee2e2; border: 2px solid #dc3545; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="color: #dc3545; font-weight: bold; font-size: 1.1rem; margin-bottom: 0.5rem;">
                                ✗ Extraction Failed
                            </div>
                            <p style="color: #7f1d1d; margin: 0;">
                                ${errorMessage ? `<strong>Reason:</strong> ${errorMessage}${errorCode ? ` <span style="opacity:0.7;">(code: ${errorCode})</span>` : ''}` : 'AI extraction could not process this bill. Please upload annotated screenshots or manually enter the data using the Edit button.'}
                            </p>
                        </div>
                    `;
                    dataEl.innerHTML = errorHtml;
                    
                    // Auto-open edit mode for failed extractions
                    if (!this._isEditMode) {
                        this._isEditMode = true;
                        const editBtn = document.getElementById('billReviewEditBtn');
                        const saveBtn = document.getElementById('billReviewSaveBtn');
                        if (editBtn) editBtn.innerHTML = '❌ Cancel';
                        if (saveBtn) saveBtn.style.display = 'inline-block';
                        // Store empty original payload for dirty tracking
                        this._originalPayload = '{}';
                    }
                    return;
                }
                
                // Check for empty payload (pending/processing state or no data)
                // IMPORTANT: Don't bail out if detailed_data exists - we can still show analysis even without accounts/meters
                const hasAccounts = payload?.accounts && payload.accounts.length > 0;
                const hasMeters = payload?.meters && payload.meters.length > 0;
                const hasDetailedData = payload?.detailed_data && Object.keys(payload.detailed_data).length > 0;
                const hasAnyRenderableData = hasAccounts || hasMeters || hasDetailedData || payload?.utility_name || payload?.account_number;
                
                if (!payload || !hasAnyRenderableData) {
                    if (processingStatus === 'pending' || processingStatus === 'processing') {
                        dataEl.innerHTML = '<p style="color:#666;font-style:italic;">Bill is still being processed. Please wait...</p>';
                    } else {
                        dataEl.innerHTML = '<p style="color:#666;font-style:italic;">No data extracted yet. Upload annotated screenshots or use Edit to fill in missing fields.</p>';
                    }
                    return;
                }
                
                let html = '';
                
                // Show a non-blocking warning banner if review_status is needs_review
                // This replaces the "hostage" pattern - data is shown, user can review/edit, warning is informational.
                const reviewSt = file.review_status || file.processing_status || '';
                if (reviewSt === 'needs_review' && !this._isEditMode) {
                    const mf = file.validation?.missing_fields || [];
                    const contextFields = mf.filter(f => {
                        const fname = (typeof f === 'string' ? f : f.field || '').toLowerCase();
                        return ['service_address', 'rate_schedule', 'meter_number'].some(c => fname.includes(c));
                    });
                    const coreFields = mf.filter(f => !contextFields.includes(f));
                    
                    if (coreFields.length > 0 || contextFields.length > 0) {
                        html += `<div style="background:#fff3cd;border:1px solid #ffc107;border-radius:6px;padding:0.75rem;margin-bottom:1rem;">
                            <strong style="color:#856404;">⚠️ Some fields need attention</strong>
                            <p style="margin:0.5rem 0 0 0;font-size:0.9rem;color:#856404;">
                                ${coreFields.length > 0 ? `<b>Required:</b> ${coreFields.map(f => typeof f === 'string' ? f.replace(/_/g,' ') : f.label).join(', ')}<br>` : ''}
                                ${contextFields.length > 0 ? `<span style="opacity:0.85">Optional context: ${contextFields.map(f => typeof f === 'string' ? f.replace(/_/g,' ') : f.label).join(', ')}</span>` : ''}
                            </p>
                        </div>`;
                    }
                }
                
                // Handle accounts/meters structure
                const accounts = payload.accounts || [{ account_number: payload.account_number || '', utility_name: payload.utility_name || '', meters: payload.meters || [] }];
                
                // Get first account for bill-level fields
                const firstAccount = accounts[0] || {};
                const utilityName = firstAccount.utility_name || payload.utility_name || '';
                const accountNumber = firstAccount.account_number || payload.account_number || '';
                
                // Bill-Level Fields Section
                html += '<div class="bill-level-fields"><h5>📋 Bill Information</h5><div class="bill-field-row">';
                
                const utilityMissing = !utilityName ? 'field-missing' : '';
                const accountMissing = !accountNumber ? 'field-missing' : '';
                
                // Get due_date and rate_schedule from payload or detailed_data
                const detailedData = payload.detailed_data || {};
                const dueDate = payload.due_date || detailedData.due_date || '';
                const rateSchedule = payload.rate_schedule || detailedData.rate_schedule || detailedData.rate || '';
                const dueDateMissing = !dueDate ? 'field-missing' : '';
                const rateMissing = !rateSchedule ? 'field-missing' : '';
                
                if (this._isEditMode) {
                    html += `
                        <div class="bill-field">
                            <label>Utility Name</label>
                            <input type="text" id="billUtilityName" class="${utilityMissing}" value="${utilityName}" placeholder="e.g., SCE, PG&E">
                        </div>
                        <div class="bill-field">
                            <label>Account Number</label>
                            <input type="text" id="billAccountNumber" class="${accountMissing}" value="${accountNumber}" placeholder="Account #">
                        </div>
                        <div class="bill-field">
                            <label>Due Date</label>
                            <input type="date" id="billDueDate" class="${dueDateMissing}" value="${dueDate}" placeholder="YYYY-MM-DD">
                        </div>
                        <div class="bill-field">
                            <label>Rate Schedule</label>
                            <input type="text" id="billRateSchedule" class="${rateMissing}" value="${rateSchedule}" placeholder="e.g., TOU-GS-2-E">
                        </div>
                    `;
                } else {
                    const displayDueDate = dueDate ? new Date(dueDate).toLocaleDateString() : 'Not specified';
                    html += `
                        <div class="bill-field">
                            <label>Utility Name</label>
                            <input type="text" disabled value="${utilityName || 'Not specified'}">
                        </div>
                        <div class="bill-field">
                            <label>Account Number</label>
                            <input type="text" disabled value="${accountNumber || 'Not specified'}">
                        </div>
                        <div class="bill-field">
                            <label>Due Date</label>
                            <input type="text" disabled value="${displayDueDate}">
                        </div>
                        <div class="bill-field">
                            <label>Rate Schedule</label>
                            <input type="text" disabled value="${rateSchedule || 'Not specified'}">
                        </div>
                    `;
                }
                html += '</div></div>';
                
                // Render meters (or show a notice if no meters but we have detailed_data)
                let hasAnyMeters = false;
                for (let acctIdx = 0; acctIdx < accounts.length; acctIdx++) {
                    const account = accounts[acctIdx];
                    const meters = account.meters || [];
                    if (meters.length > 0) hasAnyMeters = true;
                    
                    for (let meterIdx = 0; meterIdx < meters.length; meterIdx++) {
                        const meter = meters[meterIdx];
                        const meterNumber = meter.meter_number || '';
                        // Fall back to bill-level service_address if meter doesn't have one
                        const serviceAddress = meter.service_address || detailedData.service_address || '';
                        
                        html += `<div class="bill-meter-card">`;
                        html += `<h5>📟 Meter ${meterIdx + 1}</h5>`;
                        
                        // Meter header fields
                        html += '<div class="bill-meter-header-fields">';
                        if (this._isEditMode) {
                            const meterMissing = !meterNumber ? 'field-missing' : '';
                            html += `
                                <div class="bill-field">
                                    <label>Meter Number</label>
                                    <input type="text" class="${meterMissing}" data-field="meter_number" data-account-idx="${acctIdx}" data-meter-idx="${meterIdx}" value="${meterNumber}" placeholder="Meter #">
                                </div>
                                <div class="bill-field">
                                    <label>Service Address</label>
                                    <input type="text" data-field="service_address" data-account-idx="${acctIdx}" data-meter-idx="${meterIdx}" value="${serviceAddress}" placeholder="Service address">
                                </div>
                            `;
                        } else {
                            html += `
                                <div class="bill-field">
                                    <label>Meter Number</label>
                                    <input type="text" disabled value="${meterNumber || 'Unknown'}">
                                </div>
                                <div class="bill-field">
                                    <label>Service Address</label>
                                    <input type="text" disabled value="${serviceAddress || 'Not specified'}">
                                </div>
                            `;
                        }
                        html += '</div>';
                        
                        // Reads table
                        html += `<div class="bill-meter-reads"><table>
                            <thead>
                                <tr>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>kWh</th>
                                    <th>Total Charge</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>`;
                        
                        const reads = meter.reads || [];
                        if (reads.length === 0) {
                            html += '<tr><td colspan="5" style="color:#999;text-align:center;">No reads</td></tr>';
                        } else {
                            for (let i = 0; i < reads.length; i++) {
                                const read = reads[i];
                                const startVal = read.period_start || '';
                                const endVal = read.period_end || '';
                                const kwhVal = read.kwh != null ? read.kwh : '';
                                const chargeVal = read.total_charge != null ? read.total_charge : '';
                                
                                // Determine if read is complete
                                const isComplete = startVal && endVal && kwhVal !== '' && kwhVal !== null;
                                const statusIcon = isComplete ? '<span class="read-status-ok">✓</span>' : '<span class="read-status-warning">⚠️</span>';
                                
                                // Determine which fields are missing
                                const startMissing = !startVal;
                                const endMissing = !endVal;
                                const kwhMissing = kwhVal === '' || kwhVal === null;
                                const chargeMissing = chargeVal === '' || chargeVal === null;
                                
                                if (this._isEditMode) {
                                    html += `<tr class="bill-review-editable">
                                        <td class="${startMissing ? 'field-missing' : ''}"><input type="date" data-field="period_start" data-account-idx="${acctIdx}" data-meter-idx="${meterIdx}" data-read-idx="${i}" value="${startVal}"></td>
                                        <td class="${endMissing ? 'field-missing' : ''}"><input type="date" data-field="period_end" data-account-idx="${acctIdx}" data-meter-idx="${meterIdx}" data-read-idx="${i}" value="${endVal}"></td>
                                        <td class="${kwhMissing ? 'field-missing' : ''}"><input type="number" data-field="kwh" data-account-idx="${acctIdx}" data-meter-idx="${meterIdx}" data-read-idx="${i}" value="${kwhVal}"></td>
                                        <td class="${chargeMissing ? 'field-missing' : ''}"><input type="number" step="0.01" data-field="total_charge" data-account-idx="${acctIdx}" data-meter-idx="${meterIdx}" data-read-idx="${i}" value="${chargeVal}"></td>
                                        <td>${statusIcon}</td>
                                    </tr>`;
                                } else {
                                    const startDate = startVal ? new Date(startVal).toLocaleDateString() : '-';
                                    const endDate = endVal ? new Date(endVal).toLocaleDateString() : '-';
                                    const kwh = kwhVal !== '' && kwhVal !== null ? Number(kwhVal).toLocaleString() : '-';
                                    const charge = chargeVal !== '' && chargeVal !== null ? `$${Number(chargeVal).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '-';
                                    html += `<tr>
                                        <td>${startDate}</td>
                                        <td>${endDate}</td>
                                        <td>${kwh}</td>
                                        <td>${charge}</td>
                                        <td>${statusIcon}</td>
                                    </tr>`;
                                }
                            }
                        }
                        
                        html += '</tbody></table></div></div>';
                    }
                }
                
                // If no meters found but we have detailed_data, show helpful notice
                if (!hasAnyMeters && detailedData && Object.keys(detailedData).length > 0) {
                    html += `<div style="background:#e3f2fd;border:1px solid #90caf9;border-radius:6px;padding:0.75rem;margin:1rem 0;color:#0d47a1;">
                        <strong>ℹ️ Meter data not extracted</strong>
                        <p style="margin:0.25rem 0 0 0;font-size:0.9rem;">
                            Individual meter reads weren't extracted for this bill, but we have billing summary data below.
                            You can use Edit mode to add meter details if needed.
                        </p>
                    </div>`;
                }
                
                // Add detailed data sections if available (keep visible even in edit mode so users can confirm fixes)
                if (detailedData && Object.keys(detailedData).length > 0) {
                    html += this.renderReviewDetailedSections(detailedData);
                }
                
                dataEl.innerHTML = html;
                
                // Add toggle handlers for collapsible sections in modal
                dataEl.querySelectorAll('.bill-detail-header').forEach(header => {
                    header.addEventListener('click', () => {
                        header.classList.toggle('collapsed');
                        const content = header.nextElementSibling;
                        if (content) content.classList.toggle('collapsed');
                    });
                });

                // UX: clear red "missing" styling as soon as user types a value (then validation can re-apply on save if needed).
                const clearMissing = (target) => {
                    if (!target || !target.matches) return;
                    if (!target.matches('input, textarea, select')) return;
                    const val = (target.value || '').toString().trim();
                    if (!val) return;
                    target.classList.remove('field-missing');
                    const parentMissing = target.closest('.field-missing');
                    if (parentMissing) parentMissing.classList.remove('field-missing');
                };
                if (this._isEditMode) {
                    dataEl.oninput = (e) => clearMissing(e.target);
                    dataEl.onchange = (e) => clearMissing(e.target);
                } else {
                    dataEl.oninput = null;
                    dataEl.onchange = null;
                }
                
                // Update button visibility
                if (saveBtn) saveBtn.style.display = this._isEditMode ? 'inline-block' : 'none';
                if (editBtn) editBtn.textContent = this._isEditMode ? '✖️ Cancel Edit' : '✏️ Edit';
            },
            
            renderReviewDetailedSections(d) {
                let html = '<div class="bill-review-detailed" style="margin-top: 1.25rem;">';
                html += '<h5 style="margin-bottom: 0.75rem; color: #1e5a99; border-bottom: 1px solid #e0e0e0; padding-bottom: 0.5rem;">📊 Detailed Extraction Data</h5>';
                
                // Bill Summary - with fallback field names for different data sources
                const periodStartRaw = d.billing_period_start || d.period_start;
                const periodEndRaw = d.billing_period_end || d.period_end;
                const periodStart = periodStartRaw ? new Date(periodStartRaw).toLocaleDateString() : '-';
                const periodEnd = periodEndRaw ? new Date(periodEndRaw).toLocaleDateString() : '-';
                const dueDate = d.due_date ? new Date(d.due_date).toLocaleDateString() : '-';
                const amountDueVal = d.amount_due ?? d.total_amount_due ?? d.total_cost;
                const fmt = (v) => formatBillValue(v, 'cost');
                const computedDays = computeDaysInPeriod(d.days_in_period, periodStartRaw, periodEndRaw);
                
                html += `
                    <div class="bill-detail-section">
                        <div class="bill-detail-header">
                            <span>📋 Bill Summary</span>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="bill-detail-content">
                            <div class="bill-summary-grid">
                                <div class="bill-summary-item">
                                    <label>Service Address</label>
                                    <span>${d.service_address || '-'}</span>
                                </div>
                                <div class="bill-summary-item">
                                    <label>Rate Schedule</label>
                                    <span>${d.rate_schedule || d.rate || '-'}</span>
                                </div>
                                <div class="bill-summary-item">
                                    <label>Billing Period</label>
                                    <span>${periodStart} - ${periodEnd} (${computedDays ?? '-'} days)</span>
                                </div>
                                <div class="bill-summary-item highlight">
                                    <label>Amount Due</label>
                                    <span>${fmt(amountDueVal)}</span>
                                </div>
                                <div class="bill-summary-item">
                                    <label>Due Date</label>
                                    <span>${dueDate}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Usage Summary
                const hasToU = d.kwh_on_peak || d.kwh_mid_peak || d.kwh_off_peak;
                const hasDemand = d.max_demand_kw || d.max_demand_on_peak_kw;
                
                // Calculate blended rate and avg cost per day - use fallback field names
                const totalKwh = d.kwh_total != null ? Number(d.kwh_total) : null;
                const daysInPeriod = computedDays;
                const amountDueRaw = d.amount_due ?? d.total_amount_due ?? d.total_cost;
                const amountDue = amountDueRaw != null ? Number(amountDueRaw) : null;
                const blendedRateDollars = (totalKwh && amountDue && totalKwh > 0) ? amountDue / totalKwh : null;
                const avgCostPerDay = (amountDue != null && daysInPeriod && daysInPeriod > 0) ? amountDue / daysInPeriod : null;
                const avgKwhPerDay = (totalKwh != null && daysInPeriod && daysInPeriod > 0) ? totalKwh / daysInPeriod : (d.daily_avg_kwh != null ? Number(d.daily_avg_kwh) : null);
                
                let touHtml = '';
                if (hasToU) {
                    touHtml = `<div class="tou-breakdown">
                        ${d.kwh_on_peak ? `<div class="tou-item on-peak"><div class="period">On-Peak</div><div class="kwh">${formatBillValue(d.kwh_on_peak, 'kwh')} kWh</div></div>` : ''}
                        ${d.kwh_mid_peak ? `<div class="tou-item mid-peak"><div class="period">Mid-Peak</div><div class="kwh">${formatBillValue(d.kwh_mid_peak, 'kwh')} kWh</div></div>` : ''}
                        ${d.kwh_off_peak ? `<div class="tou-item off-peak"><div class="period">Off-Peak</div><div class="kwh">${formatBillValue(d.kwh_off_peak, 'kwh')} kWh</div></div>` : ''}
                    </div>`;
                }
                
                let demandHtml = '';
                if (hasDemand) {
                    demandHtml = `<div style="margin-top: 0.75rem;">
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.35rem;">Max Demand</div>
                        <div class="tou-breakdown">
                            ${d.max_demand_kw ? `<div class="usage-stat"><div class="value">${Number(d.max_demand_kw).toLocaleString()} kW</div><div class="label">Total</div></div>` : ''}
                            ${d.max_demand_on_peak_kw ? `<div class="usage-stat"><div class="value">${Number(d.max_demand_on_peak_kw).toLocaleString()} kW</div><div class="label">On-Peak</div></div>` : ''}
                            ${d.max_demand_mid_peak_kw ? `<div class="usage-stat"><div class="value">${Number(d.max_demand_mid_peak_kw).toLocaleString()} kW</div><div class="label">Mid-Peak</div></div>` : ''}
                        </div>
                    </div>`;
                }
                
                html += `
                    <div class="bill-detail-section">
                        <div class="bill-detail-header">
                            <span>⚡ Usage Summary</span>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="bill-detail-content">
                            <div class="bill-usage-summary">
                                <div class="usage-stat">
                                    <div class="value">${formatBillValue(totalKwh, 'kwh')}</div>
                                    <div class="label">Total kWh</div>
                                </div>
                                <div class="usage-stat">
                                    <div class="value">${avgKwhPerDay != null ? avgKwhPerDay.toFixed(1) : '-'}</div>
                                    <div class="label">Avg kWh/Day</div>
                                </div>
                                <div class="usage-stat">
                                    <div class="value">${blendedRateDollars != null ? formatBillValue(blendedRateDollars * 100, 'rate') + '/kWh' : '-'}</div>
                                    <div class="label">Avg Rate</div>
                                </div>
                                <div class="usage-stat">
                                    <div class="value">${formatBillValue(avgCostPerDay, 'avgDay')}${avgCostPerDay != null ? '/day' : ''}</div>
                                    <div class="label">Avg Cost/Day</div>
                                </div>
                            </div>
                            ${touHtml}
                            ${demandHtml}
                        </div>
                    </div>
                `;
                
                // Line Items (collapsed by default)
                if (d.line_items && d.line_items.length > 0) {
                    let lineRows = '';
                    for (const item of d.line_items) {
                        const isCredit = item.amount != null && item.amount < 0;
                        lineRows += `<tr>
                            <td>${item.category || '-'}</td>
                            <td>${item.label || '-'}</td>
                            <td>${item.calc || '-'}</td>
                            <td class="num ${isCredit ? 'credit' : ''}">${item.amount != null ? (isCredit ? '-' : '') + '$' + Math.abs(item.amount).toFixed(2) : '-'}</td>
                        </tr>`;
                    }
                    
                    html += `
                        <div class="bill-detail-section">
                            <div class="bill-detail-header collapsed">
                                <span>📝 Line Items (${d.line_items.length})</span>
                                <span class="toggle-icon">▼</span>
                            </div>
                            <div class="bill-detail-content collapsed">
                                <table class="bill-line-items-table">
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Description</th>
                                            <th>Calculation</th>
                                            <th class="num">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>${lineRows}</tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                // Usage History (collapsed by default)
                if (d.usage_history && d.usage_history.length > 0) {
                    let historyRows = '';
                    for (const h of d.usage_history) {
                        historyRows += `<tr>
                            <td>${h.month || '-'}</td>
                            <td class="num">${formatBillValue(h.kwh, 'kwh')}</td>
                            <td class="num">${h.days || '-'}</td>
                            <td class="num">${h.avg_kwh_per_day != null ? Number(h.avg_kwh_per_day).toFixed(1) : '-'}</td>
                        </tr>`;
                    }
                    
                    html += `
                        <div class="bill-detail-section">
                            <div class="bill-detail-header collapsed">
                                <span>📅 Usage History (${d.usage_history.length} months)</span>
                                <span class="toggle-icon">▼</span>
                            </div>
                            <div class="bill-detail-content collapsed">
                                <table class="bill-history-table">
                                    <thead>
                                        <tr>
                                            <th>Month</th>
                                            <th class="num">kWh</th>
                                            <th class="num">Days</th>
                                            <th class="num">Avg kWh/Day</th>
                                        </tr>
                                    </thead>
                                    <tbody>${historyRows}</tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                return html;
            },
            
            toggleEditMode() {
                this._isEditMode = !this._isEditMode;
                
                const editBtn = document.getElementById('billReviewEditBtn');
                const saveBtn = document.getElementById('billReviewSaveBtn');
                
                if (this._isEditMode) {
                    if (editBtn) editBtn.innerHTML = '❌ Cancel';
                    if (saveBtn) saveBtn.style.display = 'inline-block';
                    // Store original payload for dirty tracking
                    if (this._currentReviewFile && this._currentReviewFile.extraction_payload) {
                        this._originalPayload = JSON.stringify(this._currentReviewFile.extraction_payload);
                    } else {
                        this._originalPayload = '{}';
                    }
                } else {
                    if (editBtn) editBtn.innerHTML = '✏️ Edit';
                    if (saveBtn) saveBtn.style.display = 'none';
                    this._originalPayload = null;
                }
                
                if (this._currentReviewFile) {
                    this.renderBillReviewModal(this._currentReviewFile);
                }
            },
            
            async saveCorrections(projectId) {
                if (!this._currentReviewFile) return;
                
                const dataEl = document.getElementById('billReviewData');
                
                // Clone the current payload
                const payload = JSON.parse(JSON.stringify(this._currentReviewFile.extraction_payload || {}));
                const accounts = payload.accounts || [{ account_number: payload.account_number || '', utility_name: payload.utility_name || '', meters: payload.meters || [] }];
                
                // Get bill-level fields
                const utilityNameInput = document.getElementById('billUtilityName');
                const accountNumberInput = document.getElementById('billAccountNumber');
                const dueDateInput = document.getElementById('billDueDate');
                const rateScheduleInput = document.getElementById('billRateSchedule');
                
                if (utilityNameInput) {
                    const utilityVal = utilityNameInput.value.trim();
                    if (accounts[0]) accounts[0].utility_name = utilityVal;
                    payload.utility_name = utilityVal;
                }
                if (accountNumberInput) {
                    const accountVal = accountNumberInput.value.trim();
                    if (accounts[0]) accounts[0].account_number = accountVal;
                    payload.account_number = accountVal;
                }
                if (dueDateInput) {
                    const dueDateVal = dueDateInput.value.trim();
                    if (dueDateVal) {
                        payload.due_date = dueDateVal;
                        if (!payload.detailed_data) payload.detailed_data = {};
                        payload.detailed_data.due_date = dueDateVal;
                    }
                }
                if (rateScheduleInput) {
                    const rateVal = rateScheduleInput.value.trim();
                    if (rateVal) {
                        payload.rate_schedule = rateVal;
                        if (!payload.detailed_data) payload.detailed_data = {};
                        payload.detailed_data.rate_schedule = rateVal;
                    }
                }
                
                // Update meter-level fields
                const meterInputs = dataEl.querySelectorAll('input[data-field="meter_number"], input[data-field="service_address"]');
                meterInputs.forEach(input => {
                    const field = input.dataset.field;
                    const acctIdx = parseInt(input.dataset.accountIdx, 10);
                    const meterIdx = parseInt(input.dataset.meterIdx, 10);
                    
                    if (accounts[acctIdx] && accounts[acctIdx].meters && accounts[acctIdx].meters[meterIdx]) {
                        const v = input.value.trim();
                        accounts[acctIdx].meters[meterIdx][field] = v;
                        // Keep bill-level + detailed_data fields in sync so the lower "Bill Summary" section populates.
                        if (field === 'service_address' && v) {
                            payload.service_address = v;
                            if (!payload.detailed_data) payload.detailed_data = {};
                            payload.detailed_data.service_address = v;
                        }
                    }
                });
                
                // Update read values from inputs
                const readInputs = dataEl.querySelectorAll('input[data-read-idx]');
                readInputs.forEach(input => {
                    const field = input.dataset.field;
                    const acctIdx = parseInt(input.dataset.accountIdx, 10);
                    const meterIdx = parseInt(input.dataset.meterIdx, 10);
                    const readIdx = parseInt(input.dataset.readIdx, 10);
                    
                    if (accounts[acctIdx] && accounts[acctIdx].meters && accounts[acctIdx].meters[meterIdx]) {
                        const meter = accounts[acctIdx].meters[meterIdx];
                        if (meter.reads && meter.reads[readIdx]) {
                            let val = input.value;
                            if (field === 'kwh' || field === 'total_charge') {
                                val = val ? parseFloat(val) : null;
                            }
                            meter.reads[readIdx][field] = val;
                        }
                    }
                });
                
                // Ensure accounts array is updated in payload
                payload.accounts = accounts;
                
                // Dirty state check: compare new payload to original
                const newPayloadStr = JSON.stringify(payload);
                if (this._originalPayload && newPayloadStr === this._originalPayload) {
                    this.showToast('No changes to save', 'info');
                    return;
                }
                
                // Build corrections data for training
                const correctionData = {
                    corrected_payload: payload,
                    screenshot_data: this._screenshotDataUrl || null
                };
                
                // POST to corrections endpoint
                try {
                    const response = await fetch(`/api/projects/${projectId}/bills/files/${this._currentReviewFile.id}/corrections`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(correctionData)
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showToast('Corrections saved!', 'success');
                        this._currentReviewFile.extraction_payload = payload;
                        // If backend returned updated review state/missing_fields, reflect it immediately in the modal.
                        if (result.review_status) this._currentReviewFile.review_status = result.review_status;
                        if (Array.isArray(result.missing_fields)) this._currentReviewFile.validation = { missing_fields: result.missing_fields };
                        this._isEditMode = false;
                        this._screenshotDataUrl = null;
                        this._originalPayload = null;
                        this.renderBillReviewModal(this._currentReviewFile);
                        await this.loadBillsData(projectId);
                        // CRITICAL: Refresh summary to ensure totals reflect corrections
                        await this.loadProjectBillsSummary();
                    } else {
                        this.showToast('Save failed: ' + (result.error || 'Unknown error'), 'error');
                    }
                } catch (e) {
                    console.error('[bills] Save corrections error:', e);
                    this.showToast('Save failed: ' + e.message, 'error');
                }
            },
            
            async saveManualFix(projectId) {
                if (!this._currentReviewFile) return;
                
                const manualFixBtn = document.getElementById('billReviewManualFixBtn');
                
                // Collect all manual fix input values
                const inputs = document.querySelectorAll('.manual-fix-input');
                const updates = {};
                
                inputs.forEach(input => {
                    const field = input.dataset.field;
                    let value = input.value.trim();
                    
                    if (value === '') return;
                    
                    // Convert to appropriate type
                    if (input.type === 'number') {
                        value = parseFloat(value);
                        if (isNaN(value)) return;
                    }
                    
                    // Map field names to bill table columns
                    const fieldMapping = {
                        'total_kwh': 'total_kwh',
                        'total_amount_due': 'total_amount_due',
                        'period_start': 'period_start',
                        'period_end': 'period_end',
                        'utility_name': 'utility_name',
                        'account_number': 'account_number',
                        'rate_schedule': 'rate_schedule',
                        'service_address': 'service_address'
                    };
                    
                    const mappedField = fieldMapping[field] || field;
                    updates[mappedField] = value;
                });
                
                if (Object.keys(updates).length === 0) {
                    this.showScreenshotError('Please enter at least one value to fix');
                    return;
                }
                
                // Get the bill ID - need to find the bills associated with this file
                const payload = this._currentReviewFile.extraction_payload;
                if (!payload) {
                    this.showScreenshotError('No extraction data available');
                    return;
                }
                
                // For now, use the file ID to get bills and update them
                const fileId = this._currentReviewFile.id;
                
                try {
                    if (manualFixBtn) {
                        manualFixBtn.disabled = true;
                        manualFixBtn.textContent = 'Saving...';
                    }
                    
                    // First, get the bills for this file to find the bill IDs
                    const billsResponse = await fetch(`/api/bills/file/${fileId}/bills`);
                    const billsData = await billsResponse.json();
                    
                    if (!billsData.success || !billsData.bills || billsData.bills.length === 0) {
                        // If no bills found, try to update the file directly
                        this.showScreenshotError('No bills found for this file. Please use Edit mode instead.');
                        return;
                    }
                    
                    // Update each bill with the manual fixes
                    let successCount = 0;
                    for (const bill of billsData.bills) {
                        const response = await fetch(`/api/bills/${bill.id}/manual-fix`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updates)
                        });
                        const result = await response.json();
                        if (result.success) {
                            successCount++;
                        }
                    }
                    
                    if (successCount > 0) {
                        this.closeBillReview();
                        await this.loadBillsData(projectId);
                        // CRITICAL: Explicitly refresh summary to ensure totals are updated
                        await this.loadProjectBillsSummary();
                        this.showToast('Bill saved and marked as OK', 'success');
                    } else {
                        this.showScreenshotError('Failed to save changes');
                    }
                } catch (e) {
                    console.error('[bills] Manual fix error:', e);
                    this.showScreenshotError('Save failed: ' + e.message);
                } finally {
                    if (manualFixBtn) {
                        manualFixBtn.disabled = false;
                        manualFixBtn.textContent = '💾 Save & Mark as OK';
                    }
                }
            },
            
            async deleteBillFile(projectId, fileId) {
                try {
                    const response = await fetch(`/api/projects/${projectId}/bills/files/${fileId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (result.success) {
                        await this.loadBillsData(projectId);
                        // CRITICAL: Refresh summary after deleting a bill file
                        await this.loadProjectBillsSummary();
                    } else {
                        this.showToast('Delete failed: ' + (result.error || 'Unknown error'), 'error');
                    }
                } catch (e) {
                    console.error('[bills] Delete error:', e);
                }
            }
        };
        
        // Expose NavigationController to window for inline onclick handlers
        window.NavigationController = NavigationController;
        
        // Initialize NavigationController after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            NavigationController.init();
        });
        
        // ==================================================================================
        // OPEN PROJECT PRINT PREVIEW - Opens print-friendly view in new tab
        // Uses in-memory ProjectState - no backend fetch required
        // ==================================================================================
        function openProjectPrintPreview() {
            // Navigate to in-app print view instead of opening new tab
            const sd = ProjectState.siteData || siteData || {};
            const entriesData = ProjectState.entries || entries || [];
            
            if (!sd.customer && entriesData.length === 0) {
                showToast('No project data to print. Please add customer info or equipment first.', 'warning');
                return;
            }
            
            NavigationController.setView('printView');
        }
        
        // ==================================================================================
        // LOAD PROJECT FROM SERVICE - Helper for navigation
        // ==================================================================================
        async function loadProjectFromService(projectId) {
            try {
                const proj = await ProjectService.getProject(projectId);
                if (!proj) {
                    showToast('Failed to load project.', 'error');
                    return false;
                }
                
                // Track in recently opened list (deduplicated)
                NavigationController.addToRecentlyOpened(projectId);
                
                // Load into ProjectState
                ProjectState.load(proj);
                
                // CRITICAL: Always ensure currentProjectId matches the projectId we fetched
                // This guarantees the Electric Bills section and other features work correctly
                ProjectState.currentProjectId = projectId;
                ProjectState.project_id = projectId;
                ProjectState.siteData.project_id = projectId;
                console.log('[loadProjectFromService] Set currentProjectId:', projectId);
                
                // Sync to legacy variables
                Object.keys(siteData).forEach(key => delete siteData[key]);
                Object.assign(siteData, proj.siteData || {});
                
                entries.length = 0;
                entries.push(...migrateEntries(proj.entries || []));
                
                photos.length = 0;
                if (Array.isArray(proj.photos)) {
                    photos.push(...proj.photos);
                }
                
                // Populate site form values
                document.getElementById('site-date').value = siteData.date || '';
                const visitDateText = document.getElementById('visitDateText');
                if (visitDateText && siteData.visitDate) {
                    visitDateText.textContent = siteData.visitDate;
                }
                document.getElementById('site-customer').value = siteData.customer || '';
                document.getElementById('site-street').value = siteData.street || '';
                document.getElementById('site-city').value = siteData.city || '';
                document.getElementById('site-state').value = siteData.state || 'CA';
                document.getElementById('site-zip').value = siteData.zip || '';
                document.getElementById('site-contact').value = siteData.contact || '';
                document.getElementById('site-phone').value = siteData.phone || '';
                
                if (typeof applyUtilityToForm === 'function') {
                    applyUtilityToForm(siteData.utility);
                }
                
                // Update displays
                const customerNameEl = document.getElementById('customerName');
                if (customerNameEl) customerNameEl.textContent = siteData.customer || '';
                
                const addressParts = [];
                if (siteData.street) addressParts.push(siteData.street);
                const cityStateZip = [siteData.city, siteData.state, siteData.zip].filter(v => v).join(', ');
                if (cityStateZip) addressParts.push(cityStateZip);
                const siteAddressText = document.getElementById('siteAddressText');
                if (siteAddressText) siteAddressText.textContent = addressParts.join(', ') || 'No address provided';
                
                // Show data section
                const siteSection = document.getElementById('siteSection');
                const dataSection = document.getElementById('dataSection');
                if (siteSection) siteSection.classList.add('hidden');
                if (dataSection) dataSection.classList.remove('hidden');
                setSaveCustomerInfoVisible(false);
                
                // Show edit site pencil icon
                const editSiteBtn = document.getElementById('editSiteBtn');
                if (editSiteBtn) editSiteBtn.classList.remove('hidden');
                
                if (typeof renderEntries === 'function') {
                    renderEntries();
                }
                
                console.log('[loadProjectFromService] Loaded project:', projectId);
                
                // CRITICAL: Update URL with projectId so refresh works
                if (typeof updateUrlWithProjectId === 'function') {
                    updateUrlWithProjectId(projectId);
                }
                
                // CRITICAL: Save to localStorage immediately so refresh works
                try {
                    const snapshot = {
                        project_id: ProjectState.project_id,
                        currentProjectId: ProjectState.currentProjectId,
                        currentProjectName: ProjectState.currentProjectName,
                        siteData: ProjectState.siteData,
                        entries: ProjectState.entries,
                        photos: ProjectState.photos || [],
                        lastSavedAt: new Date().toISOString()
                    };
                    localStorage.setItem('currentProject', JSON.stringify(snapshot));
                    console.log('[loadProjectFromService] Saved to localStorage for refresh support');
                } catch (e) {
                    console.error('[loadProjectFromService] Failed to save to localStorage:', e);
                }
                
                // Render embedded bills section
                if (typeof renderEmbeddedBillsSection === 'function') {
                    renderEmbeddedBillsSection();
                }
                
                return true;
            } catch (err) {
                console.error('[loadProjectFromService] Error:', err);
                showToast('Failed to load project: ' + err.message, 'error');
                return false;
            }
        }
        
        // ==================================================================================
        // EMBEDDED BILLS SECTION FUNCTIONS
        // ==================================================================================
        
        // Global showToast function wrapper (delegates to NavigationController if available)
        function showToast(message, type = 'info') {
            if (typeof NavigationController !== 'undefined' && NavigationController.showToast) {
                NavigationController.showToast(message, type);
            } else {
                // Fallback toast
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 24px;border-radius:8px;z-index:100002;font-size:0.95rem;box-shadow:0 4px 12px rgba(0,0,0,0.3);';
                if (type === 'success') toast.style.background = '#28a745';
                else if (type === 'error') toast.style.background = '#dc3545';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        }
        
        async function renderEmbeddedBillsSection() {
            const container = document.getElementById('embeddedBillsContent');
            if (!container) return;
            
            // Get current project ID first - if no project, show save prompt immediately
            const projectId = ProjectState.currentProjectId;
            if (!projectId) {
                console.log('[bills] No project ID - showing save prompt');
                container.innerHTML = `
                    <div class="embedded-bills-upload">
                        <p style="color: #666; margin-bottom: 1rem;">Save the project first to upload electric bills.</p>
                    </div>
                `;
                return;
            }
            
            // Ensure config is loaded before checking billsFeatureEnabled
            // This prevents showing "not enabled" when config just hasn't loaded yet
            if (NavigationController.billsFeatureEnabled === undefined || 
                (NavigationController.billsFeatureEnabled === false && !NavigationController._configLoaded)) {
                console.log('[bills] Waiting for config to load...');
                container.innerHTML = '<div class="bills-loading" style="text-align: center; padding: 2rem; color: #666;">Loading...</div>';
                
                // Retry after a short delay (config should load quickly)
                setTimeout(() => {
                    if (NavigationController.billsFeatureEnabled === true) {
                        renderEmbeddedBillsSection();
                    } else if (NavigationController._configLoaded) {
                        // Config loaded but bills not enabled
                        container.innerHTML = '<div style="text-align: center; color: #999; padding: 1rem;">Electric bills feature is not enabled.</div>';
                    }
                }, 500);
                return;
            }
            
            // Check if bills feature is enabled (require explicit true)
            const billsEnabled = NavigationController.billsFeatureEnabled === true;
            if (!billsEnabled) {
                console.log('[bills] Bills feature not enabled');
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 1rem;">Electric bills feature is not enabled.</div>';
                return;
            }
            
            // Show loading state
            container.innerHTML = '<div class="bills-loading" style="text-align: center; padding: 2rem; color: #666;">Loading bills data...</div>';
            
            // Setup timeout for fetch (10 second limit)
            const BILLS_TIMEOUT_MS = 10000;
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), BILLS_TIMEOUT_MS);
            
            let groupedData = { files: [], accounts: [] };
            try {
                // Fetch grouped bills data (includes files and extracted accounts/meters)
                // service=electric filters to electric/combined/NULL service types (excludes water/gas-only)
                const response = await fetch(`/api/projects/${encodeURIComponent(projectId)}/bills/grouped?service=electric&_t=${Date.now()}`, {
                    signal: controller.signal,
                    cache: 'no-store'
                });
                clearTimeout(timeoutId);
                groupedData = response.ok ? await response.json() : { files: [], accounts: [] };
                const files = groupedData.files || [];
                const accounts = groupedData.accounts || [];
                
                // Check if we have bills from CSV import (no files but have accounts with bills)
                const hasBillsFromCsv = files.length === 0 && accounts.length > 0;
                
                if (files.length === 0 && !hasBillsFromCsv) {
                    // No bills uploaded and no CSV imports - show upload interface
                    container.innerHTML = `
                        <div class="embedded-bills-upload">
                            <p style="color: #666; margin-bottom: 1rem;">📤 Upload PDF utility bills to extract account, meter, and usage data automatically.</p>
                            <div style="display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap;">
                                <input type="file" id="embeddedBillFileInput" accept=".pdf,image/*" multiple style="display:none;">
                                <button id="embeddedBillUploadBtn" class="button primary" style="font-size: 1rem; padding: 0.75rem 1.5rem;">
                                    📤 Upload Electric Bills
                                </button>
                                <input type="file" id="embeddedBillCsvInput" accept=".csv" style="display:none;">
                                <button id="embeddedBillImportCsvBtn" class="button secondary" style="font-size: 1rem; padding: 0.75rem 1.5rem;">
                                    📥 Import from CSV
                                </button>
                            </div>
                            <div id="embeddedBillUploadStatus" style="margin-top: 1rem;"></div>
                            <div id="embeddedBillProgressContainer" class="bills-progress-container" style="display: none; margin-top: 1rem;">
                                <div class="bills-progress-bar">
                                    <div id="embeddedBillProgressFill" class="bills-progress-fill"></div>
                                </div>
                                <div id="embeddedBillProgressText" class="bills-progress-text"></div>
                            </div>
                        </div>
                    `;
                    
                    // Wire up upload button
                    const uploadBtn = document.getElementById('embeddedBillUploadBtn');
                    const fileInput = document.getElementById('embeddedBillFileInput');
                    if (uploadBtn && fileInput) {
                        // Use direct property assignment to avoid stacking multiple listeners
                        uploadBtn.onclick = () => fileInput.click();
                        fileInput.onchange = (e) => { 
                            const filesArray = Array.from(e.target.files);
                            e.target.value = '';
                            handleEmbeddedBillUpload(filesArray);
                        };
                    }
                    
                    // Wire up CSV import button
                    const csvImportBtn = document.getElementById('embeddedBillImportCsvBtn');
                    const csvInput = document.getElementById('embeddedBillCsvInput');
                    if (csvImportBtn && csvInput) {
                        csvImportBtn.onclick = () => csvInput.click();
                        csvInput.onchange = (e) => {
                            const file = e.target.files[0];
                            e.target.value = '';
                            if (file) handleEmbeddedBillCsvImport(file, projectId);
                        };
                    }
                } else if (hasBillsFromCsv) {
                    // Bills imported from CSV (no files, but have accounts) - show extracted data only
                    let html = '<div class="embedded-bills-csv-import">';
                    html += `<div style="background: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px; padding: 0.75rem 1rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #2e7d32;">✓ Bills imported from CSV (${accounts.reduce((sum, a) => sum + (a.meters || []).reduce((ms, m) => ms + (m.bills?.length || 0), 0), 0)} bills)</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="file" id="embeddedBillFileInput" accept=".pdf,image/*" multiple style="display:none;">
                            <button id="embeddedBillUploadBtn" class="button secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                + Add PDFs
                            </button>
                            <input type="file" id="embeddedBillCsvInput" accept=".csv" style="display:none;">
                            <button id="embeddedBillImportCsvBtn" class="button secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                📥 Import More
                            </button>
                            <button id="embeddedBillDeleteAllBtn" class="button danger" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                🗑 Delete All
                            </button>
                        </div>
                    </div>`;
                    html += '</div>';
                    
                    container.innerHTML = html;
                    
                    // Render extracted data section
                    const extractedDataContainer = document.createElement('div');
                    extractedDataContainer.className = 'embedded-bills-data';
                    extractedDataContainer.innerHTML = '<div style="color: #666; text-align: center;">Loading...</div>';
                    container.appendChild(extractedDataContainer);
                    
                    // Fetch and render extracted data with facility totals
                    const extractedHtml = await renderEmbeddedExtractedData(projectId);
                    extractedDataContainer.innerHTML = '<h4 style="margin: 0 0 0.75rem 0; color: #333;">Extracted Data</h4>' + extractedHtml;
                    
                    // Setup click handlers for bill dropdowns
                    setupEmbeddedBillClickHandlers();
                    
                    // Wire up buttons
                    const uploadBtn = document.getElementById('embeddedBillUploadBtn');
                    const fileInput = document.getElementById('embeddedBillFileInput');
                    if (uploadBtn && fileInput) {
                        uploadBtn.onclick = () => fileInput.click();
                        fileInput.onchange = (e) => { 
                            const filesArray = Array.from(e.target.files);
                            e.target.value = '';
                            handleEmbeddedBillUpload(filesArray);
                        };
                    }
                    
                    const csvImportBtn = document.getElementById('embeddedBillImportCsvBtn');
                    const csvInput = document.getElementById('embeddedBillCsvInput');
                    if (csvImportBtn && csvInput) {
                        csvImportBtn.onclick = () => csvInput.click();
                        csvInput.onchange = (e) => {
                            const file = e.target.files[0];
                            e.target.value = '';
                            if (file) handleEmbeddedBillCsvImport(file, projectId);
                        };
                    }
                    
                    // Wire up delete all button
                    const deleteAllBtn = document.getElementById('embeddedBillDeleteAllBtn');
                    if (deleteAllBtn) {
                        deleteAllBtn.onclick = async () => {
                            const confirmed = await showConfirmModal({
                                title: 'Delete All Bills',
                                message: 'This will delete ALL bill data for this project (accounts, meters, bills). This cannot be undone.',
                                confirmText: 'Delete All',
                                cancelText: 'Cancel',
                                danger: true
                            });
                            if (confirmed) {
                                try {
                                    const response = await fetch(`/api/projects/${encodeURIComponent(projectId)}/bills/delete-all`, { method: 'DELETE' });
                                    const result = await response.json();
                                    if (result.success) {
                                        showToast(`Deleted ${result.bills_deleted} bills`, 'success');
                                        renderEmbeddedBillsSection(); // Refresh
                                    } else {
                                        showToast(result.error || 'Failed to delete bills', 'error');
                                    }
                                } catch (err) {
                                    console.error('[bills] Error deleting all:', err);
                                    showToast('Error deleting bills', 'error');
                                }
                            }
                        };
                    }
                } else {
                    // Bills exist (from uploaded files) - show files and extracted data
                    let html = '';
                    
                    // Check if any files are still processing (should default expanded)
                    const hasProcessingFiles = files.some(f => !f.processed && (f.processing_status === 'processing' || f.processing_status === 'pending'));
                    const filesCollapsedKey = 'embeddedBillsFilesCollapsed';
                    const savedCollapsed = localStorage.getItem(filesCollapsedKey);
                    const isFilesCollapsed = hasProcessingFiles ? false : (savedCollapsed === 'true');
                    
                    // Files section with multi-select and collapsible header
                    html += '<div class="embedded-bills-files">';
                    html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; cursor: pointer;" id="embeddedFilesHeader" onclick="window.toggleEmbeddedFilesSection()">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span id="embeddedFilesArrow" style="transition: transform 0.2s; transform: rotate(${isFilesCollapsed ? '-90deg' : '0deg'}); font-size: 0.8rem;">▼</span>
                            <h4 style="margin: 0; color: #333;">Uploaded Files (${files.length})</h4>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;" onclick="event.stopPropagation()">
                            <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.85rem; color: #666; cursor: pointer;">
                                <input type="checkbox" id="embeddedBillSelectAll" style="cursor: pointer;"> Select All
                            </label>
                            <button id="embeddedBillDeleteSelected" class="button danger" style="font-size: 0.8rem; padding: 0.3rem 0.6rem; display: none;">
                                Delete Selected
                            </button>
                        </div>
                    </div>`;
                    html += `<div id="embeddedFilesListContainer" style="display: ${isFilesCollapsed ? 'none' : 'flex'}; flex-direction: column; gap: 0.5rem;">`;
                    
                    files.forEach(file => {
                        // Determine status from processing_status and review_status
                        const procStatus = file.processing_status || 'pending';
                        const reviewStatus = file.review_status || 'pending';
                        const processed = file.processed;
                        const serviceType = file.service_type || (file.extraction_payload ? file.extraction_payload.service_type : null);
                        
                        let statusText, statusClass;
                        if (procStatus === 'error' || procStatus === 'failed') {
                            statusText = '✗ Analysis failed';
                            statusClass = 'error';
                        } else if (reviewStatus === 'skipped') {
                            statusText = serviceType ? serviceType.charAt(0).toUpperCase() + serviceType.slice(1) : 'Non-Electric';
                            statusClass = 'skipped';
                        } else if (!processed && procStatus === 'pending') {
                            statusText = 'Waiting...';
                            statusClass = 'waiting';
                        } else if (!processed && procStatus === 'processing') {
                            statusText = 'Analyzing...';
                            statusClass = 'processing';
                        } else if (reviewStatus === 'ok' || reviewStatus === 'approved' || reviewStatus === 'complete') {
                            statusText = 'Complete';
                            statusClass = 'complete';
                        } else if (reviewStatus === 'needs_review') {
                            statusText = 'Needs Review';
                            statusClass = 'needs-review';
                        } else if (processed) {
                            statusText = 'Complete';
                            statusClass = 'complete';
                        } else {
                            statusText = 'Analyzing...';
                            statusClass = 'processing';
                        }
                        
                        // Use original_filename for cleaner display
                        const displayName = file.original_filename || file.filename;
                        
                        // Check if file has extracted data (processed and has ok/needs_review status)
                        const hasExtractedData = processed && (reviewStatus === 'ok' || reviewStatus === 'needs_review' || reviewStatus === 'approved');
                        
                        html += `
                            <div class="embedded-bill-file-row" data-file-id="${file.id}" data-status="${statusClass}">
                                <div class="file-info-column">
                                    <div class="file-row-header">
                                        <input type="checkbox" class="embedded-bill-checkbox" data-file-id="${file.id}" style="cursor: pointer;">
                                        <span class="file-name">${displayName}</span>
                                    </div>
                                    <div class="file-progress-bar">
                                        <div class="progress-track">
                                            <div class="progress-fill ${statusClass}"></div>
                                        </div>
                                        <span class="progress-text ${statusClass}">${statusText}</span>
                                    </div>
                                </div>
                                <button class="embedded-file-view-btn" data-file-id="${file.id}" title="View">View</button>
                                <button class="embedded-file-delete-btn" data-file-id="${file.id}" data-has-extracted="${hasExtractedData}" title="Delete">Delete</button>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    
                    // Add upload more button and import from CSV button
                    html += `
                        <div style="margin-top: 1rem; text-align: center; display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap;">
                            <input type="file" id="embeddedBillFileInput" accept=".pdf,image/*" multiple style="display:none;">
                            <button id="embeddedBillUploadBtn" class="button secondary" style="font-size: 0.9rem;">
                                + Add More Bills
                            </button>
                            <input type="file" id="embeddedBillCsvInput" accept=".csv" style="display:none;">
                            <button id="embeddedBillImportCsvBtn" class="button secondary" style="font-size: 0.9rem;">
                                📥 Import from CSV
                            </button>
                        </div>
                    `;
                    html += '</div>';
                    
                    html += '</div>';
                    
                    // Render file list first
                    container.innerHTML = html;
                    
                    // Now render extracted data section (using summary endpoint with facility totals)
                    const extractedDataContainer = document.createElement('div');
                    extractedDataContainer.className = 'embedded-bills-data';
                    extractedDataContainer.style.marginTop = '1rem';
                    extractedDataContainer.innerHTML = '<h4 style="margin: 0 0 0.75rem 0; color: #333;">Extracted Data</h4><div style="color: #666; text-align: center;">Loading...</div>';
                    container.appendChild(extractedDataContainer);
                    
                    // Fetch and render extracted data with facility totals
                    const extractedHtml = await renderEmbeddedExtractedData(projectId);
                    extractedDataContainer.innerHTML = '<h4 style="margin: 0 0 0.75rem 0; color: #333;">Extracted Data</h4>' + extractedHtml;
                    
                    // Setup click handlers for bill dropdowns
                    setupEmbeddedBillClickHandlers();
                    
                    // Check if any files are still processing - start lightweight status polling
                    const hasProcessing = files.some(f => 
                        !f.processed && (f.processing_status === 'pending' || f.processing_status === 'processing')
                    );
                    if (hasProcessing) {
                        startEmbeddedBillsPolling(projectId);
                    } else {
                        stopEmbeddedBillsPolling();
                    }
                    
                    // Wire up View button clicks
                    container.querySelectorAll('.embedded-file-view-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const fileId = btn.dataset.fileId;
                            if (typeof openBillReviewModal === 'function') {
                                openBillReviewModal(fileId);
                            }
                        });
                    });
                    
                    // Wire up Delete button clicks
                    container.querySelectorAll('.embedded-file-delete-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const fileId = btn.dataset.fileId;
                            const fileName = btn.closest('.embedded-bill-file-row').querySelector('span').textContent.trim();
                            const currentProjectId = ProjectState.currentProjectId || ProjectState.project_id;
                            const hasExtracted = btn.dataset.hasExtracted === 'true';
                            
                            // Show different message based on whether data has been extracted
                            const confirmMsg = hasExtracted 
                                ? `Are you sure you want to delete this bill file?\n\n${fileName}\n\nThis will also remove its extracted data from the analysis.`
                                : `Delete this bill file?\n\n${fileName}`;
                            
                            const confirmed = await showConfirmModal({
                                title: 'Delete Bill File',
                                message: confirmMsg,
                                confirmText: 'Delete',
                                cancelText: 'Cancel',
                                danger: true
                            });
                            if (confirmed) {
                                try {
                                    const response = await fetch(`/api/projects/${encodeURIComponent(currentProjectId)}/bills/files/${fileId}`, { method: 'DELETE' });
                                    const result = await response.json();
                                    
                                    if (result.success) {
                                        showToast('Bill file deleted successfully', 'success');
                                        renderEmbeddedBillsSection(); // Refresh the section
                                    } else {
                                        showToast(result.error || 'Failed to delete file', 'error');
                                    }
                                } catch (err) {
                                    console.error('[embeddedBills] Error deleting file:', err);
                                    showToast('Error deleting file', 'error');
                                }
                            }
                        });
                    });
                    
                    // Wire up upload button
                    const uploadBtn = document.getElementById('embeddedBillUploadBtn');
                    const fileInput = document.getElementById('embeddedBillFileInput');
                    if (uploadBtn && fileInput) {
                        // Use direct property assignment to avoid stacking multiple listeners
                        uploadBtn.onclick = () => fileInput.click();
                        fileInput.onchange = (e) => { 
                            const filesArray = Array.from(e.target.files);
                            e.target.value = '';
                            handleEmbeddedBillUpload(filesArray);
                        };
                    }
                    
                    // Wire up CSV import button
                    const csvImportBtn = document.getElementById('embeddedBillImportCsvBtn');
                    const csvInput = document.getElementById('embeddedBillCsvInput');
                    if (csvImportBtn && csvInput) {
                        csvImportBtn.onclick = () => csvInput.click();
                        csvInput.onchange = (e) => {
                            const file = e.target.files[0];
                            e.target.value = '';
                            if (file) handleEmbeddedBillCsvImport(file, projectId);
                        };
                    }
                }
            } catch (err) {
                clearTimeout(timeoutId);
                console.error('[embeddedBills] Error loading bills:', err);
                
                // Handle timeout vs other errors
                const isTimeout = err.name === 'AbortError';
                const errorMsg = isTimeout 
                    ? 'Bills data request timed out. Please try again.'
                    : 'Error loading bills data.';
                
                container.innerHTML = `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="color: #dc3545; margin-bottom: 0.5rem;">${errorMsg}</p>
                        <button onclick="renderEmbeddedBillsSection()" class="button secondary" style="font-size: 0.9rem; padding: 0.4rem 0.8rem;">
                            🔄 Retry
                        </button>
                    </div>
                `;
            }
        }
        
        // Smart polling for embedded bills - updates status in-place without rebuilding DOM
        let _embeddedBillsPollingTimer = null;
        let _embeddedBillsLastStatuses = {};
        
        // Granular state labels for embedded bills
        const EMBEDDED_STATE_LABELS = {
            'queued': 'Queued...',
            'extracting_text': 'Extracting text...',
            'ocr': 'Running OCR...',
            'cleaning': 'Cleaning text...',
            'cached_hit': '⚡ Cached',
            'parsing_pass_a': 'AI parsing...',
            'parsing_pass_b': 'AI parsing (detailed)...',
            'done': 'Complete',
            'failed': 'Error',
            'ok': 'Complete',
            'needs_review': 'Needs Review'
        };
        
        function startEmbeddedBillsPolling(projectId) {
            stopEmbeddedBillsPolling();
            
            const poll = async () => {
                try {
                    const response = await fetch(`/api/projects/${encodeURIComponent(projectId)}/bills/status`);
                    const data = await response.json();
                    
                    if (!data.success || !data.files) return;
                    
                    let allComplete = true;
                    let anyNewlyComplete = false;
                    
                    for (const file of data.files) {
                        const fileId = file.id;
                        const procStatus = file.processing_status || 'pending';
                        const reviewStatus = file.review_status || 'pending';
                        const processed = file.processed;
                        
                        // Check if still processing
                        if (!processed && (procStatus === 'pending' || procStatus === 'processing')) {
                            allComplete = false;
                            
                            // For files still processing, fetch granular status
                            try {
                                const granularResp = await fetch(`/api/bills/status/${fileId}`);
                                const granularData = await granularResp.json();
                                if (granularData.success && granularData.state) {
                                    const granularState = granularData.state;
                                    const progress = granularData.progress || 0;
                                    
                                    // Update row with granular status
                                    const row = document.querySelector(`.embedded-bill-file-row[data-file-id="${fileId}"]`);
                                    if (row) {
                                        let statusText, statusClass;
                                        const processingStates = ['queued', 'extracting_text', 'ocr', 'cleaning', 'parsing_pass_a', 'parsing_pass_b'];
                                        
                                        if (granularState === 'cached_hit') {
                                            statusText = '⚡ Cached'; statusClass = 'complete';
                                        } else if (processingStates.includes(granularState)) {
                                            statusText = `${EMBEDDED_STATE_LABELS[granularState] || 'Processing...'} ${Math.round(progress * 100)}%`;
                                            statusClass = 'processing';
                                        } else if (granularState === 'done') {
                                            statusText = 'Complete'; statusClass = 'complete';
                                        } else if (granularState === 'failed') {
                                            statusText = 'Error'; statusClass = 'error';
                                        } else {
                                            statusText = 'Processing...'; statusClass = 'processing';
                                        }
                                        
                                        row.dataset.status = statusClass;
                                        const progressFill = row.querySelector('.progress-fill');
                                        const progressText = row.querySelector('.progress-text');
                                        if (progressFill) progressFill.className = `progress-fill ${statusClass}`;
                                        if (progressText) {
                                            progressText.className = `progress-text ${statusClass}`;
                                            progressText.textContent = statusText;
                                        }
                                    }
                                    
                                    // Save granular status and skip normal processing below
                                    _embeddedBillsLastStatuses[fileId] = { processed, procStatus, reviewStatus, granularState };
                                    continue;
                                }
                            } catch (ge) {
                                // Granular status unavailable, fall through to normal processing
                            }
                        }
                        
                        // Check if this file just completed
                        const prevStatus = _embeddedBillsLastStatuses[fileId];
                        if (prevStatus && !prevStatus.processed && processed) {
                            anyNewlyComplete = true;
                        }
                        _embeddedBillsLastStatuses[fileId] = { processed, procStatus, reviewStatus };
                        
                        // Update status display in-place using progress bars
                        const row = document.querySelector(`.embedded-bill-file-row[data-file-id="${fileId}"]`);
                        if (row) {
                            let statusText, statusClass;
                            if (procStatus === 'error') {
                                statusText = 'Error'; statusClass = 'error';
                            } else if (!processed && procStatus === 'pending') {
                                statusText = data.queue_depth > 3 ? `Queued (${data.queue_depth})` : 'Waiting...';
                                statusClass = 'waiting';
                            } else if (!processed && procStatus === 'processing') {
                                statusText = 'Analyzing...'; statusClass = 'processing';
                            } else if (reviewStatus === 'ok' || reviewStatus === 'approved') {
                                statusText = 'Complete'; statusClass = 'complete';
                            } else if (reviewStatus === 'needs_review') {
                                statusText = 'Needs Review'; statusClass = 'needs-review';
                            } else if (processed) {
                                statusText = 'Complete'; statusClass = 'complete';
                            } else {
                                statusText = 'Analyzing...'; statusClass = 'processing';
                            }
                            
                            // Update progress bar and text
                            row.dataset.status = statusClass;
                            const progressFill = row.querySelector('.progress-fill');
                            const progressText = row.querySelector('.progress-text');
                            if (progressFill) {
                                progressFill.className = `progress-fill ${statusClass}`;
                            }
                            if (progressText) {
                                progressText.className = `progress-text ${statusClass}`;
                                progressText.textContent = statusText;
                            }
                        }
                    }
                    
                    // If all files are complete, stop polling and refresh extracted data
                    if (allComplete) {
                        stopEmbeddedBillsPolling();
                        // Refresh the extracted data section only
                        const projectId = ProjectState.currentProjectId;
                        if (projectId) {
                            const extractedContainer = document.querySelector('.embedded-bills-data');
                            if (extractedContainer) {
                                const extractedHtml = await renderEmbeddedExtractedData(projectId);
                                extractedContainer.innerHTML = '<h4 style="margin: 0 0 0.75rem 0; color: #333;">Extracted Data</h4>' + extractedHtml;
                                setupEmbeddedBillClickHandlers();
                            }
                        }
                    } else if (anyNewlyComplete) {
                        // If some files just completed, refresh extracted data
                        const projectId = ProjectState.currentProjectId;
                        if (projectId) {
                            const extractedContainer = document.querySelector('.embedded-bills-data');
                            if (extractedContainer) {
                                const extractedHtml = await renderEmbeddedExtractedData(projectId);
                                extractedContainer.innerHTML = '<h4 style="margin: 0 0 0.75rem 0; color: #333;">Extracted Data</h4>' + extractedHtml;
                                setupEmbeddedBillClickHandlers();
                            }
                        }
                    }
                } catch (err) {
                    console.error('[embeddedBills] Polling error:', err);
                }
            };
            
            // Poll immediately then every 2 seconds (faster for granular updates)
            poll();
            _embeddedBillsPollingTimer = setInterval(poll, 2000);
        }
        
        function stopEmbeddedBillsPolling() {
            if (_embeddedBillsPollingTimer) {
                clearInterval(_embeddedBillsPollingTimer);
                _embeddedBillsPollingTimer = null;
            }
        }
        
        // Render embedded bills using summary endpoint data (matches original hamburger menu format)
        async function renderEmbeddedExtractedData(projectId) {
            try {
                // Use the summary endpoint which provides properly aggregated data
                // service=electric filters to electric/combined/NULL service types (excludes water/gas-only)
                const response = await fetch(`/api/projects/${encodeURIComponent(projectId)}/bills/summary?months=12&service=electric&_t=${Date.now()}`, { cache: 'no-store' });
                const data = response.ok ? await response.json() : { success: false };
                
                if (!data.success || !data.accounts || data.accounts.length === 0) {
                    return '<div style="color: #666; text-align: center; padding: 1rem;">No data extracted yet.</div>';
                }
                
                let html = '';
                
                // Intro text
                html += `<div style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Data is grouped by Account, then by Meter. Each meter shows all extracted billing periods.</div>`;
                
                // Calculate facility-wide totals (across ALL accounts)
                // Use Set to deduplicate bills by (meter_number, period_start, period_end)
                let facilityTotalKwh = 0;
                let facilityTotalCost = 0;
                let facilityBillCount = 0;
                let facilitySumAvgPerDay = 0; // Sum of each meter's Avg $/day
                const seenBillKeys = new Set(); // Track unique bills for deduplication
                
                // Aggregate TOU data across all accounts
                let facilityTouOnKwh = 0, facilityTouOnCost = 0;
                let facilityTouMidKwh = 0, facilityTouMidCost = 0;
                let facilityTouOffKwh = 0, facilityTouOffCost = 0;
                let facilityTouSuperOffKwh = 0, facilityTouSuperOffCost = 0;
                
                for (const account of data.accounts) {
                    const accountNum = account.accountNumber || account.account_number || 'unknown';
                    const meters = account.meters || [];
                    
                    // Aggregate TOU from account combined data (already summed by backend)
                    const accountTou = (account.combined || account).tou || {};
                    facilityTouOnKwh += accountTou.onPeakKwh || 0;
                    facilityTouOnCost += accountTou.onPeakCost || 0;
                    facilityTouMidKwh += accountTou.midPeakKwh || 0;
                    facilityTouMidCost += accountTou.midPeakCost || 0;
                    facilityTouOffKwh += accountTou.offPeakKwh || 0;
                    facilityTouOffCost += accountTou.offPeakCost || 0;
                    facilityTouSuperOffKwh += accountTou.superOffPeakKwh || 0;
                    facilityTouSuperOffCost += accountTou.superOffPeakCost || 0;
                    
                    for (const meter of meters) {
                        const meterNumber = meter.meterNumber || meter.meter_number || 'unknown';
                        // Sum each meter's Avg $/day for facility total
                        facilitySumAvgPerDay += meter.avgCostPerDay || meter.avgCostPerDayDollars || 0;
                        for (const bill of (meter.bills || [])) {
                            // Create unique key for deduplication - include account to avoid false deduplication
                            const periodStart = bill.period_start || bill.periodStart || '';
                            const periodEnd = bill.period_end || bill.periodEnd || '';
                            const billKey = `${accountNum}|${meterNumber}|${periodStart}|${periodEnd}`;

                            // Only count each unique period once per meter
                            if (!seenBillKeys.has(billKey)) {
                                seenBillKeys.add(billKey);
                                facilityBillCount++;
                                facilityTotalKwh += bill.total_kwh || bill.totalKwh || 0;
                                facilityTotalCost += bill.total_amount_due || bill.totalAmountDue || 0;
                            }
                        }
                    }
                }
                
                const facilityBlendedRate = facilityTotalKwh > 0 ? (facilityTotalCost / facilityTotalKwh) * 100 : 0;
                const facilityAvgCostPerDay = facilitySumAvgPerDay;
                
                // Get utility name from first account for header
                const primaryUtility = data.accounts[0]?.utilityName || data.accounts[0]?.utility_name || 'Electric Utility';
                
                // Build account list for header
                // For LADWP, show full account number; for others, mask to last 4 digits
                const accountListHtml = data.accounts.map(acc => {
                    const accUtility = acc.utilityName || acc.utility_name || '';
                    const accNum = acc.accountNumber || acc.account_number || 'N/A';
                    const displayNum = isUtilityLADWP(accUtility) ? accNum : (accNum.length > 4 ? '(...)' + accNum.slice(-4) : accNum);
                    return `<div style="font-size: 0.9rem; opacity: 0.9;">Account: ${displayNum}</div>`;
                }).join('');
                
                // Calculate facility date range
                let facilityOldestDate = null;
                let facilityNewestDate = null;
                for (const account of data.accounts) {
                    for (const meter of (account.meters || [])) {
                        for (const bill of (meter.bills || [])) {
                            const periodStart = bill.periodStart;
                            const periodEnd = bill.periodEnd;
                            if (periodStart) {
                                const d = new Date(periodStart);
                                if (!facilityOldestDate || d < facilityOldestDate) facilityOldestDate = d;
                            }
                            if (periodEnd) {
                                const d = new Date(periodEnd);
                                if (!facilityNewestDate || d > facilityNewestDate) facilityNewestDate = d;
                            }
                        }
                    }
                }
                
                // Format date range for pill
                let dateRangePill = '';
                if (facilityOldestDate && facilityNewestDate) {
                    const startMonth = facilityOldestDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    const endMonth = facilityNewestDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    dateRangePill = startMonth === endMonth ? startMonth : `${startMonth} – ${endMonth}`;
                }
                
                // Count total meters
                let totalMeters = 0;
                for (const account of data.accounts) {
                    totalMeters += (account.meters || []).length;
                }
                
                // Facility-wide totals banner (blue, same style as account sections)
                html += `
                    <div style="background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; text-align: center;">
                        <div style="font-weight: 700; font-size: 1.2rem;">${primaryUtility}</div>
                        <div style="display: inline-block; background: rgba(255,255,255,0.2); border-radius: 12px; padding: 0.25rem 0.75rem; font-size: 0.8rem; margin: 0.5rem 0;">
                            ${data.accounts.length} account${data.accounts.length !== 1 ? 's' : ''} • ${facilityBillCount} bill${facilityBillCount !== 1 ? 's' : ''}${dateRangePill ? ` • ${dateRangePill}` : ''}
                        </div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin: 0.5rem 0 0.75rem; font-size: 0.95rem; font-weight: 600;">
                            <span>🏢</span> <span>Facility Summary</span>
                        </div>
                        <div class="facility-stats-grid">
                            <div style="background: rgba(255,255,255,0.15); border-radius: 6px; padding: 0.5rem;">
                                <div class="stat-value">${formatBillValue(facilityTotalKwh, 'kwh')}</div>
                                <div class="stat-label">Total kWh</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); border-radius: 6px; padding: 0.5rem;">
                                <div class="stat-value">${formatBillValue(facilityTotalCost, 'cost')}</div>
                                <div class="stat-label">Total Cost</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); border-radius: 6px; padding: 0.5rem;">
                                <div class="stat-value">${formatBillValue(facilityBlendedRate, 'rate')}</div>
                                <div class="stat-label">Rate/kWh</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); border-radius: 6px; padding: 0.5rem;">
                                <div class="stat-value">${formatBillValue(facilityAvgCostPerDay, 'avgDay')}</div>
                                <div class="stat-label">Avg/Day</div>
                            </div>
                        </div>
                        ${(() => {
                            // Build TOU summary section if any TOU data exists
                            const hasTOU = facilityTouOnKwh > 0 || facilityTouMidKwh > 0 || facilityTouOffKwh > 0 || facilityTouSuperOffKwh > 0;
                            if (!hasTOU) return '';
                            
                            const totalTouKwh = facilityTouOnKwh + facilityTouMidKwh + facilityTouOffKwh + facilityTouSuperOffKwh;
                            
                            // TOU config with colors
                            const touItems = [
                                { kwh: facilityTouOnKwh, cost: facilityTouOnCost, color: '#e53935', label: 'ON PEAK' },
                                { kwh: facilityTouMidKwh, cost: facilityTouMidCost, color: '#ff9800', label: 'MID PEAK' },
                                { kwh: facilityTouOffKwh, cost: facilityTouOffCost, color: '#4caf50', label: 'OFF PEAK' },
                                { kwh: facilityTouSuperOffKwh, cost: facilityTouSuperOffCost, color: '#2196f3', label: 'SUPER OFF-PEAK' }
                            ].filter(t => t.kwh > 0);
                            
                            // Build percentage bar
                            let barHtml = '<div style="display: flex; gap: 2px; margin-bottom: 0.75rem; height: 8px; border-radius: 4px; overflow: hidden;">';
                            touItems.forEach(t => {
                                const pct = totalTouKwh > 0 ? (t.kwh / totalTouKwh * 100) : 0;
                                if (pct > 0) barHtml += '<div style="width: ' + pct + '%; background: ' + t.color + ';"></div>';
                            });
                            barHtml += '</div>';
                            
                            // Build TOU cards with full vibrant colors
                            let cardsHtml = '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
                            touItems.forEach(t => {
                                const rate = t.kwh > 0 ? ((t.cost / t.kwh) * 100).toFixed(1) : '0.0';
                                cardsHtml += '<div style="flex: 1; min-width: 100px; background: ' + t.color + '; border-radius: 6px; padding: 0.5rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">';
                                cardsHtml += '<div style="font-size: 0.65rem; font-weight: 700; margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.5px;">' + t.label + '</div>';
                                cardsHtml += '<div style="font-size: 0.85rem; font-weight: 700;">' + formatBillValue(t.kwh, 'kwh') + '</div>';
                                cardsHtml += '<div style="font-size: 0.75rem; opacity: 0.95;">' + formatBillValue(t.cost, 'cost') + '</div>';
                                cardsHtml += '<div style="font-size: 0.7rem; opacity: 0.9;">' + rate + '¢/kWh</div>';
                                cardsHtml += '</div>';
                            });
                            cardsHtml += '</div>';
                            
                            return '<div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.2);"><div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><span>⚡</span> Time-of-Use Breakdown</div>' + barHtml + cardsHtml + '</div>';
                        })()}
                    </div>
                `;
                
                // Process each account
                for (const account of data.accounts) {
                    const combined = account.combined || account;
                    const accountNumber = account.accountNumber || account.account_number || 'N/A';
                    const utilityName = account.utilityName || account.utility_name || '';
                    const displayAccountNum = isUtilityLADWP(utilityName) ? accountNumber : (accountNumber.length > 4 ? '(...)' + accountNumber.slice(-4) : accountNumber);
                    const meters = account.meters || [];
                    
                    // Per-meter sections (no more "All Meters" summary row)
                    for (const meter of meters) {
                        const meterNumber = meter.meterNumber || meter.meter_number || 'Unknown';
                        const meterKwh = meter.totalKwh || meter.sumKwh || 0;
                        const meterCost = meter.totalCost || meter.sumCost || 0;
                        const meterRate = (meter.blendedRateDollars || 0) * 100;
                        const meterAvgDay = meter.avgCostPerDay || meter.avgCostPerDayDollars || 0;
                        const bills = meter.bills || [];
                        const meterId = meter.meterId || meter.id || meterNumber;
                        
                        // Calculate date range for this meter
                        let oldestDate = null;
                        let newestDate = null;
                        for (const bill of bills) {
                            const periodStart = bill.period_start;
                            const periodEnd = bill.period_end;
                            if (periodStart) {
                                const startDate = new Date(periodStart);
                                if (!oldestDate || startDate < oldestDate) oldestDate = startDate;
                            }
                            if (periodEnd) {
                                const endDate = new Date(periodEnd);
                                if (!newestDate || endDate > newestDate) newestDate = endDate;
                            }
                        }
                        
                        let dateRangeLabel = '';
                        if (bills.length > 0) {
                            const billText = `${bills.length} Bill${bills.length !== 1 ? 's' : ''}`;
                            if (oldestDate && newestDate) {
                                const startMonthYear = oldestDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                                const endMonthYear = newestDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                                dateRangeLabel = startMonthYear === endMonthYear ? `${billText} · ${startMonthYear}` : `${billText} · ${startMonthYear} – ${endMonthYear}`;
                            } else {
                                dateRangeLabel = billText;
                            }
                        } else {
                            dateRangeLabel = 'No Bills';
                        }
                        
                        // Account/Meter header (light opacity blue ~75%)
                        html += `
                            <div class="embedded-meter-section" style="margin-bottom: 1rem; border-radius: 8px; overflow: hidden; border: 1px solid rgba(21, 101, 192, 0.3);">
                                <div style="background: rgba(21, 101, 192, 0.25); padding: 0.6rem 1rem; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 0.25rem;">
                                    <span style="font-weight: 600; color: #1565c0;">Account: ${displayAccountNum}</span>
                                    <span style="display: inline-flex; flex-wrap: wrap; align-items: center; gap: 0.25rem;"><span style="font-weight: 500; color: #1976d2;">Meter:</span> <span style="font-weight: 500; color: #1976d2; white-space: nowrap;">${meterNumber}</span></span>
                                </div>
                                <div style="background: rgba(21, 101, 192, 0.1); padding: 0.5rem 1rem; font-size: 0.85rem; color: #555; display: flex; justify-content: space-between; align-items: center;">
                                    <span>${dateRangeLabel}</span>
                                    ${bills.length > 1 ? `<span class="expand-all-bills-toggle" data-meter-id="${meterId}" title="Expand/Collapse all bills" style="cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px; border: 1px solid rgba(21, 101, 192, 0.3); background: rgba(255,255,255,0.5); color: #1565c0; font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem; user-select: none;"><span class="expand-all-icon" style="transition: transform 0.2s;">▼</span></span>` : ''}
                                </div>
                                <div class="embedded-meter-header" data-meter-id="${meterId}" style="background: #fff; padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #e0e0e0;">
                                    <div class="embedded-meter-stats-row">
                                        <div>
                                            <div class="stat-value">${formatBillValue(meterKwh, 'kwh')}</div>
                                            <div class="stat-label">kWh</div>
                                        </div>
                                        <div>
                                            <div class="stat-value">${formatBillValue(meterCost, 'cost')}</div>
                                            <div class="stat-label">Cost</div>
                                        </div>
                                        <div>
                                            <div class="stat-value">${formatBillValue(meterRate, 'rate')}</div>
                                            <div class="stat-label">Rate</div>
                                        </div>
                                        <div>
                                            <div class="stat-value">${formatBillValue(meterAvgDay, 'avgDay')}</div>
                                            <div class="stat-label">Avg/Day</div>
                                        </div>
                                        <span class="meter-expand-icon" data-meter-id="${meterId}" style="color: #666; transition: transform 0.2s; transform: rotate(-90deg);">▼</span>
                                    </div>
                                </div>
                                <div class="embedded-meter-bills" id="embedded-meter-bills-${meterId}" style="display: none;">
                                    <div style="background: #f5f5f5; padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 600; color: #555; text-transform: uppercase; border-bottom: 1px solid #ddd;">
                                        Billing History
                                    </div>
                        `;
                        
                        // Bill rows within meter
                        if (bills.length > 0) {
                            // Sort bills by period (newest first)
                            bills.sort((a, b) => {
                                const dateA = a.period_end || a.periodEnd || '';
                                const dateB = b.period_end || b.periodEnd || '';
                                return dateB.localeCompare(dateA);
                            });

                            for (const bill of bills) {
                                const billId = bill.billId || bill.id;
                                const periodLabel = bill.periodLabel || formatBillPeriod(bill);
                                const billKwh = bill.total_kwh || bill.totalKwh || 0;
                                const billCost = bill.total_amount_due || bill.totalAmountDue || 0;
                                const billRateValue = billKwh > 0 ? ((billCost / billKwh) * 100) : 0;
                                const billDays = computeDaysInPeriod(bill.daysInPeriod, bill.periodStart || bill.period_start, bill.periodEnd || bill.period_end) || 30;
                                const billAvgDayValue = billDays > 0 ? (billCost / billDays) : 0;
                                
                                html += `
                                    <div class="embedded-bill-row" data-bill-id="${billId}">
                                        <span class="period-col">${periodLabel}</span>
                                        <span class="kwh-col">${formatBillValue(billKwh, 'kwh')}</span>
                                        <span class="cost-col">${formatBillValue(billCost, 'cost')}</span>
                                        <span class="rate-col">${formatBillValue(billRateValue, 'rate')}</span>
                                        <span class="bill-expand-icon" data-bill-id="${billId}" style="color: #999; font-size: 0.8rem; text-align: center;">▶</span>
                                    </div>
                                    <div class="embedded-bill-detail" id="embedded-bill-detail-${billId}" style="display: none; padding: 0.75rem 1rem; background: #fafafa; border-bottom: 1px solid #eee;">
                                        <div style="font-size: 0.85rem; color: #666;">Loading details...</div>
                                    </div>
                                `;
                            }
                        } else {
                            html += `<div style="padding: 1rem; color: #999; text-align: center;">No billing periods available</div>`;
                        }
                        
                        html += `</div></div>`; // Close meter-bills and meter-section
                    }
                }
                
                return html;
            } catch (err) {
                console.error('[embeddedBills] Error rendering extracted data:', err);
                return '<div style="color: #dc3545; text-align: center;">Error loading extracted data.</div>';
            }
        }
        
        // Toggle function for collapsible Uploaded Files section
        window.toggleEmbeddedFilesSection = function() {
            const container = document.getElementById('embeddedFilesListContainer');
            const arrow = document.getElementById('embeddedFilesArrow');
            if (!container) return;
            
            const isHidden = container.style.display === 'none';
            container.style.display = isHidden ? 'flex' : 'none';
            if (arrow) arrow.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(-90deg)';
            
            // Save state to localStorage
            localStorage.setItem('embeddedBillsFilesCollapsed', isHidden ? 'false' : 'true');
        };
        
        window.toggleEmbeddedMeter = function(meterId) {
            const billsContainer = document.getElementById(`embedded-meter-bills-${meterId}`);
            const icon = document.querySelector(`.meter-expand-icon[data-meter-id="${meterId}"]`);
            if (billsContainer) {
                const isHidden = billsContainer.style.display === 'none' || !billsContainer.style.display;
                billsContainer.style.display = isHidden ? 'block' : 'none';
                // Arrow down (0deg) = expanded, Arrow right (-90deg) = collapsed
                if (icon) icon.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(-90deg)';
            }
        };
        
        // Toggle all bill details within a meter section (expand or collapse all)
        window.toggleAllBillsInMeter = function(meterId, toggleElement) {
            const billsContainer = document.getElementById(`embedded-meter-bills-${meterId}`);
            if (!billsContainer) return;
            
            // First, make sure the meter section is expanded
            if (billsContainer.style.display === 'none' || !billsContainer.style.display) {
                window.toggleEmbeddedMeter(meterId);
            }
            
            // Get all bill detail elements within this meter
            const billDetails = billsContainer.querySelectorAll('.embedded-bill-detail');
            const billRows = billsContainer.querySelectorAll('.embedded-bill-row');
            
            // Check if any are currently expanded
            let anyExpanded = false;
            billDetails.forEach(detail => {
                if (detail.style.display !== 'none') {
                    anyExpanded = true;
                }
            });
            
            // Toggle icon in the expand-all button
            const icon = toggleElement.querySelector('.expand-all-icon');
            
            if (anyExpanded) {
                // Collapse all
                billDetails.forEach(detail => {
                    detail.style.display = 'none';
                });
                billRows.forEach(row => {
                    const rowIcon = row.querySelector('.bill-expand-icon');
                    if (rowIcon) rowIcon.style.transform = 'rotate(0deg)';
                });
                if (icon) icon.style.transform = 'rotate(-90deg)';
            } else {
                // Expand all - trigger each bill to load its details
                billRows.forEach(row => {
                    const billId = row.dataset.billId;
                    if (billId) {
                        const detailEl = document.getElementById(`embedded-bill-detail-${billId}`);
                        if (detailEl && detailEl.style.display === 'none') {
                            window.toggleEmbeddedBillDetail(billId);
                        }
                    }
                });
                if (icon) icon.style.transform = 'rotate(0deg)';
            }
        };
        
        function formatBillPeriod(bill) {
            // Support both camelCase (legacy) and snake_case (API) field names
            const start = bill.periodStart || bill.period_start;
            const end = bill.periodEnd || bill.period_end;
            if (end) {
                const d = new Date(end);
                return d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            }
            if (start) {
                const d = new Date(start);
                return d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            }
            return 'Unknown Period';
        }
        
        // Global function to open bill review modal from embedded bills section
        window.openBillReviewModal = function(fileId) {
            const projectId = ProjectState.currentProjectId || ProjectState.project_id;
            if (!projectId) {
                console.error('[openBillReviewModal] No project ID available');
                return;
            }
            // Use NavigationController's openBillReview method if available
            if (typeof NavigationController !== 'undefined' && NavigationController.openBillReview) {
                // Ensure modal close handlers are set up (may not be if coming from embedded view)
                NavigationController.setupReviewModalHandlers(projectId);
                NavigationController.openBillReview(projectId, fileId);
            } else {
                // Fallback: open PDF in new tab
                window.open(`/api/bills/file/${fileId}/pdf`, '_blank');
            }
        };
        
        window.toggleEmbeddedBillDetail = async function(billId) {
            const detailEl = document.getElementById(`embedded-bill-detail-${billId}`);
            const icon = document.querySelector(`.bill-expand-icon[data-bill-id="${billId}"]`);
            
            if (!detailEl) return;
            
            const isHidden = detailEl.style.display === 'none' || !detailEl.style.display;
            
            if (isHidden) {
                detailEl.style.display = 'block';
                if (icon) icon.style.transform = 'rotate(90deg)';
                
                // Load detail if not already loaded
                if (detailEl.innerHTML.includes('Loading')) {
                    try {
                        const response = await fetch(`/api/bills/${billId}/detail`);
                        const data = await response.json();
                        
                        if (data.success) {
                            const bill = data;
                            const rawTou = bill.tou || {};
                            const charges = bill.charges || {};
                            const totalKwh = bill.total_kwh || bill.totalKwh || 0;
                            const totalCost = bill.total_amount_due || bill.totalAmountDue || 0;
                            const days = computeDaysInPeriod(bill.daysInPeriod, bill.periodStart, bill.periodEnd) ?? 0;
                            const ratePerKwhCents = totalKwh > 0 ? ((totalCost / totalKwh) * 100).toFixed(2) : '0.00';
                            
                            // Transform TOU data - prefer touPeriods array if available, fall back to flat structure
                            const tou = {};
                            const touPeriods = bill.touPeriods || [];
                            if (touPeriods.length > 0) {
                                // Use touPeriods array (from bill_tou_periods table)
                                for (const p of touPeriods) {
                                    const periodName = (p.period || '').toLowerCase().replace(/[- ]/g, '');
                                    if (periodName.includes('super') && periodName.includes('off')) {
                                        tou.superOffPeak = { kwh: p.kwh || 0, cost: p.estCostDollars || 0 };
                                    } else if (periodName.includes('on')) {
                                        tou.onPeak = { kwh: p.kwh || 0, cost: p.estCostDollars || 0 };
                                    } else if (periodName.includes('mid')) {
                                        tou.midPeak = { kwh: p.kwh || 0, cost: p.estCostDollars || 0 };
                                    } else if (periodName.includes('off')) {
                                        tou.offPeak = { kwh: p.kwh || 0, cost: p.estCostDollars || 0 };
                                    }
                                }
                            } else {
                                // Fallback to flat structure from bills table columns
                                if (rawTou.onPeakKwh || rawTou.onPeakCost) tou.onPeak = { kwh: rawTou.onPeakKwh || 0, cost: rawTou.onPeakCost || 0 };
                                if (rawTou.midPeakKwh || rawTou.midPeakCost) tou.midPeak = { kwh: rawTou.midPeakKwh || 0, cost: rawTou.midPeakCost || 0 };
                                if (rawTou.offPeakKwh || rawTou.offPeakCost) tou.offPeak = { kwh: rawTou.offPeakKwh || 0, cost: rawTou.offPeakCost || 0 };
                                if (rawTou.superOffPeakKwh || rawTou.superOffPeakCost) tou.superOffPeak = { kwh: rawTou.superOffPeakKwh || 0, cost: rawTou.superOffPeakCost || 0 };
                            }
                            
                            // Format dates
                            const periodStart = bill.periodStart ? new Date(bill.periodStart).toLocaleDateString() : 'N/A';
                            const periodEnd = bill.periodEnd ? new Date(bill.periodEnd).toLocaleDateString() : 'N/A';
                            const dueDate = bill.dueDate || bill.due_date ? new Date(bill.dueDate || bill.due_date).toLocaleDateString() : 'N/A';
                            
                            // Check for demand data
                            const peakDemand = bill.demand || bill.peakDemand || bill.peak_demand || 0;
                            const hasDemand = peakDemand > 0;
                            
                            let detailHtml = `
                                <!-- Bill Summary Section -->
                                <div style="background: white; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 0.75rem; overflow: hidden;">
                                    <div style="background: #f5f5f5; padding: 0.5rem 0.75rem; font-weight: 600; color: #333; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                                        <span>📋 Bill Summary</span>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button onclick="openBillReviewModal(${bill.billFileId || bill.bill_file_id || billId})" style="background: #6c757d; color: white; border: none; border-radius: 4px; padding: 0.35rem 0.75rem; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;">🔧 Edit</button>
                                            <button onclick="openBillPdfModal(${bill.billFileId || bill.bill_file_id || billId}, '${(bill.original_filename || 'Bill').replace(/'/g, "\\'")}')" style="background: #1976d2; color: white; border: none; border-radius: 4px; padding: 0.35rem 0.75rem; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;">📄 View Bill</button>
                                        </div>
                                    </div>
                                    <div style="padding: 0.75rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; font-size: 0.85rem;">
                                        <div>
                                            <div style="color: #666; font-size: 0.75rem; text-transform: uppercase;">Service Address</div>
                                            <div style="color: #333; font-weight: 500;">${resolveBillField('serviceAddress', 
                                                [bill.serviceAddress, 'bill.serviceAddress'], 
                                                [bill.service_address, 'bill.service_address'], 
                                                [bill.meterAddress, 'bill.meterAddress'],
                                                [ProjectState.siteData?.street ? (ProjectState.siteData.street + (ProjectState.siteData.city ? ', ' + ProjectState.siteData.city : '') + (ProjectState.siteData.state ? ' ' + ProjectState.siteData.state : '')) : null, 'project.siteAddress']
                                            ) || 'N/A'}</div>
                                        </div>
                                        <div>
                                            <div style="color: #666; font-size: 0.75rem; text-transform: uppercase;">Rate Schedule</div>
                                            <div style="color: #333; font-weight: 500;">${resolveBillField('rateSchedule', [bill.rateSchedule, 'bill.rateSchedule'], [bill.rate_schedule, 'bill.rate_schedule'], [bill.tariff, 'bill.tariff']) || 'N/A'}</div>
                                        </div>
                                        <div>
                                            <div style="color: #666; font-size: 0.75rem; text-transform: uppercase;">Billing Period</div>
                                            <div style="color: #333; font-weight: 500;">${periodStart} - ${periodEnd} (${days} days)</div>
                                        </div>
                                        <div>
                                            <div style="color: #666; font-size: 0.75rem; text-transform: uppercase;">Amount Due</div>
                                            <div style="color: #333; font-weight: 600; font-size: 1rem;">${formatBillValue(totalCost, 'cost')}</div>
                                        </div>
                                        <div>
                                            <div style="color: #666; font-size: 0.75rem; text-transform: uppercase;">Due Date</div>
                                            <div style="color: #333; font-weight: 500;">${dueDate}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Usage Summary Section -->
                                <div style="background: white; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 0.75rem; overflow: hidden;">
                                    <div style="background: #f5f5f5; padding: 0.5rem 0.75rem; font-weight: 600; color: #333; border-bottom: 1px solid #ddd;">⚡ Usage Summary</div>
                                    <div style="padding: 0.75rem; display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 0.5rem; text-align: center;">
                                        <div style="background: #f8f9fa; border-radius: 6px; padding: 0.5rem;">
                                            <div style="font-size: clamp(0.9rem, 4vw, 1.25rem); font-weight: 700; color: #333; white-space: nowrap;">${formatBillValue(totalKwh, 'kwh')}</div>
                                            <div style="font-size: 0.7rem; color: #666; line-height: 1.2;">Total kWh</div>
                                        </div>
                                        <div style="background: #f8f9fa; border-radius: 6px; padding: 0.5rem;">
                                            <div style="font-size: clamp(0.9rem, 4vw, 1.25rem); font-weight: 700; color: #333; white-space: nowrap;">${formatBillValue(totalCost, 'cost')}</div>
                                            <div style="font-size: 0.7rem; color: #666; line-height: 1.2;">Total Cost</div>
                                        </div>
                                        <div style="background: #f8f9fa; border-radius: 6px; padding: 0.5rem;">
                                            <div style="font-size: clamp(0.9rem, 4vw, 1.25rem); font-weight: 700; color: #333; white-space: nowrap;">${formatBillValue(parseFloat(ratePerKwhCents), 'rate')}</div>
                                            <div style="font-size: 0.7rem; color: #666; line-height: 1.2;">Rate/kWh</div>
                                        </div>
                                    </div>
                                    ${hasDemand ? `
                                    <div style="padding: 0 0.75rem 0.75rem; text-align: center;">
                                        <div style="background: #fff3e0; border-radius: 6px; padding: 0.5rem; border: 1px solid #ff9800; display: inline-block;">
                                            <span style="font-size: 1rem; font-weight: 700; color: #e65100;">${peakDemand.toLocaleString()} kW</span>
                                            <span style="font-size: 0.7rem; color: #e65100; margin-left: 0.25rem;">Peak Demand</span>
                                        </div>
                                    </div>
                                    ` : ''}
                            `;
                            
                            // TOU breakdown with color-coded horizontal bars
                            const hasTOU = tou.onPeak || tou.offPeak || tou.midPeak || tou.superOffPeak;
                            if (hasTOU) {
                                // TOU color scheme matching utility bill format
                                // Using more saturated background colors for better visibility across displays
                                const touConfig = [
                                    { key: 'onPeak', color: '#e53935', bgColor: '#ffcdd2', label: 'ON PEAK' },
                                    { key: 'midPeak', color: '#ff9800', bgColor: '#ffe0b2', label: 'MID PEAK' },
                                    { key: 'offPeak', color: '#4caf50', bgColor: '#c8e6c9', label: 'OFF PEAK' },
                                    { key: 'superOffPeak', color: '#2196f3', bgColor: '#bbdefb', label: 'SUPER OFF-PEAK' }
                                ];
                                
                                // Calculate total for percentage bars
                                let totalTouKwh = 0;
                                touConfig.forEach(t => {
                                    if (tou[t.key]) totalTouKwh += (tou[t.key].kwh || 0);
                                });
                                
                                detailHtml += `
                                    <div style="padding: 0.75rem; border-top: 1px solid #eee;">
                                        <div style="display: flex; gap: 0.25rem; margin-bottom: 0.75rem; height: 8px; border-radius: 4px; overflow: hidden;">
                                `;
                                
                                // Render percentage bar segments
                                touConfig.forEach(t => {
                                    if (tou[t.key]) {
                                        const kwh = tou[t.key].kwh || 0;
                                        const pct = totalTouKwh > 0 ? (kwh / totalTouKwh * 100) : 0;
                                        if (pct > 0) {
                                            detailHtml += `<div style="width: ${pct}%; background: ${t.color};"></div>`;
                                        }
                                    }
                                });
                                
                                detailHtml += `</div><div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">`;
                                
                                // Render TOU detail cards
                                touConfig.forEach(t => {
                                    if (tou[t.key]) {
                                        const kwh = tou[t.key].kwh || 0;
                                        const cost = tou[t.key].cost || 0;
                                        const rate = kwh > 0 ? ((cost / kwh) * 100).toFixed(2) : '0.00';
                                        
                                        detailHtml += `
                                            <div style="flex: 1; min-width: 120px; background: ${t.bgColor}; border-radius: 6px; padding: 0.5rem; text-align: center;">
                                                <div style="display: flex; align-items: center; justify-content: center; gap: 0.25rem; margin-bottom: 0.25rem;">
                                                    <div style="width: 10px; height: 10px; background: ${t.color}; border-radius: 2px;"></div>
                                                    <span style="font-size: 0.7rem; font-weight: 600; color: #555;">${t.label}</span>
                                                </div>
                                                <div style="font-size: 0.9rem; font-weight: 600; color: #333;">${formatBillValue(kwh, 'kwh')}</div>
                                                <div style="font-size: 0.8rem; color: #555;">${formatBillValue(cost, 'cost')}</div>
                                                <div style="font-size: 0.75rem; color: #888;">${formatBillValue(parseFloat(rate), 'rate')}/kWh</div>
                                            </div>
                                        `;
                                    }
                                });
                                
                                detailHtml += `</div></div>`;
                            } else {
                                detailHtml += `
                                    <div style="padding: 0.75rem; border-top: 1px solid #eee; text-align: center;">
                                        <div style="color: #888; font-size: 0.85rem; font-style: italic;">TOU data not available for this bill</div>
                                    </div>
                                `;
                            }
                            
                            detailHtml += `</div>`; // Close usage summary card
                            
                            detailEl.innerHTML = detailHtml;
                        } else {
                            detailEl.innerHTML = '<div style="font-size: 0.85rem; color: #666;">No additional details available.</div>';
                        }
                    } catch (err) {
                        console.error('[embeddedBills] Error loading bill detail:', err);
                        detailEl.innerHTML = '<div style="font-size: 0.85rem; color: #dc3545;">Error loading details.</div>';
                    }
                }
            } else {
                detailEl.style.display = 'none';
                if (icon) icon.style.transform = 'rotate(0deg)';
            }
        }
        
        // Setup click handlers for embedded bill rows (called after rendering)
        function setupEmbeddedBillClickHandlers() {
            const projectId = ProjectState.currentProjectId || ProjectState.project_id;
            
            // Handle meter header clicks for expanding/collapsing bills
            document.querySelectorAll('.embedded-meter-header[data-meter-id]').forEach(header => {
                header.style.cursor = 'pointer';
                header.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const meterId = this.dataset.meterId;
                    if (meterId) {
                        window.toggleEmbeddedMeter(meterId);
                    }
                });
            });
            
            // Handle expand/collapse all bills toggle
            document.querySelectorAll('.expand-all-bills-toggle[data-meter-id]').forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const meterId = this.dataset.meterId;
                    if (meterId) {
                        window.toggleAllBillsInMeter(meterId, this);
                    }
                });
            });
            
            // Handle bill row clicks for expanding details
            document.querySelectorAll('.embedded-bill-row[data-bill-id]').forEach(row => {
                row.style.cursor = 'pointer';
                row.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const billId = this.dataset.billId;
                    if (billId) {
                        window.toggleEmbeddedBillDetail(billId);
                    }
                });
            });
            
            // Multi-select functionality
            const selectAllCheckbox = document.getElementById('embeddedBillSelectAll');
            let deleteSelectedBtn = document.getElementById('embeddedBillDeleteSelected');

            function updateDeleteButtonVisibility() {
                const checkedCount = document.querySelectorAll('.embedded-bill-checkbox:checked').length;
                // Always get fresh reference in case button was replaced
                const btn = document.getElementById('embeddedBillDeleteSelected');
                if (btn) {
                    btn.style.display = checkedCount > 0 ? 'inline-block' : 'none';
                    btn.textContent = checkedCount > 1 ? `Delete ${checkedCount} Selected` : 'Delete Selected';
                }
            }

            // Delete Selected button - clone to remove old listeners FIRST
            if (deleteSelectedBtn) {
                // IMPORTANT: Remove all previous event listeners by cloning the button
                // This prevents the delete handler from running multiple times
                const newDeleteBtn = deleteSelectedBtn.cloneNode(true);
                deleteSelectedBtn.parentNode.replaceChild(newDeleteBtn, deleteSelectedBtn);
                deleteSelectedBtn = newDeleteBtn; // Update reference to new button

                newDeleteBtn.addEventListener('click', async function() {
                    const checkedBoxes = document.querySelectorAll('.embedded-bill-checkbox:checked');
                    const fileIds = Array.from(checkedBoxes).map(cb => cb.dataset.fileId);

                    // Debug: log file IDs to check for duplicates
                    console.log('[embeddedBills] Deleting file IDs:', fileIds);
                    console.log('[embeddedBills] Unique file IDs:', [...new Set(fileIds)]);

                    if (fileIds.length === 0) return;

                    const confirmMsg = fileIds.length === 1
                        ? 'Delete this bill file and its extracted data?'
                        : `Delete ${fileIds.length} bill files and their extracted data?`;

                    const confirmed = await showConfirmModal({
                        title: 'Delete Bill Files',
                        message: confirmMsg,
                        confirmText: 'Delete',
                        cancelText: 'Cancel',
                        danger: true
                    });
                    if (!confirmed) return;

                    // Use batch delete for much faster deletion (single request instead of N requests)
                    let deleted = 0;
                    let failed = 0;
                    
                    console.log(`[embeddedBills] Batch deleting ${fileIds.length} files...`);
                    try {
                        const resp = await fetch(`/api/projects/${encodeURIComponent(projectId)}/bills/files/batch-delete`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ file_ids: fileIds.map(id => parseInt(id, 10)) })
                        });
                        const result = await resp.json();
                        console.log(`[embeddedBills] Batch delete response:`, result);
                        
                        deleted = result.deleted_count || 0;
                        failed = (result.total_requested || fileIds.length) - deleted;
                        
                        // Remove deleted rows from UI
                        fileIds.forEach(fileId => {
                            const row = document.querySelector(`.embedded-bill-file-row[data-file-id="${fileId}"]`);
                            if (row) row.remove();
                        });
                    } catch (err) {
                        console.error('[embeddedBills] Batch delete error:', err);
                        failed = fileIds.length;
                    }

                    console.log(`[embeddedBills] Final counts - deleted: ${deleted}, failed: ${failed}`);

                    // Show detailed message about deletions
                    if (deleted > 0 && failed === 0) {
                        showToast(`${deleted} file${deleted === 1 ? '' : 's'} deleted`, 'success');
                    } else if (deleted > 0 && failed > 0) {
                        showToast(`${deleted} file${deleted === 1 ? '' : 's'} deleted, ${failed} failed`, 'warning');
                    } else if (failed > 0) {
                        showToast(`Failed to delete ${failed} file${failed === 1 ? '' : 's'}`, 'error');
                    }

                    if (deleted > 0) {
                        updateDeleteButtonVisibility();
                        // Reset select-all checkbox
                        const selectAllCb = document.getElementById('embeddedBillSelectAll');
                        if (selectAllCb) selectAllCb.checked = false;
                        // Always refresh extracted data section after deleting bills
                        if (typeof BillsManager !== 'undefined' && BillsManager.loadProjectBillsSummary) {
                            BillsManager.loadProjectBillsSummary();
                        }
                        // Re-render if all files deleted
                        if (document.querySelectorAll('.embedded-bill-file-row').length === 0) {
                            renderEmbeddedBillsSection();
                        }
                    }
                });
            }

            // Select All checkbox - always use fresh query (covers files uploaded later)
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.embedded-bill-checkbox');
                    checkboxes.forEach(cb => cb.checked = this.checked);
                    updateDeleteButtonVisibility();
                });
            }

            // Individual checkboxes - use event delegation on container for dynamic content
            const filesContainer = document.getElementById('embeddedFilesListContainer');
            if (filesContainer) {
                filesContainer.addEventListener('change', function(e) {
                    if (e.target.classList.contains('embedded-bill-checkbox')) {
                        e.stopPropagation();
                        updateDeleteButtonVisibility();
                        // Update select-all state with fresh count
                        if (selectAllCheckbox) {
                            const totalCheckboxes = document.querySelectorAll('.embedded-bill-checkbox').length;
                            const checkedCount = document.querySelectorAll('.embedded-bill-checkbox:checked').length;
                            selectAllCheckbox.checked = totalCheckboxes > 0 && checkedCount === totalCheckboxes;
                        }
                    }
                });
                filesContainer.addEventListener('click', function(e) {
                    if (e.target.classList.contains('embedded-bill-checkbox')) {
                        e.stopPropagation();
                    }
                });
            }
        }

        async function handleEmbeddedBillUpload(files) {
            if (!files || files.length === 0) return;
            
            // Use currentProjectId first, fall back to project_id
            const projectId = ProjectState.currentProjectId || ProjectState.project_id;
            if (!projectId) {
                showToast('Please save the project first before uploading bills.', 'warning');
                return;
            }
            
            console.log(`[embeddedBills] Starting upload of ${files.length} files for project ${projectId}`);
            
            const statusEl = document.getElementById('embeddedBillUploadStatus');
            const progressContainer = document.getElementById('embeddedBillProgressContainer');
            const progressFill = document.getElementById('embeddedBillProgressFill');
            const progressText = document.getElementById('embeddedBillProgressText');
            
            if (progressContainer) progressContainer.style.display = 'block';
            if (statusEl) statusEl.innerHTML = '<span style="color: #2196f3;">Uploading...</span>';
            
            let uploaded = 0;
            const total = files.length;
            
            const uploadedFileIds = [];
            
            for (const file of files) {
                try {
                    console.log(`[embeddedBills] Uploading file: ${file.name}, size: ${file.size}, type: ${file.type}`);
                    
                    // Verify file has content
                    if (!file.size || file.size === 0) {
                        console.error(`[embeddedBills] ERROR: File ${file.name} has zero size!`);
                        showToast(`File ${file.name} appears to be empty`, 'error');
                        continue;
                    }
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    // Use correct API path: /api/projects/<project_id>/bills/upload
                    const response = await fetch(`/api/projects/${encodeURIComponent(projectId)}/bills/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    // Always attempt to parse response so we can show actionable errors
                    let result = null;
                    try {
                        result = await response.json();
                    } catch (e) {
                        const txt = await response.text().catch(() => '');
                        result = { success: false, error: txt || 'Upload failed (non-JSON response)' };
                    }

                    if (!response.ok || !result || result.success === false) {
                        const msg = (result && result.error) ? result.error : `Upload failed (${response.status})`;
                        console.error('[embeddedBills] Upload failed:', file.name, msg);
                        if (statusEl) statusEl.innerHTML = `<span style="color:#dc3545;">✗ ${msg}</span>`;
                        showToast(msg, 'error');
                        continue;
                    }

                    uploaded++;
                    if (result.file && result.file.id) {
                        // Only queue for processing if not a duplicate
                        if (!result.is_duplicate) {
                            uploadedFileIds.push(result.file.id);
                        } else {
                            console.log(`[embeddedBills] Skipping duplicate file: ${file.name}`);
                        }
                    }
                    
                    const progress = (uploaded / total) * 100;
                    if (progressFill) progressFill.style.width = `${progress}%`;
                    if (progressText) progressText.textContent = `${uploaded} of ${total} uploaded`;
                    
                } catch (err) {
                    console.error('[embeddedBills] Upload error:', err);
                }
            }

            if (uploaded === 0) {
                // Avoid flashing "analyzing 0 files" then re-rendering back to the upload button
                if (statusEl) statusEl.innerHTML = '';
                if (progressText) progressText.textContent = '';
                setTimeout(() => {
                    if (progressContainer) progressContainer.style.display = 'none';
                }, 800);
                return;
            }

            if (statusEl) statusEl.innerHTML = `<span style="color: #28a745;">✓ ${uploaded} file(s) uploaded. Starting extraction...</span>`;
            
            // Trigger processing for each uploaded file
            for (const fileId of uploadedFileIds) {
                try {
                    await fetch(`/api/projects/${encodeURIComponent(projectId)}/bills/process/${fileId}`, {
                        method: 'POST'
                    });
                } catch (err) {
                    console.error('[embeddedBills] Process trigger error:', err);
                }
            }
            
            if (statusEl) statusEl.innerHTML = `<span style="color: #2196f3;">🔍 Analyzing ${uploaded} file(s)...</span>`;
            
            // Add new file rows inline instead of full re-render to avoid flashing
            setTimeout(async () => {
                // Check if file list container exists (files already displayed)
                const existingFileList = document.querySelector('.embedded-bills-files > div[style*="flex-direction: column"]');
                
                if (existingFileList && uploadedFileIds.length > 0) {
                    // Fetch updated file info for the newly uploaded files
                    try {
                        const response = await fetch(`/api/projects/${encodeURIComponent(projectId)}/bills/status`);
                        const data = await response.json();
                        
                        if (data.success && data.files) {
                            // Add rows for new files only
                            for (const fileId of uploadedFileIds) {
                                const fileInfo = data.files.find(f => f.id == fileId);
                                if (fileInfo && !document.querySelector(`.embedded-bill-file-row[data-file-id="${fileId}"]`)) {
                                    const displayName = fileInfo.original_filename || `File ${fileId}`;
                                    const row = document.createElement('div');
                                    row.className = 'embedded-bill-file-row';
                                    row.dataset.fileId = fileId;
                                    row.dataset.status = 'waiting';
                                    // IMPORTANT: Match the EXACT same structure as initial render (line 10789-10805)
                                    row.innerHTML = `
                                        <div class="file-info-column">
                                            <div class="file-row-header">
                                                <input type="checkbox" class="embedded-bill-checkbox" data-file-id="${fileId}" style="cursor: pointer;">
                                                <span class="file-name">${displayName}</span>
                                            </div>
                                            <div class="file-progress-bar">
                                                <div class="progress-track">
                                                    <div class="progress-fill waiting"></div>
                                                </div>
                                                <span class="progress-text waiting">Waiting...</span>
                                            </div>
                                        </div>
                                        <button class="embedded-file-view-btn" data-file-id="${fileId}" title="View">View</button>
                                        <button class="embedded-file-delete-btn" data-file-id="${fileId}" data-has-extracted="false" title="Delete">Delete</button>
                                    `;
                                    existingFileList.appendChild(row);
                                    
                                    // Wire up button handlers for this row
                                    row.querySelector('.embedded-file-view-btn').addEventListener('click', (e) => {
                                        e.stopPropagation();
                                        if (typeof openBillReviewModal === 'function') openBillReviewModal(fileId);
                                    });
                                    row.querySelector('.embedded-file-delete-btn').addEventListener('click', async (e) => {
                                        e.stopPropagation();
                                        const fileName = row.querySelector('span').textContent.trim();
                                        const confirmed = await showConfirmModal({
                                            title: 'Delete Bill File',
                                            message: `Delete this bill file?\n\n${fileName}`,
                                            confirmText: 'Delete',
                                            cancelText: 'Cancel',
                                            danger: true
                                        });
                                        if (confirmed) {
                                            try {
                                                const resp = await fetch(`/api/projects/${encodeURIComponent(projectId)}/bills/files/${fileId}`, { method: 'DELETE' });
                                                const result = await resp.json();
                                                if (result.success) {
                                                    row.remove();
                                                    showToast('Bill file deleted', 'success');
                                                } else {
                                                    showToast(result.error || 'Failed to delete', 'error');
                                                }
                                            } catch (err) {
                                                showToast('Error deleting file', 'error');
                                            }
                                        }
                                    });
                                }
                            }
                        }
                    } catch (err) {
                        console.error('[embeddedBills] Error adding file rows:', err);
                    }
                    
                    // Start polling to update status (if not already running)
                    startEmbeddedBillsPolling(projectId);
                } else {
                    // First upload or no existing container - do full render
                    await renderEmbeddedBillsSection();
                }
                
                // Clear progress UI after a moment
                setTimeout(() => {
                    if (progressContainer) progressContainer.style.display = 'none';
                    if (statusEl) statusEl.innerHTML = '';
                }, 2000);
            }, 1500);
        }
        
        /**
         * Handle importing bills from CSV file.
         * Instantly recreates all bill data without needing to re-upload/process PDFs.
         */
        async function handleEmbeddedBillCsvImport(file, projectId) {
            if (!file) return;
            
            projectId = projectId || ProjectState.currentProjectId || ProjectState.project_id;
            if (!projectId) {
                showToast('Please save the project first before importing bills.', 'warning');
                return;
            }
            
            console.log(`[embeddedBills] Importing bills from CSV: ${file.name}`);
            
            const statusEl = document.getElementById('embeddedBillUploadStatus');
            if (statusEl) statusEl.innerHTML = '<span style="color: #2196f3;">📥 Importing bills from CSV...</span>';
            
            try {
                // Read file content
                const csvContent = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => reject(reader.error);
                    reader.readAsText(file);
                });
                
                // Send to import endpoint
                const response = await fetch(`/api/projects/${encodeURIComponent(projectId)}/bills/import-csv`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ csv: csvContent })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const msg = `✓ Imported ${result.bills_imported} bills (${result.accounts_created} accounts, ${result.meters_created} meters)`;
                    if (statusEl) statusEl.innerHTML = `<span style="color: #28a745;">${msg}</span>`;
                    showToast(msg, 'success');
                    
                    // Refresh the bills section to show imported data
                    setTimeout(() => {
                        renderEmbeddedBillsSection();
                        if (statusEl) statusEl.innerHTML = '';
                    }, 1500);
                } else {
                    const errorMsg = result.error || 'Import failed';
                    if (statusEl) statusEl.innerHTML = `<span style="color: #dc3545;">✗ ${errorMsg}</span>`;
                    showToast(errorMsg, 'error');
                }
                
            } catch (err) {
                console.error('[embeddedBills] CSV import error:', err);
                if (statusEl) statusEl.innerHTML = `<span style="color: #dc3545;">✗ Import failed: ${err.message}</span>`;
                showToast('Failed to import bills CSV', 'error');
            }
        }
        
        // ==================================================================================
        // MASS DELETE FUNCTIONALITY
        // ==================================================================================
        
        // Create project list item with checkbox (for modal and page)
        function createProjectListItemWithCheckbox(proj, context = 'modal') {
            const item = document.createElement('div');
            item.className = 'project-list-item';
            item.dataset.projectId = proj.id;
            
            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'project-checkbox';
            checkbox.dataset.projectId = proj.id;
            checkbox.addEventListener('change', () => updateDeleteButtonState(context));
            checkbox.addEventListener('click', (e) => e.stopPropagation());
            
            const info = document.createElement('div');
            info.className = 'project-list-info';
            info.style.flex = '1';
            info.style.minWidth = '0';
            info.style.cursor = 'pointer';
            
            const name = document.createElement('div');
            name.className = 'project-list-name';
            name.textContent = proj.name || proj.customer || 'Unnamed Project';
            
            const customer = document.createElement('div');
            customer.className = 'project-list-customer';
            if (proj.customer && proj.customer !== proj.name) {
                customer.textContent = proj.customer;
            }
            
            const meta = document.createElement('div');
            meta.className = 'project-list-meta';
            
            const evapCount = proj.evap_count || 0;
            const condCount = proj.cond_count || 0;
            const totalUnits = evapCount + condCount;
            
            let metaText = [];
            if (totalUnits > 0) {
                metaText.push(`${evapCount} evap, ${condCount} cond`);
            }
            if (proj.last_modified) {
                metaText.push(`Modified: ${formatProjectDate(proj.last_modified)}`);
            } else if (proj.created_at) {
                metaText.push(`Created: ${formatProjectDate(proj.created_at)}`);
            }
            
            meta.textContent = metaText.join(' • ');
            
            info.appendChild(name);
            if (customer.textContent) info.appendChild(customer);
            info.appendChild(meta);
            
            // Click on info area loads project OR toggles selection if in selection mode
            info.addEventListener('click', async () => {
                // Check if any checkboxes are checked (selection mode active)
                const containerSelector = context === 'modal' ? '#loadProjectListContainer' : '#projectsPageListContainer';
                const anyChecked = document.querySelectorAll(`${containerSelector} .project-checkbox:checked`).length > 0;
                
                if (anyChecked) {
                    // Toggle this row's checkbox
                    checkbox.checked = !checkbox.checked;
                    updateDeleteButtonState(context);
                } else {
                    // Load project as normal
                    await loadProjectFromService(proj.id);
                    if (context === 'modal') {
                        document.getElementById('loadProjectModal').classList.add('hidden');
                    } else {
                        NavigationController.setView('home');
                    }
                }
            });
            
            const actions = document.createElement('div');
            actions.className = 'project-list-actions';
            
            const duplicateBtn = document.createElement('button');
            duplicateBtn.textContent = '📋';
            duplicateBtn.title = 'Duplicate';
            duplicateBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                try {
                    await ProjectService.duplicateProject(proj.id);
                    if (context === 'modal') {
                        openLoadProjectModal();
                    } else {
                        loadProjectsPage();
                    }
                } catch (err) {
                    showToast('Failed to duplicate: ' + err.message, 'error');
                }
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = '🗑️';
            deleteBtn.title = 'Delete';
            deleteBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const confirmed = await showConfirmModal({
                    title: 'Delete Project',
                    message: `Delete "${proj.name || 'this project'}"? This cannot be undone.`,
                    confirmText: 'Delete',
                    cancelText: 'Cancel',
                    danger: true
                });
                if (!confirmed) return;
                try {
                    await ProjectService.deleteProjects([proj.id]);
                    if (ProjectState.currentProjectId === proj.id) {
                        newProject();
                    }
                    if (context === 'modal') {
                        openLoadProjectModal();
                    } else {
                        loadProjectsPage();
                    }
                } catch (err) {
                    showToast('Failed to delete: ' + err.message, 'error');
                }
            });
            
            actions.appendChild(duplicateBtn);
            actions.appendChild(deleteBtn);
            
            item.appendChild(checkbox);
            item.appendChild(info);
            item.appendChild(actions);
            
            return item;
        }
        
        function formatProjectDate(dateStr) {
            if (!dateStr) return '';
            try {
                const d = new Date(dateStr);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } catch (e) { return ''; }
        }
        
        // Setup mass delete handlers for modal or page
        function setupMassDeleteHandlers(context = 'modal') {
            const prefix = context === 'modal' ? 'modal' : 'page';
            const selectAllCheckbox = document.getElementById(`${prefix}SelectAllCheckbox`);
            const deleteBtn = document.getElementById(`${prefix}DeleteSelectedBtn`);
            const containerSelector = context === 'modal' ? '#loadProjectListContainer' : '#projectsPageListContainer';
            
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.onchange = () => {
                    const checkboxes = document.querySelectorAll(`${containerSelector} .project-checkbox`);
                    checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
                    updateDeleteButtonState(context);
                };
            }
            
            if (deleteBtn) {
                deleteBtn.onclick = async () => {
                    const checkboxes = document.querySelectorAll(`${containerSelector} .project-checkbox:checked`);
                    if (checkboxes.length === 0) {
                        showToast('Please select at least one project to delete.', 'warning');
                        return;
                    }
                    
                    const confirmed = await showConfirmModal({
                        title: 'Delete Projects',
                        message: `Delete ${checkboxes.length} project(s)? This cannot be undone.`,
                        confirmText: 'Delete',
                        cancelText: 'Cancel',
                        danger: true
                    });
                    if (!confirmed) return;
                    
                    const ids = Array.from(checkboxes).map(cb => cb.dataset.projectId);
                    try {
                        const result = await ProjectService.deleteProjects(ids);
                        
                        // Clear current project if deleted
                        if (ids.includes(ProjectState.currentProjectId)) {
                            newProject();
                        }
                        
                        showToast(`${result.succeeded.length} project(s) deleted.`, 'success');
                        
                        if (context === 'modal') {
                            openLoadProjectModal();
                        } else {
                            loadProjectsPage();
                        }
                    } catch (err) {
                        showToast('Error deleting projects: ' + err.message, 'error');
                    }
                };
            }
        }
        
        function updateDeleteButtonState(context = 'modal') {
            const prefix = context === 'modal' ? 'modal' : 'page';
            const containerSelector = context === 'modal' ? '#loadProjectListContainer' : '#projectsPageListContainer';
            const deleteBtn = document.getElementById(`${prefix}DeleteSelectedBtn`);
            const checkboxes = document.querySelectorAll(`${containerSelector} .project-checkbox:checked`);
            
            if (deleteBtn) {
                deleteBtn.disabled = checkboxes.length === 0;
            }
        }
        
        // NOTE: loadProjectFromService is defined earlier in the file
        // See the section "LOAD PROJECT FROM SERVICE - Helper for navigation"
        
        // Legacy accessors for backward compatibility (gradually migrate away from these)
        let siteData = ProjectState.siteData;
        let entries = ProjectState.entries;
        let photos = ProjectState.photos;
        let editIndex = null;
        
        // ==================================================================================
        // AUTOSAVE SYSTEM - Periodic Local Storage Backup
        // ==================================================================================
        // Saves to "sitewalk_autosave" key every 15 seconds when there are unsaved changes
        // This is SEPARATE from the named project save system
        // Never overwrites server data - purely local backup for crash recovery
        
        const AUTOSAVE_KEY = 'sitewalk_autosave';
        const AUTOSAVE_INTERVAL_MS = 15000; // 15 seconds
        let autosaveTimerId = null;
        
        // Save lock/mutex to prevent duplicate project creation from concurrent saves
        let _saveInProgress = false;
        let _pendingProjectId = null;
        
        // Save current state to autosave storage
        function saveToAutosave() {
            if (!ProjectState.isDirty) {
                console.log('[autosave] Skipped - no unsaved changes');
                return;
            }
            
            try {
                const autosaveData = {
                    siteData: ProjectState.siteData,
                    entries: ProjectState.entries,
                    photos: ProjectState.photos,
                    currentProjectId: ProjectState.currentProjectId,
                    currentProjectName: ProjectState.currentProjectName,
                    project_id: ProjectState.project_id,
                    autosavedAt: new Date().toISOString()
                };
                
                localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(autosaveData));
                console.log('[autosave] Saved at', autosaveData.autosavedAt, '-', entries.length, 'entries,', photos.length, 'photos');
            } catch (e) {
                console.error('[autosave] Failed to save:', e);
            }
        }
        
        // Load autosave data from storage
        function loadFromAutosave() {
            try {
                const dataStr = localStorage.getItem(AUTOSAVE_KEY);
                if (!dataStr) return null;
                return JSON.parse(dataStr);
            } catch (e) {
                console.error('[autosave] Failed to load:', e);
                return null;
            }
        }
        
        // Clear autosave from storage (local only)
        function clearAutosave() {
            try {
                localStorage.removeItem(AUTOSAVE_KEY);
                console.log('[autosave] Cleared local');
            } catch (e) {
                console.error('[autosave] Failed to clear:', e);
            }
        }
        
        // ==================================================================================
        // SERVER-SIDE AUTOSAVE - Project-Specific Server Backup
        // ==================================================================================
        // Saves to /api/projects/<project_id>/autosave when editing a named project
        // Allows recovery even when switching devices
        
        // Save autosave to server for current project
        async function saveAutosaveToServer() {
            const projectId = ProjectState.currentProjectId;
            if (!projectId) {
                return; // No project loaded, skip server autosave
            }
            
            if (!ProjectState.isDirty) {
                return; // No unsaved changes
            }
            
            try {
                const autosaveData = {
                    siteData: ProjectState.siteData,
                    entries: ProjectState.entries,
                    photos: ProjectState.photos,
                    autosavedAt: new Date().toISOString()
                };
                
                const response = await fetch(`/api/projects/${projectId}/autosave`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(autosaveData)
                });
                
                if (response.ok) {
                    console.log('[autosave] Saved to server for project', projectId);
                } else {
                    console.warn('[autosave] Server save failed:', response.status);
                }
            } catch (e) {
                console.warn('[autosave] Server save error:', e.message);
            }
        }
        
        // Fetch autosave from server for a specific project
        async function fetchAutosaveFromServer(projectId) {
            try {
                const response = await fetch(`/api/projects/${projectId}/autosave`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.autosavedAt) {
                        return data;
                    }
                }
                return null;
            } catch (e) {
                console.warn('[autosave] Server fetch error:', e.message);
                return null;
            }
        }
        
        // Clear autosave from server for a specific project
        async function clearAutosaveFromServer(projectId) {
            if (!projectId) return;
            
            try {
                const response = await fetch(`/api/projects/${projectId}/autosave`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    console.log('[autosave] Cleared from server for project', projectId);
                }
            } catch (e) {
                console.warn('[autosave] Server clear error:', e.message);
            }
        }
        
        // Check if server autosave is newer than project's last save
        async function checkServerAutosaveNewer(projectId, projectUpdatedAt) {
            const serverAutosave = await fetchAutosaveFromServer(projectId);
            if (!serverAutosave || !serverAutosave.autosavedAt) {
                return null;
            }
            
            const autosaveTime = new Date(serverAutosave.autosavedAt).getTime();
            const projectTime = projectUpdatedAt ? new Date(projectUpdatedAt).getTime() : 0;
            
            // Only return autosave if it's newer than the last manual save
            if (autosaveTime > projectTime) {
                return serverAutosave;
            }
            return null;
        }
        
        // Start the autosave timer (saves to both localStorage and server)
        function startAutosaveTimer() {
            if (autosaveTimerId) {
                clearInterval(autosaveTimerId);
            }
            autosaveTimerId = setInterval(() => {
                saveToAutosave();
                saveAutosaveToServer(); // Also save to server if project is loaded
            }, AUTOSAVE_INTERVAL_MS);
            console.log('[autosave] Timer started (every', AUTOSAVE_INTERVAL_MS / 1000, 'seconds)');
        }
        
        // Stop the autosave timer
        function stopAutosaveTimer() {
            if (autosaveTimerId) {
                clearInterval(autosaveTimerId);
                autosaveTimerId = null;
                console.log('[autosave] Timer stopped');
            }
        }
        
        // ==================================================================================
        // SAVE CONTROLLER - Centralized Save Management
        // ==================================================================================
        // SaveController: Owns all save operations to prevent race conditions and duplicates
        // - Manages isSaving/pendingSave flags to prevent concurrent saves
        // - queueSave() provides debouncing to batch rapid save requests
        // - Logs all save operations for debugging
        const SaveController = {
            isSaving: false,
            pendingSave: null,
            saveHistory: [],
            debounceTimer: null,
            DEBOUNCE_MS: 2000,
            
            log: function(action, id, name, reason, httpMethod) {
                const entry = {
                    action: action,
                    id: id || 'no-id',
                    name: name || 'unnamed',
                    reason: reason || 'unknown',
                    httpMethod: httpMethod || (action === 'UPDATE' ? 'PUT' : (action === 'CREATE' ? 'POST' : 'n/a')),
                    timestamp: new Date().toISOString()
                };
                this.saveHistory.push(entry);
                if (this.saveHistory.length > 50) {
                    this.saveHistory.shift();
                }
                console.log(`[SaveController] ${action} (${entry.httpMethod}):`, entry);
                return entry;
            },
            
            queueSave: function(reason) {
                if (this.debounceTimer) {
                    clearTimeout(this.debounceTimer);
                }
                
                if (this.isSaving) {
                    this.pendingSave = reason;
                    console.log('[SaveController] Save in progress, queued for:', reason);
                    return;
                }
                
                this.debounceTimer = setTimeout(() => {
                    this.executeSave(reason);
                }, this.DEBOUNCE_MS);
            },
            
            executeSave: async function(reason) {
                // Check if this tab is the leader for autosave
                if (!TabLeaderLock.acquireLock()) {
                    console.log('[SaveController] Not leader tab, skipping autosave');
                    return;
                }
                
                if (this.isSaving) {
                    this.pendingSave = reason;
                    return;
                }
                
                this.isSaving = true;
                try {
                    await saveProject(reason);
                } catch (e) {
                    console.error('[SaveController] Save failed:', e);
                } finally {
                    this.isSaving = false;
                    
                    if (this.pendingSave) {
                        const nextReason = this.pendingSave;
                        this.pendingSave = null;
                        setTimeout(() => this.executeSave(nextReason), 500);
                    }
                }
            },
            
            getHistory: function() {
                return [...this.saveHistory];
            }
        };
        
        // ==================================================================================
        // CROSS-TAB LEADER LOCK - Prevents autosave storms from multiple tabs
        // ==================================================================================
        const TabLeaderLock = {
            LOCK_KEY: 'sitewalk_autosave_leader',
            LOCK_TTL_MS: 10000, // 10 second TTL
            tabId: Math.random().toString(36).substr(2, 9),
            isLeader: false,
            
            acquireLock: function() {
                try {
                    const now = Date.now();
                    const lockData = localStorage.getItem(this.LOCK_KEY);
                    
                    if (lockData) {
                        const lock = JSON.parse(lockData);
                        // Check if existing lock is expired or belongs to this tab
                        if (lock.expires > now && lock.tabId !== this.tabId) {
                            this.isLeader = false;
                            console.log('[TabLeader] Another tab is leader:', lock.tabId);
                            return false;
                        }
                    }
                    
                    // Acquire the lock
                    const newLock = {
                        tabId: this.tabId,
                        expires: now + this.LOCK_TTL_MS,
                        acquiredAt: new Date().toISOString()
                    };
                    localStorage.setItem(this.LOCK_KEY, JSON.stringify(newLock));
                    this.isLeader = true;
                    console.log('[TabLeader] This tab is now leader:', this.tabId);
                    return true;
                } catch (e) {
                    console.warn('[TabLeader] Lock error:', e);
                    return true; // Fail open - allow save if lock mechanism fails
                }
            },
            
            releaseLock: function() {
                try {
                    const lockData = localStorage.getItem(this.LOCK_KEY);
                    if (lockData) {
                        const lock = JSON.parse(lockData);
                        if (lock.tabId === this.tabId) {
                            localStorage.removeItem(this.LOCK_KEY);
                            this.isLeader = false;
                            console.log('[TabLeader] Released lock');
                        }
                    }
                } catch (e) {
                    console.warn('[TabLeader] Release error:', e);
                }
            },
            
            renewLock: function() {
                if (this.isLeader) {
                    this.acquireLock();
                }
            }
        };
        
        // Renew lock periodically
        setInterval(() => TabLeaderLock.renewLock(), 5000);
        
        // Release lock when tab closes
        window.addEventListener('beforeunload', () => TabLeaderLock.releaseLock());
        
        // Update leader indicator (shown in dev mode)
        function updateLeaderIndicator() {
            const indicator = document.getElementById('tabLeaderIndicator');
            if (indicator && window.location.hostname === 'localhost') {
                indicator.style.display = 'block';
                indicator.textContent = TabLeaderLock.isLeader ? 
                    `Tab ${TabLeaderLock.tabId} (Leader)` : 
                    `Tab ${TabLeaderLock.tabId} (Follower)`;
            }
        }
        setInterval(updateLeaderIndicator, 2000);
        
        // ==================================================================================
        // URL-BASED PROJECT ID PERSISTENCE
        // ==================================================================================
        // getProjectIdFromUrl: Read projectId from URL query parameter
        function getProjectIdFromUrl() {
            try {
                const params = new URLSearchParams(window.location.search);
                return params.get('projectId') || null;
            } catch (e) {
                console.warn('[URL] Failed to read projectId from URL:', e);
                return null;
            }
        }
        
        // updateUrlWithProjectId: Update URL with projectId parameter (without page reload)
        function updateUrlWithProjectId(projectId) {
            if (!projectId) return;
            try {
                const url = new URL(window.location.href);
                url.searchParams.set('projectId', projectId);
                window.history.replaceState({}, '', url.toString());
                localStorage.setItem('lastProjectId', projectId);
                console.log('[URL] Updated URL with projectId:', projectId);
            } catch (e) {
                console.warn('[URL] Failed to update URL:', e);
            }
        }
        
        // clearProjectIdFromUrl: Remove projectId from URL (for new projects)
        function clearProjectIdFromUrl() {
            try {
                const url = new URL(window.location.href);
                url.searchParams.delete('projectId');
                window.history.replaceState({}, '', url.toString());
                console.log('[URL] Cleared projectId from URL');
            } catch (e) {
                console.warn('[URL] Failed to clear URL:', e);
            }
        }
        
        // NOTE: loadProjectById is defined later in the file with full source/navigation support
        // See the definition near the initialization code that handles deep links
        
        // Format a timestamp for display
        function formatAutosaveTimestamp(isoString) {
            try {
                const date = new Date(isoString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                
                const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                if (diffMins < 1) {
                    return 'Just now';
                } else if (diffMins < 60) {
                    return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago (${timeStr})`;
                } else if (diffHours < 24 && date.getDate() === now.getDate()) {
                    return `Today at ${timeStr}`;
                } else {
                    return `${dateStr} at ${timeStr}`;
                }
            } catch (e) {
                return isoString;
            }
        }
        
        // Show the autosave restore modal
        function showAutosaveRestoreModal(autosaveData) {
            const modal = document.getElementById('autosaveRestoreModal');
            const timestampDiv = document.getElementById('autosaveTimestamp');
            const detailsDiv = document.getElementById('autosaveDetails');
            const restoreBtn = document.getElementById('autosaveRestoreBtn');
            const discardBtn = document.getElementById('autosaveDiscardBtn');
            
            if (!modal) return;
            
            // Format and display autosave info
            const customer = autosaveData.siteData?.customer || 'Unnamed project';
            const entryCount = (autosaveData.entries || []).length;
            const photoCount = (autosaveData.photos || []).length;
            const timestamp = formatAutosaveTimestamp(autosaveData.autosavedAt);
            
            timestampDiv.innerHTML = `<strong>Last saved:</strong> ${timestamp}`;
            
            let details = `<strong>Customer:</strong> ${customer}`;
            if (entryCount > 0 || photoCount > 0) {
                details += `<br><strong>Data:</strong> ${entryCount} equipment entries`;
                if (photoCount > 0) {
                    details += `, ${photoCount} photos`;
                }
            }
            detailsDiv.innerHTML = details;
            
            // Setup button handlers
            function onRestore() {
                restoreAutosaveData(autosaveData);
                modal.classList.add('hidden');
                cleanup();
            }
            
            function onDiscard() {
                clearAutosave();
                modal.classList.add('hidden');
                cleanup();
                // Continue with normal load behavior
                checkForInProgressWork();
            }
            
            function cleanup() {
                restoreBtn.removeEventListener('click', onRestore);
                discardBtn.removeEventListener('click', onDiscard);
            }
            
            restoreBtn.addEventListener('click', onRestore);
            discardBtn.addEventListener('click', onDiscard);
            
            // Show modal
            modal.classList.remove('hidden');
        }
        
        // Restore autosave data into the app
        function restoreAutosaveData(autosaveData) {
            console.log('[autosave] Restoring data...');
            
            // Restore project state
            // If currentProjectId exists (this was a saved project), use it as project_id
            // This ensures subsequent saves UPDATE the correct project instead of creating new
            ProjectState.project_id = autosaveData.currentProjectId || autosaveData.project_id || generateUUID();
            ProjectState.currentProjectId = autosaveData.currentProjectId || null;
            ProjectState.currentProjectName = autosaveData.currentProjectName || null;
            
            // Clear and repopulate siteData
            Object.keys(ProjectState.siteData).forEach(key => delete ProjectState.siteData[key]);
            Object.assign(ProjectState.siteData, autosaveData.siteData || {});
            
            // Clear and repopulate entries
            ProjectState.entries.length = 0;
            if (Array.isArray(autosaveData.entries)) {
                ProjectState.entries.push(...migrateEntries(autosaveData.entries));
            }
            
            // Clear and repopulate photos
            ProjectState.photos.length = 0;
            if (Array.isArray(autosaveData.photos)) {
                ProjectState.photos.push(...autosaveData.photos);
            }
            
            // Mark as dirty since this is restored unsaved work
            ProjectState.isDirty = true;
            
            // Populate UI
            if (siteData && Object.keys(siteData).length > 0) {
                document.getElementById('site-date').value = siteData.date || document.getElementById('site-date').value;
                document.getElementById('site-customer').value = siteData.customer || '';
                document.getElementById('site-street').value = siteData.street || '';
                document.getElementById('site-city').value = siteData.city || '';
                document.getElementById('site-state').value = siteData.state || 'CA';
                document.getElementById('site-zip').value = siteData.zip || '';
                document.getElementById('site-contact').value = siteData.contact || '';
                document.getElementById('site-phone').value = siteData.phone || '';
                applyUtilityToForm(siteData.utility);
            }
            
            // If there are units, skip to data section
            if (entries.length > 0) {
                if (siteData.visitDate) {
                    document.getElementById('visitDateText').textContent = siteData.visitDate;
                }
                
                // Update Site Address display
                const addressParts = [];
                if (siteData.street) addressParts.push(siteData.street);
                const cityStateZip = [siteData.city, siteData.state, siteData.zip].filter(v => v).join(', ');
                if (cityStateZip) addressParts.push(cityStateZip);
                const siteAddressText = document.getElementById('siteAddressText');
                if (siteAddressText) {
                    siteAddressText.textContent = addressParts.join(', ') || 'No address provided';
                }
                
                // Skip site entry and show data section
                siteSection.classList.add('hidden');
                dataSection.classList.remove('hidden');
                setSaveCustomerInfoVisible(false);
                
                // Show edit site pencil icon
                const editSiteBtn = document.getElementById('editSiteBtn');
                if (editSiteBtn) {
                    editSiteBtn.classList.remove('hidden');
                }
                
                // Update header customer name
                const customerNameEl = document.getElementById('customerName');
                if (customerNameEl && siteData.customer) {
                    customerNameEl.textContent = siteData.customer;
                }
                
                // Render entries (skip save since we just loaded)
                renderEntries(true);
            }
            
            // Update current project display
            updateCurrentProjectDisplay();
            
            // Hide resume banner if visible
            const resumeBanner = document.getElementById('resumeBanner');
            if (resumeBanner) {
                resumeBanner.classList.add('hidden');
            }
            
            console.log('[autosave] Restored:', entries.length, 'entries,', photos.length, 'photos');
        }
        
        // Check for autosave on page load
        function checkForAutosaveOnLoad() {
            const autosaveData = loadFromAutosave();
            
            if (!autosaveData) {
                console.log('[autosave] No autosave found');
                return false;
            }
            
            // Check if autosave has meaningful data
            const sd = autosaveData.siteData || {};
            const hasCustomerFields = [
                sd.customer,
                sd.street,
                sd.city,
                sd.contact,
                sd.phone
            ].some(v => v && String(v).trim() !== '');
            
            const hasEntries = (autosaveData.entries || []).length > 0;
            const hasPhotos = (autosaveData.photos || []).length > 0;
            
            if (!hasCustomerFields && !hasEntries && !hasPhotos) {
                console.log('[autosave] Autosave found but has no meaningful data, clearing');
                clearAutosave();
                return false;
            }
            
            // Check if autosave is recent (within last 7 days)
            const autosaveDate = new Date(autosaveData.autosavedAt);
            const daysSinceAutosave = (Date.now() - autosaveDate.getTime()) / (1000 * 60 * 60 * 24);
            
            if (daysSinceAutosave > 7) {
                console.log('[autosave] Autosave is older than 7 days, clearing');
                clearAutosave();
                return false;
            }
            
            // Show restore modal
            console.log('[autosave] Found valid autosave from', autosaveData.autosavedAt);
            showAutosaveRestoreModal(autosaveData);
            return true;
        }
        
        // ==================================================================================
        // PHOTO HANDLING SYSTEM
        // ==================================================================================
        
        // Store previous assignments for undo functionality
        let previousPhotoAssignments = null;
        
        // Currently attaching to which entry (for modal)
        let attachingToEntryId = null;
        let selectedPhotosForAttach = [];
        
        // Generate unique ID for photos
        function generatePhotoId() {
            return 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // ==================================================================================
        // ROOM KEY HELPERS - Convert between entry IDs and room keys
        // Room keys use format: "evap:0", "evap:1", "cond:0", etc.
        // ==================================================================================
        
        // Get room key from an entry (e.g., "evap:0" for the first evaporator)
        function getRoomKey(entry) {
            if (!entry || !entry.section) return null;
            const sectionEntries = entries.filter(e => e.section === entry.section);
            const idx = sectionEntries.findIndex(e => e.id === entry.id);
            if (idx === -1) return null;
            return `${entry.section}:${idx}`;
        }
        
        // Get entry from a room key (e.g., "evap:0" returns the first evaporator entry)
        function getEntryByRoomKey(roomKey) {
            if (!roomKey || typeof roomKey !== 'string') return null;
            const parts = roomKey.split(':');
            if (parts.length !== 2) return null;
            const section = parts[0];
            const idx = parseInt(parts[1], 10);
            if (isNaN(idx) || idx < 0) return null;
            const sectionEntries = entries.filter(e => e.section === section);
            return sectionEntries[idx] || null;
        }
        
        // Get all rooms in order (evaporators first, then condensers)
        function getAllRoomsInOrder() {
            const evaps = entries.filter(e => e.section === 'evap');
            const conds = entries.filter(e => e.section === 'cond');
            return [
                ...evaps.map((e, i) => ({ key: `evap:${i}`, type: 'evap', index: i, entry: e, name: e['room-name'] || e['room-roomname'] || `Evaporator ${i + 1}` })),
                ...conds.map((e, i) => ({ key: `cond:${i}`, type: 'cond', index: i, entry: e, name: e['room-name'] || e['room-roomname'] || `Condenser ${i + 1}` }))
            ];
        }
        
        // Get photos assigned to a specific room key
        function getPhotosForRoom(roomKey) {
            return photos.filter(p => p.assignedTo === roomKey);
        }
        
        // Remap photo assignments when entries are reordered
        // This ensures photos stay with their assigned room, not the position
        function remapPhotoAssignmentsOnReorder(section) {
            // Build a map of entry ID → current room key BEFORE the reorder was applied
            // But since we're called AFTER the reorder, we need to recalculate based on entry IDs
            
            // Get all entries in this section with their new indices
            const sectionEntries = entries.filter(e => e.section === section);
            
            // For each photo assigned to a room in this section, update to use entry ID lookup
            photos.forEach(photo => {
                if (photo.assignedTo && photo.assignedTo.startsWith(section + ':')) {
                    // This photo is assigned to a room in the reordered section
                    // We need to find which entry it's actually for
                    
                    // If the photo has a legacy _entryId field, use it; otherwise we need to be smart
                    if (photo._entryId) {
                        // Find the new room key for this entry ID
                        const entryIdx = sectionEntries.findIndex(e => e.id === photo._entryId);
                        if (entryIdx >= 0) {
                            photo.assignedTo = `${section}:${entryIdx}`;
                        }
                    }
                }
            });
        }
        
        // Store entry ID when assigning photos (for reorder remapping)
        function assignPhotoToRoom(photoId, roomKey) {
            const photo = photos.find(p => p.id === photoId);
            if (photo) {
                photo.assignedTo = roomKey;
                // Also store entry ID for reorder remapping
                const entry = getEntryByRoomKey(roomKey);
                if (entry) {
                    photo._entryId = entry.id;
                }
            }
        }
        
        // ==================================================================================
        // PHOTO MIGRATION - Migrate old photo format to new format
        // Old: { isSeparator, assignedRoomId, sequenceIndex, type, localUri }
        // New: { isStart, assignedTo, createdAt, url }
        // ==================================================================================
        
        function migratePhotosToNewFormat() {
            if (!photos || photos.length === 0) return;
            
            let migrated = false;
            
            photos.forEach(photo => {
                // Migrate isSeparator → isStart
                if (photo.isSeparator !== undefined && photo.isStart === undefined) {
                    photo.isStart = photo.isSeparator;
                    delete photo.isSeparator;
                    migrated = true;
                }
                
                // Migrate assignedRoomId (UUID) → assignedTo (room key)
                if (photo.assignedRoomId !== undefined && photo.assignedTo === undefined) {
                    if (photo.assignedRoomId === null) {
                        photo.assignedTo = null;
                    } else {
                        // Find the entry and get its room key
                        const entry = entries.find(e => e.id === photo.assignedRoomId);
                        if (entry) {
                            photo.assignedTo = getRoomKey(entry);
                            // Store entry ID for reorder remapping
                            photo._entryId = photo.assignedRoomId;
                        } else {
                            photo.assignedTo = null; // Entry not found, unassign
                        }
                    }
                    delete photo.assignedRoomId;
                    delete photo.type; // No longer needed, derived from assignedTo
                    migrated = true;
                }
                
                // Migrate localUri → url (keep localUri for backward compat)
                if (photo.localUri && !photo.url) {
                    photo.url = photo.localUri;
                    migrated = true;
                }
                
                // Ensure createdAt exists
                if (!photo.createdAt) {
                    photo.createdAt = Date.now();
                    migrated = true;
                }
                
                // Ensure isStart has a default value
                if (photo.isStart === undefined) {
                    photo.isStart = false;
                    migrated = true;
                }
                
                // Remove deprecated sequenceIndex (now use createdAt for ordering)
                if (photo.sequenceIndex !== undefined) {
                    delete photo.sequenceIndex;
                    migrated = true;
                }
            });
            
            if (migrated) {
                console.log('[photos] Migrated photos to new format');
            }
        }
        
        // Create thumbnail from file using canvas (max 200px)
        function createThumbnail(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const maxSize = 200;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const thumbUri = canvas.toDataURL('image/jpeg', 0.7);
                    callback(thumbUri, e.target.result);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // Handle adding multiple photos to the unassigned pool
        function handleAddPhotos(files) {
            if (!files || files.length === 0) return;
            
            // Convert to array and filter for images only
            const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
            if (imageFiles.length === 0) return;
            
            // Sort files by lastModified to preserve capture order from library
            // This gives us chronological order based on when photos were taken
            imageFiles.sort((a, b) => (a.lastModified || 0) - (b.lastModified || 0));
            
            let processed = 0;
            const total = imageFiles.length;
            
            // Process files in picker order, using lastModified for createdAt
            imageFiles.forEach((file, fileIndex) => {
                createThumbnail(file, (thumbUri, localUri) => {
                    const photo = {
                        id: generatePhotoId(),
                        url: localUri,           // New field name
                        localUri: localUri,      // Keep for backward compat
                        thumbUri: thumbUri,
                        filename: file.name,
                        createdAt: file.lastModified || Date.now(),
                        isStart: false,          // New field name (was isSeparator)
                        assignedTo: null         // New field name (was assignedRoomId)
                    };
                    
                    photos.push(photo);
                    processed++;
                    ProjectState.markDirty();
                    
                    if (processed >= total) {
                        renderPhotoPool();
                        SaveController.queueSave('photo-pool-add');
                    }
                });
            });
        }
        
        // Handle adding photos directly to a specific room (not to the pool)
        function handleAddPhotosToRoom(files, roomKey) {
            if (!files || files.length === 0) return;
            
            // Convert to array and filter for images only
            const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
            if (imageFiles.length === 0) return;
            
            // Sort files by lastModified to preserve capture order from library
            imageFiles.sort((a, b) => (a.lastModified || 0) - (b.lastModified || 0));
            
            let processed = 0;
            const total = imageFiles.length;
            
            // Process files in order
            imageFiles.forEach((file, fileIndex) => {
                createThumbnail(file, (thumbUri, localUri) => {
                    // Get entry ID for reorder remapping
                    const entry = getEntryByRoomKey(roomKey);
                    
                    const photo = {
                        id: generatePhotoId(),
                        url: localUri,           // New field name
                        localUri: localUri,      // Keep for backward compat
                        thumbUri: thumbUri,
                        filename: file.name,
                        createdAt: file.lastModified || Date.now(),
                        isStart: false,          // New field name
                        assignedTo: roomKey,     // Room key like "evap:0" or "cond:1"
                        _entryId: entry ? entry.id : null  // Store entry ID for reorder remapping
                    };
                    
                    photos.push(photo);
                    processed++;
                    ProjectState.markDirty();
                    
                    if (processed >= total) {
                        renderPhotoPool();
                        renderEntries(true);  // Re-render entries to show new photos
                        SaveController.queueSave('photo-add-to-room');
                    }
                });
            });
        }
        
        // Render unassigned photos in the photo pool grid
        function renderPhotoPool() {
            const photoGrid = document.getElementById('photoGrid');
            if (!photoGrid) return;
            
            // Filter for unassigned photos (assignedTo is null or undefined)
            const unassignedPhotos = photos.filter(p => !p.assignedTo);
            
            if (unassignedPhotos.length === 0) {
                photoGrid.innerHTML = '<p style="color:#999;font-style:italic;text-align:center;grid-column:1/-1;">No photos yet. Click "Add Photos" to get started.</p>';
                return;
            }
            
            // Sort by createdAt ASC to maintain chronological order
            unassignedPhotos.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
            
            photoGrid.innerHTML = '';
            
            unassignedPhotos.forEach((photo, idx) => {
                const tile = document.createElement('div');
                tile.className = 'photo-tile' + (photo.isStart ? ' separator' : '');
                tile.setAttribute('data-photo-id', photo.id);
                
                const img = document.createElement('img');
                img.className = 'photo-thumb';
                img.src = photo.thumbUri || photo.url || photo.localUri;
                img.alt = 'Photo ' + (idx + 1);
                img.loading = 'lazy';
                tile.appendChild(img);
                
                if (photo.isStart) {
                    const badge = document.createElement('div');
                    badge.className = 'photo-separator-badge';
                    badge.textContent = 'START';
                    tile.appendChild(badge);
                }
                
                const actions = document.createElement('div');
                actions.className = 'photo-actions';
                
                const sepBtn = document.createElement('button');
                sepBtn.className = 'separator-btn' + (photo.isStart ? ' active' : '');
                sepBtn.textContent = photo.isStart ? '★ Start' : '☆ Start';
                sepBtn.title = 'Mark as Room Start';
                sepBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleIsStart(photo.id);
                });
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = '✕';
                removeBtn.title = 'Delete photo';
                removeBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const confirmed = await showConfirmModal({
                        title: 'Delete Photo',
                        message: 'Delete this photo?',
                        confirmText: 'Delete',
                        cancelText: 'Cancel',
                        danger: true
                    });
                    if (confirmed) {
                        const idx = photos.findIndex(p => p.id === photo.id);
                        if (idx !== -1) {
                            photos.splice(idx, 1);
                            renderPhotoPool();
                            SaveController.queueSave('photo-delete');
                        }
                    }
                });
                
                actions.appendChild(sepBtn);
                actions.appendChild(removeBtn);
                tile.appendChild(actions);
                
                photoGrid.appendChild(tile);
            });
        }
        
        // Toggle isStart flag on a photo (marks beginning of a room's photos)
        function toggleIsStart(photoId) {
            const photo = photos.find(p => p.id === photoId);
            if (photo) {
                photo.isStart = !photo.isStart;
                ProjectState.markDirty();
                renderPhotoPool();
                SaveController.queueSave('photo-toggle-start');
            }
        }
        
        // Attach photo to a room using room key (e.g., "evap:0", "cond:1")
        function attachPhotoToRoom(photoId, roomKey) {
            const photo = photos.find(p => p.id === photoId);
            if (photo) {
                photo.assignedTo = roomKey;
                // Store entry ID for reorder remapping
                const entry = getEntryByRoomKey(roomKey);
                if (entry) {
                    photo._entryId = entry.id;
                }
                ProjectState.markDirty();
                renderPhotoPool();
                renderEntries();
                SaveController.queueSave('photo-attach');
            }
        }
        
        // Remove photo from room (back to pool)
        // skipFullRender: if true, only update photo pool (caller handles card update)
        function removePhotoFromRoom(photoId, skipFullRender = false) {
            const photo = photos.find(p => p.id === photoId);
            if (photo) {
                photo.assignedTo = null;
                photo._entryId = null;
                ProjectState.markDirty();
                renderPhotoPool();
                if (!skipFullRender) {
                    renderEntries();
                }
                SaveController.queueSave('photo-remove-from-room');
            }
        }
        
        // Get photos assigned to a specific entry (legacy compatibility wrapper)
        function getPhotosForEntry(entryId) {
            // Find the entry and get its room key
            const entry = entries.find(e => e.id === entryId);
            if (!entry) return [];
            const roomKey = getRoomKey(entry);
            if (!roomKey) return [];
            return getPhotosForRoom(roomKey);
        }
        
        // Open attach modal for an entry (using room key)
        function openAttachModal(entryId) {
            attachingToEntryId = entryId;
            selectedPhotosForAttach = [];
            
            const modal = document.getElementById('photoAttachModal');
            const grid = document.getElementById('photoAttachGrid');
            
            if (!modal || !grid) return;
            
            // Filter for unassigned photos
            const unassignedPhotos = photos.filter(p => !p.assignedTo);
            
            if (unassignedPhotos.length === 0) {
                grid.innerHTML = '<p style="color:#999;font-style:italic;text-align:center;grid-column:1/-1;">No unassigned photos available. Add photos first.</p>';
            } else {
                grid.innerHTML = '';
                // Sort by createdAt ASC for chronological order
                unassignedPhotos.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
                
                unassignedPhotos.forEach(photo => {
                    const item = document.createElement('div');
                    item.className = 'photo-attach-item';
                    item.setAttribute('data-photo-id', photo.id);
                    
                    const img = document.createElement('img');
                    img.src = photo.thumbUri || photo.url || photo.localUri;
                    img.loading = 'lazy';
                    item.appendChild(img);
                    
                    item.addEventListener('click', () => {
                        item.classList.toggle('selected');
                        const idx = selectedPhotosForAttach.indexOf(photo.id);
                        if (idx === -1) {
                            selectedPhotosForAttach.push(photo.id);
                        } else {
                            selectedPhotosForAttach.splice(idx, 1);
                        }
                    });
                    
                    grid.appendChild(item);
                });
            }
            
            modal.classList.add('show');
        }
        
        // Close attach modal
        function closeAttachModal() {
            const modal = document.getElementById('photoAttachModal');
            if (modal) {
                modal.classList.remove('show');
            }
            attachingToEntryId = null;
            selectedPhotosForAttach = [];
        }
        
        // Confirm attaching selected photos (uses room key)
        // Includes duplicate assignment protection - same photo can't be attached twice to same room
        function confirmAttachPhotos() {
            if (!attachingToEntryId || selectedPhotosForAttach.length === 0) {
                closeAttachModal();
                return;
            }
            
            // Get the room key from the entry
            const entry = entries.find(e => e.id === attachingToEntryId);
            const roomKey = entry ? getRoomKey(entry) : null;
            
            if (!roomKey) {
                console.warn('[photos] Could not determine room key for entry:', attachingToEntryId);
                closeAttachModal();
                return;
            }
            
            // Get the entry for storing entry ID
            const entryForId = entry;
            
            // Track assignment results for logging
            let assignedCount = 0;
            let skippedDuplicates = 0;
            
            selectedPhotosForAttach.forEach(photoId => {
                const photo = photos.find(p => p.id === photoId);
                if (photo) {
                    // Duplicate assignment protection: skip if already assigned to this room
                    if (photo.assignedTo === roomKey) {
                        console.log(`[photos] Skipping duplicate: photo ${photo.id.substring(0,8)} already assigned to ${roomKey}`);
                        skippedDuplicates++;
                        return;
                    }
                    
                    photo.assignedTo = roomKey;
                    // Store entry ID for reorder remapping
                    if (entryForId) {
                        photo._entryId = entryForId.id;
                    }
                    assignedCount++;
                }
            });
            
            if (skippedDuplicates > 0) {
                console.log(`[photos] Attach complete: ${assignedCount} assigned, ${skippedDuplicates} duplicates skipped`);
            }
            
            closeAttachModal();
            renderPhotoPool();
            renderEntries();
            SaveController.queueSave('photo-attach-confirm');
        }
        
        // Upload photos to Dropbox using batch endpoint
        // Uploads in smaller batches to avoid request size limits
        // Includes duplicate upload protection - tracks uploaded photos per session
        async function uploadPhotosToDropbox(photosToUpload, company, utility, streetAddress, visitDate) {
            if (!photosToUpload || photosToUpload.length === 0) {
                console.log("[photos] No photos to upload");
                return { ok: true, uploaded: [], failed: [], message: "No photos to upload", skipped: 0 };
            }
            
            setDropboxStatus(`Uploading ${photosToUpload.length} photos to Dropbox…`, false);
            
            try {
                // Sort photos by createdAt to preserve chronological order
                const sortedPhotos = [...photosToUpload].sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
                
                // Track per-room sequence numbers for filename prefixes
                const roomSequence = {};
                
                // Build photo data for batch upload (with duplicate upload protection)
                const allPhotoData = [];
                let skippedDuplicates = 0;
                
                for (const photo of sortedPhotos) {
                    // Create unique upload key: photo.id + room assignment
                    // This allows re-uploading if photo is reassigned to different room
                    const uploadKey = `${photo.id}:${photo.assignedTo || 'unassigned'}`;
                    
                    // Skip if already uploaded in this session (duplicate upload protection)
                    if (ProjectState.uploadedPhotoIds.has(uploadKey)) {
                        console.log(`[photos] Skipping already uploaded: ${photo.id.substring(0,8)} → ${photo.assignedTo || 'unassigned'}`);
                        skippedDuplicates++;
                        continue;
                    }
                    
                    // Get the photo data URI - check multiple possible fields
                    const photoDataUri = photo.url || photo.localUri;
                    if (!photoDataUri) {
                        console.warn("[photos] Photo has no data URI:", photo.id);
                        continue;
                    }
                    
                    // Get the room name if assigned (using new assignedTo room key)
                    let roomName = null;
                    let section = null;
                    
                    if (photo.assignedTo) {
                        const entry = getEntryByRoomKey(photo.assignedTo);
                        if (entry) {
                            roomName = entry['room-name'] || entry['room-roomname'] || `Room_${photo.assignedTo}`;
                            section = entry.section;
                        }
                    }
                    
                    // Determine sequence number for this room/unassigned group
                    const seqKey = photo.assignedTo || 'unassigned';
                    if (!roomSequence[seqKey]) {
                        roomSequence[seqKey] = 0;
                    }
                    roomSequence[seqKey]++;
                    const seqNum = roomSequence[seqKey];
                    
                    // Generate filename with sequence prefix for ordering
                    const timestamp = new Date(photo.createdAt || Date.now());
                    const ts = timestamp.toISOString().replace(/[:-]/g, '').replace('T', '_').split('.')[0];
                    const ext = photo.filename ? photo.filename.split('.').pop() : 'jpg';
                    // Prefix with 3-digit sequence number for alphabetical ordering
                    const seqPrefix = String(seqNum).padStart(3, '0');
                    const filename = `${seqPrefix}_photo_${ts}.${ext}`;
                    
                    allPhotoData.push({
                        id: photo.id,
                        uploadKey: uploadKey,  // Track for marking as uploaded after success
                        data: photoDataUri,  // Use url or localUri (whichever exists)
                        filename: filename,
                        room_name: roomName,
                        section: section
                    });
                }
                
                if (skippedDuplicates > 0) {
                    console.log(`[photos] Skipped ${skippedDuplicates} already-uploaded photos`);
                }
                
                if (allPhotoData.length === 0) {
                    if (skippedDuplicates > 0) {
                        console.log(`[photos] All ${skippedDuplicates} photos already uploaded in this session`);
                        setDropboxStatus(`Photos already uploaded (${skippedDuplicates} skipped)`, false);
                        return { ok: true, uploaded: [], failed: [], skipped: skippedDuplicates, message: "All photos already uploaded" };
                    }
                    console.log("[photos] No valid photos to upload");
                    return { ok: true, uploaded: [], failed: [], skipped: 0, message: "No valid photos" };
                }
                
                // Upload photos one at a time to avoid request size limits on mobile
                const allResults = { ok: true, uploaded: [], failed: [], skipped: skippedDuplicates };
                
                for (let i = 0; i < allPhotoData.length; i++) {
                    const photo = allPhotoData[i];
                    const photoNum = i + 1;
                    
                    setDropboxStatus(`Uploading photo ${photoNum}/${allPhotoData.length}…`, false);
                    
                    try {
                        const photoSizeKB = Math.round((photo.data?.length || 0) / 1024);
                        console.log(`[photos] Uploading photo ${photoNum}/${allPhotoData.length} (${photo.filename}, ~${photoSizeKB}KB)`);
                        
                        const response = await fetch('/upload-photos-batch', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                company: company,
                                utility: utility,
                                street_address: streetAddress,
                                visit_date: visitDate,
                                photos: [photo]  // Send one photo at a time
                            })
                        });
                        
                        if (!response.ok) {
                            console.error(`[photos] Photo ${photoNum} HTTP error:`, response.status, response.statusText);
                            const errorText = await response.text();
                            console.error(`[photos] Error body:`, errorText.substring(0, 500));
                            allResults.failed.push({ filename: photo.filename, error: `HTTP ${response.status}` });
                            allResults.ok = false;
                            continue;
                        }
                        
                        const result = await response.json();
                        console.log(`[photos] Photo ${photoNum}/${allPhotoData.length} result:`, result.ok ? 'OK' : 'FAILED');
                        
                        if (result.uploaded && result.uploaded.length > 0) {
                            allResults.uploaded.push(...result.uploaded);
                            // Mark this photo as uploaded in session tracker (duplicate upload protection)
                            ProjectState.uploadedPhotoIds.add(photo.uploadKey);
                            console.log(`[photos] Marked as uploaded: ${photo.uploadKey}`);
                        }
                        if (result.failed && result.failed.length > 0) {
                            allResults.failed.push(...result.failed);
                        }
                        if (!result.ok) {
                            allResults.ok = false;
                        }
                    } catch (photoError) {
                        console.error(`[photos] Photo ${photoNum} failed:`, photoError);
                        allResults.failed.push({ filename: photo.filename, error: photoError.message });
                        allResults.ok = false;
                    }
                }
                
                console.log("[photos] All batches complete:", allResults);
                
                if (allResults.ok && allResults.failed.length === 0) {
                    const skippedMsg = allResults.skipped > 0 ? `, ${allResults.skipped} skipped` : '';
                    setDropboxStatus(`Photos uploaded (${allResults.uploaded.length}${skippedMsg})`, false);
                } else if (allResults.uploaded.length > 0) {
                    setDropboxStatus(`Photos partially uploaded (${allResults.uploaded.length}/${allPhotoData.length})`, true);
                } else {
                    setDropboxStatus("Photo upload failed", true);
                }
                
                return allResults;
            } catch (error) {
                console.error("[photos] Photo upload error:", error);
                setDropboxStatus("Photo upload failed", true);
                throw error;
            }
        }
        
        // Auto-assign photos to rooms based on START markers
        // Works with evaporators first, then condensers
        // Implements deduplication: treats room photos as a set keyed by photo.id
        function autoAssignPhotos() {
            // Get all rooms in order (evaps first, then condensers)
            const rooms = getAllRoomsInOrder();
            
            console.log('[auto-assign] Rooms in order:', rooms.map(r => `${r.key}: ${r.name}`));
            
            if (rooms.length === 0) {
                showToast('No rooms found. Add evaporator or condenser rooms before auto-assigning photos.', 'warning');
                return;
            }
            
            // Get unassigned photos only (must be truly unassigned - null, undefined, or empty string)
            const pool = photos.filter(p => !p.assignedTo || p.assignedTo === '');
            console.log('[auto-assign] Total photos:', photos.length, '| Unassigned pool:', pool.length);
            
            if (pool.length === 0) {
                showToast('No unassigned photos to auto-assign.', 'warning');
                return;
            }
            
            // Sort pool by createdAt ASC (chronological order)
            pool.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
            
            // Log first few photos with their timestamps for debugging
            console.log('[auto-assign] Pool sorted by createdAt:', pool.slice(0, 5).map(p => ({
                id: p.id.substring(0, 10),
                isStart: p.isStart,
                createdAt: new Date(p.createdAt).toISOString()
            })));
            
            // Build segments using START markers as boundaries
            // Each segment starts at a START photo and continues until the next START or end
            const segments = [];
            let currentSegment = [];
            
            for (const photo of pool) {
                if (photo.isStart && currentSegment.length > 0) {
                    // Push current segment and start a new one
                    console.log(`[auto-assign] Segment ${segments.length + 1} complete: ${currentSegment.length} photos`);
                    segments.push({ photos: currentSegment });
                    currentSegment = [];
                }
                currentSegment.push(photo);
            }
            // Push final segment
            if (currentSegment.length > 0) {
                console.log(`[auto-assign] Segment ${segments.length + 1} complete: ${currentSegment.length} photos`);
                segments.push({ photos: currentSegment });
            }
            
            // Log all segments
            console.log('[auto-assign] Built segments:', segments.map((s, i) => `Seg${i+1}: ${s.photos.length} photos`).join(', '));
            
            if (segments.length === 0) {
                showToast('No photos to assign.', 'warning');
                return;
            }
            
            // Check if first photo is marked as START
            if (!pool[0].isStart) {
                showToast('First photo should be marked as "★ Start" for proper auto-assignment.', 'warning');
                return;
            }
            
            // Store previous assignments for undo
            previousPhotoAssignments = photos.map(p => ({
                id: p.id,
                assignedTo: p.assignedTo,
                _entryId: p._entryId
            }));
            
            // Track which photo IDs have been assigned in this run (deduplication)
            const assignedPhotoIds = new Set();
            
            // Map segments to rooms
            const summary = [];
            let extraSegments = 0;
            
            console.log('[auto-assign] === ASSIGNING SEGMENTS TO ROOMS ===');
            
            for (let i = 0; i < segments.length; i++) {
                if (i >= rooms.length) {
                    // More segments than rooms - these photos stay unassigned
                    console.log(`[auto-assign] Segment ${i+1} (${segments[i].photos.length} photos) - NO ROOM AVAILABLE, stays unassigned`);
                    extraSegments++;
                    continue;
                }
                
                const room = rooms[i];
                const segment = segments[i];
                let assignedCount = 0;
                let skippedCount = 0;
                
                console.log(`[auto-assign] Segment ${i+1} (${segment.photos.length} photos) → Room: "${room.name}" (${room.key})`);
                
                // Assign all photos in this segment to this room (with deduplication)
                segment.photos.forEach(photo => {
                    // Skip if this photo was already assigned in this run
                    if (assignedPhotoIds.has(photo.id)) {
                        console.warn('[auto-assign] Skipping duplicate photo:', photo.id);
                        skippedCount++;
                        return;
                    }
                    
                    photo.assignedTo = room.key;
                    photo._entryId = room.entry.id;
                    assignedPhotoIds.add(photo.id);
                    assignedCount++;
                });
                
                if (skippedCount > 0) {
                    console.log(`[auto-assign]   → Assigned ${assignedCount}, skipped ${skippedCount} duplicates`);
                }
                
                summary.push({
                    roomKey: room.key,
                    roomName: room.name,
                    roomType: room.type,
                    photoCount: assignedCount
                });
            }
            
            // Show summary modal
            showAutoAssignSummary(summary, extraSegments);
            
            renderPhotoPool();
            renderEntries();
            SaveController.queueSave('photo-auto-assign');
        }
        
        // Show auto-assign summary modal
        function showAutoAssignSummary(summary, extraSegments = 0) {
            const modal = document.getElementById('autoAssignModal');
            const summaryDiv = document.getElementById('autoAssignSummary');
            
            if (!modal || !summaryDiv) return;
            
            if (summary.length === 0) {
                summaryDiv.innerHTML = '<p>No photos were assigned.</p>';
            } else {
                let html = '';
                summary.forEach(item => {
                    const typeLabel = item.roomType === 'evap' ? '❄️' : '🔥';
                    html += `<div class="auto-assign-summary-item">
                        ${typeLabel} <strong>${item.roomName}</strong>: ${item.photoCount} photo${item.photoCount !== 1 ? 's' : ''} assigned
                    </div>`;
                });
                
                // Show note about extra segments if any
                if (extraSegments > 0) {
                    html += `<div class="auto-assign-summary-note" style="margin-top:12px;padding:8px;background:#fff3cd;border-radius:4px;font-size:13px;">
                        Note: ${extraSegments} extra photo group${extraSegments !== 1 ? 's' : ''} left unassigned (not enough rooms).
                    </div>`;
                }
                
                summaryDiv.innerHTML = html;
            }
            
            modal.classList.add('show');
        }
        
        // Undo auto-assign
        function undoAutoAssign() {
            if (!previousPhotoAssignments) {
                showToast('Nothing to undo.', 'info');
                return;
            }
            
            previousPhotoAssignments.forEach(prev => {
                const photo = photos.find(p => p.id === prev.id);
                if (photo) {
                    photo.assignedTo = prev.assignedTo;
                }
            });
            
            previousPhotoAssignments = null;
            
            closeAutoAssignModal();
            renderPhotoPool();
            renderEntries();
            SaveController.queueSave('photo-undo-auto-assign');
        }
        
        // Close auto-assign modal
        function closeAutoAssignModal() {
            const modal = document.getElementById('autoAssignModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }
        
        // Setup photo event listeners
        function setupPhotoEventListeners() {
            // Photos nav button handler is now attached to photosNavBtnBottom in the main initialization
            // This function handles other photo-related listeners
            
            // Add photos button (Choose from Library - no capture, opens iOS picker)
            const addPhotosBtn = document.getElementById('addPhotosBtn');
            const photoFileInput = document.getElementById('photoFileInput');
            
            if (addPhotosBtn && photoFileInput) {
                addPhotosBtn.addEventListener('click', () => {
                    photoFileInput.click();
                });
                
                photoFileInput.addEventListener('change', (e) => {
                    handleAddPhotos(e.target.files);
                    e.target.value = ''; // Reset for re-selection
                });
            }
            
            // Take photo button (with capture - opens camera directly)
            const takePhotoBtn = document.getElementById('takePhotoBtn');
            const cameraPhotoInput = document.getElementById('cameraPhotoInput');
            
            if (takePhotoBtn && cameraPhotoInput) {
                takePhotoBtn.addEventListener('click', () => {
                    cameraPhotoInput.click();
                });
                
                cameraPhotoInput.addEventListener('change', (e) => {
                    handleAddPhotos(e.target.files);
                    e.target.value = ''; // Reset for re-selection
                });
            }
            
            // Auto-assign button
            const autoAssignBtn = document.getElementById('autoAssignPhotosBtn');
            if (autoAssignBtn) {
                autoAssignBtn.addEventListener('click', autoAssignPhotos);
            }
            
            // Attach modal buttons
            const attachModalClose = document.querySelector('.photo-attach-modal-close');
            const attachCancelBtn = document.getElementById('photoAttachCancelBtn');
            const attachConfirmBtn = document.getElementById('photoAttachConfirmBtn');
            
            if (attachModalClose) {
                attachModalClose.addEventListener('click', closeAttachModal);
            }
            if (attachCancelBtn) {
                attachCancelBtn.addEventListener('click', closeAttachModal);
            }
            if (attachConfirmBtn) {
                attachConfirmBtn.addEventListener('click', confirmAttachPhotos);
            }
            
            // Auto-assign modal buttons
            const autoAssignUndoBtn = document.getElementById('autoAssignUndoBtn');
            const autoAssignCloseBtn = document.getElementById('autoAssignCloseBtn');
            
            if (autoAssignUndoBtn) {
                autoAssignUndoBtn.addEventListener('click', undoAutoAssign);
            }
            if (autoAssignCloseBtn) {
                autoAssignCloseBtn.addEventListener('click', closeAutoAssignModal);
            }
            
            // Click outside to close modals
            const photoAttachModal = document.getElementById('photoAttachModal');
            const autoAssignModal = document.getElementById('autoAssignModal');
            
            if (photoAttachModal) {
                photoAttachModal.addEventListener('click', (e) => {
                    if (e.target === photoAttachModal) {
                        closeAttachModal();
                    }
                });
            }
            
            if (autoAssignModal) {
                autoAssignModal.addEventListener('click', (e) => {
                    if (e.target === autoAssignModal) {
                        closeAutoAssignModal();
                    }
                });
            }
        }
        
        // Initialize photo system when DOM is ready
        setTimeout(setupPhotoEventListeners, 100);

        // Flags to enable reorder mode for each section
        let reorderEvap = false;
        let reorderCond = false;
        
        // Track last edited field for better UX when reopening edit form
        let lastEditedFieldId = null;
        
        // Helper function to get count from entry (backwards compatible with old 'count' field)
        function getEntryCount(entry) {
            // Try new field name first, fallback to old field name for backwards compatibility
            return parseInt(entry['room-count'] || entry['count']) || 0;
        }
        
        // Migrate old entry data to new format (count -> room-count)
        // Also cleanup legacy Motor HP labels: "1 HP" → "1.0 HP", "2 HP" → "2.2 HP"
        function migrateEntry(entry) {
            if (!entry) return entry;
            // Ensure every entry has a unique ID for photo assignment tracking
            if (!entry.id) {
                entry.id = generateUUID();
            }
            // If entry has old 'count' field but not new 'room-count', migrate it
            if (entry['count'] !== undefined && entry['room-count'] === undefined) {
                entry['room-count'] = entry['count'];
                delete entry['count']; // Remove old field
            }
            // Legacy Motor HP label cleanup: snap old labels to dropdown options
            // Only applies to exact legacy labels - do NOT modify any other HP values
            const hp = entry['room-hp'];
            if (hp) {
                const hpNorm = String(hp).trim().toLowerCase();
                if (hpNorm === '1 hp' || hpNorm === '1hp' || hpNorm === '1') {
                    entry['room-hp'] = '1.0 HP';
                } else if (hpNorm === '2 hp' || hpNorm === '2hp' || hpNorm === '2') {
                    entry['room-hp'] = '2.2 HP';
                }
            }
            // Run Time / Operation Time Factor migration:
            // Old data may be stored as fractions (0-1 or 0-2). Convert to 0-100 percent.
            // If value <= 2, assume it's a fraction and multiply by 100.
            // If value > 2, assume it's already in percent.
            // Also strip any % suffix and store as pure number.
            const runTime = entry['room-runTime'];
            if (runTime !== undefined && runTime !== null && runTime !== '') {
                let numVal = parseFloat(String(runTime).replace('%', '').trim());
                if (!isNaN(numVal) && numVal >= 0) {
                    // Detect old fraction format (0-2 range) and convert to percent
                    if (numVal > 0 && numVal <= 2) {
                        numVal = numVal * 100;
                    }
                    // Clamp to 0-100 range and store as whole number
                    numVal = Math.min(100, Math.max(0, numVal));
                    entry['room-runTime'] = String(Math.round(numVal));
                } else {
                    // Invalid value, default to 100
                    entry['room-runTime'] = '100';
                }
            }
            return entry;
        }
        
        // Migrate array of entries
        function migrateEntries(entriesArray) {
            if (!Array.isArray(entriesArray)) return entriesArray;
            return entriesArray.map(migrateEntry);
        }

        // ==================================================================================
        // LOCALSTORAGE AUTOSAVE - Single Device Persistence
        // ==================================================================================
        // saveProject(): Saves current work-in-progress to localStorage under "currentProject" key
        // This provides bulletproof single-device persistence - if browser crashes, work is recovered
        // 
        // COMPLETE SNAPSHOT: Always writes { project_id, siteData, entries, lastSavedAt }
        // - project_id: Stable UUID that survives save/load cycles
        // - siteData: Customer info, address, contact details
        // - entries: Array of all equipment entries (evaporators + condensers)
        // - lastSavedAt: ISO timestamp for debugging and recovery UI
        // 
        // ERROR HANDLING: Never writes partial JSON on error (try/catch protects localStorage)
        // AUTO-SYNC: Opportunistically syncs to server for cross-device access (if online)
        async function saveProject(reason = 'unknown') {
            // MUTEX: If a save is already in progress, skip to prevent race conditions
            // This prevents duplicate project creation from concurrent calls
            if (_saveInProgress) {
                console.log('ℹ Save already in progress, skipping (reason:', reason, ')');
                return;
            }
            _saveInProgress = true;
            
            // DEBUG: Determine if this is a CREATE or UPDATE operation
            const actionType = ProjectState.currentProjectId ? 'UPDATE' : 'CREATE';
            const saveTimestamp = new Date().toISOString();
            
            console.log(`[saveProject] ========================`);
            console.log(`[saveProject] Action: ${actionType}`);
            console.log(`[saveProject] Project ID: ${ProjectState.currentProjectId || ProjectState.project_id || 'NEW'}`);
            console.log(`[saveProject] Reason: ${reason}`);
            console.log(`[saveProject] Timestamp: ${saveTimestamp}`);
            console.log(`[saveProject] ========================`);
            
            // Log to SaveController history with HTTP method info
            const expectedHttpMethod = ProjectState.currentProjectId ? 'PUT' : 'POST';
            if (typeof SaveController !== 'undefined') {
                SaveController.log(actionType, ProjectState.currentProjectId || ProjectState.project_id, ProjectState.currentProjectName, reason, expectedHttpMethod);
            }
            
            try {
                // CRITICAL FIX: Use currentProjectId (server-assigned) if available
                // This prevents duplicate creation when syncing to server
                if (ProjectState.currentProjectId) {
                    // Project was loaded from or saved to server - use that ID
                    ProjectState.project_id = ProjectState.currentProjectId;
                    ProjectState.siteData.project_id = ProjectState.currentProjectId;
                } else if (!ProjectState.project_id) {
                    // Truly new project - generate a new ID ONCE and cache it
                    // This prevents multiple concurrent calls from generating different IDs
                    if (!_pendingProjectId) {
                        _pendingProjectId = generateUUID();
                    }
                    ProjectState.project_id = _pendingProjectId;
                    ProjectState.siteData.project_id = _pendingProjectId;
                }
                
                // Build complete snapshot for localStorage
                // CRITICAL: Include currentProjectId so auto-restore doesn't lose server ID
                // OPTIMIZATION: Strip base64 data ONLY from synced photos (with dropboxPath)
                // Keep base64 for unsynced photos to preserve offline recovery
                const lightweightPhotos = (ProjectState.photos || []).map(p => {
                    if (p.dropboxPath) {
                        // Photo is synced - strip base64 data
                        return {
                            id: p.id,
                            filename: p.filename,
                            roomKey: p.roomKey,
                            timestamp: p.timestamp,
                            dropboxPath: p.dropboxPath
                        };
                    } else {
                        // Photo not synced - keep full data for recovery
                        return { ...p };
                    }
                });
                
                const snapshot = {
                    project_id: ProjectState.project_id,
                    currentProjectId: ProjectState.currentProjectId,
                    currentProjectName: ProjectState.currentProjectName,
                    siteData: ProjectState.siteData,
                    entries: ProjectState.entries,
                    photos: lightweightPhotos,
                    lastSavedAt: saveTimestamp
                };
                
                // Atomic write to localStorage (all-or-nothing)
                localStorage.setItem('currentProject', JSON.stringify(snapshot));
                
                console.log(`✓ Saved to localStorage: ${entries.length} cards, ${siteData.customer || 'no customer'}, action=${actionType}`);
                
                // Auto-sync to server for cross-device access (only if there's actual data)
                // Calculate actual unit counts (sum of room-count fields, not number of cards)
                const evapUnits = entries
                    .filter(e => e.section === 'evap')
                    .reduce((sum, e) => sum + getEntryCount(e), 0);
                const condUnits = entries
                    .filter(e => e.section === 'cond')
                    .reduce((sum, e) => sum + getEntryCount(e), 0);
                const totalUnits = (evapUnits || 0) + (condUnits || 0);
                
                const hasCustomer = siteData.customer && siteData.customer.trim() !== '';
                const hasUnits = totalUnits > 0;
                
                // IMPORTANT: Only sync to server if there are actual unsaved changes
                // This prevents duplicate entries when simply opening/closing a project
                if (!ProjectState.isDirty) {
                    console.log('ℹ Skipping server sync - no unsaved changes');
                } else if (!(hasCustomer && hasUnits)) {
                    console.log('ℹ Skipping server sync - requires customer AND at least one evap/cond unit');
                } else {
                    const projectData = {
                        project_id: ProjectState.project_id,
                        siteData: siteData,
                        entries: entries,
                        evaporators: entries.filter(e => e.section === 'evap'),
                        condensers: entries.filter(e => e.section === 'cond'),
                        totalUnits: totalUnits,
                        evapCount: evapUnits,
                        condCount: condUnits
                    };
                    
                    // Sync to server and AWAIT result to get server-assigned ID
                    try {
                        const serverId = await syncProjectToServer(projectData);
                        if (serverId) {
                            // Server confirmed save - clear pending ID
                            _pendingProjectId = null;
                        }
                    } catch (err) {
                        console.error('Failed to sync to server:', err);
                    }
                }
            } catch (e) {
                console.error('❌ Auto-save FAILED:', e);
                // Never write partial/corrupted JSON - error is caught and logged
            } finally {
                // ALWAYS release the lock, even on error
                _saveInProgress = false;
            }
        }

        // ==================================================================================
        // BACKEND SYNC - Cross-Device Access
        // ==================================================================================
        // TASK 4: Gate to prevent duplicate project creation during POST
        let _projectCreationInProgress = false;
        
        // syncProjectToServer(): Opportunistically syncs current project to Flask backend
        // This enables cross-device access - save on phone, load on tablet
        // 
        // CROSS-DEVICE BEHAVIOR (Current Implementation):
        // - All devices use X-User-Id: "default" (no real authentication yet)
        // - All saved projects are shared across all devices
        // - Creating project on Device A makes it appear in dropdown on Device B
        // - This is intentional for single-user/single-company use case
        // 
        // FUTURE: When adding real authentication, each user gets their own project pool
        // 
        // ACCURATE COUNTS: Always sends sum of room-count fields, NOT card count
        // (A single card with count=5 means 5 units, not 1 unit)
        // 
        // RESPONSE HANDLING: If server returns success, we store the project_id back
        // This ensures stable project_id across save/load cycles
        async function syncProjectToServer(projectData) {
            // CRITICAL FIX: Always use currentProjectId as the authoritative ID
            // This prevents duplicate project creation when project_id is stale/null
            const authoritativeId = ProjectState.currentProjectId || ProjectState.project_id || projectData.project_id;
            
            // Ensure projectData has the authoritative ID
            projectData.project_id = authoritativeId;
            
            // VALIDATION: Don't sync empty projects (prevents saving incomplete data)
            const hasCustomer = projectData.siteData && projectData.siteData.customer && projectData.siteData.customer.trim() !== '';
            const hasUnits = projectData.totalUnits && projectData.totalUnits > 0;
            
            if (!hasCustomer && !hasUnits) {
                console.log('ℹ Skipping sync - empty project (no customer, no units)');
                return null;
            }
            
            // CRITICAL: Determine if this is CREATE or UPDATE based on currentProjectId
            // - If currentProjectId exists: This project was loaded from server, use PUT to UPDATE
            // - If no currentProjectId: This is a new project, use POST to CREATE
            const isUpdate = !!ProjectState.currentProjectId;
            
            // TASK 4: Prevent duplicate creation with gate
            if (!isUpdate && _projectCreationInProgress) {
                console.log('[syncProjectToServer] Creation already in progress, skipping duplicate POST');
                return ProjectState.currentProjectId || null;
            }
            
            const httpMethod = isUpdate ? 'PUT' : 'POST';
            const endpoint = isUpdate ? `/api/projects/${ProjectState.currentProjectId}` : '/api/data';
            
            const syncTimestamp = new Date().toISOString();
            const clientAction = isUpdate ? 'autosave' : 'create_new';
            
            console.log(`[syncProjectToServer] ========================`);
            console.log(`[syncProjectToServer] Action: ${isUpdate ? 'UPDATE' : 'CREATE'}`);
            console.log(`[syncProjectToServer] HTTP: ${httpMethod} ${endpoint}`);
            console.log(`[syncProjectToServer] X-Client-Action: ${clientAction}`);
            console.log(`[syncProjectToServer] Project ID: ${authoritativeId || 'NEW'}`);
            console.log(`[syncProjectToServer] currentProjectId: ${ProjectState.currentProjectId || 'null'}`);
            console.log(`[syncProjectToServer] Timestamp: ${syncTimestamp}`);
            console.log(`[syncProjectToServer] ========================`);
            
            // Set creation gate before POST
            if (!isUpdate) {
                _projectCreationInProgress = true;
            }
            
            // Generate idempotency key for POST requests to prevent duplicate creates
            const idempotencyKey = !isUpdate ? `${TabLeaderLock.tabId}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}` : null;
            
            try {
                const headers = { 
                    'Content-Type': 'application/json',
                    'X-User-Id': 'default',        // All devices share "default" user pool
                    'X-User-Role': 'admin',        // Admin sees all projects
                    'X-Client-Action': clientAction, // Track autosave vs create_new
                    'X-Client-Version': BUILD_ID   // Track build version for debugging
                };
                
                // Add idempotency key for POST (create) requests
                if (idempotencyKey) {
                    headers['Idempotency-Key'] = idempotencyKey;
                    console.log(`[syncProjectToServer] Idempotency-Key: ${idempotencyKey}`);
                }
                
                const response = await fetch(endpoint, {
                    method: httpMethod,
                    headers: headers,
                    body: JSON.stringify(projectData)
                });
                
                const result = await response.json();
                
                // Handle 409 Conflict responses (build mismatch, invalid action)
                if (!response.ok) {
                    if (response.status === 409) {
                        console.error('[syncProjectToServer] Server rejected request:', result);
                        
                        // Handle specific error codes
                        if (result.code === 'BUILD_MISMATCH') {
                            console.error('🔄 BUILD MISMATCH - Client needs refresh');
                            showBuildMismatchBanner();
                            return null;
                        }
                        if (result.code === 'CREATE_ACTION_INVALID' || result.code === 'AUTOSAVE_CREATE_REJECTED' || result.code === 'IDEMPOTENCY_KEY_MISSING') {
                            console.error('⚠️ Invalid create action or missing idempotency key');
                            // Don't show error to user, just log - this is expected behavior
                            _projectCreationInProgress = false;
                            return null;
                        }
                    }
                    throw new Error(`Server returned ${response.status}: ${result.message || 'Unknown error'}`);
                }
                
                if (result.status === 'success') {
                    console.log(`✓ ${isUpdate ? 'Updated' : 'Created'} on server:`, result.project_id);
                    
                    // TASK 3: IMMEDIATE ID synchronization - set ID BEFORE anything else
                    // This prevents race conditions where other code runs before ID is set
                    if (result.project_id) {
                        // IMMEDIATELY set currentProjectId - this is the authoritative server ID
                        ProjectState.currentProjectId = result.project_id;
                        ProjectState.project_id = result.project_id;
                        ProjectState.siteData.project_id = result.project_id;
                        
                        // IMMEDIATELY update URL with project ID
                        updateUrlWithProjectId(result.project_id);
                        
                        // IMMEDIATELY store to localStorage as backup
                        try {
                            localStorage.setItem('lastProjectId', result.project_id);
                        } catch (e) {
                            console.warn('[syncProjectToServer] Failed to store lastProjectId:', e);
                        }
                        
                        // Clear pending ID since we now have a confirmed server ID
                        _pendingProjectId = null;
                        
                        // TASK 4: Clear creation gate now that ID is set
                        _projectCreationInProgress = false;
                        
                        // Update localStorage directly without recursive saveProject call
                        // CRITICAL: Include currentProjectId so auto-restore doesn't lose server ID
                        // OPTIMIZATION: Strip base64 data ONLY from synced photos (with dropboxPath)
                        try {
                            const lightweightPhotos = (ProjectState.photos || []).map(p => {
                                if (p.dropboxPath) {
                                    return {
                                        id: p.id,
                                        filename: p.filename,
                                        roomKey: p.roomKey,
                                        timestamp: p.timestamp,
                                        dropboxPath: p.dropboxPath
                                    };
                                } else {
                                    return { ...p };
                                }
                            });
                            const snapshot = {
                                project_id: result.project_id,
                                currentProjectId: result.project_id,
                                currentProjectName: ProjectState.currentProjectName,
                                siteData: ProjectState.siteData,
                                entries: ProjectState.entries,
                                photos: lightweightPhotos,
                                lastSavedAt: new Date().toISOString()
                            };
                            localStorage.setItem('currentProject', JSON.stringify(snapshot));
                            console.log('✓ Updated localStorage with server-confirmed ID:', result.project_id);
                        } catch (e) {
                            console.error('Failed to update localStorage with server ID:', e);
                        }
                    }
                    
                    return result.project_id;
                } else {
                    console.error('❌ Server sync failed:', result.message);
                    return null;
                }
            } catch (e) {
                console.error('❌ Server sync error:', e.message);
                // TASK 4: Clear creation gate on error so retry is possible
                _projectCreationInProgress = false;
                // Offline or network error - that's OK, localStorage will hold the data
                // Work continues offline, will sync when connection restored
                return null;
            }
        }

        // Fetch all projects from server (fetches all pages)
        async function fetchProjectsFromServer() {
            try {
                let allProjects = [];
                let offset = 0;
                const limit = 100;
                let hasMore = true;
                
                while (hasMore) {
                    const response = await fetch(`/api/projects?limit=${limit}&offset=${offset}`, {
                        headers: {
                            'X-User-Id': 'default',
                            'X-User-Role': 'admin',
                            'X-Client-Version': BUILD_ID
                        }
                    });
                    if (!response.ok) {
                        throw new Error('Failed to fetch projects');
                    }
                    const data = await response.json();
                    const pageProjects = Array.isArray(data) ? data : (data.items || []);
                    allProjects = allProjects.concat(pageProjects);
                    hasMore = data.hasMore === true;
                    offset += limit;
                    if (offset >= 1000) break;
                }
                console.log('✓ Fetched', allProjects.length, 'projects from server');
                return allProjects;
            } catch (e) {
                console.error('❌ Failed to fetch from server:', e.message);
                // Return empty if offline/error - will fall back to localStorage
                return [];
            }
        }

        // Set Dropbox status message with colors and retry button
        function setDropboxStatus(message, isError, isUploading = false, retryFn = null) {
            const el = document.getElementById("dropbox-status");
            if (!el) return;
            el.textContent = message || "";
            el.classList.remove('status-uploading', 'status-success', 'status-error');
            
            if (isUploading) {
                el.classList.add('status-uploading');
            } else if (isError) {
                el.classList.add('status-error');
                if (retryFn && !el.querySelector('.retry-btn')) {
                    const retryBtn = document.createElement('button');
                    retryBtn.className = 'retry-btn';
                    retryBtn.textContent = ' Retry';
                    retryBtn.addEventListener('click', retryFn);
                    el.appendChild(retryBtn);
                }
            } else {
                el.classList.add('status-success');
                if (el.querySelector('.retry-btn')) {
                    el.querySelector('.retry-btn').remove();
                }
            }
        }

        // Upload CSV to Dropbox via backend (SDK-based)
        async function uploadCsvToDropbox(filename, csv) {
            setDropboxStatus("Uploading CSV to Dropbox…", false);

            try {
                const csvBlob = new Blob([csv], { type: 'text/csv' });
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: csvBlob,
                    headers: {
                        "X-Company": document.getElementById("site-customer").value || "Unknown"
                    }
                });

                // Check HTTP-level failure first
                if (!response.ok) {
                    let errorText = "";
                    try {
                        errorText = await response.text();
                    } catch (e) {
                        errorText = "";
                    }
                    console.error("Dropbox HTTP error:", response.status, errorText);
                    setDropboxStatus(`Dropbox upload failed (HTTP ${response.status})`, true);
                    return false;
                }

                // Parse JSON response
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    console.error("Dropbox JSON parse error:", e);
                    setDropboxStatus("Dropbox upload failed (invalid server response)", true);
                    return false;
                }

                console.log("DROPBOX RESPONSE:", response.status, data);

                // Check logical success
                if (data.ok) {
                    console.log("Dropbox upload success:", data);
                    setDropboxStatus("Dropbox upload successful", false);
                    return true;
                } else {
                    console.error("Dropbox logical error:", data);
                    const msg = data.error || "Unknown Dropbox error";
                    setDropboxStatus(`Dropbox upload failed: ${msg}`, true);
                    return false;
                }

            } catch (err) {
                console.error("Dropbox network error:", err);
                setDropboxStatus("Dropbox upload failed (network error)", true);
                return false;
            }
        }
        
        // Alias for backwards compatibility
        const uploadCsvToServer = uploadCsvToDropbox;

        // ==================================================================================
        // NEW SAVE/LOAD SYSTEM - Uses new backend endpoints
        // ==================================================================================
        // POST /api/projects/create - Creates new project with name
        // GET /api/projects/<project_id> - Fetches single project
        // PUT /api/projects/<project_id> - Updates existing project (merges data)
        // POST /api/projects/<project_id>/duplicate - Duplicates a project
        // GET /api/projects - Lists all projects

        // Create a new project on the server
        async function createProjectOnServer(name) {
            try {
                const response = await fetch('/api/projects/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Failed to create project');
                }
                return await response.json();
            } catch (err) {
                console.error('Error creating project:', err);
                throw err;
            }
        }

        // Update an existing project on the server
        async function updateProjectOnServer(projectId, data) {
            try {
                const response = await fetch(`/api/projects/${projectId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Failed to update project');
                }
                return await response.json();
            } catch (err) {
                console.error('Error updating project:', err);
                throw err;
            }
        }

        // Fetch a single project from the server
        async function fetchProjectFromServer(projectId) {
            console.log('[load] Fetching project ID:', projectId);
            if (!projectId || typeof projectId !== 'string') {
                console.error('[load] Invalid project ID:', projectId, typeof projectId);
                throw new Error('Invalid project ID for loading');
            }
            try {
                const url = `/api/projects/${projectId}`;
                console.log('[load] GET', url);
                const response = await fetch(url);
                if (!response.ok) {
                    const errData = await response.json();
                    console.error('[load] Server error:', errData);
                    throw new Error(errData.message || errData.error || 'Failed to fetch project');
                }
                const result = await response.json();
                console.log('[load] Success, loaded project:', result._metadata?.name || result.project_id);
                return result;
            } catch (err) {
                console.error('[load] Error:', err);
                throw err;
            }
        }

        // Fetch all projects list from the server (fetches all pages)
        async function fetchAllProjectsFromServer() {
            try {
                let allProjects = [];
                let offset = 0;
                const limit = 100;
                let hasMore = true;
                
                while (hasMore) {
                    const response = await fetch(`/api/projects?limit=${limit}&offset=${offset}`, {
                        headers: {
                            'X-User-Id': 'default',
                            'X-User-Role': 'admin'
                        }
                    });
                    if (!response.ok) {
                        return allProjects;
                    }
                    const data = await response.json();
                    const pageProjects = Array.isArray(data) ? data : (data.items || []);
                    allProjects = allProjects.concat(pageProjects);
                    hasMore = data.hasMore === true;
                    offset += limit;
                    if (offset >= 1000) break;
                }
                return allProjects;
            } catch (err) {
                console.error('Error fetching projects list:', err);
                return [];
            }
        }
        
        // Refresh all project lists (modal if open, projects page if visible)
        async function refreshAllProjectLists() {
            console.log('[refresh] Refreshing all project lists...');
            // Use ProjectService to refresh the cache
            await ProjectService.listProjects();
        }

        // Duplicate a project on the server
        async function duplicateProjectOnServer(projectId) {
            console.log('[duplicate] Calling duplicate for project ID:', projectId);
            if (!projectId || typeof projectId !== 'string') {
                console.error('[duplicate] Invalid project ID:', projectId, typeof projectId);
                throw new Error('Invalid project ID for duplication');
            }
            try {
                const url = `/api/projects/${projectId}/duplicate`;
                console.log('[duplicate] POST', url);
                const response = await fetch(url, {
                    method: 'POST'
                });
                if (!response.ok) {
                    const errData = await response.json();
                    console.error('[duplicate] Server error:', errData);
                    throw new Error(errData.message || errData.error || 'Failed to duplicate project');
                }
                const result = await response.json();
                console.log('[duplicate] Success:', result);
                return result;
            } catch (err) {
                console.error('[duplicate] Error:', err);
                throw err;
            }
        }

        // Delete a project on the server
        async function deleteProjectOnServer(projectId) {
            console.log('[delete] Calling delete for project ID:', projectId);
            if (!projectId || typeof projectId !== 'string') {
                console.error('[delete] Invalid project ID:', projectId, typeof projectId);
                throw new Error('Invalid project ID for deletion');
            }
            try {
                const url = `/api/projects/${projectId}`;
                console.log('[delete] DELETE', url);
                const response = await fetch(url, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    const errData = await response.json();
                    console.error('[delete] Server error:', errData);
                    throw new Error(errData.message || errData.error || 'Failed to delete project');
                }
                const result = await response.json();
                console.log('[delete] Success:', result);
                return result;
            } catch (err) {
                console.error('[delete] Error:', err);
                throw err;
            }
        }

        // Show Project Name Modal for saving new projects or Save As
        function showProjectNameModal(defaultName = '', isSaveAs = false) {
            return new Promise((resolve, reject) => {
                const modal = document.getElementById('projectNameModal');
                const input = document.getElementById('projectNameInput');
                const saveBtn = document.getElementById('projectNameSaveBtn');
                const cancelBtn = document.getElementById('projectNameCancelBtn');
                const title = modal.querySelector('h3');
                
                if (isSaveAs) {
                    title.textContent = 'Save As New Project';
                } else {
                    title.textContent = 'Save Project';
                }
                
                input.value = defaultName;
                modal.classList.remove('hidden');
                input.focus();
                input.select();
                
                function cleanup() {
                    modal.classList.add('hidden');
                    saveBtn.removeEventListener('click', onSave);
                    cancelBtn.removeEventListener('click', onCancel);
                    input.removeEventListener('keydown', onKeydown);
                }
                
                function onSave() {
                    const name = input.value.trim();
                    if (!name) {
                        showToast('Please enter a project name.', 'warning');
                        return;
                    }
                    cleanup();
                    resolve(name);
                }
                
                function onCancel() {
                    cleanup();
                    resolve(null);
                }
                
                function onKeydown(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        onSave();
                    } else if (e.key === 'Escape') {
                        onCancel();
                    }
                }
                
                saveBtn.addEventListener('click', onSave);
                cancelBtn.addEventListener('click', onCancel);
                input.addEventListener('keydown', onKeydown);
            });
        }

        // Save current project using new endpoints
        async function saveProjectWithNewSystem(forceSaveAs = false) {
            const hasCustomer = siteData.customer && siteData.customer.trim() !== '';
            const hasUnits = entries.length > 0;
            
            if (!hasCustomer) {
                showToast('Please enter customer information before saving.', 'warning');
                return;
            }
            
            try {
                let projectId = ProjectState.currentProjectId;
                const originalProjectId = ProjectState.currentProjectId; // Remember for bill copying
                
                // FIRST SAVE / SAVE AS LOGIC:
                // - First save (no projectId): Prompts for name, defaults to customer name
                // - Save As (forceSaveAs=true): Creates new project with user-entered name
                // - Regular Save: Uses existing projectId, keeps projectName unchanged
                if (!projectId || forceSaveAs) {
                    // First save: default name = customer name (backward compatible)
                    // Save As: suggest current projectName + " (Copy)"
                    let defaultName = siteData.customer || 'New Project';
                    if (forceSaveAs && ProjectState.currentProjectName) {
                        defaultName = ProjectState.currentProjectName + ' (Copy)';
                    }
                    
                    const name = await showProjectNameModal(defaultName, forceSaveAs);
                    if (!name) {
                        return; // User cancelled
                    }
                    
                    // Create NEW project on server with new UUID and projectName
                    // Save As: Original project remains intact, this creates independent copy
                    const createResult = await createProjectOnServer(name);
                    projectId = createResult.project_id;
                    ProjectState.currentProjectId = projectId;
                    ProjectState.currentProjectName = name; // projectName set here
                    
                    // SAVE AS: Copy electric bills from original project to new project
                    if (forceSaveAs && originalProjectId) {
                        try {
                            const copyResponse = await fetch(`/api/projects/${originalProjectId}/bills/copy-to/${projectId}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            });
                            const copyResult = await copyResponse.json();
                            if (copyResult.success) {
                                console.log(`[Save As] Copied ${copyResult.files_copied} bill files to new project`);
                            }
                        } catch (copyErr) {
                            console.warn('[Save As] Could not copy bills:', copyErr);
                        }
                    }
                }
                
                // Sum room-count fields for accurate unit counts
                const evapCount = entries
                    .filter(e => e.section === 'evap')
                    .reduce((sum, e) => sum + getEntryCount(e), 0);
                const condCount = entries
                    .filter(e => e.section === 'cond')
                    .reduce((sum, e) => sum + getEntryCount(e), 0);
                
                // Prepare data for update
                const projectData = {
                    siteData: siteData,
                    entries: entries,
                    photos: ProjectState.photos || photos || [],
                    evap_count: evapCount,
                    cond_count: condCount
                };
                
                // Update project on server
                await updateProjectOnServer(projectId, projectData);
                
                ProjectState.isDirty = false;
                updateCurrentProjectDisplay();
                
                // Clear autosave since we've explicitly saved
                clearAutosave();
                
                // Also save to localStorage for offline backup
                SaveController.queueSave('save-as');
                addProjectToSavedLocally(projectId);
                
                // Refresh all project lists so dropdown shows updated project
                await refreshAllProjectLists();
                
                showToast('Project saved successfully!', 'success');
                
            } catch (err) {
                console.error('Error saving project:', err);
                showToast('Could not save project: ' + err.message, 'error');
            }
        }

        // Helper function removed - backend is source of truth, no more localStorage for projects
        function addProjectToSavedLocally(projectId) {
            // DEPRECATED: Backend is now the source of truth for projects
            // This function is kept for backward compatibility but does nothing
            console.log('[deprecated] addProjectToSavedLocally called - backend is source of truth');
        }

        // Update the current project display indicator
        function updateCurrentProjectDisplay() {
            const display = document.getElementById('currentProjectDisplay');
            if (display) {
                if (ProjectState.currentProjectId && ProjectState.currentProjectName) {
                    display.textContent = `📁 ${ProjectState.currentProjectName}`;
                } else if (ProjectState.currentProjectId) {
                    display.textContent = '📁 Untitled Project';
                } else {
                    display.textContent = '';
                }
            }
        }

        // Open Load Project Modal and populate list
        async function openLoadProjectModal() {
            const modal = document.getElementById('loadProjectModal');
            const container = document.getElementById('loadProjectListContainer');
            const closeBtn = document.getElementById('loadProjectCloseBtn');
            
            modal.classList.remove('hidden');
            container.innerHTML = '<p style="text-align:center;color:#666;">Loading projects...</p>';
            
            // Fetch projects from server using ProjectService
            const projects = await ProjectService.listProjects();
            
            if (projects.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#666;">No saved projects yet.</p>';
            } else {
                container.innerHTML = '';
                projects.forEach(proj => {
                    const item = createProjectListItemWithCheckbox(proj, 'modal');
                    container.appendChild(item);
                });
            }
            
            // Setup mass delete handlers for modal
            setupMassDeleteHandlers('modal');
            
            // Close button handler
            function onClose() {
                modal.classList.add('hidden');
                closeBtn.removeEventListener('click', onClose);
            }
            closeBtn.addEventListener('click', onClose);
            
            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    onClose();
                }
            });
        }

        // Create a project list item for the Load modal
        function createProjectListItem(proj) {
            const item = document.createElement('div');
            item.className = 'project-list-item';
            
            const info = document.createElement('div');
            info.className = 'project-list-info';
            
            const name = document.createElement('div');
            name.className = 'project-list-name';
            name.textContent = proj.name || proj.customer || 'Untitled Project';
            
            const customer = document.createElement('div');
            customer.className = 'project-list-customer';
            if (proj.customer && proj.customer !== proj.name) {
                customer.textContent = proj.customer;
            }
            
            const meta = document.createElement('div');
            meta.className = 'project-list-meta';
            
            // Format dates
            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                try {
                    const d = new Date(dateStr);
                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                } catch (e) { return ''; }
            };
            
            const evapCount = proj.evap_count || 0;
            const condCount = proj.cond_count || 0;
            const totalUnits = evapCount + condCount;
            
            let metaText = [];
            if (totalUnits > 0) {
                metaText.push(`${evapCount} evap, ${condCount} cond`);
            }
            if (proj.last_modified) {
                metaText.push(`Modified: ${formatDate(proj.last_modified)}`);
            } else if (proj.created_at) {
                metaText.push(`Created: ${formatDate(proj.created_at)}`);
            }
            
            meta.textContent = metaText.join(' • ');
            
            info.appendChild(name);
            if (customer.textContent) info.appendChild(customer);
            info.appendChild(meta);
            
            const actions = document.createElement('div');
            actions.className = 'project-list-actions';
            
            const duplicateBtn = document.createElement('button');
            duplicateBtn.textContent = '📋 Duplicate';
            duplicateBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                try {
                    const result = await duplicateProjectOnServer(proj.id);
                    console.log('[duplicate] Project duplicated, new ID:', result.project_id);
                    // Refresh both the modal and dropdown
                    await refreshAllProjectLists();
                    openLoadProjectModal(); // Refresh the modal list
                } catch (err) {
                    console.error('[duplicate] Failed:', err);
                    showToast('Failed to duplicate project: ' + err.message, 'error');
                }
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = '🗑️ Delete';
            deleteBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const confirmed = await showConfirmModal({
                    title: 'Delete Project',
                    message: `Are you sure you want to delete "${proj.name || 'this project'}"? This cannot be undone.`,
                    confirmText: 'Delete',
                    cancelText: 'Cancel',
                    danger: true
                });
                if (!confirmed) return;
                try {
                    await deleteProjectOnServer(proj.id);
                    console.log('[delete] Project deleted:', proj.id);
                    // If deleted project is currently loaded, clear the form
                    if (ProjectState.currentProjectId === proj.id) {
                        console.log('[delete] Clearing currently loaded project');
                        newProject();
                    }
                    // Refresh both the modal and dropdown
                    await refreshAllProjectLists();
                    openLoadProjectModal(); // Refresh the modal list
                } catch (err) {
                    console.error('[delete] Failed:', err);
                    showToast('Failed to delete project: ' + err.message, 'error');
                }
            });
            
            actions.appendChild(duplicateBtn);
            actions.appendChild(deleteBtn);
            
            item.appendChild(info);
            item.appendChild(actions);
            
            // Click to load project
            item.addEventListener('click', async () => {
                await loadProjectFromServer(proj.id);
                document.getElementById('loadProjectModal').classList.add('hidden');
            });
            
            return item;
        }

        // Load a project from the server using new endpoint
        // Checks for newer server autosave and prompts user to restore or discard
        async function loadProjectFromServer(projectId) {
            try {
                const proj = await fetchProjectFromServer(projectId);
                const projectUpdatedAt = proj._metadata?.updated_at;
                
                // Check for newer server autosave before loading
                const newerAutosave = await checkServerAutosaveNewer(projectId, projectUpdatedAt);
                
                if (newerAutosave) {
                    // Show restore prompt and wait for user choice
                    const userChoice = await showServerAutosavePrompt(newerAutosave, proj);
                    
                    if (userChoice === 'restore') {
                        // Load autosave data instead of saved project
                        applyProjectData(proj, newerAutosave);
                        ProjectState.isDirty = true; // Mark as dirty since autosave differs from saved
                        await clearAutosaveFromServer(projectId);
                        console.log('✓ Restored autosave for project:', projectId);
                    } else {
                        // Discard autosave and load saved project
                        applyProjectData(proj, null);
                        await clearAutosaveFromServer(projectId);
                        console.log('✓ Loaded saved project (discarded autosave):', projectId);
                    }
                } else {
                    // No newer autosave, load saved project normally
                    applyProjectData(proj, null);
                    console.log('✓ Loaded project:', projectId, 'name:', ProjectState.currentProjectName);
                }
                
            } catch (err) {
                console.error('Failed to load project:', err);
                showToast('Failed to load project: ' + err.message, 'error');
            }
        }
        
        // Apply project data to the app state (optionally override with autosave data)
        function applyProjectData(proj, autosaveOverride) {
            const projectId = proj._metadata?.project_id || proj.project_id;
            
            // Load data into ProjectState
            ProjectState.currentProjectId = projectId;
            ProjectState.currentProjectName = proj._metadata?.name || proj.name || null;
            
            // Use autosave data if provided, otherwise use saved project data
            const dataSource = autosaveOverride || proj;
            
            // Update local state (global variables)
            Object.keys(siteData).forEach(key => delete siteData[key]);
            Object.assign(siteData, dataSource.siteData || {});
            
            entries.length = 0;
            entries.push(...migrateEntries(dataSource.entries || []));
            
            photos.length = 0;
            if (Array.isArray(dataSource.photos)) {
                photos.push(...dataSource.photos);
            }
            
            // CRITICAL: Also update ProjectState.siteData and ProjectState.entries
            // These are used by saveProject() when saving to localStorage
            Object.keys(ProjectState.siteData).forEach(key => delete ProjectState.siteData[key]);
            Object.assign(ProjectState.siteData, siteData);
            
            ProjectState.entries.length = 0;
            ProjectState.entries.push(...entries);
            
            ProjectState.photos = ProjectState.photos || [];
            ProjectState.photos.length = 0;
            ProjectState.photos.push(...photos);
            
            // Update project_id for consistency
            siteData.project_id = ProjectState.currentProjectId;
            ProjectState.project_id = ProjectState.currentProjectId;
            ProjectState.siteData.project_id = ProjectState.currentProjectId;
            
            // Populate site form values
            document.getElementById('site-date').value = siteData.date || '';
            if (siteData.visitDate) {
                document.getElementById('visitDateText').textContent = siteData.visitDate;
            }
            document.getElementById('site-customer').value = siteData.customer || '';
            document.getElementById('site-street').value = siteData.street || '';
            document.getElementById('site-city').value = siteData.city || '';
            document.getElementById('site-state').value = siteData.state || 'CA';
            document.getElementById('site-zip').value = siteData.zip || '';
            document.getElementById('site-contact').value = siteData.contact || '';
            document.getElementById('site-phone').value = siteData.phone || '';
            
            applyUtilityToForm(siteData.utility);
            
            // Update Site Address display
            const addressParts = [];
            if (siteData.street) addressParts.push(siteData.street);
            const cityStateZip = [siteData.city, siteData.state, siteData.zip].filter(v => v).join(', ');
            if (cityStateZip) addressParts.push(cityStateZip);
            document.getElementById('siteAddressText').textContent = addressParts.join(', ') || 'No address provided';
            
            // Update customer name in header
            const customerNameEl = document.getElementById('customerName');
            if (customerNameEl && siteData.customer) {
                customerNameEl.textContent = siteData.customer;
            }
            
            if (!autosaveOverride) {
                ProjectState.isDirty = false;
            }
            updateCurrentProjectDisplay();
            
            // Save to localStorage IMMEDIATELY (not debounced) so refresh works
            // This is critical for page refresh to restore the project
            try {
                const snapshot = {
                    project_id: ProjectState.project_id,
                    currentProjectId: ProjectState.currentProjectId,
                    currentProjectName: ProjectState.currentProjectName,
                    siteData: ProjectState.siteData,
                    entries: ProjectState.entries,
                    photos: ProjectState.photos || [],
                    lastSavedAt: new Date().toISOString()
                };
                console.log('[applyProjectData] DEBUG: Saving snapshot with entries.length:', snapshot.entries.length);
                console.log('[applyProjectData] DEBUG: Saving snapshot with siteData.customer:', snapshot.siteData?.customer);
                console.log('[applyProjectData] DEBUG: Saving snapshot with currentProjectId:', snapshot.currentProjectId);
                localStorage.setItem('currentProject', JSON.stringify(snapshot));
                console.log('[applyProjectData] Saved to localStorage immediately, verifying...');
                const verify = localStorage.getItem('currentProject');
                console.log('[applyProjectData] DEBUG: Verified localStorage length:', verify?.length);
            } catch (e) {
                console.error('[applyProjectData] Failed to save to localStorage:', e);
            }
            
            // Switch to data view
            siteSection.classList.add('hidden');
            dataSection.classList.remove('hidden');
            setSaveCustomerInfoVisible(false);
            const editSiteBtn = document.getElementById('editSiteBtn');
            if (editSiteBtn) {
                editSiteBtn.classList.remove('hidden');
            }
            renderEntries();
        }
        
        // Show prompt for server autosave restore/discard
        // Returns a promise that resolves to 'restore' or 'discard'
        function showServerAutosavePrompt(autosaveData, projectData) {
            return new Promise((resolve) => {
                const modal = document.getElementById('serverAutosaveModal');
                if (!modal) {
                    // Fallback to confirm dialog if modal doesn't exist
                    const timestamp = formatAutosaveTimestamp(autosaveData.autosavedAt);
                    showConfirmModal({
                        title: 'Restore Autosave?',
                        message: `A more recent autosave was found for this project.\n\nAutosaved: ${timestamp}\n\nRestore the autosave, or discard it and use the last saved version?`,
                        confirmText: 'Restore',
                        cancelText: 'Discard',
                        danger: false
                    }).then(choice => {
                        resolve(choice ? 'restore' : 'discard');
                    });
                    return;
                }
                
                // Populate modal content
                const timestampEl = document.getElementById('serverAutosaveTimestamp');
                const savedTimestampEl = document.getElementById('serverSavedTimestamp');
                const detailsEl = document.getElementById('serverAutosaveDetails');
                const restoreBtn = document.getElementById('serverAutosaveRestoreBtn');
                const discardBtn = document.getElementById('serverAutosaveDiscardBtn');
                
                const autosaveTime = formatAutosaveTimestamp(autosaveData.autosavedAt);
                const savedTime = projectData._metadata?.updated_at 
                    ? formatAutosaveTimestamp(projectData._metadata.updated_at)
                    : 'Unknown';
                
                timestampEl.innerHTML = `<strong>Autosave:</strong> ${autosaveTime}`;
                savedTimestampEl.innerHTML = `<strong>Last saved:</strong> ${savedTime}`;
                
                const entryCount = (autosaveData.entries || []).length;
                const photoCount = (autosaveData.photos || []).length;
                const customer = autosaveData.siteData?.customer || 'Unnamed';
                detailsEl.innerHTML = `<strong>Customer:</strong> ${customer}<br>` +
                    `<strong>Data:</strong> ${entryCount} equipment entries, ${photoCount} photos`;
                
                function onRestore() {
                    modal.classList.add('hidden');
                    cleanup();
                    resolve('restore');
                }
                
                function onDiscard() {
                    modal.classList.add('hidden');
                    cleanup();
                    resolve('discard');
                }
                
                function cleanup() {
                    restoreBtn.removeEventListener('click', onRestore);
                    discardBtn.removeEventListener('click', onDiscard);
                }
                
                restoreBtn.addEventListener('click', onRestore);
                discardBtn.addEventListener('click', onDiscard);
                
                modal.classList.remove('hidden');
            });
        }

        // ==================================================================================
        // SAVE PROJECT - Named Save to Server & LocalStorage
        // ==================================================================================
        // addProjectToSaved(): Saves current project as a named, retrievable project
        // This is different from saveProject() which just autosaves work-in-progress
        // 
        // DUPLICATE PREVENTION:
        // - Uses project_id to detect duplicates (not customer name)
        // - If project_id exists in saved list, UPDATE existing instead of creating new
        // - This prevents "Save" button from creating multiple copies of same project
        // 
        // EMPTY PROJECT PREVENTION:
        // - Refuses to save if no customer AND no units
        // - This prevents accidental saves of blank forms
        // 
        // CROSS-DEVICE: Syncs to server immediately after localStorage save
        async function addProjectToSaved() {
            try {
                // VALIDATION: Don't save empty projects (requires BOTH customer AND at least one unit)
                const hasCustomer = siteData.customer && siteData.customer.trim() !== '';
                const hasUnits = entries.length > 0;
                
                if (!(hasCustomer && hasUnits)) {
                    console.log('ℹ Not saving - must have customer AND at least one evap/cond entry');
                    return;
                }
                
                // Ensure stable project_id exists (generate if missing)
                // This ID is used for duplicate detection
                if (!siteData.project_id) {
                    siteData.project_id = generateUUID();
                }
                const projectId = siteData.project_id;
                
                // Deep copy siteData and entries so changes later don't affect saved project
                const siteCopy = JSON.parse(JSON.stringify(siteData));
                const entriesCopy = JSON.parse(JSON.stringify(entries));
                
                // Add timestamp and summary info
                const now = new Date();
                const timestamp = now.toISOString();
                
                // FIXED: Sum the room-count fields instead of counting cards
                const evapCount = entriesCopy
                    .filter(e => e.section === 'evap')
                    .reduce((sum, e) => sum + getEntryCount(e), 0);
                const condCount = entriesCopy
                    .filter(e => e.section === 'cond')
                    .reduce((sum, e) => sum + getEntryCount(e), 0);
                
                const project = {
                    project_id: projectId,
                    siteData: siteCopy,
                    entries: entriesCopy,
                    evaporators: entriesCopy.filter(e => e.section === 'evap'),
                    condensers: entriesCopy.filter(e => e.section === 'cond'),
                    totalUnits: evapCount + condCount,
                    timestamp: timestamp,
                    savedAt: timestamp,
                    evapCount: evapCount,
                    condCount: condCount
                };
                
                // Sync to server (backend is source of truth, no localStorage for projects)
                syncProjectToServer(project).then(serverId => {
                    if (serverId) {
                        console.log('✓ Project synced to server:', serverId);
                        // Clear server autosave after successful manual save
                        clearAutosaveFromServer(projectId);
                    }
                    // Refresh project cache
                    ProjectService.listProjects();
                });
                
                // Mark as clean after save
                ProjectState.isDirty = false;
                
            } catch (e) {
                console.error('Failed to save project:', e);
            }
        }
        
        // Generate UUID v4 for project IDs
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // DEPRECATED: Use Load Project modal and ProjectService instead
        function refreshSavedProjectsList() {
            // Function deprecated - use ProjectService.listProjects() instead
            console.log('[deprecated] refreshSavedProjectsList called');
        }

        // ==================================================================================
        // AUTOMATIC DRAFT RECOVERY - Robust Autosave
        // ==================================================================================
        // On page load, automatically restore in-progress work from localStorage
        // This ensures Safari refreshes and pull-to-refresh don't lose work
        // User can start fresh using "New Project" which clears the draft
        function checkForInProgressWork() {
            const dataStr = localStorage.getItem('currentProject');
            if (!dataStr) {
                console.log('ℹ No auto-saved draft found');
                return false;
            }
            
            try {
                const data = JSON.parse(dataStr);
                const customer = data.siteData?.customer || 'Unnamed';
                const unitCount = (data.entries || []).length;
                const photoCount = (data.photos || []).length;
                const lastSaved = data.lastSavedAt;
                
                // Validation: check if there's meaningful data to restore
                const sd = data.siteData || {};
                const hasCustomerFields = [
                    sd.customer,
                    sd.street,
                    sd.city,
                    sd.state,
                    sd.zip,
                    sd.contact,
                    sd.phone
                ].some(v => v && String(v).trim() !== '');
                
                const hasUnits = unitCount > 0;
                const hasPhotos = photoCount > 0;
                
                // Auto-restore if there's meaningful data (customer info OR units OR photos)
                if (hasCustomerFields || hasUnits || hasPhotos) {
                    console.log('✓ Auto-restoring draft:', customer, '-', unitCount, 'units,', photoCount, 'photos');
                    
                    // Automatically restore the draft
                    resumeInProgressWork();
                    return true;
                } else {
                    console.log('ℹ Draft found but has no meaningful data. Starting fresh.');
                    return false;
                }
            } catch (e) {
                console.error('❌ Failed to parse localStorage data:', e);
                // Clear corrupted data
                localStorage.removeItem('currentProject');
                return false;
            }
        }
        
        // Resume button handler: Load the in-progress work from localStorage
        function resumeInProgressWork() {
            const dataStr = localStorage.getItem('currentProject');
            if (!dataStr) {
                console.log('ℹ No data to resume');
                return;
            }
            
            try {
                const data = JSON.parse(dataStr);
                
                // Load into ProjectState (this updates siteData and entries references)
                ProjectState.load(data);
                
                console.log('✓ Resumed:', entries.length, 'units,', siteData.customer || 'no customer');
                
                // Populate site form fields
                if (siteData && Object.keys(siteData).length > 0) {
                    document.getElementById('site-date').value = siteData.date || document.getElementById('site-date').value;
                    document.getElementById('site-customer').value = siteData.customer || '';
                    document.getElementById('site-street').value = siteData.street || '';
                    document.getElementById('site-city').value = siteData.city || '';
                    document.getElementById('site-state').value = siteData.state || 'CA';
                    document.getElementById('site-zip').value = siteData.zip || '';
                    document.getElementById('site-contact').value = siteData.contact || '';
                    document.getElementById('site-phone').value = siteData.phone || '';
                    
                    applyUtilityToForm(siteData.utility);
                }
                
                // If there are units, skip to data section
                if (entries.length > 0) {
                    if (siteData.visitDate) {
                        document.getElementById('visitDateText').textContent = siteData.visitDate;
                    }
                    
                    // Update Site Address display
                    const addressParts = [];
                    if (siteData.street) addressParts.push(siteData.street);
                    const cityStateZip = [siteData.city, siteData.state, siteData.zip].filter(v => v).join(', ');
                    if (cityStateZip) addressParts.push(cityStateZip);
                    document.getElementById('siteAddressText').textContent = addressParts.join(', ') || 'No address provided';
                    
                    // Skip site entry and show data section
                    siteSection.classList.add('hidden');
                    dataSection.classList.remove('hidden');
                    setSaveCustomerInfoVisible(false);
                    
                    // Show edit site pencil icon
                    const editSiteBtn = document.getElementById('editSiteBtn');
                    if (editSiteBtn) {
                        editSiteBtn.classList.remove('hidden');
                    }
                    
                    // Update header customer name
                    const forLineEl = document.getElementById('forLine');
                    const customerNameEl = document.getElementById('customerName');
                    if (forLineEl && customerNameEl) {
                        const { customer } = siteData;
                        if (customer) {
                            customerNameEl.textContent = customer;
                        } else {
                            customerNameEl.textContent = '';
                        }
                    }
                    
                    // Render entries (skip save since we just loaded)
                    renderEntries(true);
                }
                
                // Hide resume banner
                const resumeBanner = document.getElementById('resumeBanner');
                if (resumeBanner) {
                    resumeBanner.classList.add('hidden');
                }
                
            } catch (e) {
                console.error('❌ Failed to resume:', e);
                showToast('Failed to resume in-progress work. Starting fresh.', 'error');
                discardInProgressWork();
            }
        }
        
        // Discard button handler: Clear localStorage and hide banner
        function discardInProgressWork() {
            localStorage.removeItem('currentProject');
            const resumeBanner = document.getElementById('resumeBanner');
            if (resumeBanner) {
                resumeBanner.classList.add('hidden');
            }
            console.log('✓ Discarded in-progress work');
        }
        
        // Start New Project: Prompt for name, clear all data, and start fresh
        async function startNewProject() {
            // Prompt for project name first
            const projectName = prompt('Enter a name for the new project:', '');
            if (projectName === null) {
                return; // User cancelled
            }
            
            const trimmedName = projectName.trim();
            if (!trimmedName) {
                showToast('Project name cannot be empty.', 'warning');
                return;
            }
            
            // Confirm clearing current work
            if (ProjectState.isDirty || ProjectState.entries.length > 0) {
                const confirmed = await showConfirmModal({
                    title: 'Start New Project',
                    message: 'Start a new project? This will clear all current work.',
                    confirmText: 'Start New',
                    cancelText: 'Cancel',
                    danger: false
                });
                if (!confirmed) return;
            }
            
            // Clear localStorage draft
            localStorage.removeItem('currentProject');
            
            // Clear autosave
            clearAutosave();
            
            // Create new project on server
            try {
                const response = await fetch('/api/projects/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: trimmedName })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const newProjectId = result.project_id;
                    
                    // Reset ProjectState with new project info
                    ProjectState.reset();
                    ProjectState.project_id = newProjectId;
                    ProjectState.currentProjectId = newProjectId;
                    ProjectState.currentProjectName = trimmedName;
                    ProjectState.isDirty = false;
                    
                    // Update display
                    updateCurrentProjectDisplay();
                    
                    // Store today's date in localStorage so it can be retrieved after reload
                    localStorage.setItem('newProjectDate', getTodayISO());
                    
                    // Reload the page to get a completely fresh state with the new project
                    window.location.reload();
                } else {
                    showToast('Failed to create new project on server. Please try again.', 'error');
                }
            } catch (e) {
                console.error('Failed to create new project:', e);
                // Fall back to local-only new project
                ProjectState.reset();
                ProjectState.project_id = generateUUID();
                ProjectState.currentProjectId = null;
                ProjectState.currentProjectName = trimmedName;
                ProjectState.isDirty = false;
                updateCurrentProjectDisplay();
                // Store today's date in localStorage so it can be retrieved after reload
                localStorage.setItem('newProjectDate', getTodayISO());
                window.location.reload();
            }
        }
        
        // ==================================================================================
        // CANONICAL EMPTY PROJECT FACTORY
        // ==================================================================================
        // Creates a fresh empty project with today's date and generates a new ID.
        // This is the single source of truth for what an "empty project" looks like.
        function createEmptyProject() {
            const todayISO = getTodayISO();
            const todayDisplay = formatDateForDisplay(todayISO);
            
            return {
                project_id: generateUUID(),
                currentProjectId: null,
                currentProjectName: null,
                siteData: {
                    date: todayISO,
                    visitDate: todayDisplay,
                    customer: '',
                    street: '',
                    city: '',
                    state: 'CA',
                    zip: '',
                    contact: '',
                    phone: '',
                    utility: ''
                },
                entries: [],
                photos: [],
                isDirty: false
            };
        }
        
        // Apply an empty project to ProjectState and legacy globals
        // Clears arrays/objects IN-PLACE to maintain references
        function applyEmptyProject(emptyProject) {
            // Update ProjectState
            ProjectState.project_id = emptyProject.project_id;
            ProjectState.currentProjectId = emptyProject.currentProjectId;
            ProjectState.currentProjectName = emptyProject.currentProjectName;
            ProjectState.isDirty = emptyProject.isDirty;
            
            // Clear and repopulate siteData IN-PLACE
            Object.keys(ProjectState.siteData).forEach(key => delete ProjectState.siteData[key]);
            Object.assign(ProjectState.siteData, emptyProject.siteData);
            
            // Clear and repopulate entries IN-PLACE
            ProjectState.entries.length = 0;
            // entries array is empty in new project, so nothing to push
            
            // Clear and repopulate photos IN-PLACE
            ProjectState.photos.length = 0;
            // photos array is empty in new project, so nothing to push
            
            // Sync legacy global variables IN-PLACE
            Object.keys(siteData).forEach(key => delete siteData[key]);
            Object.assign(siteData, emptyProject.siteData);
            
            entries.length = 0;
            
            // Always clear photos array - it's defined globally at script start
            photos.length = 0;
        }
        
        // newProject(): Clear state for starting a new project (used by Home "Start New Project" and card-view "New Project" buttons)
        // Creates a completely empty project with today's date pre-filled
        function newProject() {
            // Clear localStorage draft and autosave
            localStorage.removeItem('currentProject');
            clearAutosave();
            
            // Create and apply a fresh empty project
            const emptyProject = createEmptyProject();
            applyEmptyProject(emptyProject);
            
            // Reset any room-editing UI state
            if (typeof isEditingRoom !== 'undefined') isEditingRoom = null;
            if (typeof selectedRoomId !== 'undefined') selectedRoomId = null;
            if (typeof currentRoomType !== 'undefined') currentRoomType = null;
            
            // Clear forms if they exist
            const siteForm = document.getElementById('siteForm');
            if (siteForm) siteForm.reset();
            
            // Set form values to match empty project
            const siteDateInput = document.getElementById('site-date');
            if (siteDateInput) siteDateInput.value = emptyProject.siteData.date;
            const stateInput = document.getElementById('site-state');
            if (stateInput) stateInput.value = 'CA';
            
            // Update displays
            updateCurrentProjectDisplay();
            
            // Re-render entries to clear any displayed cards
            if (typeof renderEntries === 'function') {
                renderEntries(true);
            }
            
            console.log('[newProject] Created empty project with ID:', emptyProject.project_id);
        }
        
        // Attach resume/discard button handlers
        document.addEventListener('DOMContentLoaded', () => {
            const resumeBtn = document.getElementById('resumeBtn');
            const discardBtn = document.getElementById('discardBtn');
            
            if (resumeBtn) {
                resumeBtn.addEventListener('click', resumeInProgressWork);
            }
            if (discardBtn) {
                discardBtn.addEventListener('click', discardInProgressWork);
            }
        });

        // Set default state value to CA if not already selected
        const stateSelect = document.getElementById('site-state');
        if (stateSelect && !stateSelect.value) {
            stateSelect.value = 'CA';
        }

        // Auto-save site details as user types to prevent data loss on crashes
        function autoSaveSiteDetails() {
            siteData.date = document.getElementById('site-date').value;
            siteData.customer = document.getElementById('site-customer').value.trim();
            siteData.street = document.getElementById('site-street').value.trim();
            siteData.city = document.getElementById('site-city').value.trim();
            siteData.state = document.getElementById('site-state').value;
            siteData.zip = document.getElementById('site-zip').value.trim();
            siteData.contact = document.getElementById('site-contact').value.trim();
            siteData.phone = document.getElementById('site-phone').value.trim();
            siteData.utility = computeUtilityValue();
            ProjectState.markDirty();
            SaveController.queueSave('site-details-input');
        }

        // Add event listeners to all site form fields for auto-save
        const siteFieldIds = ['site-customer', 'site-street', 'site-city', 'site-state', 'site-zip', 'site-contact', 'site-phone', 'site-utility'];
        siteFieldIds.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                // Use 'input' event for text fields and 'change' for select
                const eventType = field.tagName === 'SELECT' ? 'change' : 'input';
                field.addEventListener(eventType, autoSaveSiteDetails);
            }
        });

        // Format phone input as (xxx) xxx-xxxx during input
        const phoneInput = document.getElementById('site-phone');
        if (phoneInput) {
            phoneInput.addEventListener('input', (e) => {
                // Remove non-digit characters
                let digits = e.target.value.replace(/\D/g, '');
                let formatted = '';
                if (digits.length > 0) {
                    formatted += '(' + digits.substring(0, Math.min(3, digits.length));
                }
                if (digits.length >= 4) {
                    formatted += ') ' + digits.substring(3, Math.min(6, digits.length));
                }
                if (digits.length >= 7) {
                    formatted += '-' + digits.substring(6, 10);
                }
                e.target.value = formatted;
            });
        }

        // Toggle visibility of the legacy "Save Customer Info" button container
        function setSaveCustomerInfoVisible(visible) {
            const el = document.getElementById('bottomSaveContainer');
            if (!el) return;
            if (visible) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        // Save Customer Info button - allows saving site details without units
        const saveProjectBtn = document.getElementById('saveProjectBtn');
        if (saveProjectBtn) {
            saveProjectBtn.addEventListener('click', () => {
                // Ensure customer field is filled
                const customer = document.getElementById('site-customer').value.trim();
                if (!customer) {
                    showToast('Please enter a customer name before saving.', 'warning');
                    return;
                }
                // Update siteData
                autoSaveSiteDetails();
                
                // Save ONLY customer info (no units) by temporarily clearing entries
                const savedEntries = entries; // Backup current entries
                entries = []; // Clear entries so only customer info is saved
                addProjectToSaved();
                entries = savedEntries; // Restore entries
                
                showToast(`Customer info saved for "${customer}". You can load it later from the dropdown above.`, 'success');
            });
        }

        // Edit Saved Projects functionality
        const editSavedProjectsLink = document.getElementById('editSavedProjectsLink');
        const editSavedProjectsContainer = document.getElementById('editSavedProjectsContainer');
        const savedProjectsChecklistContainer = document.getElementById('savedProjectsChecklistContainer');
        const deleteSelectedProjectsBtn = document.getElementById('deleteSelectedProjectsBtn');
        const cancelEditProjectsBtn = document.getElementById('cancelEditProjectsBtn');

        // Function to populate the edit list with checkboxes (fetches from server)
        async function populateEditProjectsList() {
            try {
                // Show loading state
                savedProjectsChecklistContainer.innerHTML = '<p style="color:#666; font-style:italic;">Loading projects...</p>';
                
                // Reset Select All checkbox
                const selectAllCheckbox = document.getElementById('selectAllProjectsCheckbox');
                if (selectAllCheckbox) selectAllCheckbox.checked = false;
                
                // Fetch from server using ProjectService (backend is source of truth)
                const allProjects = await ProjectService.listProjects();
                
                if (allProjects.length === 0) {
                    savedProjectsChecklistContainer.innerHTML = '<p style="color:#666; font-style:italic;">No saved projects to edit.</p>';
                    return;
                }
                
                savedProjectsChecklistContainer.innerHTML = '';
                
                // Show all projects with checkboxes
                allProjects.forEach((proj, idx) => {
                    let label = proj.customer;
                    if (proj.evapCount || proj.condCount) {
                        label += ` (${proj.evapCount} evap, ${proj.condCount} cond)`;
                    }
                    // Add owner name for admin multi-user view
                    if (proj.owner_name && proj.owner_name !== 'Carlisle Energy') {
                        label += ` - ${proj.owner_name}`;
                    }
                    // Format timestamp
                    if (proj.saved_at) {
                        try {
                            const d = new Date(proj.saved_at);
                            const mm = String(d.getMonth() + 1).padStart(2, '0');
                            const dd = String(d.getDate()).padStart(2, '0');
                            const yy = String(d.getFullYear()).slice(-2);
                            const hh = String(d.getHours()).padStart(2, '0');
                            const min = String(d.getMinutes()).padStart(2, '0');
                            label += ` - ${mm}/${dd}/${yy} ${hh}:${min}`;
                        } catch (e) {}
                    }
                    
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.style.padding = '0.5rem';
                    checkboxDiv.style.borderBottom = '1px solid #ddd';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = proj.id; // Use project ID instead of array index
                    checkbox.dataset.source = proj.source;
                    checkbox.id = `project-checkbox-${idx}`;
                    checkbox.style.marginRight = '0.5rem';
                    
                    const labelEl = document.createElement('label');
                    labelEl.htmlFor = `project-checkbox-${idx}`;
                    labelEl.textContent = label;
                    labelEl.style.cursor = 'pointer';
                    
                    checkboxDiv.appendChild(checkbox);
                    checkboxDiv.appendChild(labelEl);
                    savedProjectsChecklistContainer.appendChild(checkboxDiv);
                });
            } catch (e) {
                console.error('Error loading projects for edit:', e);
                savedProjectsChecklistContainer.innerHTML = '<p style="color:#d9534f;">Error loading projects.</p>';
            }
        }

        // Show edit list when "Edit List..." is clicked
        if (editSavedProjectsLink) {
            editSavedProjectsLink.addEventListener('click', (e) => {
                e.preventDefault();
                populateEditProjectsList();
                editSavedProjectsContainer.classList.remove('hidden');
            });
        }

        // Cancel editing
        if (cancelEditProjectsBtn) {
            cancelEditProjectsBtn.addEventListener('click', () => {
                editSavedProjectsContainer.classList.add('hidden');
                // Reset Select All checkbox when closing
                const selectAllCheckbox = document.getElementById('selectAllProjectsCheckbox');
                if (selectAllCheckbox) selectAllCheckbox.checked = false;
            });
        }

        // Select All checkbox handler
        const selectAllCheckbox = document.getElementById('selectAllProjectsCheckbox');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', (e) => {
                const checkboxes = savedProjectsChecklistContainer.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = e.target.checked;
                });
            });
        }

        // Delete selected projects (from both server and localStorage)
        if (deleteSelectedProjectsBtn) {
            deleteSelectedProjectsBtn.addEventListener('click', async () => {
                const checkboxes = savedProjectsChecklistContainer.querySelectorAll('input[type="checkbox"]:checked');
                
                if (checkboxes.length === 0) {
                    showToast('Please select at least one project to delete.', 'warning');
                    return;
                }
                
                const confirmMsg = `Are you sure you want to delete ${checkboxes.length} project(s)?\nThis cannot be undone.`;
                const confirmed = await showConfirmModal({
                    title: 'Delete Projects',
                    message: confirmMsg,
                    confirmText: 'Delete',
                    cancelText: 'Cancel',
                    danger: true
                });
                if (!confirmed) return;
                
                try {
                    // Get project IDs to delete
                    const projectIdsToDelete = Array.from(checkboxes).map(cb => cb.value);
                    
                    // Delete from server (async)
                    const deletePromises = projectIdsToDelete.map(async (projectId) => {
                        try {
                            const response = await fetch(`/api/data/${projectId}`, {
                                method: 'DELETE',
                                headers: {
                                    'X-User-Id': 'default',
                                    'X-User-Role': 'admin'
                                }
                            });
                            if (response.ok) {
                                console.log('✓ Deleted from server:', projectId);
                            } else {
                                console.warn('⚠️ Failed to delete from server:', projectId);
                            }
                        } catch (e) {
                            console.warn('⚠️ Server delete error for', projectId, ':', e.message);
                        }
                    });
                    
                    // Wait for all server deletions to complete
                    await Promise.all(deletePromises);
                    
                    // Refresh project cache (backend is source of truth)
                    await ProjectService.listProjects();
                    
                    // Refresh the edit list and show confirmation
                    await populateEditProjectsList();
                    showToast(`${checkboxes.length} project(s) deleted successfully.`, 'success');
                } catch (e) {
                    console.error('Delete error:', e);
                    showToast('Error deleting projects. Please try again.', 'error');
                }
            });
        }

        // Format blade spec input as XX/XX/XX with auto-advance
        const bladeSpecInput = document.getElementById('room-bladeSpec');
        if (bladeSpecInput) {
            bladeSpecInput.addEventListener('input', (e) => {
                const cursorPos = e.target.selectionStart;
                const oldValue = e.target.value;
                
                // Only auto-format if input contains only digits and slashes
                const hasOnlyDigitsAndSlashes = /^[0-9/]*$/.test(oldValue);
                if (!hasOnlyDigitsAndSlashes) {
                    // Preserve legacy values or non-standard input
                    return;
                }
                
                // Remove non-numeric characters except forward slash
                let value = oldValue.replace(/[^0-9/]/g, '');
                // Remove multiple consecutive slashes
                value = value.replace(/\/{2,}/g, '/');
                // Split by slash to get parts
                let parts = value.split('/');
                // Limit each part to 2 digits
                parts = parts.map(part => part.substring(0, 2));
                // Only keep first 3 parts
                parts = parts.slice(0, 3);
                
                // Auto-insert slashes after 2 digits
                let formatted = '';
                for (let i = 0; i < parts.length; i++) {
                    formatted += parts[i];
                    // Add slash after part if it has 2 digits and we're not at the last part
                    if (parts[i].length === 2 && i < 2 && i === parts.length - 1) {
                        formatted += '/';
                    } else if (i < parts.length - 1) {
                        formatted += '/';
                    }
                }
                
                // Calculate new cursor position
                let newCursorPos = cursorPos;
                if (formatted.length > oldValue.length && formatted[cursorPos] === '/') {
                    // Slash was auto-inserted, move cursor past it
                    newCursorPos = cursorPos + 1;
                }
                
                e.target.value = formatted;
                e.target.setSelectionRange(newCursorPos, newCursorPos);
            });
        }

        // Populate count datalist (1-100)
        const countList = document.getElementById('count-options');
        for (let i = 1; i <= 100; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            countList.appendChild(opt);
        }

        // Helper function: compute utility value from form (returns "Other -- CustomName" if Other selected)
        function computeUtilityValue() {
            const utilitySelect = document.getElementById('site-utility');
            const utilityOtherInput = document.getElementById('site-utility-other');
            
            if (!utilitySelect) return '';
            
            const selectedValue = utilitySelect.value;
            
            // If "Other" is selected, return "Other -- CustomName" format
            if (selectedValue === 'Other' && utilityOtherInput && utilityOtherInput.value.trim()) {
                return `Other -- ${utilityOtherInput.value.trim()}`;
            }
            
            // Otherwise return the selected standard utility
            return selectedValue;
        }
        
        // Helper function: apply utility value to form (sets dropdown and shows/hides Other input)
        function applyUtilityToForm(utilityValue) {
            const utilitySelect = document.getElementById('site-utility');
            const utilityOtherContainer = document.getElementById('site-utility-other-container');
            const utilityOtherInput = document.getElementById('site-utility-other');
            
            if (!utilitySelect) return;
            
            if (!utilityValue || utilityValue.trim() === '') {
                utilitySelect.value = '';
                if (utilityOtherContainer) utilityOtherContainer.classList.add('hidden');
                if (utilityOtherInput) utilityOtherInput.value = '';
                return;
            }
            
            // Check if it's in "Other -- CustomName" format
            if (utilityValue.startsWith('Other -- ')) {
                const customName = utilityValue.substring('Other -- '.length);
                utilitySelect.value = 'Other';
                if (utilityOtherInput) utilityOtherInput.value = customName;
                if (utilityOtherContainer) utilityOtherContainer.classList.remove('hidden');
            } else {
                // Try to select the value in the dropdown
                utilitySelect.value = utilityValue;
                
                // If the value doesn't exist in dropdown, it might be a custom utility that should be there
                if (utilitySelect.value === '') {
                    // Value not found, treat as Other
                    utilitySelect.value = 'Other';
                    if (utilityOtherInput) utilityOtherInput.value = utilityValue;
                    if (utilityOtherContainer) utilityOtherContainer.classList.remove('hidden');
                } else {
                    // Standard utility selected, hide Other input
                    if (utilityOtherContainer) utilityOtherContainer.classList.add('hidden');
                    if (utilityOtherInput) utilityOtherInput.value = '';
                }
            }
        }
        
        // Populate utility dropdown with custom utilities from saved projects as permanent options
        async function populateUtilityDropdown() {
            try {
                // Standard utilities (already in HTML)
                const standardUtilities = new Set([
                    'LADWP', 'Vernon', 'SCE', 'PG&E', 'SDG&E', 'RPU', 'Anaheim',
                    'TID', 'Hawaii Energy', 'NV Energy', 'Pilgrim', 'Azusa Light & Water',
                    'Chicago', 'Eversource - Boston', 'FPL - FL', 'IID',
                    'MPD Electric - Carolinas', 'PSEG', 'RMP - Utah'
                ]);

                // Get all utilities from saved projects using ProjectService (backend is source of truth)
                const serverProjects = await ProjectService.listProjects();
                
                // Collect unique custom utilities (extract from "Other -- CustomName" format)
                const customUtilities = new Set();
                
                // From server projects
                serverProjects.forEach(proj => {
                    const utility = proj.utility;
                    if (utility && utility.trim()) {
                        // Check if it's in "Other -- CustomName" format
                        if (utility.startsWith('Other -- ')) {
                            const customName = utility.substring('Other -- '.length).trim();
                            if (customName && !standardUtilities.has(customName)) {
                                customUtilities.add(customName);
                            }
                        } else if (!standardUtilities.has(utility.trim())) {
                            // Legacy custom utility (not in standard list and not in Other format)
                            customUtilities.add(utility.trim());
                        }
                    }
                });
                
                // Add custom utilities to the dropdown BEFORE the "Other" option
                const utilitySelect = document.getElementById('site-utility');
                if (utilitySelect && customUtilities.size > 0) {
                    // Find the "Other" option
                    const otherOption = Array.from(utilitySelect.options).find(opt => opt.value === 'Other');
                    
                    // Sort custom utilities alphabetically
                    const sortedCustomUtilities = Array.from(customUtilities).sort();
                    
                    sortedCustomUtilities.forEach(utility => {
                        const opt = document.createElement('option');
                        opt.value = utility;
                        opt.textContent = utility;
                        
                        // Insert before "Other" option
                        if (otherOption) {
                            utilitySelect.insertBefore(opt, otherOption);
                        } else {
                            utilitySelect.appendChild(opt);
                        }
                    });
                    console.log(`✓ Added ${customUtilities.size} custom utilities to dropdown`);
                }
            } catch (e) {
                console.error('❌ Failed to populate utility dropdown:', e);
            }
        }
        
        // Event listener for utility dropdown change to show/hide "Other" input
        document.addEventListener('DOMContentLoaded', () => {
            const utilitySelect = document.getElementById('site-utility');
            const utilityOtherContainer = document.getElementById('site-utility-other-container');
            
            if (utilitySelect && utilityOtherContainer) {
                utilitySelect.addEventListener('change', () => {
                    if (utilitySelect.value === 'Other') {
                        utilityOtherContainer.classList.remove('hidden');
                    } else {
                        utilityOtherContainer.classList.add('hidden');
                        const utilityOtherInput = document.getElementById('site-utility-other');
                        if (utilityOtherInput) utilityOtherInput.value = '';
                    }
                    // Trigger auto-save
                    autoSaveSiteDetails();
                });
                
                // Also add listener to the "Other" input field for auto-save
                const utilityOtherInput = document.getElementById('site-utility-other');
                if (utilityOtherInput) {
                    utilityOtherInput.addEventListener('input', autoSaveSiteDetails);
                }
            }
            
            // Populate custom utilities in dropdown on page load
            populateUtilityDropdown();
        });

        // Save site fields in memory only (no persistence).  Whenever a field changes we update siteData.
        siteForm.addEventListener('change', () => {
            siteData.date = document.getElementById('site-date').value;
            // Also save visitDate in M/D/YY format for CSV export (parse manually to avoid timezone issues)
            if (siteData.date) {
                const dateParts = siteData.date.split('-'); // YYYY-MM-DD format
                if (dateParts.length === 3) {
                    const year = dateParts[0];
                    const month = parseInt(dateParts[1], 10); // Remove leading zero
                    const day = parseInt(dateParts[2], 10); // Remove leading zero
                    const yy = year.slice(-2);
                    siteData.visitDate = `${month}/${day}/${yy}`;
                    // Update display
                    const visitDateText = document.getElementById('visitDateText');
                    if (visitDateText) {
                        visitDateText.textContent = siteData.visitDate;
                    }
                }
            }
            siteData.customer = document.getElementById('site-customer').value;
            siteData.street = document.getElementById('site-street').value;
            siteData.city = document.getElementById('site-city').value;
            siteData.state = document.getElementById('site-state').value;
            siteData.zip = document.getElementById('site-zip').value;
            siteData.contact = document.getElementById('site-contact').value;
            siteData.phone = document.getElementById('site-phone').value;
            siteData.utility = computeUtilityValue();

            // Persist site data changes
            SaveController.queueSave('site-form-change');
        });

        // Address suggestions: user does not want persistence or previous entry suggestions,
        // so we do not populate the datalist. The browser's built‑in autocomplete may still assist.

        // Proceed button: hide site section and show data section
        proceedBtn.addEventListener('click', () => {
            // store site data one last time
            siteData.date = document.getElementById('site-date').value;
            siteData.customer = document.getElementById('site-customer').value;
            siteData.street = document.getElementById('site-street').value;
            siteData.city = document.getElementById('site-city').value;
            siteData.state = document.getElementById('site-state').value;
            siteData.zip = document.getElementById('site-zip').value;
            siteData.contact = document.getElementById('site-contact').value;
            siteData.phone = document.getElementById('site-phone').value;
            siteData.utility = computeUtilityValue();
            
            // Update Site Address display
            const addressParts = [];
            if (siteData.street) addressParts.push(siteData.street);
            const cityStateZip = [siteData.city, siteData.state, siteData.zip].filter(v => v).join(', ');
            if (cityStateZip) addressParts.push(cityStateZip);
            document.getElementById('siteAddressText').textContent = addressParts.join(', ') || 'No address provided';
            
            // Update visit date display from the date input (parse manually to avoid timezone issues)
            if (siteData.date) {
                const dateParts = siteData.date.split('-'); // YYYY-MM-DD format
                if (dateParts.length === 3) {
                    const year = dateParts[0];
                    const month = parseInt(dateParts[1], 10); // Remove leading zero
                    const day = parseInt(dateParts[2], 10); // Remove leading zero
                    const yy = year.slice(-2);
                    const visitDateDisplay = `${month}/${day}/${yy}`;
                    document.getElementById('visitDateText').textContent = visitDateDisplay;
                    siteData.visitDate = visitDateDisplay;
                }
            }
            
            // hide site section and show data section
            siteSection.classList.add('hidden');
            dataSection.classList.remove('hidden');
            // Hide the legacy "Save Customer Info" button in data collection view
            setSaveCustomerInfoVisible(false);
            
            // Show edit site pencil icon
            const editSiteBtnElem = document.getElementById('editSiteBtn');
            if (editSiteBtnElem) {
                editSiteBtnElem.classList.remove('hidden');
            }

            // update header lines
            const forLineEl = document.getElementById('forLine');
            const customerNameEl = document.getElementById('customerName');
            const { customer } = siteData;
            if (forLineEl && customerNameEl) {
                if (customer) {
                    customerNameEl.textContent = customer;
                } else {
                    customerNameEl.textContent = '';
                }
            }
        });

        // Current section (evap or cond) when adding
        let currentSection = null;

        // Cancel button hides the form and clears editIndex
        cancelBtn.addEventListener('click', () => {
            closeForm();
            editIndex = null;
        });
        
        // Form header cancel button - same functionality
        formHeaderCancelBtn.addEventListener('click', () => {
            closeForm();
            editIndex = null;
        });
        
        // Top buttons - same functionality as bottom buttons
        const formTopSaveBtn = document.getElementById('formTopSaveBtn');
        const formTopCancelBtn = document.getElementById('formTopCancelBtn');
        
        formTopSaveBtn.addEventListener('click', () => {
            roomForm.requestSubmit();
        });
        
        formTopCancelBtn.addEventListener('click', () => {
            closeForm();
            editIndex = null;
        });
        
        // ==================================================================================
        // CUSTOM DELETE CONFIRMATION MODAL
        // ==================================================================================
        // Shows a custom modal instead of native confirm() to work around iOS keyboard issues.
        // The modal dismisses the keyboard first, ensuring the dialog is fully visible.
        
        function showDeleteConfirmModal(itemType = 'room') {
            return new Promise((resolve) => {
                // Blur any focused input to dismiss iOS keyboard FIRST
                if (document.activeElement && document.activeElement.blur) {
                    document.activeElement.blur();
                }
                
                // Wait a moment for keyboard to dismiss before showing modal
                setTimeout(() => {
                    const modal = document.getElementById('deleteConfirmModal');
                    const message = document.getElementById('deleteConfirmMessage');
                    const cancelBtn = document.getElementById('deleteConfirmCancelBtn');
                    const deleteBtn = document.getElementById('deleteConfirmDeleteBtn');
                    
                    // Set message based on item type
                    message.textContent = `Are you sure you want to delete this ${itemType}?`;
                    
                    modal.classList.remove('hidden');
                    
                    function cleanup() {
                        modal.classList.add('hidden');
                        cancelBtn.removeEventListener('click', onCancel);
                        deleteBtn.removeEventListener('click', onDelete);
                    }
                    
                    function onCancel() {
                        cleanup();
                        resolve(false);
                    }
                    
                    function onDelete() {
                        cleanup();
                        resolve(true);
                    }
                    
                    cancelBtn.addEventListener('click', onCancel);
                    deleteBtn.addEventListener('click', onDelete);
                }, 100); // Short delay to let keyboard dismiss
            });
        }
        
        // Shared delete function for entries - used by Delete Room button AND trash icon in reorder mode
        async function deleteEntryAtIndex(index, closeFormAfter = false) {
            if (index < 0 || index >= entries.length) return;
            
            const entry = entries[index];
            const itemType = entry.section === 'evap' ? 'evaporator' : 'condenser';
            
            const confirmed = await showDeleteConfirmModal(itemType);
            if (!confirmed) return;
            
            entries.splice(index, 1);
            ProjectState.markDirty();
            
            if (closeFormAfter) {
                editIndex = null;
                closeForm();
            }
            
            renderEntries();
            
            // Auto-sync to server after deleting equipment
            if (siteData.customer) {
                addProjectToSaved().catch(e => console.error('Auto-sync failed:', e));
            }
        }
        
        // Delete Room button - only visible when editing existing room
        // Uses shared deleteEntryAtIndex function with custom confirmation modal
        deleteRoomBtn.addEventListener('click', async () => {
            if (editIndex === null) return;
            await deleteEntryAtIndex(editIndex, true);
        });

        function openForm(entry, index) {
            // set form title and labels based on section
            const submitBtn = document.getElementById('formSubmitBtn');
            const topSaveBtn = document.getElementById('formTopSaveBtn');
            if (currentSection === 'evap') {
                // Determine sheet number for evaporators (if editing, use existing; if new, next index)
                let sheetNumber;
                if (entry && typeof entry.sheetNumber !== 'undefined') {
                    sheetNumber = entry.sheetNumber;
                } else {
                    // count existing evaporators to assign next sheet number
                    const countEvaps = entries.filter(e => e.section === 'evap').length;
                    sheetNumber = countEvaps + 1;
                }
                formTitle.textContent = 'Sheet ' + sheetNumber + ' Evaporators';
                document.getElementById('count-label').textContent = 'Evaporator Count';
                document.getElementById('split-field').classList.add('hidden');
                document.getElementById('temp-fields').classList.remove('hidden');
                submitBtn.textContent = 'Save Evaporator';
                topSaveBtn.textContent = 'Save Evaporator';
            } else {
                formTitle.textContent = 'New Condenser';
                document.getElementById('count-label').textContent = 'Condenser Count';
                document.getElementById('split-field').classList.remove('hidden');
                document.getElementById('temp-fields').classList.add('hidden');
                submitBtn.textContent = 'Save Condenser';
                topSaveBtn.textContent = 'Save Condenser';
            }
            // Hide customer info section when editing a room
            const customerInfoView = document.getElementById('customerInfoView');
            if (customerInfoView) customerInfoView.classList.add('hidden');
            // Hide the legacy "Save Customer Info" button while editing a room
            setSaveCustomerInfoVisible(false);
            
            // show form
            roomForm.classList.remove('hidden');
            // set hidden fields
            document.getElementById('room-section').value = currentSection;
            document.getElementById('room-mode').value = 'detailed';
            // if index provided, we are editing existing entry
            if (typeof index === 'number') {
                editIndex = index;
            } else if (!entry) {
                editIndex = null;
                roomForm.reset();
                document.getElementById('custom-mount-field').classList.add('hidden');
                document.getElementById('custom-hp-field').classList.add('hidden');
                document.getElementById('custom-mfg-field').classList.add('hidden');
                document.getElementById('custom-zone-field').classList.add('hidden');
                document.getElementById('custom-adapter-field').classList.add('hidden');
            }
            if (entry) {
                // populate fields
                
                // Handle zone field - check if value exists in dropdown
                const zoneValue = entry['room-zone'] || '';
                const zoneSelect = document.getElementById('room-zone');
                const zoneOptions = Array.from(zoneSelect.options).map(opt => opt.value);
                if (zoneValue && !zoneOptions.includes(zoneValue) && zoneValue !== 'custom') {
                    // Custom zone - select "Other..." and show custom field
                    zoneSelect.value = 'custom';
                    document.getElementById('custom-zone-field').classList.remove('hidden');
                    document.getElementById('room-zoneCustom').value = zoneValue;
                } else {
                    zoneSelect.value = zoneValue;
                    document.getElementById('custom-zone-field').classList.add('hidden');
                }
                
                document.getElementById('room-name').value = entry['room-name'] || entry['room-roomname'] || '';
                
                // Handle manufacturer field - check if value exists in dropdown
                const mfgValue = entry['room-mfg'] || '';
                const mfgSelect = document.getElementById('room-mfg');
                const mfgOptions = Array.from(mfgSelect.options).map(opt => opt.value);
                if (mfgValue && !mfgOptions.includes(mfgValue)) {
                    // Custom manufacturer - select "Other" and show custom field
                    mfgSelect.value = 'Other (type new)';
                    document.getElementById('custom-mfg-field').classList.remove('hidden');
                    document.getElementById('room-mfgCustom').value = mfgValue;
                } else {
                    mfgSelect.value = mfgValue;
                    document.getElementById('custom-mfg-field').classList.add('hidden');
                }
                
                document.getElementById('room-count').value = entry['room-count'] || '';
                document.getElementById('room-fanMotorsPerUnit').value = entry['room-fanMotorsPerUnit'] || '';
                document.getElementById('room-voltage').value = entry['room-voltage'] || '';
                document.getElementById('room-phase').value = entry['room-phase'] || '';
                document.getElementById('room-amps').value = entry['room-amps'] || '';
                
                // Handle HP field - check if value exists in dropdown
                const hpValue = entry['room-hp'] || '';
                const hpSelect = document.getElementById('room-hp');
                const hpOptions = Array.from(hpSelect.options).map(opt => opt.value);
                if (hpValue && !hpOptions.includes(hpValue)) {
                    // Custom HP - select "Other" and show custom field
                    hpSelect.value = 'Other';
                    document.getElementById('custom-hp-field').classList.remove('hidden');
                    document.getElementById('room-hpCustom').value = hpValue;
                } else {
                    hpSelect.value = hpValue;
                    document.getElementById('custom-hp-field').classList.add('hidden');
                }
                
                document.getElementById('room-motorMounting').value = entry['room-motorMounting'] || '';
                
                // Handle Frame field - check if value exists in dropdown
                const frameValue = entry['room-frame'] || '';
                const frameSelect = document.getElementById('room-frame');
                const frameOptions = Array.from(frameSelect.options).map(opt => opt.value);
                if (frameValue && !frameOptions.includes(frameValue)) {
                    // Custom frame - select "Other" and show custom field
                    frameSelect.value = 'Other';
                    document.getElementById('custom-frame-field').classList.remove('hidden');
                    document.getElementById('room-frameCustom').value = frameValue;
                } else {
                    frameSelect.value = frameValue;
                    document.getElementById('custom-frame-field').classList.add('hidden');
                }
                
                // Handle RPM field - check if value exists in dropdown
                const rpmValue = entry['room-rpm'] || '';
                const rpmSelect = document.getElementById('room-rpm');
                const rpmOptions = Array.from(rpmSelect.options).map(opt => opt.value);
                if (rpmValue && !rpmOptions.includes(rpmValue)) {
                    // Custom RPM - select "Other" and show custom field
                    rpmSelect.value = 'Other';
                    document.getElementById('custom-rpm-field').classList.remove('hidden');
                    document.getElementById('room-rpmCustom').value = rpmValue;
                } else {
                    rpmSelect.value = rpmValue;
                    document.getElementById('custom-rpm-field').classList.add('hidden');
                }
                
                document.getElementById('room-notes').value = entry['room-notes'] || '';
                document.getElementById('room-section').value = entry.section || currentSection;
                document.getElementById('room-mode').value = entry.mode || 'detailed';
                // condenser specific
                if (entry.section === 'cond') {
                    document.getElementById('room-split').value = entry['room-split'] || 'No';
                }
                // detailed fields
                document.getElementById('room-bladeSpec').value = entry['room-bladeSpec'] || '';
                // set shaft adapters select and adapter type field
                const shaftSelect = document.getElementById('room-shaftAdapters');
                const adapterTypeField = document.getElementById('adapter-type-field');
                const adapterQtyField = document.getElementById('adapter-qty-field');
                const adapterTypeSelect = document.getElementById('room-shaftAdapterType');
                const adapterTypeCustomField = document.getElementById('custom-adapter-field');
                const shaftVal = entry['room-shaftAdapters'] || 'No';
                shaftSelect.value = shaftVal;
                if (shaftVal === 'Yes') {
                    adapterTypeField.classList.remove('hidden');
                    adapterQtyField.classList.remove('hidden');
                    // Handle adapter type - check if value exists in dropdown
                    const adapterValue = entry['room-shaftAdapterType'] || '';
                    const adapterOptions = Array.from(adapterTypeSelect.options).map(opt => opt.value);
                    if (adapterValue && !adapterOptions.includes(adapterValue) && adapterValue !== 'custom') {
                        // Custom adapter type - select "Other..." and show custom field
                        adapterTypeSelect.value = 'custom';
                        adapterTypeCustomField.classList.remove('hidden');
                        document.getElementById('room-shaftAdapterTypeCustom').value = adapterValue;
                    } else {
                        adapterTypeSelect.value = adapterValue;
                        adapterTypeCustomField.classList.add('hidden');
                    }
                    // Populate adapter qty (will recalculate automatically)
                    document.getElementById('room-shaftAdapterQty').value = entry['room-shaftAdapterQty'] || '';
                } else {
                    adapterTypeField.classList.add('hidden');
                    adapterQtyField.classList.add('hidden');
                    adapterTypeCustomField.classList.add('hidden');
                    adapterTypeSelect.value = '';
                    document.getElementById('room-shaftAdapterQty').value = '';
                }
                document.getElementById('room-bladesNeeded').value = entry['room-bladesNeeded'] || '';
                // Display Run Time with % suffix (stored as numeric 0-100)
                const runTimeVal = entry['room-runTime'] || '';
                document.getElementById('room-runTime').value = runTimeVal ? runTimeVal + '%' : '';
                document.getElementById('room-shaftSize').value = entry['room-shaftSize'] || '';
                document.getElementById('room-rotation').value = entry['room-rotation'] || '';
                // custom mount
                if (entry['room-motorMounting'] === 'custom' || entry['room-motorMountingCustom']) {
                    document.getElementById('room-motorMounting').value = 'custom';
                    document.getElementById('custom-mount-field').classList.remove('hidden');
                    document.getElementById('room-motorMountingCustom').value = entry['room-motorMountingCustom'] || '';
                }
                // temperature fields (evap only)
                document.getElementById('room-currentTemp').value = entry['room-currentTemp'] || '';
                document.getElementById('room-setPoint').value = entry['room-setPoint'] || '';
            }
            // update blades options if in detailed mode
            updateBladesOptions();
            
            // Show/hide Delete Room button based on whether editing or adding new
            if (typeof index === 'number') {
                // Editing existing room - show Delete button
                deleteRoomBtn.style.display = 'inline-block';
                // Set edit mode state
                editingRoomId = index;
                document.body.classList.add('editing-room');
                // Mark the card being edited
                setTimeout(() => {
                    const cards = document.querySelectorAll('.card');
                    cards.forEach((card, cardIndex) => {
                        if (parseInt(card.getAttribute('data-index')) === index) {
                            card.classList.add('editing');
                        }
                    });
                }, 10);
            } else {
                // Adding new room - hide Delete button
                deleteRoomBtn.style.display = 'none';
                editingRoomId = null;
                document.body.classList.remove('editing-room');
            }
            
            // focus on last edited field, or room-name if new entry
            const fieldToFocus = (entry && lastEditedFieldId && document.getElementById(lastEditedFieldId)) 
                ? document.getElementById(lastEditedFieldId) 
                : document.getElementById('room-name');
            if (fieldToFocus) {
                fieldToFocus.focus();
                // Scroll the field into view smoothly
                setTimeout(() => {
                    fieldToFocus.scrollIntoView({ block: 'center', behavior: 'smooth' });
                }, 100);
            }
            // update Enter navigation
            setupEnterNavigation();

            // hide export/import buttons while form is open
            const exportImport = document.getElementById('exportImportSection');
            if (exportImport) exportImport.classList.add('hidden');
        }

        // Utility function to exit edit mode and clean up state
        function exitEditMode() {
            // Remove "editing-room" class from body
            document.body.classList.remove('editing-room');
            
            // Remove "editing" class from any cards
            document.querySelectorAll('.card.editing').forEach(card => {
                card.classList.remove('editing');
            });
            
            // Reset editingRoomId to null
            editingRoomId = null;
        }

        function closeForm() {
            roomForm.reset();
            roomForm.classList.add('hidden');
            document.getElementById('custom-mount-field').classList.add('hidden');
            document.getElementById('custom-hp-field').classList.add('hidden');
            document.getElementById('custom-frame-field').classList.add('hidden');
            document.getElementById('custom-rpm-field').classList.add('hidden');
            document.getElementById('custom-mfg-field').classList.add('hidden');
            document.getElementById('custom-zone-field').classList.add('hidden');
            document.getElementById('custom-adapter-field').classList.add('hidden');
            document.getElementById('adapter-type-field').classList.add('hidden');
            document.getElementById('adapter-qty-field').classList.add('hidden');
            document.getElementById('temp-fields').classList.add('hidden');
            
            // Show customer info section when closing form
            const customerInfoView = document.getElementById('customerInfoView');
            if (customerInfoView) customerInfoView.classList.remove('hidden');
            
            // Exit edit mode and clean up state
            exitEditMode();
            
            // show export/import buttons again
            const exportImport = document.getElementById('exportImportSection');
            if (exportImport) exportImport.classList.remove('hidden');
        }

        // respond to motor mount selection to show custom field
        document.getElementById('room-motorMounting').addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                document.getElementById('custom-mount-field').classList.remove('hidden');
            } else {
                document.getElementById('custom-mount-field').classList.add('hidden');
                document.getElementById('room-motorMountingCustom').value = '';
            }
        });

        // respond to HP selection to show custom field
        document.getElementById('room-hp').addEventListener('change', (e) => {
            if (e.target.value === 'Other') {
                document.getElementById('custom-hp-field').classList.remove('hidden');
            } else {
                document.getElementById('custom-hp-field').classList.add('hidden');
                document.getElementById('room-hpCustom').value = '';
            }
        });

        // respond to Frame selection to show custom field
        document.getElementById('room-frame').addEventListener('change', (e) => {
            if (e.target.value === 'Other') {
                document.getElementById('custom-frame-field').classList.remove('hidden');
            } else {
                document.getElementById('custom-frame-field').classList.add('hidden');
                document.getElementById('room-frameCustom').value = '';
            }
        });

        // respond to RPM selection to show custom field
        document.getElementById('room-rpm').addEventListener('change', (e) => {
            if (e.target.value === 'Other') {
                document.getElementById('custom-rpm-field').classList.remove('hidden');
            } else {
                document.getElementById('custom-rpm-field').classList.add('hidden');
                document.getElementById('room-rpmCustom').value = '';
            }
        });

        // respond to manufacturer selection to show custom field
        document.getElementById('room-mfg').addEventListener('change', (e) => {
            if (e.target.value === 'Other (type new)') {
                document.getElementById('custom-mfg-field').classList.remove('hidden');
            } else {
                document.getElementById('custom-mfg-field').classList.add('hidden');
                document.getElementById('room-mfgCustom').value = '';
            }
        });

        // respond to zone selection to show custom field
        document.getElementById('room-zone').addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                document.getElementById('custom-zone-field').classList.remove('hidden');
            } else {
                document.getElementById('custom-zone-field').classList.add('hidden');
                document.getElementById('room-zoneCustom').value = '';
            }
        });

        // respond to adapter type selection to show custom field
        document.getElementById('room-shaftAdapterType').addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                document.getElementById('custom-adapter-field').classList.remove('hidden');
            } else {
                document.getElementById('custom-adapter-field').classList.add('hidden');
                document.getElementById('room-shaftAdapterTypeCustom').value = '';
            }
        });

        // Initialize manufacturer dropdown with default options and load custom ones
        function initializeManufacturerDropdown() {
            const mfgSelect = document.getElementById('room-mfg');
            const defaultManufacturers = [
                'Larkin', 'Bohn', 'Century', 'Russell', 'Heatcraft', 
                'Krack', 'Keeprite', 'Evapco', 'Güntner', 'Witt', 
                'Trenton', 'Frigid Coil'
            ];
            
            // Load custom manufacturers from localStorage
            let customMfgs = [];
            try {
                const stored = localStorage.getItem('customManufacturers');
                customMfgs = stored ? JSON.parse(stored) : [];
            } catch (e) {}
            
            // Combine and sort (except "Other" goes last)
            const allMfgs = [...new Set([...defaultManufacturers, ...customMfgs])].sort();
            
            // Clear existing options except the empty one
            mfgSelect.innerHTML = '<option value="">—</option>';
            
            // Add all manufacturers
            allMfgs.forEach(mfg => {
                const opt = document.createElement('option');
                opt.value = mfg;
                opt.textContent = mfg;
                mfgSelect.appendChild(opt);
            });
            
            // Add "Other" option last
            const otherOpt = document.createElement('option');
            otherOpt.value = 'Other (type new)';
            otherOpt.textContent = 'Other (type new)';
            mfgSelect.appendChild(otherOpt);
        }
        
        // Call on page load
        initializeManufacturerDropdown();

        // Auto-calculate shaft adapter quantity (count × motors per unit)
        function calculateAdapterQty() {
            const count = parseInt(document.getElementById('room-count').value) || 0;
            const motorsPerUnit = parseInt(document.getElementById('room-fanMotorsPerUnit').value) || 0;
            const qty = count * motorsPerUnit;
            document.getElementById('room-shaftAdapterQty').value = qty > 0 ? qty : '';
        }

        // show/hide adapter fields based on shaft adapters yes/no
        document.getElementById('room-shaftAdapters').addEventListener('change', (e) => {
            if (e.target.value === 'Yes') {
                document.getElementById('adapter-type-field').classList.remove('hidden');
                document.getElementById('adapter-qty-field').classList.remove('hidden');
                calculateAdapterQty();
            } else {
                document.getElementById('adapter-type-field').classList.add('hidden');
                document.getElementById('adapter-qty-field').classList.add('hidden');
                document.getElementById('room-shaftAdapterType').value = '';
                document.getElementById('room-shaftAdapterQty').value = '';
            }
        });

        // Recalculate adapter qty when count or motors per unit changes
        document.getElementById('room-count').addEventListener('input', () => {
            if (document.getElementById('room-shaftAdapters').value === 'Yes') {
                calculateAdapterQty();
            }
        });
        document.getElementById('room-fanMotorsPerUnit').addEventListener('input', () => {
            if (document.getElementById('room-shaftAdapters').value === 'Yes') {
                calculateAdapterQty();
            }
        });

        // Do not reformat amps field; user may input decimals or integers directly
        
        // Track last edited field for better scroll position when reopening edit form
        roomForm.addEventListener('focusin', (e) => {
            const target = e.target;
            if (target.id && (target.tagName === 'INPUT' || target.tagName === 'SELECT' || target.tagName === 'TEXTAREA')) {
                lastEditedFieldId = target.id;
            }
        });

        // Save a new or edited unit entry
        roomForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(roomForm);
            const entry = {};
            formData.forEach((value, key) => {
                entry[key] = value.trim();
            });
            // Backward-compat: older builds stored room name under "room-roomname".
            // Normalize it so edits persist and UI reads the correct key.
            if (!entry['room-name'] && entry['room-roomname']) {
                entry['room-name'] = entry['room-roomname'];
            }
            delete entry['room-roomname'];
            // assign section and mode from hidden inputs (fall back to current values)
            entry.section = document.getElementById('room-section').value || currentSection;
            entry.mode = document.getElementById('room-mode').value || 'detailed';
            // remove hidden keys from entry object
            delete entry['room-section'];
            delete entry['room-mode'];
            // if motor mounting is custom, capture custom value
            if (entry['room-motorMounting'] === 'custom') {
                entry['room-motorMountingCustom'] = formData.get('room-motorMountingCustom')?.trim() || '';
            }
            // if HP is custom, use custom value
            if (entry['room-hp'] === 'Other') {
                const customHp = formData.get('room-hpCustom')?.trim() || '';
                entry['room-hp'] = customHp;
            }
            // if Frame is custom, use custom value
            if (entry['room-frame'] === 'Other') {
                const customFrame = formData.get('room-frameCustom')?.trim() || '';
                entry['room-frame'] = customFrame;
            }
            // if RPM is custom, use custom value
            if (entry['room-rpm'] === 'Other') {
                const customRpm = formData.get('room-rpmCustom')?.trim() || '';
                entry['room-rpm'] = customRpm;
            }
            // if zone is custom, use custom value
            if (entry['room-zone'] === 'custom') {
                const customZone = formData.get('room-zoneCustom')?.trim() || '';
                entry['room-zone'] = customZone;
            }
            // if manufacturer is custom, use custom value and save to localStorage
            if (entry['room-mfg'] === 'Other (type new)') {
                const customMfg = formData.get('room-mfgCustom')?.trim() || '';
                entry['room-mfg'] = customMfg;
                // Save to localStorage for future use
                if (customMfg) {
                    try {
                        const stored = localStorage.getItem('customManufacturers');
                        let customMfgs = stored ? JSON.parse(stored) : [];
                        if (!customMfgs.includes(customMfg)) {
                            customMfgs.push(customMfg);
                            localStorage.setItem('customManufacturers', JSON.stringify(customMfgs));
                            // Refresh dropdown to include new manufacturer
                            initializeManufacturerDropdown();
                        }
                    } catch (e) {}
                }
            }
            // if adapter type is custom, use custom value
            if (entry['room-shaftAdapterType'] === 'custom') {
                const customAdapter = formData.get('room-shaftAdapterTypeCustom')?.trim() || '';
                entry['room-shaftAdapterType'] = customAdapter;
            }
            // Normalize Run Time: store as numeric 0-100 (no % sign)
            // User can type "100", "100%", "60", "60%" etc.
            // Always ensure a valid numeric value is stored (default to 100 if blank/invalid)
            if (entry['room-runTime'] && String(entry['room-runTime']).trim()) {
                let rawVal = String(entry['room-runTime']).replace('%', '').trim();
                let numVal = parseFloat(rawVal);
                if (!isNaN(numVal) && numVal >= 0) {
                    // Clamp to 0-100 range and store as whole number string
                    numVal = Math.min(100, Math.max(0, numVal));
                    entry['room-runTime'] = String(Math.round(numVal));
                } else {
                    // If not a valid number, default to 100
                    entry['room-runTime'] = '100';
                }
            } else {
                // If blank or undefined, default to 100
                entry['room-runTime'] = '100';
            }
            // Determine if we are editing or adding new
            let targetIndex;
            if (editIndex !== null && editIndex >= 0) {
                // Preserve entry.id when editing (critical for photo assignments)
                // If existing entry has an id, preserve it; otherwise generate one
                const existingEntry = entries[editIndex];
                entry.id = (existingEntry && existingEntry.id) ? existingEntry.id : generateUUID();
                // Preserve sheet number for evaporators if editing
                if (existingEntry && existingEntry.section === 'evap') {
                    entry.sheetNumber = existingEntry.sheetNumber;
                }
                targetIndex = editIndex;
                entries[editIndex] = entry;
                editIndex = null;
            } else {
                // Assign unique ID for new entries (critical for photo assignments)
                entry.id = generateUUID();
                // Assign sheet number for new evaporator entries
                if (entry.section === 'evap') {
                    const countEvaps = entries.filter(e => e.section === 'evap').length;
                    entry.sheetNumber = countEvaps + 1;
                }
                targetIndex = entries.length;
                entries.push(entry);
            }
            ProjectState.markDirty();
            renderEntries();
            closeForm();
            
            // Auto-sync to server after saving equipment
            if (siteData.customer && entries.length > 0) {
                addProjectToSaved().catch(e => console.error('Auto-sync failed:', e));
            }
            
            // Scroll to the card that was just added/edited
            setTimeout(() => {
                const targetCard = entry.section === 'evap' 
                    ? evapCardsContainer.children[entries.slice(0, targetIndex).filter(e => e.section === 'evap').length]
                    : condCardsContainer.children[entries.slice(0, targetIndex).filter(e => e.section === 'cond').length];
                if (targetCard) {
                    targetCard.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            }, 100);
        });

        // Render cards into separate containers
        function renderEntries(skipSave = false) {
            evapCardsContainer.innerHTML = '';
            condCardsContainer.innerHTML = '';
            entries.forEach((entry, index) => {
                const card = document.createElement('div');
                
                // Check if this section is in reorder mode
                const isReorder = (entry.section === 'evap' && reorderEvap) || (entry.section === 'cond' && reorderCond);
                card.className = isReorder ? 'card reorder-active' : 'card';
                
                // Create card header wrapper for grid layout
                const cardHeaderWrapper = document.createElement('div');
                cardHeaderWrapper.className = 'card-header';
                
                // Create card icon header with drag handle only (no edit button)
                const iconHeader = document.createElement('div');
                iconHeader.className = 'card-icon-header';
                
                // Six-dot drag handle (left)
                const handle = document.createElement('span');
                handle.className = 'drag-handle';
                handle.textContent = '⋮⋮';
                handle.title = 'Drag to reorder (desktop) or tap for arrows (mobile)';
                handle.setAttribute('role', 'button');
                handle.setAttribute('aria-label', 'Reorder unit');
                // On click/tap, toggle reorder mode for this section (mobile behavior)
                handle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (entry.section === 'evap') {
                        reorderEvap = !reorderEvap;
                    } else {
                        reorderCond = !reorderCond;
                    }
                    renderEntries();
                });
                
                iconHeader.appendChild(handle);
                
                // TRASH ICON - Will be added at the end of the card for bottom-center positioning
                
                // Add reorder arrows next to drag handle when in reorder mode
                if (isReorder) {
                    // Move up arrow
                    const upBtn = document.createElement('span');
                    upBtn.className = 'icon-button';
                    upBtn.textContent = '⬆️';
                    upBtn.title = 'Move Up';
                    upBtn.style.fontSize = '1.2rem';
                    upBtn.style.cursor = 'pointer';
                    upBtn.setAttribute('role','button');
                    upBtn.addEventListener('click', (ev) => {
                        ev.stopPropagation();
                        const currentIdx = index;
                        let swapIdx = -1;
                        for (let i = currentIdx - 1; i >= 0; i--) {
                            if (entries[i].section === entry.section) {
                                swapIdx = i;
                                break;
                            }
                        }
                        if (swapIdx >= 0) {
                            const temp = entries[currentIdx];
                            entries[currentIdx] = entries[swapIdx];
                            entries[swapIdx] = temp;
                            // Remap photo assignments to follow their entries
                            remapPhotoAssignmentsOnReorder(entry.section);
                            renderEntries();
                            SaveController.queueSave('card-reorder-up'); // Save after reordering to persist photo assignments
                            // Scroll to the moved card
                            setTimeout(() => {
                                const container = entry.section === 'evap' ? evapCardsContainer : condCardsContainer;
                                const sectionEntries = entries.filter(e => e.section === entry.section);
                                const newPosition = sectionEntries.findIndex(e => e === temp);
                                const targetCard = container.children[newPosition];
                                if (targetCard) {
                                    targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }, 100);
                            // Auto-sync after reordering
                            if (siteData.customer) {
                                addProjectToSaved().catch(e => console.error('Auto-sync failed:', e));
                            }
                        }
                    });
                    
                    // Move down arrow
                    const downBtn = document.createElement('span');
                    downBtn.className = 'icon-button';
                    downBtn.textContent = '⬇️';
                    downBtn.title = 'Move Down';
                    downBtn.style.fontSize = '1.2rem';
                    downBtn.style.cursor = 'pointer';
                    downBtn.setAttribute('role','button');
                    downBtn.addEventListener('click', (ev) => {
                        ev.stopPropagation();
                        const currentIdx = index;
                        let swapIdx = -1;
                        for (let i = currentIdx + 1; i < entries.length; i++) {
                            if (entries[i].section === entry.section) {
                                swapIdx = i;
                                break;
                            }
                        }
                        if (swapIdx >= 0) {
                            const temp = entries[currentIdx];
                            entries[currentIdx] = entries[swapIdx];
                            entries[swapIdx] = temp;
                            // Remap photo assignments to follow their entries
                            remapPhotoAssignmentsOnReorder(entry.section);
                            renderEntries();
                            SaveController.queueSave('card-reorder-down'); // Save after reordering to persist photo assignments
                            // Scroll to the moved card
                            setTimeout(() => {
                                const container = entry.section === 'evap' ? evapCardsContainer : condCardsContainer;
                                const sectionEntries = entries.filter(e => e.section === entry.section);
                                const newPosition = sectionEntries.findIndex(e => e === temp);
                                const targetCard = container.children[newPosition];
                                if (targetCard) {
                                    targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }, 100);
                            // Auto-sync after reordering
                            if (siteData.customer) {
                                addProjectToSaved().catch(e => console.error('Auto-sync failed:', e));
                            }
                        }
                    });
                    
                    iconHeader.appendChild(upBtn);
                    iconHeader.appendChild(downBtn);
                }
                
                // Create centered title section with room name and zone
                const titleSection = document.createElement('div');
                titleSection.className = 'card-title-section';
                
                // Room name (centered, large, bold)
                const roomName = document.createElement('div');
                roomName.style.fontSize = '1.4rem';
                roomName.style.fontWeight = 'bold';
                roomName.textContent = entry['room-name'] || entry['room-roomname'] || `Unit ${index + 1}`;
                titleSection.appendChild(roomName);
                
                // Zone (centered below room name if exists)
                if (entry['room-zone']) {
                    const zoneLine = document.createElement('div');
                    zoneLine.style.fontSize = '1rem';
                    zoneLine.style.fontWeight = 'bold';
                    zoneLine.style.marginTop = '0.25rem';
                    zoneLine.textContent = 'Zone: ' + entry['room-zone'];
                    titleSection.appendChild(zoneLine);
                }
                
                // Create temps display for header (top-right, evap only)
                let headerTempsDiv = null;
                if (entry.section === 'evap') {
                    const formatTemp = (temp) => {
                        if (!temp) return temp;
                        const numTemp = parseFloat(temp);
                        if (isNaN(numTemp)) return temp;
                        return numTemp % 1 === 0 ? numTemp.toFixed(1) : temp;
                    };
                    
                    let tempLines = [];
                    if (entry['room-setPoint']) {
                        tempLines.push(`Set: ${formatTemp(entry['room-setPoint'])}°F`);
                    }
                    if (entry['room-currentTemp']) {
                        tempLines.push(`Temp: ${formatTemp(entry['room-currentTemp'])}°F`);
                    }
                    
                    if (tempLines.length > 0) {
                        headerTempsDiv = document.createElement('div');
                        headerTempsDiv.style.position = 'absolute';
                        headerTempsDiv.style.top = '0';
                        headerTempsDiv.style.right = '0';
                        headerTempsDiv.style.fontSize = '0.85rem';
                        headerTempsDiv.style.textAlign = 'right';
                        headerTempsDiv.style.lineHeight = '1.3';
                        headerTempsDiv.innerHTML = tempLines.join('<br>');
                    }
                }
                
                // Append both to the wrapper, then wrapper to card
                cardHeaderWrapper.appendChild(iconHeader);
                cardHeaderWrapper.appendChild(titleSection);
                if (headerTempsDiv) cardHeaderWrapper.appendChild(headerTempsDiv);
                card.appendChild(cardHeaderWrapper);
                
                // Horizontal line separator
                const separator = document.createElement('hr');
                separator.style.border = 'none';
                separator.style.borderTop = '2px solid #aaa';
                separator.style.margin = '0.5rem 0';
                card.appendChild(separator);

                // NEW TABS + TEMPS ROW: Tabs on left, temps on right (same row)
                const tabsRow = document.createElement('div');
                tabsRow.className = 'tabs-row';
                tabsRow.style.display = 'flex';
                tabsRow.style.flexWrap = 'wrap';
                tabsRow.style.justifyContent = 'space-between';
                tabsRow.style.alignItems = 'flex-start';
                tabsRow.style.marginBottom = '0.75rem';
                tabsRow.style.borderBottom = '2px solid #ccc';
                tabsRow.style.paddingBottom = '0';
                
                // Tabs container (left side)
                const tabsContainer = document.createElement('div');
                tabsContainer.style.display = 'flex';
                tabsContainer.style.gap = '0.25rem';
                
                const detailsTab = document.createElement('div');
                detailsTab.className = 'card-tab active';
                detailsTab.textContent = 'Details';
                detailsTab.setAttribute('data-tab', 'details');
                
                const notesTab = document.createElement('div');
                notesTab.className = 'card-tab';
                notesTab.textContent = 'Notes';
                notesTab.setAttribute('data-tab', 'notes');
                
                tabsContainer.appendChild(detailsTab);
                tabsContainer.appendChild(notesTab);
                
                // Photos tab with count badge
                const photosTab = document.createElement('div');
                photosTab.className = 'card-tab';
                photosTab.setAttribute('data-tab', 'photos');
                const entryRoomKey = getRoomKey(entry);
                const entryPhotos = entryRoomKey ? getPhotosForRoom(entryRoomKey) : [];
                const photoCount = entryPhotos.length;
                photosTab.innerHTML = '📷' + (photoCount > 0 ? ` <span class="photo-count-badge">${photoCount}</span>` : '');
                photosTab.title = 'Photos';
                tabsContainer.appendChild(photosTab);
                
                // Edit tab - opens the edit form for this unit
                const editTab = document.createElement('div');
                editTab.className = 'card-tab';
                editTab.setAttribute('data-tab', 'edit');
                editTab.textContent = '✏️ Edit';
                editTab.title = 'Edit this unit';
                editTab.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editIndex = index;
                    openForm(entry, index);
                });
                tabsContainer.appendChild(editTab);
                
                // Add tab switching functionality
                const switchTab = (tabName) => {
                    const tabs = card.querySelectorAll('.card-tab');
                    const contents = card.querySelectorAll('.tab-content');
                    
                    tabs.forEach(tab => {
                        if (tab.getAttribute('data-tab') === tabName) {
                            tab.classList.add('active');
                        } else {
                            tab.classList.remove('active');
                        }
                    });
                    
                    contents.forEach(content => {
                        if (content.getAttribute('data-tab-content') === tabName) {
                            content.classList.add('active');
                        } else {
                            content.classList.remove('active');
                        }
                    });
                };
                
                detailsTab.addEventListener('click', () => switchTab('details'));
                notesTab.addEventListener('click', () => switchTab('notes'));
                photosTab.addEventListener('click', () => switchTab('photos'));
                
                tabsRow.appendChild(tabsContainer);
                card.appendChild(tabsRow);

                // Build left and right columns for quantities/specs and detailed fields
                const countVal = entry['room-count'] || '';
                const fansVal = entry['room-fanMotorsPerUnit'] || '';
                const hpVal = entry['room-hp'] || '';
                // Compute total fan motors
                let totalMotors = '';
                const countInt = parseInt(countVal || '0', 10);
                const fansInt = parseInt(fansVal || '0', 10);
                if (!isNaN(countInt) && !isNaN(fansInt) && countInt > 0 && fansInt > 0) {
                    totalMotors = countInt * fansInt;
                }
                
                // LEFT COLUMN: QUANTITIES ONLY
                let leftHtml = '';
                leftHtml += `<p style="text-align:center; text-decoration:underline; margin-bottom:0.75rem;"><em><strong>Quantities</strong></em></p>`;
                const sectionLabel = entry.section === 'evap' ? 'Evaporator Count' : 'Condenser Count';
                if (countVal) {
                    leftHtml += `<p style="text-align:center; margin-bottom:0.3rem; font-size:0.75rem;">${sectionLabel}:</p>`;
                    leftHtml += `<p style="text-align:center; font-weight:bold; font-size:1.1rem; margin-bottom:0.8rem;">${countVal}</p>`;
                }
                if (fansVal) {
                    leftHtml += `<p style="text-align:center; margin-bottom:0.3rem; font-size:0.75rem;">Motors Per ${entry.section === 'evap' ? 'Evap' : 'Cond'}:</p>`;
                    leftHtml += `<p style="text-align:center; font-weight:bold; font-size:1.1rem; margin-bottom:0.8rem;">${fansVal}</p>`;
                }
                if (totalMotors) {
                    leftHtml += `<p style="text-align:center; margin-bottom:0.3rem; font-size:0.75rem;">Total Fan Motors:</p>`;
                    leftHtml += `<p style="text-align:center; font-weight:bold; font-size:1.1rem; margin-bottom:0.8rem;">${totalMotors}</p>`;
                }
                // RIGHT COLUMN: MOTOR SPECS + DETAILS (compact format)
                let rightHtml = '';
                
                // Motor Specs section - all on one line
                rightHtml += `<p style="text-align:center; text-decoration:underline; margin-bottom:0.75rem;"><em><strong>Motor Specs</strong></em></p>`;
                
                // Build single line: HP (bold italic) — voltage, phase, amps
                let motorSpecLine = '';
                if (hpVal) {
                    const displayHp = (hpVal.includes('HP') || hpVal.includes('W')) ? hpVal : `${hpVal} HP`;
                    motorSpecLine += `<strong><em>${displayHp}</em></strong>`;
                }
                
                const specs = [];
                if (entry['room-voltage']) specs.push(`${entry['room-voltage']}v`);
                if (entry['room-phase']) specs.push(`${entry['room-phase']}-ph`);
                if (entry['room-amps']) specs.push(`${entry['room-amps']} FLA`);
                if (specs.length > 0) {
                    if (motorSpecLine) motorSpecLine += ' &mdash; ';
                    motorSpecLine += specs.join(', ');
                }
                
                if (motorSpecLine) {
                    rightHtml += `<p style="text-align:center; margin-bottom:1rem; white-space: nowrap; overflow-x: auto;">${motorSpecLine}</p>`;
                }
                
                // Details section - collect all detail pairs
                const detailedPairs = [];
                if (entry['room-motorMounting']) {
                    const mountValue = entry['room-motorMounting'];
                    const capitalizedMount = mountValue.charAt(0).toUpperCase() + mountValue.slice(1);
                    detailedPairs.push({ label: 'Mount', value: capitalizedMount });
                }
                if (entry['room-frame']) detailedPairs.push({ label: 'Frame', value: entry['room-frame'] });
                if (entry['room-rotation']) detailedPairs.push({ label: 'Rotation', value: entry['room-rotation'] });
                if (entry['room-shaftSize']) detailedPairs.push({ label: 'Shaft', value: entry['room-shaftSize'] });
                // Combine adapter qty and type into one line: "(8) 5/8 to 1/2"
                if (entry['room-shaftAdapterQty'] && Number(entry['room-shaftAdapterQty']) > 0 && entry['room-shaftAdapterType']) {
                    const adapterDisplay = `(${entry['room-shaftAdapterQty']}) ${entry['room-shaftAdapterType']}`;
                    detailedPairs.push({ label: 'Adapters', value: adapterDisplay });
                }
                // Combine blade spec and blades needed into one line: "(3) 33/18/5"
                if (entry['room-bladesNeeded'] && Number(entry['room-bladesNeeded']) > 0 && entry['room-bladeSpec']) {
                    const bladeDisplay = `(${entry['room-bladesNeeded']}) ${entry['room-bladeSpec']}`;
                    detailedPairs.push({ label: 'FanBlade(s)', value: bladeDisplay });
                } else if (entry['room-bladeSpec']) {
                    detailedPairs.push({ label: 'FanBlade(s)', value: entry['room-bladeSpec'] });
                } else if (entry['room-bladesNeeded'] && Number(entry['room-bladesNeeded']) > 0) {
                    detailedPairs.push({ label: 'FanBlade(s)', value: `(${entry['room-bladesNeeded']})` });
                }
                if (entry['room-runTime'] && entry['room-runTime'].trim() !== '' && entry['room-runTime'] !== '100') {
                    // Display Run Time with % suffix (stored as numeric 0-100)
                    detailedPairs.push({ label: 'Run Time', value: entry['room-runTime'] + '%' });
                }
                
                // Format Details as 2-column layout with smaller font and tighter spacing
                if (detailedPairs.length > 0) {
                    rightHtml += `<p style="text-align:center; text-decoration:underline; margin-top:1rem; margin-bottom:0.5rem;"><em><strong>Details</strong></em></p>`;
                    rightHtml += '<div style="display:flex; gap:1rem; align-items:flex-start; justify-content:center; margin-bottom:0.5rem;">';
                    
                    // Split into two columns
                    const mid = Math.ceil(detailedPairs.length / 2);
                    const col1 = detailedPairs.slice(0, mid);
                    const col2 = detailedPairs.slice(mid);
                    
                    // Column 1
                    rightHtml += '<div style="flex:0 1 auto;">';
                    col1.forEach(pair => {
                        rightHtml += `<p style="margin:0.25rem 0; font-size:0.85rem; text-align:center;"><strong>${pair.label}:</strong> <span style="white-space: nowrap;">${pair.value}</span></p>`;
                    });
                    rightHtml += '</div>';
                    
                    // Column 2
                    rightHtml += '<div style="flex:0 1 auto;">';
                    col2.forEach(pair => {
                        rightHtml += `<p style="margin:0.25rem 0; font-size:0.85rem; text-align:center;"><strong>${pair.label}:</strong> <span style="white-space: nowrap;">${pair.value}</span></p>`;
                    });
                    rightHtml += '</div>';
                    
                    rightHtml += '</div>';
                }
                const body = document.createElement('div');
                body.className = 'card-body';
                body.style.position = 'relative';
                body.style.paddingBottom = '2.5rem';
                
                // Create columns container
                const cols = document.createElement('div');
                cols.style.display = 'flex';
                cols.style.justifyContent = 'space-between';
                cols.style.alignItems = 'flex-start';
                cols.style.gap = '1.5rem';
                cols.style.minHeight = '200px';
                
                // Left column - Quantities (narrower 28%)
                const leftCol = document.createElement('div');
                leftCol.innerHTML = leftHtml;
                leftCol.style.flex = '0 0 28%';
                leftCol.style.paddingRight = '0.25rem';
                
                // Right column - Motor Specs + Details (wider, more room)
                const rightCol = document.createElement('div');
                rightCol.innerHTML = rightHtml;
                rightCol.style.flex = '1';
                
                cols.appendChild(leftCol);
                cols.appendChild(rightCol);
                cols.style.marginTop = '0.5rem';
                body.appendChild(cols);
                
                // Vertical divider line - positioned on body to extend full height
                const divider = document.createElement('div');
                divider.style.position = 'absolute';
                divider.style.left = 'calc(28% + 0.5rem)';
                divider.style.top = '0.5rem';
                divider.style.bottom = '1rem';
                divider.style.width = '2px';
                divider.style.backgroundColor = '#ccc';
                body.appendChild(divider);

                // Wrap body in details tab content
                const detailsContent = document.createElement('div');
                detailsContent.className = 'tab-content active';
                detailsContent.setAttribute('data-tab-content', 'details');
                detailsContent.appendChild(body);
                
                // Create notes tab content with textarea (tap to edit, save on blur)
                const notesContent = document.createElement('div');
                notesContent.className = 'tab-content';
                notesContent.setAttribute('data-tab-content', 'notes');
                
                const notesTextarea = document.createElement('textarea');
                notesTextarea.className = 'notes-textarea';
                notesTextarea.placeholder = 'Tap to add notes for this unit...';
                notesTextarea.value = entry['room-notes'] || '';
                notesTextarea.style.width = '100%';
                notesTextarea.style.minHeight = '120px';
                notesTextarea.style.padding = '0.75rem';
                notesTextarea.style.border = '1px solid #ddd';
                notesTextarea.style.borderRadius = '4px';
                notesTextarea.style.fontSize = '0.95rem';
                notesTextarea.style.resize = 'vertical';
                notesTextarea.style.fontFamily = 'inherit';
                notesTextarea.style.boxSizing = 'border-box';
                
                // Save on blur - when user taps away from textarea
                notesTextarea.addEventListener('blur', () => {
                    const updatedNotes = notesTextarea.value.trim();
                    // Only save if content changed
                    if (entry['room-notes'] !== updatedNotes) {
                        entry['room-notes'] = updatedNotes;
                        ProjectState.markDirty();
                        SaveController.queueSave('notes-blur');
                    }
                });
                
                notesContent.appendChild(notesTextarea);
                
                // Create photos tab content
                const photosContent = document.createElement('div');
                photosContent.className = 'tab-content';
                photosContent.setAttribute('data-tab-content', 'photos');
                
                const photosContainer = document.createElement('div');
                photosContainer.className = 'room-photos-container';
                photosContainer.style.padding = '0.5rem';
                
                // Button row for photo actions
                const photoButtonRow = document.createElement('div');
                photoButtonRow.style.display = 'flex';
                photoButtonRow.style.gap = '0.5rem';
                photoButtonRow.style.marginBottom = '0.75rem';
                photoButtonRow.style.flexWrap = 'wrap';
                
                // Get room key for this entry (e.g., "evap:0", "cond:1")
                const roomKey = getRoomKey(entry);
                
                // Attach from pool button
                const attachBtn = document.createElement('button');
                attachBtn.className = 'button secondary';
                attachBtn.style.fontSize = '0.85rem';
                attachBtn.style.flex = '1';
                attachBtn.style.minWidth = '120px';
                attachBtn.textContent = '+ From Pool';
                attachBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openAttachModal(entry.id);  // Use entry.id, not array index
                });
                photoButtonRow.appendChild(attachBtn);
                
                // Add photos directly to this room - Take Photo button
                const roomTakePhotoBtn = document.createElement('button');
                roomTakePhotoBtn.className = 'button secondary';
                roomTakePhotoBtn.style.fontSize = '0.85rem';
                roomTakePhotoBtn.textContent = '📸';
                roomTakePhotoBtn.title = 'Take Photo';
                
                // Hidden camera input for this room
                const roomCameraInput = document.createElement('input');
                roomCameraInput.type = 'file';
                roomCameraInput.accept = 'image/*';
                roomCameraInput.capture = 'environment';
                roomCameraInput.style.display = 'none';
                roomCameraInput.addEventListener('change', (e) => {
                    handleAddPhotosToRoom(e.target.files, roomKey);  // Use room key
                    e.target.value = '';
                });
                
                roomTakePhotoBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    roomCameraInput.click();
                });
                photoButtonRow.appendChild(roomTakePhotoBtn);
                photoButtonRow.appendChild(roomCameraInput);
                
                // Add photos directly to this room - Choose from Library button
                const roomAddPhotosBtn = document.createElement('button');
                roomAddPhotosBtn.className = 'button';
                roomAddPhotosBtn.style.fontSize = '0.85rem';
                roomAddPhotosBtn.style.flex = '1';
                roomAddPhotosBtn.style.minWidth = '120px';
                roomAddPhotosBtn.textContent = '📁 Add Photos';
                roomAddPhotosBtn.title = 'Choose from Library';
                
                // Hidden file input for this room (no capture - opens iOS picker)
                const roomFileInput = document.createElement('input');
                roomFileInput.type = 'file';
                roomFileInput.accept = 'image/*';
                roomFileInput.multiple = true;
                roomFileInput.style.display = 'none';
                roomFileInput.addEventListener('change', (e) => {
                    handleAddPhotosToRoom(e.target.files, roomKey);  // Use room key
                    e.target.value = '';
                });
                
                roomAddPhotosBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    roomFileInput.click();
                });
                photoButtonRow.appendChild(roomAddPhotosBtn);
                photoButtonRow.appendChild(roomFileInput);
                
                photosContainer.appendChild(photoButtonRow);
                
                // Photos grid for this entry
                const roomPhotosGrid = document.createElement('div');
                roomPhotosGrid.className = 'room-photos-grid';
                roomPhotosGrid.setAttribute('data-entry-index', index);
                
                // Get photos for this room using room key
                const roomPhotos = getPhotosForRoom(roomKey);
                // Sort by createdAt ASC for chronological order
                roomPhotos.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
                
                // Render assigned photos
                if (roomPhotos.length > 0) {
                    roomPhotos.forEach(photo => {
                        const tile = document.createElement('div');
                        tile.className = 'photo-tile small';
                        tile.innerHTML = `
                            <img src="${photo.thumbUri || photo.url || photo.localUri}" class="photo-thumb" alt="Photo" loading="lazy">
                            <div class="photo-actions">
                                <button class="photo-action-btn remove-btn" title="Remove from room">✕</button>
                            </div>
                        `;
                        tile.querySelector('.remove-btn').addEventListener('click', (e) => {
                            e.stopPropagation();
                            // Remove photo and update just this grid (don't re-render entire card)
                            removePhotoFromRoom(photo.id, true);  // skipFullRender=true
                            // Remove just this tile from the grid
                            tile.remove();
                            // Update photo count badge
                            const remainingPhotos = getPhotosForRoom(roomKey);
                            const badge = card.querySelector('.photo-count-badge');
                            if (remainingPhotos.length > 0) {
                                if (badge) {
                                    badge.textContent = remainingPhotos.length;
                                } else {
                                    const photosTab = card.querySelector('[data-tab="photos"]');
                                    if (photosTab) {
                                        photosTab.innerHTML = '📷 <span class="photo-count-badge">' + remainingPhotos.length + '</span>';
                                    }
                                }
                            } else {
                                if (badge) badge.remove();
                                const photosTab = card.querySelector('[data-tab="photos"]');
                                if (photosTab) photosTab.innerHTML = '📷';
                                roomPhotosGrid.innerHTML = '<p style="color:#999; font-style:italic; text-align:center;">No photos assigned to this room.</p>';
                            }
                        });
                        roomPhotosGrid.appendChild(tile);
                    });
                } else {
                    roomPhotosGrid.innerHTML = '<p style="color:#999; font-style:italic; text-align:center;">No photos assigned to this room.</p>';
                }
                
                photosContainer.appendChild(roomPhotosGrid);
                photosContent.appendChild(photosContainer);
                
                card.appendChild(detailsContent);
                card.appendChild(notesContent);
                card.appendChild(photosContent);
                
                // TRASH ICON - Positioned at bottom center of card
                // Always created, but only visible when in reorder mode (CSS controls visibility)
                // Uses the shared deleteEntryAtIndex function for consistent behavior
                const trashBtn = document.createElement('span');
                trashBtn.className = 'reorder-trash-icon';
                trashBtn.textContent = '🗑️';
                trashBtn.title = 'Delete this unit';
                trashBtn.setAttribute('role', 'button');
                trashBtn.setAttribute('aria-label', 'Delete unit');
                trashBtn.addEventListener('click', async (ev) => {
                    ev.stopPropagation();
                    await deleteEntryAtIndex(index, false);
                });
                card.appendChild(trashBtn);
                
                // assign attributes and append to correct container
                if (entry.section === 'evap') {
                    card.setAttribute('data-index', index);
                    card.setAttribute('draggable', 'true');
                    evapCardsContainer.appendChild(card);
                } else {
                    card.setAttribute('data-index', index);
                    card.setAttribute('draggable', 'true');
                    condCardsContainer.appendChild(card);
                }
            });
            // After rendering cards, setup drag-and-drop
            setupDragAndDrop();
            
            // Recreate Add buttons to keep them positioned correctly
            createAddButtons();

            // Show/hide Export CSV button based on whether there are units
            const exportImport = document.getElementById('exportImportSection');
            if (exportImport) {
                if (entries.length === 0) {
                    exportImport.classList.add('hidden');
                } else {
                    exportImport.classList.remove('hidden');
                }
            }

            // Persist changes to localStorage (unless skipping save on initial load)
            if (!skipSave) {
                SaveController.queueSave('entries-render');
            }
        }

        // initial render (skip save to avoid overwriting restored data)
        renderEntries(true);
        
        // Create Add buttons on initial load
        createAddButtons();
        
        // Populate saved projects dropdown on page load
        populateSavedProjectsDropdown();

        // Bottom button cluster handlers (now the only action buttons below Electric Bills)
        const saveProjectBtn2Bottom = document.getElementById('saveProjectBtn2Bottom');
        if (saveProjectBtn2Bottom) {
            saveProjectBtn2Bottom.addEventListener('click', async () => {
                await saveProjectWithNewSystem(false);
            });
        }
        
        const saveAsBtnBottom = document.getElementById('saveAsBtnBottom');
        if (saveAsBtnBottom) {
            saveAsBtnBottom.addEventListener('click', async () => {
                await saveProjectWithNewSystem(true);
            });
        }
        
        
        const printViewBtnBottom = document.getElementById('printViewBtnBottom');
        if (printViewBtnBottom) {
            printViewBtnBottom.addEventListener('click', () => {
                openProjectPrintPreview();
            });
        }
        
        const photosNavBtnBottom = document.getElementById('photosNavBtnBottom');
        if (photosNavBtnBottom) {
            photosNavBtnBottom.addEventListener('click', () => {
                const photosPoolSection = document.getElementById('photosPoolSection');
                if (photosPoolSection) {
                    photosPoolSection.classList.toggle('hidden');
                    if (!photosPoolSection.classList.contains('hidden')) {
                        if (typeof renderPhotoPool === 'function') renderPhotoPool();
                        photosPoolSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            });
        }
        
        const newProjectBtnBottom = document.getElementById('newProjectBtnBottom');
        if (newProjectBtnBottom) {
            newProjectBtnBottom.addEventListener('click', () => {
                newProject();
                NavigationController.setView('customerInfo');
            });
        }
        
        const loadProjectBtnBottom = document.getElementById('loadProjectBtnBottom');
        if (loadProjectBtnBottom) {
            loadProjectBtnBottom.addEventListener('click', () => {
                openLoadProjectModal();
            });
        }

        // Export CSV - Horizontal layout matching Excel structure
        // SCOPED TO CURRENT PROJECT ONLY - uses ProjectState.entries, .siteData, .photos
        exportBtn.addEventListener('click', async () => {
            console.log("EXPORT CSV CLICKED");
            
            // Log current project scope for verification
            console.log("=== EXPORT SCOPE ===");
            console.log("Project ID:", ProjectState.currentProjectId || ProjectState.project_id);
            console.log("Project Name:", ProjectState.currentProjectName || siteData.customer);
            console.log("Entries count:", entries.length);
            console.log("Photos count:", (ProjectState.photos || []).length);
            console.log("===================");
            
            try {
                if (entries.length === 0) {
                    showToast('No entries to export.', 'warning');
                    console.log("Export aborted: no entries");
                    return;
                }
                
                console.log("Building CSV with", entries.length, "entries from current project only");
                
                // Save project before exporting to ensure it's in saved projects list
                SaveController.queueSave('export-csv');
                addProjectToSaved();

            // Evaporator fields (with Sheet column; condensers will use condFieldOrder without Sheet)
            // Notes column added at the end for both evaporators and condensers
            // Condensers include currentTemp/setPoint as empty placeholders to align Notes in column X for both
            const evapFieldOrder = ['zone','sheet','name','count','fanMotorsPerUnit','voltage','amps','phase','hp','mfg','motorMounting','frame','rpm','rotation','shaftSize','shaftAdapterQty','shaftAdapterType','bladeSpec','bladesNeeded','runTime','currentTemp','setPoint','notes'];
            const condFieldOrder = ['zone','split','name','count','fanMotorsPerUnit','voltage','amps','phase','hp','mfg','motorMounting','frame','rpm','rotation','shaftSize','shaftAdapterQty','shaftAdapterType','bladeSpec','bladesNeeded','runTime','currentTemp','setPoint','notes'];
            
            // Readable column headers
            const fieldHeaders = {
                zone: 'Zone',
                sheet: 'Sheet',
                name: 'Name',
                count: 'QTY',  // Will be "Evap QTY" or "Cond QTY" in header
                fanMotorsPerUnit: 'Motor QTY',
                voltage: 'Volts',
                amps: 'Amps',
                phase: 'Phase',
                hp: 'Motor HP',
                split: 'Split',
                mfg: 'Mfg',
                motorMounting: 'Motor Mounting',
                frame: 'Frame',
                rpm: 'RPM',
                rotation: 'Rotation',
                shaftSize: 'Shaft',
                shaftAdapterQty: 'Shaft Adptr QTY',
                shaftAdapterType: 'Shaft Adptr Type',
                bladeSpec: 'Blade Specs',
                bladesNeeded: 'QTY Blades Needed',
                runTime: 'Operation Time Factor',
                currentTemp: 'Current Temp',
                setPoint: 'Set Point',
                notes: 'Notes'
            };
            
            const fieldMap = {
                zone: 'room-zone',
                sheet: 'sheetNumber',
                name: 'room-name',
                count: 'room-count',
                fanMotorsPerUnit: 'room-fanMotorsPerUnit',
                voltage: 'room-voltage',
                phase: 'room-phase',
                amps: 'room-amps',
                hp: 'room-hp',
                split: 'room-split',
                mfg: 'room-mfg',
                motorMounting: 'room-motorMounting',
                frame: 'room-frame',
                rpm: 'room-rpm',
                rotation: 'room-rotation',
                shaftSize: 'room-shaftSize',
                shaftAdapterQty: 'room-shaftAdapterQty',
                shaftAdapterType: 'room-shaftAdapterType',
                bladeSpec: 'room-bladeSpec',
                bladesNeeded: 'room-bladesNeeded',
                runTime: 'room-runTime',
                currentTemp: 'room-currentTemp',
                setPoint: 'room-setPoint',
                notes: 'room-notes'
            };

            // Separate evaporators and condensers
            const evaps = entries.filter(e => e.section === 'evap');
            const conds = entries.filter(e => e.section === 'cond');
            
            const csvRows = [];

            // Helper to clean field values - trims leading/trailing whitespace
            // IMPORTANT: Does NOT normalize or change HP values, only removes whitespace
            const cleanField = (val) => {
                if (val === null || val === undefined) return '';
                return String(val).trim();
            };
            
            // Helper to escape CSV values (with cleaning applied)
            // Wrapping in quotes prevents Excel from converting fractions like "1/4" to dates
            const escapeCSV = (val) => '"' + cleanField(val).replace(/"/g,'""') + '"';

            // ROW 1: Customer info headers (7 columns including visit date and utility)
            const cityStateZip = [siteData.city, siteData.state, siteData.zip].filter(v => v).join(', ');
            csvRows.push([
                escapeCSV('Customer'),
                escapeCSV('Address'),
                escapeCSV('City, State, Zip'),
                escapeCSV('Contact'),
                escapeCSV('Phone'),
                escapeCSV('Date of Site Visit'),
                escapeCSV('Utility Company')
            ].join(','));

            // ROW 2: Customer data (7 columns including visit date and utility)
            let visitDateFormatted = '';
            if (siteData.visitDate) {
                const vd = new Date(siteData.visitDate);
                const m = vd.getMonth() + 1;
                const d = vd.getDate();
                const y = String(vd.getFullYear()).slice(-2);
                visitDateFormatted = `${m}/${d}/${y}`;
            }
            csvRows.push([
                escapeCSV(siteData.customer || ''),
                escapeCSV(siteData.street || ''),
                escapeCSV(cityStateZip),
                escapeCSV(siteData.contact || ''),
                escapeCSV(siteData.phone || ''),
                escapeCSV(visitDateFormatted),
                escapeCSV(siteData.utility || '')
            ].join(','));

            // ROW 3: Evaporators header row - section label in first column, then full evap headers
            const evapHeaderRow = ['Evaporators'];
            evapFieldOrder.forEach(f => {
                evapHeaderRow.push(fieldHeaders[f] === 'QTY' ? 'Evap QTY' : fieldHeaders[f]);
            });
            csvRows.push(evapHeaderRow.map(h => escapeCSV(h)).join(','));

            // ROW 4+: Evaporator data rows - first column empty, then all evap data fields
            // All values are cleaned (trimmed) via cleanField() in escapeCSV()
            // Quoting prevents Excel from converting fractions like "1/4 HP" to dates
            evaps.forEach((evap, evapIndex) => {
                const row = [''];  // First column empty (not "Evaporators")
                evapFieldOrder.forEach(f => {
                    let val = '';
                    // Auto-number sheet column sequentially based on export order
                    if (f === 'sheet') {
                        val = String(evapIndex + 1);
                    } else {
                        const key = fieldMap[f];
                        val = (evap[key] !== undefined ? String(evap[key]) : '');
                        // NOTE: No TAB prefix needed - escapeCSV quotes values which prevents Excel date conversion
                        // cleanField() inside escapeCSV() trims any whitespace from HP values
                    }
                    row.push(val);
                });
                csvRows.push(row.map(v => escapeCSV(v)).join(','));
            });

            // Next: Condensers header row - section label in first column, then full cond headers
            const condHeaderRow = ['Condensers'];
            condFieldOrder.forEach(f => {
                condHeaderRow.push(fieldHeaders[f] === 'QTY' ? 'Cond QTY' : fieldHeaders[f]);
            });
            csvRows.push(condHeaderRow.map(h => escapeCSV(h)).join(','));

            // Following: Condenser data rows - first column empty, then all cond data fields
            // All values are cleaned (trimmed) via cleanField() in escapeCSV()
            // Quoting prevents Excel from converting fractions like "1/4 HP" to dates
            conds.forEach(cond => {
                const row = [''];  // First column empty (not "Condensers")
                condFieldOrder.forEach(f => {
                    const key = fieldMap[f];
                    let val = (cond[key] !== undefined ? String(cond[key]) : '');
                    // NOTE: No TAB prefix needed - escapeCSV quotes values which prevents Excel date conversion
                    // cleanField() inside escapeCSV() trims any whitespace from HP values
                    row.push(val);
                });
                csvRows.push(row.map(v => escapeCSV(v)).join(','));
            });
            
            // LOGGING: Output sample rows for verification
            console.log("=== CSV EXPORT VERIFICATION ===");
            if (evapHeaderRow.length > 0) {
                console.log("Sample Evap Header:", evapHeaderRow.join(','));
            }
            if (evaps.length > 0 && csvRows.length > 3) {
                console.log("Sample Evap Data Row 1:", csvRows[3]);
            }
            if (condHeaderRow.length > 0) {
                console.log("Sample Cond Header:", condHeaderRow.join(','));
            }
            if (conds.length > 0) {
                const condDataRowIndex = 3 + evaps.length + 1;
                if (condDataRowIndex < csvRows.length) {
                    console.log("Sample Cond Data Row 1:", csvRows[condDataRowIndex + 1]);
                }
            }
            console.log("=== END VERIFICATION ===")

            // Step 1: Create CSV content
            const csvContent = csvRows.join('\n');
            console.log("CSV built successfully, length:", csvContent.length, "chars");
            
            if (!csvContent || csvContent.length === 0) {
                console.warn("CSV content is empty!");
                showToast("Export failed: CSV content is empty", 'error');
                return;
            }
            
            // Build filename with timestamp format: MM.DD.YY_HH.MM.SS
            const now = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const timestamp = `${pad(now.getMonth()+1)}.${pad(now.getDate())}.${String(now.getFullYear()).slice(-2)}_${pad(now.getHours())}.${pad(now.getMinutes())}.${pad(now.getSeconds())}`;
            
            // rawCompany = customer name for Dropbox folder structure (NOT changed per user requirement)
            const rawCompany = siteData.customer ? siteData.customer.trim() : 'Unknown';
            
            // CSV FILENAME: Use projectName (from Save/Save As), fallback to customer name for old projects
            // This ensures "SGS – Zones 1+2 Only" shows in the filename when saved via Save As
            const rawProjectName = (ProjectState.currentProjectName && ProjectState.currentProjectName.trim()) 
                ? ProjectState.currentProjectName.trim() 
                : rawCompany;
            const namePart = rawProjectName.replace(/\s+/g, '_').replace(/[\/\\:*?"<>|]/g, '');
            const filename = `Data_Collection_${namePart}_${timestamp}.csv`;
            
            console.log("EXPORT CSV – filename:", filename);
            console.log("EXPORT CSV – csv length:", csvContent.length);
            
            // Step 2: Upload to Dropbox FIRST
            const performUpload = async () => {
                setDropboxStatus("Uploading CSV to Dropbox…", false, true);
                
                try {
                    const formData = new FormData();
                    formData.append("file", new Blob([csvContent], { type: "text/csv" }), filename);
                    formData.append("filename", filename);
                    formData.append("company", rawCompany);
                    formData.append("utility", siteData.utility || 'Unknown');
                    formData.append("street_address", siteData.street || 'Unknown');
                    
                    const uploadResponse = await fetch("/upload", {
                        method: "POST",
                        body: formData
                    });
                    
                    const result = await uploadResponse.json();
                    console.log("DROPBOX RESPONSE:", uploadResponse.status, result);
                    
                    // Step 3: Only download AFTER upload success
                    if (result.ok) {
                        // Trigger local download
                        const blob = new Blob([csvContent], { type: 'text/csv' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = filename;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        
                        setTimeout(() => {
                            document.body.removeChild(link);
                            URL.revokeObjectURL(link.href);
                        }, 100);
                        
                        // Step 3b: Upload PDF to Dropbox
                        let pdfUploadSuccess = true;
                        let pdfUploaded = false;
                        const pdfProjectId = ProjectState.project_id || ProjectState.currentProjectId;
                        if (pdfProjectId) {
                            try {
                                console.log(`[pdf] Fetching PDF for project ${pdfProjectId}`);
                                setDropboxStatus("Uploading PDF to Dropbox…", false, true);
                                
                                const pdfResponse = await fetch(`/api/projects/${pdfProjectId}/print.pdf`);
                                if (pdfResponse.ok) {
                                    const pdfBlob = await pdfResponse.blob();
                                    
                                    // Build PDF filename: "Print View - {customer} - {date}.pdf"
                                    const visitDate = siteData.date || siteData.visitDate || '';
                                    const safeDateStr = visitDate.replace(/\//g, '-').replace(/\s+/g, '_') || timestamp.split('_')[0];
                                    const pdfFilename = `Print View - ${rawCompany} - ${safeDateStr}.pdf`;
                                    console.log(`[pdf] Uploading PDF: ${pdfFilename}`);
                                    
                                    // Upload PDF to Dropbox
                                    const pdfFormData = new FormData();
                                    pdfFormData.append("file", pdfBlob, pdfFilename);
                                    pdfFormData.append("filename", pdfFilename);
                                    pdfFormData.append("company", rawCompany);
                                    pdfFormData.append("utility", siteData.utility || 'Unknown');
                                    pdfFormData.append("street_address", siteData.street || 'Unknown');
                                    
                                    const pdfUploadResponse = await fetch("/upload", {
                                        method: "POST",
                                        body: pdfFormData
                                    });
                                    
                                    const pdfResult = await pdfUploadResponse.json();
                                    if (pdfResult.ok) {
                                        console.log("✓ PDF uploaded to Dropbox:", pdfResult);
                                        pdfUploaded = true;
                                    } else {
                                        console.warn("⚠ PDF upload failed:", pdfResult);
                                        pdfUploadSuccess = false;
                                    }
                                } else {
                                    console.warn("[pdf] Failed to fetch PDF:", pdfResponse.status);
                                    pdfUploadSuccess = false;
                                }
                            } catch (pdfErr) {
                                console.error("[pdf] Error uploading PDF:", pdfErr);
                                pdfUploadSuccess = false;
                            }
                        }
                        
                        // Step 4: Upload photos to Dropbox if any exist
                        // SCOPED TO CURRENT PROJECT - only ProjectState.photos from this project
                        const projectPhotos = ProjectState.photos || [];
                        console.log(`[photos] Exporting ${projectPhotos.length} photos from current project (${ProjectState.currentProjectName || siteData.customer})`);
                        let photoUploadSuccess = true;
                        if (projectPhotos.length > 0) {
                            try {
                                const photoResult = await uploadPhotosToDropbox(projectPhotos, rawCompany, siteData.utility || '', siteData.street || '', siteData.date || '');
                                if (!photoResult || !photoResult.ok) {
                                    photoUploadSuccess = false;
                                    const uploadedCount = photoResult?.uploaded?.length || 0;
                                    setDropboxStatus(`CSV uploaded, but ${projectPhotos.length - uploadedCount} photos failed`, true);
                                    console.warn("⚠ Some photos failed to upload");
                                }
                            } catch (photoErr) {
                                photoUploadSuccess = false;
                                console.error("Photo upload error:", photoErr);
                                setDropboxStatus("CSV uploaded, photo upload failed", true);
                            }
                        }
                        
                        // Step 5: Upload Bills CSV to Dropbox if bills exist for this project
                        let billsUploadSuccess = true;
                        let billsUploaded = false;
                        const projectId = ProjectState.project_id || ProjectState.currentProjectId;
                        if (projectId) {
                            try {
                                console.log(`[bills] Fetching bills CSV for project ${projectId}`);
                                const billsResponse = await fetch(`/api/projects/${projectId}/bills/export-csv`);
                                const billsData = await billsResponse.json();
                                
                                if (billsData.success && billsData.csv) {
                                    // Build bills filename with same timestamp
                                    const billsFilename = `Bills_${namePart}_${timestamp}.csv`;
                                    console.log(`[bills] Uploading bills CSV: ${billsFilename}`);
                                    
                                    // Upload bills CSV to same folder structure
                                    const billsFormData = new FormData();
                                    billsFormData.append("file", new Blob([billsData.csv], { type: "text/csv" }), billsFilename);
                                    billsFormData.append("filename", billsFilename);
                                    billsFormData.append("company", rawCompany);
                                    billsFormData.append("utility", siteData.utility || 'Unknown');
                                    billsFormData.append("street_address", siteData.street || 'Unknown');
                                    
                                    const billsUploadResponse = await fetch("/upload", {
                                        method: "POST",
                                        body: billsFormData
                                    });
                                    
                                    const billsResult = await billsUploadResponse.json();
                                    if (billsResult.ok) {
                                        console.log("✓ Bills CSV uploaded to Dropbox:", billsResult);
                                        billsUploaded = true;
                                        
                                        // Also trigger local download of bills CSV
                                        const billsBlob = new Blob([billsData.csv], { type: 'text/csv' });
                                        const billsLink = document.createElement('a');
                                        billsLink.href = URL.createObjectURL(billsBlob);
                                        billsLink.download = billsFilename;
                                        billsLink.style.display = 'none';
                                        document.body.appendChild(billsLink);
                                        billsLink.click();
                                        setTimeout(() => {
                                            document.body.removeChild(billsLink);
                                            URL.revokeObjectURL(billsLink.href);
                                        }, 100);
                                    } else {
                                        console.warn("⚠ Bills CSV upload failed:", billsResult);
                                        billsUploadSuccess = false;
                                    }
                                } else {
                                    console.log("[bills] No bills data to export for this project");
                                }
                            } catch (billsErr) {
                                console.error("[bills] Error exporting bills CSV:", billsErr);
                                billsUploadSuccess = false;
                            }
                            
                            // Step 6: Upload Bills Excel to Dropbox (formatted for proposal workbook)
                            let excelUploaded = false;
                            try {
                                console.log(`[bills] Fetching bills Excel for project ${projectId}`);
                                const excelResponse = await fetch(`/api/projects/${projectId}/bills/export-excel?customer=${encodeURIComponent(rawCompany)}`);
                                const excelData = await excelResponse.json();
                                
                                if (excelData.success && excelData.excel) {
                                    // Build excel filename with same timestamp
                                    const excelFilename = `Utility_Summary_${namePart}_${timestamp}.xlsx`;
                                    console.log(`[bills] Uploading bills Excel: ${excelFilename}`);
                                    
                                    // Convert base64 to blob
                                    const excelBytes = atob(excelData.excel);
                                    const excelArray = new Uint8Array(excelBytes.length);
                                    for (let i = 0; i < excelBytes.length; i++) {
                                        excelArray[i] = excelBytes.charCodeAt(i);
                                    }
                                    const excelBlob = new Blob([excelArray], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                                    
                                    // Upload Excel to Dropbox
                                    const excelFormData = new FormData();
                                    excelFormData.append("file", excelBlob, excelFilename);
                                    excelFormData.append("filename", excelFilename);
                                    excelFormData.append("company", rawCompany);
                                    excelFormData.append("utility", siteData.utility || 'Unknown');
                                    excelFormData.append("street_address", siteData.street || 'Unknown');
                                    
                                    const excelUploadResponse = await fetch("/upload", {
                                        method: "POST",
                                        body: excelFormData
                                    });
                                    
                                    const excelResult = await excelUploadResponse.json();
                                    if (excelResult.ok) {
                                        console.log("✓ Bills Excel uploaded to Dropbox:", excelResult);
                                        excelUploaded = true;
                                        
                                        // Also trigger local download of Excel
                                        const excelLink = document.createElement('a');
                                        excelLink.href = URL.createObjectURL(excelBlob);
                                        excelLink.download = excelFilename;
                                        excelLink.style.display = 'none';
                                        document.body.appendChild(excelLink);
                                        excelLink.click();
                                        setTimeout(() => {
                                            document.body.removeChild(excelLink);
                                            URL.revokeObjectURL(excelLink.href);
                                        }, 100);
                                    } else {
                                        console.warn("⚠ Bills Excel upload failed:", excelResult);
                                    }
                                } else {
                                    console.log("[bills] No bills Excel to export (no bills or export failed)");
                                }
                            } catch (excelErr) {
                                console.error("[bills] Error exporting bills Excel:", excelErr);
                            }
                        }
                        
                        // Show final status with all upload results
                        // CSV upload succeeded - show success with optional warnings
                        // PDF failure should NOT block success - it's optional
                        const successParts = ['CSV'];
                        const failedParts = [];
                        
                        if (pdfUploaded) successParts.push('PDF');
                        else if (!pdfUploadSuccess) failedParts.push('PDF');
                        
                        if (projectPhotos.length > 0) {
                            if (photoUploadSuccess) successParts.push(`${projectPhotos.length} photos`);
                            else failedParts.push('photos');
                        }
                        
                        if (billsUploaded) successParts.push('bills CSV');
                        else if (!billsUploadSuccess) failedParts.push('bills CSV');
                        
                        if (typeof excelUploaded !== 'undefined' && excelUploaded) successParts.push('Excel');
                        
                        if (failedParts.length === 0) {
                            // Full success
                            setDropboxStatus(`Dropbox upload successful: ${successParts.join(' + ')} ✔`, false);
                        } else {
                            // Partial success - show as success with warning note (not error)
                            const warningMsg = `Uploaded: ${successParts.join(', ')} ✔ (${failedParts.join(', ')} failed)`;
                            setDropboxStatus(warningMsg, false); // false = not error state, show as success with note
                            console.warn('[export] Partial success - failed:', failedParts);
                        }
                        console.log("✓ Export CSV completed successfully");
                    } else {
                        console.error("Dropbox upload failed:", result);
                        const retryFn = performUpload;
                        setDropboxStatus("Dropbox upload failed – tap to retry", true, false, retryFn);
                    }
                } catch (err) {
                    console.error("Dropbox upload error:", err);
                    const retryFn = performUpload;
                    setDropboxStatus("Dropbox upload failed – tap to retry", true, false, retryFn);
                }
            };
            
            await performUpload();

            // Clear current project from localStorage
            try {
                localStorage.removeItem('currentProject');
            } catch(e) {}
            
            } catch (error) {
                console.error("Export CSV error:", error);
                showToast("Export failed: " + error.message, 'error');
            }
        });

        // Import CSV removed - no longer needed with auto-save
        // Keeping importFileInput element for potential future use
        const importFileInput = document.getElementById('importFile');
        if (importFileInput) {
            importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                const text = ev.target.result;
                try {
                    const lines = text.trim().split(/\r?\n/);
                    if (lines.length < 2) throw new Error('No data');
                    // Parse site information from first two lines
                    const siteHeaders = parseCSVRow(lines[0]);
                    const siteValues = parseCSVRow(lines[1]);
                    siteData = {};
                    entries = [];
                    siteHeaders.forEach((h, idx) => {
                        const key = h.replace(/^"|"$/g, '').trim();
                        const val = siteValues[idx] ? siteValues[idx].replace(/^"|"$/g, '') : '';
                        // normalise keys to lower-case for mapping
                        const lower = key.toLowerCase();
                        if (lower === 'customer') siteData.customer = val;
                        else if (lower === 'street') siteData.street = val;
                        else if (lower === 'city') siteData.city = val;
                        else if (lower === 'state') siteData.state = val;
                        else if (lower === 'zip') siteData.zip = val;
                        else if (lower === 'contact') siteData.contact = val;
                        else if (lower === 'phone') siteData.phone = val;
                        else if (lower === 'date') siteData.date = val;
                        else if (lower === 'utility company') siteData.utility = val;
                    });
                    // Start processing from line index 2 (0-based). Skip blank lines.
                    let idx = 2;
                    // skip blank lines
                    while (idx < lines.length && !lines[idx].trim()) idx++;
                    let currentSection = '';
                    let headers = [];
                    while (idx < lines.length) {
                        const line = lines[idx].trim();
                        if (!line) {
                            idx++;
                            continue;
                        }
                        // Remove enclosing quotes for section labels
                        const cleanLine = line.replace(/^"|"$/g, '');
                        if (cleanLine === 'Evaporators' || cleanLine === 'Condensers') {
                            currentSection = (cleanLine === 'Evaporators') ? 'evap' : 'cond';
                            idx++;
                            if (idx < lines.length) {
                                headers = parseCSVRow(lines[idx]).map(h => h.replace(/^"|"$/g, ''));
                                idx++;
                            }
                            continue;
                        }
                        // If we have headers and currentSection, parse entry row until blank or new section
                        if (currentSection && headers.length) {
                            // Check if next section begins
                            if (cleanLine === 'Evaporators' || cleanLine === 'Condensers') {
                                // start of new section, don't consume this line here (loop will handle)
                                continue;
                            }
                            const values = parseCSVRow(lines[idx]);
                            const entry = {};
                            
                            // Create reverse mapping from CSV headers to internal field names
                            const headerToFieldMap = {
                                'Zone': 'room-zone',
                                'Sheet': 'sheetNumber',
                                'Name': 'room-name',
                                'Evap QTY': 'room-count',
                                'Motor QTY': 'room-fanMotorsPerUnit',
                                'Volts': 'room-voltage',
                                'Amps': 'room-amps',
                                'Phase': 'room-phase',
                                'Motor HP': 'room-hp',
                                'Split': 'room-split',
                                'Operation Time Factor': 'room-runTime',
                                'Mfg': 'room-mfg',
                                'Motor Mounting': 'room-motorMounting',
                                'Frame': 'room-frame',
                                'RPM': 'room-rpm',
                                'Rotation': 'room-rotation',
                                'Shaft': 'room-shaftSize',
                                'Shaft Adptr QTY': 'room-shaftAdapterQty',
                                'Shaft Adptr Type': 'room-shaftAdapterType',
                                'Blade Specs': 'room-bladeSpec',
                                'QTY Blades Needed': 'room-bladesNeeded',
                                'Current Temp': 'room-currentTemp',
                                'Set Point': 'room-setPoint',
                                'Notes': 'room-notes'
                            };
                            
                            headers.forEach((h, i) => {
                                const val = values[i] ? values[i].replace(/^"|"$/g, '').trim() : '';
                                // Use mapping if available, otherwise use default 'room-' prefix
                                const fieldName = headerToFieldMap[h] || 'room-' + h;
                                if (val) {
                                    entry[fieldName] = val;
                                }
                            });
                            // If adapter qty is present, set adapters to Yes
                            if (entry['room-shaftAdapterQty'] && Number(entry['room-shaftAdapterQty']) > 0) {
                                entry['room-shaftAdapters'] = 'Yes';
                            }
                            // assign section and default mode
                            entry.section = currentSection;
                            entry.mode = 'detailed';
                            entries.push(entry);
                            idx++;
                            continue;
                        }
                        idx++;
                    }
                    // populate site form values and show data section
                    document.getElementById('site-date').value = siteData.date || '';
                    if (siteData.visitDate) {
                        document.getElementById('visitDateText').textContent = siteData.visitDate;
                    }
                    document.getElementById('site-customer').value = siteData.customer || '';
                    document.getElementById('site-street').value = siteData.street || '';
                    document.getElementById('site-city').value = siteData.city || '';
                    document.getElementById('site-state').value = siteData.state || 'CA';
                    document.getElementById('site-zip').value = siteData.zip || '';
                    document.getElementById('site-contact').value = siteData.contact || '';
                    document.getElementById('site-phone').value = siteData.phone || '';
                    
                    applyUtilityToForm(siteData.utility);
                    
                    // Update Site Address display
                    const addressParts = [];
                    if (siteData.street) addressParts.push(siteData.street);
                    const cityStateZip = [siteData.city, siteData.state, siteData.zip].filter(v => v).join(', ');
                    if (cityStateZip) addressParts.push(cityStateZip);
                    document.getElementById('siteAddressText').textContent = addressParts.join(', ') || 'No address provided';
                    
                    // hide site section and show data section
                    siteSection.classList.add('hidden');
                    dataSection.classList.remove('hidden');
                    setSaveCustomerInfoVisible(false);
                    // Show edit site pencil icon
                    const editSiteBtn = document.getElementById('editSiteBtn');
                    if (editSiteBtn) {
                        editSiteBtn.classList.remove('hidden');
                    }
                    renderEntries();
                } catch(err) {
                    showToast('Failed to import: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            });
        }

        // Edit Site Info button: show the site entry form again for editing
        const editSiteBtn = document.getElementById('editSiteBtn');
        if (editSiteBtn) {
            editSiteBtn.addEventListener('click', () => {
                // Populate the site form with current siteData values
                document.getElementById('site-date').value = siteData.date || document.getElementById('site-date').value;
                document.getElementById('site-customer').value = siteData.customer || '';
                document.getElementById('site-street').value = siteData.street || '';
                document.getElementById('site-city').value = siteData.city || '';
                document.getElementById('site-state').value = siteData.state || 'CA';
                document.getElementById('site-zip').value = siteData.zip || '';
                document.getElementById('site-contact').value = siteData.contact || '';
                document.getElementById('site-phone').value = siteData.phone || '';
                
                applyUtilityToForm(siteData.utility);
                
                // Show site section and hide data section
                siteSection.classList.remove('hidden');
                dataSection.classList.add('hidden');
                // Show the legacy "Save Customer Info" button on the site/customer screen
                setSaveCustomerInfoVisible(true);
                // Hide edit site pencil icon
                const editSiteBtn = document.getElementById('editSiteBtn');
                if (editSiteBtn) {
                    editSiteBtn.classList.add('hidden');
                }
            });
        }

        // Setup Enter navigation inside the form: move to next visible field or submit
        function setupEnterNavigation() {
            const allInputs = Array.from(roomForm.querySelectorAll('input, textarea, select'));
            allInputs.forEach((input) => {
                input.removeEventListener('keydown', handleEnter);
                input.addEventListener('keydown', handleEnter);
            });
        }
        function handleEnter(e) {
            if (e.key === 'Enter') {
                // ignore select elements to prevent default submit
                if (e.target.tagName.toLowerCase() === 'select') return;
                e.preventDefault();
                const allInputs = Array.from(roomForm.querySelectorAll('input, textarea, select'));
                const visible = allInputs.filter(inp => !inp.closest('.field') || !inp.closest('.field').classList.contains('hidden'));
                const idx = visible.indexOf(e.target);
                if (idx >= 0 && idx < visible.length - 1) {
                    visible[idx + 1].focus();
                } else {
                    roomForm.requestSubmit();
                }
            }
        }

        // call setupEnterNavigation initially and whenever form is opened
        setupEnterNavigation();

        // initial render (skip save to avoid overwriting restored data)
        renderEntries(true);

        // Update blades options based on count and fan motors per unit
        function updateBladesOptions() {
            const bladesList = document.getElementById('blades-options');
            const count = parseInt(document.getElementById('room-count').value || '0', 10);
            const fans = parseInt(document.getElementById('room-fanMotorsPerUnit').value || '0', 10);
            const max = count * fans;
            bladesList.innerHTML = '';
            // always include 0 (none needed)
            for (let i = 0; i <= max; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                bladesList.appendChild(opt);
            }
        }

        // Whenever count or fans per unit changes, update blades options
        document.getElementById('room-count').addEventListener('input', updateBladesOptions);
        document.getElementById('room-fanMotorsPerUnit').addEventListener('input', updateBladesOptions);

        // Enable drag-and-drop sorting within each section
        function setupDragAndDrop() {
            const sections = { 'evap': evapCardsContainer, 'cond': condCardsContainer };
            Object.keys(sections).forEach(section => {
                const container = sections[section];
                container.addEventListener('dragstart', (e) => {
                    if (e.target && e.target.classList.contains('card')) {
                        e.target.classList.add('dragging');
                    }
                });
                container.addEventListener('dragend', (e) => {
                    if (e.target && e.target.classList.contains('card')) {
                        e.target.classList.remove('dragging');
                    }
                });
                container.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const dragging = container.querySelector('.dragging');
                    if (!dragging) return;
                    const afterElement = getDragAfterElement(container, e.clientY);
                    if (afterElement == null) {
                        container.appendChild(dragging);
                    } else {
                        container.insertBefore(dragging, afterElement);
                    }
                });
                container.addEventListener('drop', () => {
                    // Build new order indices for this section
                    const orderedIndices = Array.from(container.children).map(card => parseInt(card.getAttribute('data-index')));
                    // Extract current entries for section and others
                    const current = entries.filter((ent, idx) => ent.section === section);
                    const others = entries.filter((ent, idx) => ent.section !== section);
                    // Build new section entries in the order of orderedIndices
                    const newSectionEntries = orderedIndices.map(i => entries[i]).filter(ent => ent.section === section);
                    // Reconstruct entries array preserving order: for evaporators, then condensers
                    if (section === 'evap') {
                        entries = newSectionEntries.concat(others);
                    } else {
                        // cond
                        entries = others.concat(newSectionEntries);
                    }
                    renderEntries();
                });
            });
        }
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Auto-capitalize inputs with class 'capitalize' on blur so that
        // underlying values have initial caps. This does not affect numbers.
        function capitalizeWords(str) {
            return str.split(/\s+/).map(word => {
                if (!word) return '';
                // Preserve mixed-case words like "KE2" or numbers
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
        }
        function attachCapitalization() {
            const caps = document.querySelectorAll('input.capitalize, textarea.capitalize');
            caps.forEach(el => {
                // Skip blade spec field - allow plain number entry
                if (el.id === 'room-bladeSpec') return;
                el.addEventListener('blur', () => {
                    el.value = capitalizeWords(el.value);
                });
            });
        }
        // attach once at initialization
        attachCapitalization();
        
        // DISABLED: 15-second autosave timer was causing race conditions and duplicate project creation
        // startAutosaveTimer();
        
        // DEEP LINK ONLY: Load project from URL parameter if present
        // This is the ONLY path that auto-navigates to a project on load
        const urlProjectId = getProjectIdFromUrl();
        if (urlProjectId) {
            console.log('[init] Deep link detected, loading project:', urlProjectId);
            loadProjectById(urlProjectId, 'deeplink');
        }
        
        // DISABLED: Auto-restore of drafts was causing unwanted navigation
        // Users must explicitly open projects via the Home screen's "Recently Opened" list
        // or by clicking "Open" on Past Sitewalks
        // The draft data is still restored to ProjectState silently for Recently Opened display,
        // but NO automatic navigation occurs
        // 
        // Old behavior that caused issues:
        // if (!checkForAutosaveOnLoad()) {
        //     checkForInProgressWork();
        // }
        console.log('[init] Always landing on Home screen - no auto-open');

        // Populate saved projects dropdown on load
        refreshSavedProjectsList();

        // Suggestions: populate datalists from localStorage and store new values when fields are blurred
        function updateSuggestionsFor(inputId) {
            const listEl = document.getElementById(inputId + '-options');
            if (!listEl) return;
            let values = [];
            try {
                const stored = localStorage.getItem('suggest:' + inputId);
                values = stored ? JSON.parse(stored) : [];
            } catch (e) {}
            // preserve default options marked with data-default
            const defaultOpts = Array.from(listEl.querySelectorAll('option[data-default]'));
            listEl.innerHTML = '';
            // append default options first
            defaultOpts.forEach(opt => listEl.appendChild(opt));
            // then append user suggestions that are not already included
            values.forEach(v => {
                if (!defaultOpts.some(o => o.value === v)) {
                    const opt = document.createElement('option');
                    opt.value = v;
                    listEl.appendChild(opt);
                }
            });
        }
        function updateAllSuggestions() {
            const suggestInputs = document.querySelectorAll('input.suggest');
            suggestInputs.forEach(inp => {
                updateSuggestionsFor(inp.id);
            });
        }
        // Call once on load
        updateAllSuggestions();
        // Attach blur events to store new suggestions
        const suggestInputs = document.querySelectorAll('input.suggest');
        suggestInputs.forEach(inp => {
            inp.addEventListener('blur', () => {
                const val = inp.value.trim();
                if (!val) return;
                const key = 'suggest:' + inp.id;
                let arr = [];
                try {
                    const stored = localStorage.getItem(key);
                    arr = stored ? JSON.parse(stored) : [];
                } catch (e) {}
                if (!arr.includes(val)) {
                    arr.push(val);
                    try {
                        localStorage.setItem(key, JSON.stringify(arr));
                    } catch (e) {}
                }
                updateSuggestionsFor(inp.id);
            });
        });

        // Blade spec auto-formatting removed - users can type plain numbers without auto-formatting

        // Reorder mode is now controlled by tapping the six-dot handles on each card

        // DEPRECATED: Dropdown removed - use Load Project modal instead
        async function populateSavedProjectsDropdown() {
            // Dropdown has been removed, this function is deprecated
            // Use ProjectService.listProjects() and Load Project modal instead
            console.log('[deprecated] populateSavedProjectsDropdown called - use Load Project modal');
        }

        // Shared function to load a project by ID
        // UPDATED: Backend is now source of truth, no localStorage fallback
        // source parameter controls navigation behavior:
        //   'deeplink' - auto-navigate to currentProject view on success
        //   anything else - caller is responsible for navigation
        // On failure: clear project state, only navigate to Home for deep links
        async function loadProjectById(projectId, source) {
            const isDeepLink = source === 'deeplink';
            
            try {
                let proj = null;
                
                // Fetch from server (backend is source of truth)
                const response = await fetch(`/api/projects/${projectId}`);
                if (response.ok) {
                    proj = await response.json();
                }
                
                if (!proj) {
                    console.warn('[loadProjectById] Project not found or fetch failed:', projectId);
                    // Clear stale project state
                    clearProjectIdFromUrl();
                    localStorage.removeItem('lastProjectId');
                    ProjectState.currentProjectId = null;
                    ProjectState.project_id = null;
                    // Show error
                    showToast('Project not found or could not be loaded.', 'error');
                    // Only navigate to Home for deep links (where we expected navigation)
                    // For other callers, let them handle the error state
                    if (isDeepLink) {
                        NavigationController.setView('home');
                    }
                    return;
                }
                
                // CRITICAL: Set ProjectState IDs so Electric Bills and other features work
                ProjectState.currentProjectId = projectId;
                ProjectState.project_id = projectId;
                ProjectState.currentProjectName = proj._metadata?.name || proj.name || proj.siteData?.customer || null;
                console.log('[loadProjectById] Set currentProjectId:', projectId);
                
                siteData = proj.siteData || {};
                siteData.project_id = projectId; // Ensure siteData also has the project_id
                entries = migrateEntries(proj.entries || []); // Migrate old 'count' to 'room-count'
                
                // Sync to ProjectState
                Object.keys(ProjectState.siteData).forEach(key => delete ProjectState.siteData[key]);
                Object.assign(ProjectState.siteData, siteData);
                ProjectState.entries.length = 0;
                ProjectState.entries.push(...entries);
                
                // Load photos and migrate to new format if needed
                photos.length = 0; // Clear existing photos
                if (Array.isArray(proj.photos)) {
                    photos.push(...proj.photos);
                }
                ProjectState.photos = ProjectState.photos || [];
                ProjectState.photos.length = 0;
                ProjectState.photos.push(...photos);
                migratePhotosToNewFormat(); // Migrate old field names to new format
                
                // Populate site form values
                document.getElementById('site-date').value = siteData.date || '';
                if (siteData.visitDate) {
                    document.getElementById('visitDateText').textContent = siteData.visitDate;
                }
                document.getElementById('site-customer').value = siteData.customer || '';
                document.getElementById('site-street').value = siteData.street || '';
                document.getElementById('site-city').value = siteData.city || '';
                document.getElementById('site-state').value = siteData.state || 'CA';
                document.getElementById('site-zip').value = siteData.zip || '';
                document.getElementById('site-contact').value = siteData.contact || '';
                document.getElementById('site-phone').value = siteData.phone || '';
                
                applyUtilityToForm(siteData.utility);
                
                // Update Site Address display
                const addressParts = [];
                if (siteData.street) addressParts.push(siteData.street);
                const cityStateZip = [siteData.city, siteData.state, siteData.zip].filter(v => v).join(', ');
                if (cityStateZip) addressParts.push(cityStateZip);
                document.getElementById('siteAddressText').textContent = addressParts.join(', ') || 'No address provided';
                
                // Update customer name in header
                const customerNameEl = document.getElementById('customerName');
                if (customerNameEl && siteData.customer) {
                    customerNameEl.textContent = siteData.customer;
                }
                
                // Save to localStorage so current project is updated
                SaveController.queueSave('project-load-legacy');
                
                // Switch to data view
                siteSection.classList.add('hidden');
                dataSection.classList.remove('hidden');
                setSaveCustomerInfoVisible(false);
                // Show edit site pencil icon
                const editSiteBtn = document.getElementById('editSiteBtn');
                if (editSiteBtn) {
                    editSiteBtn.classList.remove('hidden');
                }
                renderEntries();
                
                console.log('✓ Loaded project:', projectId, '(source:', source || 'user', ')');
                
                // Only auto-navigate for deep links - other callers handle their own navigation
                if (isDeepLink) {
                    // Respect the current path instead of always going to currentProject
                    const currentPath = window.location.pathname.replace(/^\//, '') || '';
                    const projectViews = {
                        'customer-info': 'customerInfo',
                        'current-project': 'currentProject',
                        'utility-bills': 'utilityBills',
                        'print': 'printView'
                    };
                    // If we're on a project-specific view path, stay there
                    const targetView = projectViews[currentPath] || 'currentProject';
                    NavigationController.setView(targetView);
                }
            } catch (e) {
                console.error('[loadProjectById] Failed to load project:', e);
                // Clear stale project state
                clearProjectIdFromUrl();
                localStorage.removeItem('lastProjectId');
                ProjectState.currentProjectId = null;
                ProjectState.project_id = null;
                // Show error
                showToast('Failed to load project. Please try again.', 'error');
                // Only navigate to Home for deep links
                if (isDeepLink) {
                    NavigationController.setView('home');
                }
            }
        }
        
        // DEPRECATED: Dropdown removed - use Load Project modal instead
        // (savedProjectsSelectTop has been removed from the UI)

        // Helper: parse a CSV row into an array of cell values, handling quoted fields
        function parseCSVRow(line) {
            const vals = [];
            let inside = false;
            let current = '';
            for (let i = 0; i < line.length; i++) {
                const ch = line[i];
                if (ch === '"') {
                    if (inside && line[i + 1] === '"') {
                        // escaped double quote
                        current += '"';
                        i++;
                    } else {
                        inside = !inside;
                    }
                } else if (ch === ',' && !inside) {
                    vals.push(current);
                    current = '';
                } else {
                    current += ch;
                }
            }
            vals.push(current);
            return vals;
        }

        // ===== USE MY LOCATION FEATURE =====
        // Hardcoded ZIP → Utility mapping (expand this as needed)
        const ZIP_TO_UTILITY = {
            '90058': 'LADWP',
            '92337': 'SCE',
            '90230': 'LADWP',
            '91301': 'LADWP',
            '94720': 'PG&E',
            '95814': 'SMUD'
        };

        // Initialize location feature - wait for DOM to ensure modal elements exist
        function initializeLocationFeature() {
            const useLocationBtn = document.getElementById('useLocationBtn');
            const nearbyModal = document.getElementById('nearbyBusinessesModal');
            const nearbyModalClose = document.getElementById('nearbyModalClose');
            
            if (!useLocationBtn) {
                console.warn('useLocationBtn not found');
                return;
            }
            if (!nearbyModal) {
                console.warn('nearbyBusinessesModal not found');
                return;
            }

            // Fetch nearby businesses when button is clicked
            /* ===== GEOLOCATION WITH SMART FALLBACKS ===== */
            
            // Load last known location from localStorage
            let lastKnownLocation = null;
            try {
                const stored = localStorage.getItem('ces_last_location');
                if (stored) {
                    lastKnownLocation = JSON.parse(stored);
                }
            } catch (e) {
                console.warn('Could not load last known location:', e);
            }
            
            // Fetch nearby businesses given lat/lng
            async function fetchNearbyBusinesses(lat, lng) {
                const modal = document.getElementById('nearbyBusinessesModal');
                const list = document.getElementById('nearbyBusinessesList');
                const loadMsg = document.getElementById('nearbyLoadingMsg');
                
                list.innerHTML = '';
                loadMsg.textContent = 'Loading nearby businesses...';
                loadMsg.style.color = '#333';
                loadMsg.style.display = 'block';
                modal.classList.add('show');
                
                // Store GPS location for autocomplete bias
                userLocationLatLng = { lat, lng };
                
                // Save as last known good location
                try {
                    localStorage.setItem('ces_last_location', JSON.stringify({ latitude: lat, longitude: lng }));
                    lastKnownLocation = { latitude: lat, longitude: lng };
                } catch (e) {
                    console.warn('Could not save location to localStorage:', e);
                }
                
                try {
                    const response = await fetch(`/api/nearby-businesses?lat=${lat}&lng=${lng}`);
                    const data = await response.json();
                    
                    // Check if response is an error object
                    if (!response.ok || (data.error && !Array.isArray(data))) {
                        const errorMsg = data.error || `Server error: ${response.status}`;
                        console.error('Nearby businesses API error:', errorMsg);
                        loadMsg.textContent = errorMsg;
                        loadMsg.style.color = '#d9534f';
                        loadMsg.style.display = 'block';
                        list.innerHTML = '';
                        return;
                    }
                    
                    // Response should be an array of businesses
                    const businesses = Array.isArray(data) ? data : [];
                    console.log(`✓ Received ${businesses.length} businesses from API`);
                    
                    loadMsg.style.display = 'none';
                    
                    if (businesses.length === 0) {
                        list.innerHTML = '<p style="color:#666; padding: 1rem; text-align: center;">No nearby businesses found.<br>Try a different location or enter address manually.</p>';
                        return;
                    }
                    
                    businesses.forEach((biz) => {
                        const item = document.createElement('div');
                        item.className = 'nearby-business-item';
                        item.innerHTML = `
                            <div class="nearby-business-name">${biz.name || 'Unknown'}</div>
                            <div class="nearby-business-address">${biz.address || ''}</div>
                            <div style="font-size:0.85rem; color:#999;">${biz.city || ''} ${biz.state || ''} ${biz.zip || ''}</div>
                        `;
                        item.addEventListener('click', () => selectBusiness(biz));
                        list.appendChild(item);
                    });
                } catch (err) {
                    console.error('Nearby businesses API error:', err);
                    loadMsg.textContent = 'Failed to load nearby businesses. Please try again.';
                    loadMsg.style.color = '#d9534f';
                    loadMsg.style.display = 'block';
                }
            }
            
            // Show error modal with smart fallback buttons
            function showLocationFallbacks(errorMessage) {
                const modal = document.getElementById('nearbyBusinessesModal');
                const list = document.getElementById('nearbyBusinessesList');
                const loadMsg = document.getElementById('nearbyLoadingMsg');
                
                loadMsg.style.display = 'none';
                modal.classList.add('show');
                
                list.innerHTML = `
                    <div style="padding: 1rem; text-align: center;">
                        <p style="color: #d9534f; margin-bottom: 1rem;">${errorMessage}</p>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem; max-width: 300px; margin: 0 auto;">
                            <button id="retryGeoBtn" style="padding: 0.6rem 1rem; background: #2d7bb8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                                🔄 Retry Location Access
                            </button>
                            <button id="fallbackTypedBtn" style="padding: 0.6rem 1rem; background: #5cb85c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                                📍 Use Typed Address
                            </button>
                            <button id="fallbackCityZipBtn" style="padding: 0.6rem 1rem; background: #5cb85c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                                📮 Use City + ZIP
                            </button>
                            ${lastKnownLocation ? `
                                <button id="fallbackLastBtn" style="padding: 0.6rem 1rem; background: #f0ad4e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                                    🕐 Use Last Known Location
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // Attach event listeners
                const retryBtn = document.getElementById('retryGeoBtn');
                const typedBtn = document.getElementById('fallbackTypedBtn');
                const cityZipBtn = document.getElementById('fallbackCityZipBtn');
                const lastBtn = document.getElementById('fallbackLastBtn');
                
                if (retryBtn) retryBtn.onclick = requestGeolocation;
                if (typedBtn) typedBtn.onclick = useTypedAddress;
                if (cityZipBtn) cityZipBtn.onclick = useCityZip;
                if (lastBtn && lastKnownLocation) {
                    lastBtn.onclick = () => {
                        fetchNearbyBusinesses(lastKnownLocation.latitude, lastKnownLocation.longitude);
                    };
                }
            }
            
            // Convert typed street address to coordinates
            async function useTypedAddress() {
                const street = document.getElementById('site-street').value.trim();
                const city = document.getElementById('site-city').value.trim();
                const state = document.getElementById('site-state').value.trim();
                const zip = document.getElementById('site-zip').value.trim();
                
                const parts = [street, city, state, zip].filter(x => x);
                
                if (parts.length === 0) {
                    showToast('Please fill in at least one address field (Street, City, State, or ZIP) before using this option.', 'warning');
                    return;
                }
                
                const query = parts.join(', ');
                await geocodeAndSearch(query);
            }
            
            // Convert City + ZIP to coordinates
            async function useCityZip() {
                const city = document.getElementById('site-city').value.trim();
                const state = document.getElementById('site-state').value.trim();
                const zip = document.getElementById('site-zip').value.trim();
                
                const parts = [city, state, zip].filter(x => x);
                
                if (parts.length === 0) {
                    showToast('Please fill in City, State, or ZIP before using this option.', 'warning');
                    return;
                }
                
                const query = parts.join(', ');
                await geocodeAndSearch(query);
            }
            
            // Geocode an address string and fetch nearby businesses
            async function geocodeAndSearch(address) {
                const modal = document.getElementById('nearbyBusinessesModal');
                const list = document.getElementById('nearbyBusinessesList');
                const loadMsg = document.getElementById('nearbyLoadingMsg');
                
                list.innerHTML = '';
                loadMsg.textContent = `Looking up "${address}"...`;
                loadMsg.style.color = '#333';
                loadMsg.style.display = 'block';
                
                try {
                    const response = await fetch(`/api/geocode?address=${encodeURIComponent(address)}`);
                    
                    if (!response.ok) {
                        throw new Error('Geocoding failed');
                    }
                    
                    const data = await response.json();
                    
                    if (!data || !data.lat || !data.lng) {
                        loadMsg.textContent = 'Could not find that address. Please check your input.';
                        loadMsg.style.color = '#d9534f';
                        return;
                    }
                    
                    console.log(`✓ Geocoded "${address}" to: ${data.lat}, ${data.lng}`);
                    await fetchNearbyBusinesses(data.lat, data.lng);
                    
                } catch (err) {
                    console.error('Geocoding error:', err);
                    loadMsg.textContent = 'Could not geocode that address. Please try again.';
                    loadMsg.style.color = '#d9534f';
                }
            }
            
            // Request geolocation with improved error handling
            function requestGeolocation() {
                const modal = document.getElementById('nearbyBusinessesModal');
                const list = document.getElementById('nearbyBusinessesList');
                const loadMsg = document.getElementById('nearbyLoadingMsg');
                
                list.innerHTML = '';
                loadMsg.textContent = 'Requesting your location...';
                loadMsg.style.color = '#333';
                loadMsg.style.display = 'block';
                modal.classList.add('show');
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        console.log(`✓ Got geolocation: ${lat}, ${lng}`);
                        fetchNearbyBusinesses(lat, lng);
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        
                        let msg = '';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                msg = '🚫 Location permission was denied by your browser.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                msg = '📡 Your device could not determine your location (VPN, desktop Wi-Fi, or blocked network).';
                                break;
                            case error.TIMEOUT:
                                msg = '⏱️ Location request timed out. Your device or network is running slow.';
                                break;
                            default:
                                msg = '❌ Unknown location error occurred.';
                        }
                        
                        showLocationFallbacks(msg);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 7000,
                        maximumAge: 0
                    }
                );
            }
            
            // Main button click handler
            useLocationBtn.addEventListener('click', (e) => {
                e.preventDefault();
            
            // If Places API isn't enabled, don't request location (avoids confusing empty results)
            if (!NavigationController.googlePlacesEnabled) {
                showToast('Google Places not configured. Set GOOGLE_PLACES_API_KEY in .env and restart the server.', 'warning');
                return;
            }
            
                requestGeolocation();
            });

            // Handle modal close button
            nearbyModalClose.addEventListener('click', () => {
                nearbyModal.classList.remove('show');
            });

            // Close modal when clicking outside
            nearbyModal.addEventListener('click', (e) => {
                if (e.target.id === 'nearbyBusinessesModal') {
                    nearbyModal.classList.remove('show');
                }
            });
        }

        // Call initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeLocationFeature);
        } else {
            initializeLocationFeature();
        }

        // ===== GOOGLE PLACES AUTOCOMPLETE FEATURE =====
        // Debounce timer for autocomplete requests
        let autocompleteTimers = {};
        let lastPlacesConfigToastAt = 0;
        function maybeShowPlacesConfigToast(message) {
            const now = Date.now();
            if (now - lastPlacesConfigToastAt < 10000) return; // throttle
            lastPlacesConfigToastAt = now;
            showToast(message, 'warning');
        }
        
        function setupAutocomplete(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            
            if (!input || !dropdown) return;
            
            // Listen to input changes
            input.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                // Clear previous timer
                if (autocompleteTimers[inputId]) {
                    clearTimeout(autocompleteTimers[inputId]);
                }
                
                if (query.length < 2) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                // Debounce autocomplete request (300ms delay)
                autocompleteTimers[inputId] = setTimeout(async () => {
                    try {
                        // Build autocomplete URL with GPS location bias if available
                        let url = `/api/place-autocomplete?input=${encodeURIComponent(query)}`;
                        if (userLocationLatLng) {
                            url += `&lat=${userLocationLatLng.lat}&lng=${userLocationLatLng.lng}`;
                        }
                        
                        const response = await fetch(url);
                        if (!response.ok) {
                            // Try to surface the backend error (e.g., missing GOOGLE_PLACES_API_KEY)
                            try {
                                const data = await response.json();
                                if (data && data.error) {
                                    maybeShowPlacesConfigToast(data.error);
                                }
                            } catch (e) {}
                            throw new Error('API error');
                        }
                        
                        const results = await response.json();
                        
                        // Clear previous results
                        dropdown.innerHTML = '';
                        
                        if (!results || results.length === 0) {
                            dropdown.classList.remove('show');
                            return;
                        }
                        
                        // Show dropdown with results
                        results.forEach((result) => {
                            const item = document.createElement('div');
                            item.className = 'autocomplete-item';
                            item.innerHTML = `
                                <div class="autocomplete-main">${result.main || result.name || ''}</div>
                                <div class="autocomplete-secondary">${result.secondary || ''}</div>
                            `;
                            
                            item.addEventListener('click', async () => {
                                // For autocomplete, fetch full place details and parse address
                                if (result.place_id) {
                                    try {
                                        const detailResponse = await fetch(`/api/place-details?place_id=${encodeURIComponent(result.place_id)}`);
                                        if (detailResponse.ok) {
                                            const parsed = await detailResponse.json();
                                            
                                            // Determine which function to call based on which field triggered the autocomplete
                                            if (inputId === 'site-customer' || inputId === 'ci-customer') {
                                                // Customer field: fill all fields including customer name
                                                selectBusiness({
                                                    name: parsed.name || result.main || '',
                                                    address: parsed.street || '',
                                                    city: parsed.city || '',
                                                    state: parsed.state || 'CA',
                                                    zip: parsed.zip || ''
                                                });
                                            } else {
                                                // Address fields (street, city): only fill address, preserve customer
                                                selectAddress({
                                                    street: parsed.street || '',
                                                    city: parsed.city || '',
                                                    state: parsed.state || 'CA',
                                                    zip: parsed.zip || ''
                                                });
                                            }
                                            
                                            dropdown.classList.remove('show');
                                            return;
                                        }
                                    } catch (err) {
                                        console.error('Place details error:', err);
                                    }
                                }
                                
                                // Fallback: just set the field value
                                input.value = result.value || result.main || '';
                                dropdown.classList.remove('show');
                                
                                // Update clear button visibility after programmatic fill
                                updateClearButtonVisibility(input);
                                
                                // Close all other autocomplete dropdowns
                                closeAllAutocompleteDropdowns();
                            });
                            
                            dropdown.appendChild(item);
                        });
                        
                        dropdown.classList.add('show');
                    } catch (err) {
                        console.error('Autocomplete error:', err);
                        dropdown.classList.remove('show');
                    }
                }, 300);
            });
            
            // Hide dropdown when input loses focus
            input.addEventListener('blur', () => {
                setTimeout(() => {
                    dropdown.classList.remove('show');
                }, 200);
            });
        }
        
        // Initialize autocomplete for address fields
        setTimeout(() => {
            setupAutocomplete('site-customer', 'site-customer-autocomplete');
            setupAutocomplete('site-street', 'site-street-autocomplete');
            setupAutocomplete('site-city', 'site-city-autocomplete');
        }, 500);
        
        // ===== OPTIONAL: GET GPS LOCATION ON PAGE LOAD FOR AUTOCOMPLETE BIAS =====
        // Silently capture user's GPS location to improve autocomplete suggestions
        // If user denies or it fails, no error shown - autocomplete just uses default behavior
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocationLatLng = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log(`📍 GPS location captured for autocomplete bias: ${userLocationLatLng.lat}, ${userLocationLatLng.lng}`);
                },
                (error) => {
                    // Silent failure - don't show alerts or errors to user
                    // Autocomplete will still work, just without GPS bias
                    console.warn('GPS location not available for autocomplete bias:', error.message);
                },
                {
                    timeout: 5000,  // 5 second timeout
                    maximumAge: 300000  // Accept cached location up to 5 minutes old
                }
            );
        }
        
        // Reduce iOS keyboard noise by adding HTML attributes
        function reduceIOSKeyboardNoise() {
            const allInputs = document.querySelectorAll('input[type="text"], input[type="tel"], input[type="email"], input[type="number"], input[type="search"]');
            
            allInputs.forEach(input => {
                // Skip Notes fields - they should keep normal typing behavior
                if (input.id === 'room-notes' || input.name === 'notes' || input.closest('.notes-section')) {
                    return;
                }
                
                // Add attributes to minimize iOS keyboard suggestions/autofill
                if (!input.hasAttribute('autocomplete')) {
                    input.setAttribute('autocomplete', 'off');
                }
                input.setAttribute('autocorrect', 'off');
                input.setAttribute('autocapitalize', 'off');
                input.setAttribute('spellcheck', 'false');
            });
        }
        
        /* ===============================
           CLEAR BUTTON LOGIC
           =============================== */
        
        // Helper function to control clear button visibility
        function updateClearButtonVisibility(input) {
            if (!input) return;

            // The wrapper is the div that contains the input + the X button
            const wrapper = input.closest('.input-wrapper');
            if (!wrapper) return;

            const btn = wrapper.querySelector('.clear-input-btn');
            if (!btn) return;

            const hasValue = input.value && input.value.trim() !== "";
            btn.style.display = hasValue ? "block" : "none";
        }
        
        function attachClearButton(input) {
            if (!input) return;

            const wrapper = input.closest('.input-wrapper');
            if (!wrapper) return;

            const clearBtn = wrapper.querySelector('.clear-input-btn');
            if (!clearBtn) return;

            // Set initial visibility based on whatever value is in the field
            updateClearButtonVisibility(input);

            // Whenever the user types (or script fires an input event),
            // recalc visibility.
            input.addEventListener("input", function () {
                updateClearButtonVisibility(input);
            });

            clearBtn.addEventListener("click", function (e) {
                e.preventDefault();
                e.stopPropagation();

                // Clear value
                input.value = "";

                // Clear any data attrs we use for Places
                input.removeAttribute("data-place-id");

                // Update visibility (should hide X now)
                updateClearButtonVisibility(input);

                // Bubble an input event in case other logic depends on it
                const evt = new Event("input", { bubbles: true });
                input.dispatchEvent(evt);

                // Refocus so user can immediately type
                input.focus();

                // Helps stop iOS from popping weird select-bubbles
                setTimeout(() => {
                    try {
                        input.setSelectionRange(0, 0);
                    } catch (err) {
                        // some inputs (like type=number) don't support this; ignore
                    }
                }, 0);
            });
        }
        
        // Initialize iOS noise reduction and clear buttons after DOM is ready
        setTimeout(() => {
            reduceIOSKeyboardNoise();
            
            // Attach clear button functionality to all inputs inside .input-wrapper
            document.querySelectorAll('.input-wrapper input').forEach(input => {
                attachClearButton(input);
            });
        }, 600);

        // Auto-fill form when a business is selected
        function selectBusiness(biz) {
            console.log('[selectBusiness] Filling form with:', biz.name, biz.address);
            
            // Fill main site-* fields (used in main form)
            const siteCustomer = document.getElementById('site-customer');
            const siteStreet = document.getElementById('site-street');
            const siteCity = document.getElementById('site-city');
            const siteState = document.getElementById('site-state');
            const siteZip = document.getElementById('site-zip');
            
            if (siteCustomer) siteCustomer.value = biz.name || '';
            if (siteStreet) siteStreet.value = biz.address || '';
            if (siteCity) siteCity.value = biz.city || '';
            if (siteState) siteState.value = (biz.state || 'CA').toUpperCase();
            if (siteZip) siteZip.value = biz.zip || '';
            
            // Also fill ci-* fields (used in Customer Info view)
            const ciCustomer = document.getElementById('ci-customer');
            const ciStreet = document.getElementById('ci-street');
            const ciCity = document.getElementById('ci-city');
            const ciState = document.getElementById('ci-state');
            const ciZip = document.getElementById('ci-zip');
            
            if (ciCustomer) ciCustomer.value = biz.name || '';
            if (ciStreet) ciStreet.value = biz.address || '';
            if (ciCity) ciCity.value = biz.city || '';
            if (ciState) ciState.value = (biz.state || 'CA').toUpperCase();
            if (ciZip) ciZip.value = biz.zip || '';
            
            // Log which fields were populated
            const sitePopulated = [siteCustomer, siteStreet, siteCity, siteState, siteZip].filter(el => el).length;
            const ciPopulated = [ciCustomer, ciStreet, ciCity, ciState, ciZip].filter(el => el).length;
            console.log('[selectBusiness] Populated site-* fields:', sitePopulated, ', ci-* fields:', ciPopulated);
            
            // Update clear button visibility for all fields
            [siteCustomer, siteStreet, siteCity, siteState, siteZip, ciCustomer, ciStreet, ciCity, ciState, ciZip].forEach(input => {
                if (input) {
                    updateClearButtonVisibility(input);
                }
            });
            
            // Close all autocomplete dropdowns to prevent them from opening after autofill
            closeAllAutocompleteDropdowns();
            
            // Look up utility by ZIP code
            if (biz.zip && ZIP_TO_UTILITY[biz.zip]) {
                applyUtilityToForm(ZIP_TO_UTILITY[biz.zip]);
            }
            
            // Close modal
            document.getElementById('nearbyBusinessesModal').classList.remove('show');
            
            // Update siteData and ProjectState
            siteData.customer = biz.name || '';
            siteData.street = biz.address || '';
            siteData.city = biz.city || '';
            siteData.state = (biz.state || 'CA').toUpperCase();
            siteData.zip = biz.zip || '';
            siteData.utility = computeUtilityValue();
            
            // Sync to ProjectState
            Object.assign(ProjectState.siteData, siteData);
            
            SaveController.queueSave('nearby-business-select');
        }
        
        // Auto-fill only address fields (used when editing street address, not customer)
        function selectAddress(addressData) {
            // Main form fields (site-*)
            const streetInput = document.getElementById('site-street');
            const cityInput = document.getElementById('site-city');
            const stateInput = document.getElementById('site-state');
            const zipInput = document.getElementById('site-zip');
            
            // Customer Info modal fields (ci-*)
            const ciStreetInput = document.getElementById('ci-street');
            const ciCityInput = document.getElementById('ci-city');
            const ciStateInput = document.getElementById('ci-state');
            const ciZipInput = document.getElementById('ci-zip');
            
            // Only fill address-related fields, DO NOT touch customer name
            if (streetInput) streetInput.value = addressData.street || '';
            if (cityInput) cityInput.value = addressData.city || '';
            if (stateInput) stateInput.value = (addressData.state || 'CA').toUpperCase();
            if (zipInput) zipInput.value = addressData.zip || '';
            
            // Also fill ci-* fields
            if (ciStreetInput) ciStreetInput.value = addressData.street || '';
            if (ciCityInput) ciCityInput.value = addressData.city || '';
            if (ciStateInput) ciStateInput.value = (addressData.state || 'CA').toUpperCase();
            if (ciZipInput) ciZipInput.value = addressData.zip || '';
            
            // Update clear button visibility (no input events to avoid triggering autocomplete)
            [streetInput, cityInput, stateInput, zipInput, ciStreetInput, ciCityInput, ciStateInput, ciZipInput].forEach(input => {
                if (input) {
                    updateClearButtonVisibility(input);
                }
            });
            
            // Close all autocomplete dropdowns
            closeAllAutocompleteDropdowns();
            
            // Look up utility by ZIP code
            if (addressData.zip && ZIP_TO_UTILITY[addressData.zip]) {
                applyUtilityToForm(ZIP_TO_UTILITY[addressData.zip]);
            }
            
            // Auto-save the changes to localStorage
            siteData.street = addressData.street || '';
            siteData.city = addressData.city || '';
            siteData.state = (addressData.state || 'CA').toUpperCase();
            siteData.zip = addressData.zip || '';
            siteData.utility = computeUtilityValue();
            SaveController.queueSave('address-select');
        }
        
        // Helper to close all autocomplete dropdowns
        function closeAllAutocompleteDropdowns() {
            document.querySelectorAll('.autocomplete-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }
    })();

    function getProposalData() {
        try {
            const projectStr = localStorage.getItem('currentProject');
            if (!projectStr) {
                return { error: 'No project data found' };
            }
            const project = JSON.parse(projectStr);
            return {
                siteData: project.siteData || {},
                entries: project.entries || [],
                evaporators: (project.entries || []).filter(e => e.section === 'evap'),
                condensers: (project.entries || []).filter(e => e.section === 'cond'),
                totalUnits: (project.entries || []).length
            };
        } catch (e) {
            return { error: 'Failed to read project data: ' + e.message };
        }
    }

    // expose globally for Excel / browser dev tools
    window.getProposalData = getProposalData;

    // Function to sync data to backend API
    function syncDataToBackend() {
        try {
            const data = getProposalData();
            if (data.error) return;
            
            fetch('/api/data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).catch(err => console.error('Sync failed:', err));
        } catch (e) {
            console.error('Sync error:', e);
        }
    }

    // Make syncDataToBackend globally available
    window.syncDataToBackend = syncDataToBackend;

    // Auto-sync when data changes from other tabs
    window.addEventListener('storage', syncDataToBackend);

    // Create nearby businesses modal dynamically if it doesn't exist
    if (!document.getElementById('nearbyBusinessesModal')) {
        const modal = document.createElement('div');
        modal.id = 'nearbyBusinessesModal';
        modal.innerHTML = `
            <div class="nearby-modal-content">
                <div class="nearby-modal-header">
                    Nearby Businesses
                    <button type="button" class="nearby-modal-close" id="nearbyModalClose">&times;</button>
                </div>
                <div id="nearbyBusinessesList"></div>
                <div id="nearbyLoadingMsg" style="text-align:center; color:#666;">Loading nearby businesses...</div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // OPTIONAL: if called with ?format=json, output JSON instead of the normal page
    document.addEventListener('DOMContentLoaded', function () {
        try {
            var params = new URLSearchParams(window.location.search);
            if (params.get('format') === 'json') {
                var data = getProposalData();
                var json = JSON.stringify(data, null, 2);

                // replace page with just JSON so HTTP clients can read it easily
                document.body.innerHTML = '';
                var pre = document.createElement('pre');
                pre.textContent = json;
                document.body.appendChild(pre);
            }
        } catch (e) {
            console.error('JSON view failed:', e);
        }
    });
    </script>
</body>
</html>
